window.Laya=function(t){"use strict";class e{}e.Loader=null,e.Context=null,e.Browser=null,e.Laya=null,e.loader=null,e.timer=null,e.systemTimer=null,e.physicsTimer=null,e.stage=null;class r{static getPoolBySign(t){return r._poolDic[t]||(r._poolDic[t]=[])}static clearBySign(t){r._poolDic[t]&&(r._poolDic[t].length=0)}static recover(t,e){e[r.POOLSIGN]||(e[r.POOLSIGN]=!0,r.getPoolBySign(t).push(e))}static recoverByClass(t){if(t){var e=t.__className||t.constructor._$gid;e&&r.recover(e,t)}}static _getClassSign(t){var e=t.__className||t._$gid;return e||(t._$gid=e=r._CLSID+"",r._CLSID++),e}static createByClass(t){return r.getItemByClass(r._getClassSign(t),t)}static getItemByClass(t,e){let i,s=r.getPoolBySign(t);return i=s.length?s.pop():new e,i[r.POOLSIGN]=!1,i}static getItemByCreateFun(t,e,i=null){var s=r.getPoolBySign(t),a=s.length?s.pop():e.call(i);return a[r.POOLSIGN]=!1,a}static getItem(t){var e=r.getPoolBySign(t),i=e.length?e.pop():null;return i&&(i[r.POOLSIGN]=!1),i}}r._CLSID=0,r.POOLSIGN="__InPool",r._poolDic={};class i{constructor(t=0,e=0){this.x=t,this.y=e}static create(){return r.getItemByClass("Point",i)}setTo(t,e){return this.x=t,this.y=e,this}reset(){return this.x=this.y=0,this}recover(){r.recover("Point",this.reset())}distance(t,e){return Math.sqrt((this.x-t)*(this.x-t)+(this.y-e)*(this.y-e))}toString(){return this.x+","+this.y}normalize(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t>0){var e=1/t;this.x*=e,this.y*=e}}copy(t){return this.setTo(t.x,t.y)}}i.TEMP=new i,i.EMPTY=new i;class s{static isMouseEvent(t){return a.has(t)}constructor(){this.touchId=0,this.delta=0,this.button=0,this.touchPos=new i}setTo(t,e,r){return this.type=t,this.currentTarget=e,this.target=r,this}stopPropagation(){this._stopped=!0}get touches(){return this._touches}get altKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.altKey}get ctrlKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.ctrlKey}get shiftKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.shiftKey}get metaKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}s.EMPTY=new s,s.MOUSE_DOWN="mousedown",s.MOUSE_UP="mouseup",s.RIGHT_MOUSE_DOWN="rightmousedown",s.RIGHT_MOUSE_UP="rightmouseup",s.CLICK="click",s.RIGHT_CLICK="rightclick",s.MOUSE_MOVE="mousemove",s.MOUSE_OVER="mouseover",s.MOUSE_OUT="mouseout",s.MOUSE_WHEEL="mousewheel",s.ROLL_OVER="mouseover",s.ROLL_OUT="mouseout",s.DOUBLE_CLICK="doubleclick",s.MOUSE_DRAG="mousedrag",s.MOUSE_DRAG_END="mousedragend",s.DRAG_START="dragstart",s.DRAG_MOVE="dragmove",s.DRAG_END="dragend",s.KEY_DOWN="keydown",s.KEY_PRESS="keypress",s.KEY_UP="keyup",s.CHANGE="change",s.CHANGED="changed",s.WILL_RESIZE="willResize",s.RESIZE="resize",s.ADDED="added",s.REMOVED="removed",s.DISPLAY="display",s.UNDISPLAY="undisplay",s.ERROR="error",s.COMPLETE="complete",s.LOADED="loaded",s.READY="ready",s.PROGRESS="progress",s.INPUT="input",s.RENDER="render",s.OPEN="open",s.MESSAGE="message",s.CLOSE="close",s.FRAME="enterframe",s.ENTER="enter",s.SELECT="select",s.BLUR="blur",s.FOCUS="focus",s.VISIBILITY_CHANGE="visibilitychange",s.FOCUS_CHANGE="focuschange",s.PLAYED="played",s.PAUSED="paused",s.STOPPED="stopped",s.START="start",s.END="end",s.LINK="link",s.LABEL="label",s.FULL_SCREEN_CHANGE="fullscreenchange",s.DEVICE_LOST="devicelost",s.TRANSFORM_CHANGED="transformchanged",s.LAYERCHANGE="layerChange",s.staticMask="staticMask",s.TRIGGER_ENTER="triggerenter",s.TRIGGER_STAY="triggerstay",s.TRIGGER_EXIT="triggerexit",s.COLLISION_ENTER="collisionenter",s.COLLISION_STAY="collisionstay",s.COLLISION_EXIT="collisionexit",s.JOINT_BREAK="jointbreak",s._Add_Script="addscript";const a=new Set([s.MOUSE_DOWN,s.MOUSE_UP,s.MOUSE_MOVE,s.CLICK,s.DOUBLE_CLICK,s.RIGHT_CLICK,s.RIGHT_MOUSE_DOWN,s.RIGHT_MOUSE_UP,s.MOUSE_OVER,s.MOUSE_OUT,s.MOUSE_WHEEL,s.MOUSE_DRAG,s.MOUSE_DRAG_END]);class n{}n.version="3.2.3",n.isPlaying=!0,n.isPreview=!1,n.isConch=!!window&&null!=window.conch;class l{}var o;t.RenderTargetFormat=void 0,(o=t.RenderTargetFormat||(t.RenderTargetFormat={}))[o.None=-1]="None",o[o.R8G8B8=0]="R8G8B8",o[o.R8G8B8A8=1]="R8G8B8A8",o[o.R16G16B16A16=17]="R16G16B16A16",o[o.R32G32B32=30]="R32G32B32",o[o.R32G32B32A32=15]="R32G32B32A32",o[o.R16G16B16=31]="R16G16B16",o[o.DEPTH_16=35]="DEPTH_16",o[o.STENCIL_8=36]="STENCIL_8",o[o.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",o[o.DEPTH_32=38]="DEPTH_32",o[o.DEPTHSTENCIL_24_Plus=39]="DEPTHSTENCIL_24_Plus";class h{constructor(){}static isZero(t){return Math.abs(t)<h.zeroTolerance}static nearEqual(t,e){return!!h.isZero(t-e)}static fastInvSqrt(t){return h.isZero(t)?t:1/Math.sqrt(t)}}h.zeroTolerance=1e-6,h.MaxValue=340282347e30,h.MinValue=-340282347e30,h.Deg2Rad=Math.PI/180;class u{constructor(t=0,e=0,r=0,i=0){this.x=t,this.y=e,this.z=r,this.w=i}setValue(t,e,r,i){this.x=t,this.y=e,this.z=r,this.w=i}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3]}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w}cloneTo(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}clone(){var t=new u;return this.cloneTo(t),t}static lerp(t,e,r,i){var s=t.x,a=t.y,n=t.z,l=t.w;i.x=s+r*(e.x-s),i.y=a+r*(e.y-a),i.z=n+r*(e.z-n),i.w=l+r*(e.w-l)}static transformByM4x4(t,e,r){var i=t.x,s=t.y,a=t.z,n=t.w,l=e.elements;r.x=i*l[0]+s*l[4]+a*l[8]+n*l[12],r.y=i*l[1]+s*l[5]+a*l[9]+n*l[13],r.z=i*l[2]+s*l[6]+a*l[10]+n*l[14],r.w=i*l[3]+s*l[7]+a*l[11]+n*l[15]}static equals(t,e){return h.nearEqual(Math.abs(t.x),Math.abs(e.x))&&h.nearEqual(Math.abs(t.y),Math.abs(e.y))&&h.nearEqual(Math.abs(t.z),Math.abs(e.z))&&h.nearEqual(Math.abs(t.w),Math.abs(e.w))}equal(t){return u.equals(this,t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(t,e){var r=t.length();if(r>0){var i=1/r;e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i}}static add(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z,r.w=t.w+e.w}static subtract(t,e,r){r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z,r.w=t.w-e.w}static multiply(t,e,r){r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z,r.w=t.w*e.w}static scale(t,e,r){r.x=t.x*e,r.y=t.y*e,r.z=t.z*e,r.w=t.w*e}static Clamp(t,e,r,i){var s=t.x,a=t.y,n=t.z,l=t.w,o=e.x,h=e.y,u=e.z,d=e.w,c=r.x,_=r.y,p=r.z,f=r.w;s=(s=s>c?c:s)<o?o:s,a=(a=a>_?_:a)<h?h:a,n=(n=n>p?p:n)<u?u:n,l=(l=l>f?f:l)<d?d:l,i.x=s,i.y=a,i.z=n,i.w=l}static distanceSquared(t,e){var r=t.x-e.x,i=t.y-e.y,s=t.z-e.z,a=t.w-e.w;return r*r+i*i+s*s+a*a}static distance(t,e){var r=t.x-e.x,i=t.y-e.y,s=t.z-e.z,a=t.w-e.w;return Math.sqrt(r*r+i*i+s*s+a*a)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static min(t,e,r){r.x=Math.min(t.x,e.x),r.y=Math.min(t.y,e.y),r.z=Math.min(t.z,e.z),r.w=Math.min(t.w,e.w)}static max(t,e,r){r.x=Math.max(t.x,e.x),r.y=Math.max(t.y,e.y),r.z=Math.max(t.z,e.z),r.w=Math.max(t.w,e.w)}}u.ZERO=new u,u.ONE=new u(1,1,1,1),u.UnitX=new u(1,0,0,0),u.UnitY=new u(0,1,0,0),u.UnitZ=new u(0,0,1,0),u.UnitW=new u(0,0,0,1),u.tempVec4=new u(0,0,0,0);class d{static distanceSquared(t,e){var r=t.x-e.x,i=t.y-e.y,s=t.z-e.z;return r*r+i*i+s*s}static distance(t,e){var r=t.x-e.x,i=t.y-e.y,s=t.z-e.z;return Math.sqrt(r*r+i*i+s*s)}static min(t,e,r){r.x=Math.min(t.x,e.x),r.y=Math.min(t.y,e.y),r.z=Math.min(t.z,e.z)}static max(t,e,r){r.x=Math.max(t.x,e.x),r.y=Math.max(t.y,e.y),r.z=Math.max(t.z,e.z)}static transformQuat(t,e,r){var i=t.x,s=t.y,a=t.z,n=e.x,l=e.y,o=e.z,h=e.w,u=h*i+l*a-o*s,d=h*s+o*i-n*a,c=h*a+n*s-l*i,_=-n*i-l*s-o*a;r.x=u*h+_*-n+d*-o-c*-l,r.y=d*h+_*-l+c*-n-u*-o,r.z=c*h+_*-o+u*-l-d*-n}static scalarLength(t){var e=t.x,r=t.y,i=t.z;return Math.sqrt(e*e+r*r+i*i)}static scalarLengthSquared(t){var e=t.x,r=t.y,i=t.z;return e*e+r*r+i*i}static normalize(t,e){var r=t.x,i=t.y,s=t.z,a=r*r+i*i+s*s;a>0&&(a=1/Math.sqrt(a),e.x=r*a,e.y=i*a,e.z=s*a)}static multiply(t,e,r){r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z}static scale(t,e,r){r.x=t.x*e,r.y=t.y*e,r.z=t.z*e}static lerp(t,e,r,i){var s=t.x,a=t.y,n=t.z;i.x=s+r*(e.x-s),i.y=a+r*(e.y-a),i.z=n+r*(e.z-n)}static transformV3ToV3(t,e,r){d.transformV3ToV4(t,e,c),r.x=c.x,r.y=c.y,r.z=c.z}static transformV3ToV4(t,e,r){var i=t.x,s=t.y,a=t.z,n=e.elements;r.x=i*n[0]+s*n[4]+a*n[8]+n[12],r.y=i*n[1]+s*n[5]+a*n[9]+n[13],r.z=i*n[2]+s*n[6]+a*n[10]+n[14],r.w=i*n[3]+s*n[7]+a*n[11]+n[15]}static TransformNormal(t,e,r){var i=t.x,s=t.y,a=t.z,n=e.elements;r.x=i*n[0]+s*n[4]+a*n[8],r.y=i*n[1]+s*n[5]+a*n[9],r.z=i*n[2]+s*n[6]+a*n[10]}static transformCoordinate(t,e,r){var i=t.x,s=t.y,a=t.z,n=e.elements,l=i*n[3]+s*n[7]+a*n[11]+n[15];r.x=(i*n[0]+s*n[4]+a*n[8]+n[12])/l,r.y=(i*n[1]+s*n[5]+a*n[9]+n[13])/l,r.z=(i*n[2]+s*n[6]+a*n[10]+n[14])/l}static Clamp(t,e,r,i){var s=t.x,a=t.y,n=t.z,l=e.x,o=e.y,h=e.z,u=r.x,d=r.y,c=r.z;s=(s=s>u?u:s)<l?l:s,a=(a=a>d?d:a)<o?o:a,n=(n=n>c?c:n)<h?h:n,i.x=s,i.y=a,i.z=n}static add(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z}static subtract(t,e,r){r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z}static cross(t,e,r){var i=t.x,s=t.y,a=t.z,n=e.x,l=e.y,o=e.z;r.x=s*o-a*l,r.y=a*n-i*o,r.z=i*l-s*n}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static equals(t,e){return h.nearEqual(t.x,e.x)&&h.nearEqual(t.y,e.y)&&h.nearEqual(t.z,e.z)}constructor(t=0,e=0,r=0){this.x=t,this.y=e,this.z=r}equal(t){return d.equals(this,t)}setValue(t,e,r){return this.x=t,this.y=e,this.z=r,this}set(t,e,r){return this.x=t,this.y=e,this.z=r,this}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2]}toArray(){return[this.x,this.y,this.z]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(t,e){return e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z,e}vadd(t,e){return e.x=this.x+t.x,e.y=this.y+t.y,e.z=this.z+t.z,e}scale(t,e){return e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e}normalize(){let t=this.x,e=this.y,r=this.z;var i=t*t+e*e+r*r;return i>0&&(i=1/Math.sqrt(i),this.x=t*i,this.y=e*i,this.z=r*i),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t,e){var r=this.x,i=this.y,s=this.z,a=t.x,n=t.y,l=t.z;return e.x=i*l-s*n,e.y=s*a-r*l,e.z=r*n-i*a,e}cloneTo(t){t.x=this.x,t.y=this.y,t.z=this.z}clone(){var t=new d;return this.cloneTo(t),t}toDefault(){this.x=0,this.y=0,this.z=0}}d._tempVector3=new d,d.ZERO=new d(0,0,0),d.ONE=new d(1,1,1),d.NegativeUnitX=new d(-1,0,0),d.UnitX=new d(1,0,0),d.UnitY=new d(0,1,0),d.UnitZ=new d(0,0,1),d.ForwardRH=new d(0,0,-1),d.ForwardLH=new d(0,0,1),d.Up=new d(0,1,0);const c=new u;class _{static setResolution(t,e){_.customResolution=!0,_._resoluWidth=t,_._resoluHeight=e}}var p;_.enableDynamicBatch=!0,_.enableStaticBatch=!0,_.enableUniformBufferObject=!0,_.pixelRatio=1,_.customResolution=!1,_.defaultCacheRTMemory=256,_.defaultPhysicsMemory=16,_.enableMultiLight=!0,_.maxLightCount=32,_.lightClusterCount=new d(12,12,12),_.maxMorphTargetCount=32,_.useBVHCull=!1,_.BVH_max_SpatialCount=7,_.BVH_limit_size=32,_.BVH_Min_Build_nums=10,_._resoluWidth=-1,_._resoluHeight=-1,_.debugFrustumCulling=!1,t.TextureDimension=void 0,(p=t.TextureDimension||(t.TextureDimension={}))[p.Tex2D=0]="Tex2D",p[p.Cube=1]="Cube",p[p.Tex3D=2]="Tex3D",p[p.Texture2DArray=3]="Texture2DArray",p[p.CubeArray=4]="CubeArray",p[p.Unkonw=5]="Unkonw",p[p.None=6]="None";class f{}f.isAntialias=!0,f.useWebGL2=!0,f.FPS=60,f.useRetinalCanvas=!1,f.animationInterval=50,f.webGL2D_MeshAllocMaxMem=!0,f.defaultFontSize=12,f.defaultFont="Arial",f.isAlpha=!1,f.isDepth=!1,f.isfailIfMajorPerformanceCaveat=!1,f.powerPreference="default",f.premultipliedAlpha=!0,f.isStencil=!0,f.preserveDrawingBuffer=!1,f.printWebglOrder=!1,f.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},f.fixedFrames=!0,f.destroyResourceImmediatelyDefault=!0,f._enableWindowRAFFunction=!0;const g={};var m,y;t.HDREncodeFormat=void 0,(m=t.HDREncodeFormat||(t.HDREncodeFormat={}))[m.NONE=0]="NONE",m[m.RGBM=1]="RGBM",m[m.RGBD=2]="RGBD",t.TextureFormat=void 0,(y=t.TextureFormat||(t.TextureFormat={}))[y.R8G8B8=0]="R8G8B8",y[y.R8G8B8A8=1]="R8G8B8A8",y[y.R5G6B5=16]="R5G6B5",y[y.Alpha8=2]="Alpha8",y[y.DXT1=3]="DXT1",y[y.DXT3=29]="DXT3",y[y.DXT5=4]="DXT5",y[y.ETC1RGB=5]="ETC1RGB",y[y.ETC2RGB=6]="ETC2RGB",y[y.ETC2RGBA=7]="ETC2RGBA",y[y.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",y[y.ETC2SRGB=28]="ETC2SRGB",y[y.ETC2RGB_Alpha1=32]="ETC2RGB_Alpha1",y[y.ETC2SRGB_Alpha1=33]="ETC2SRGB_Alpha1",y[y.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",y[y.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",y[y.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",y[y.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",y[y.R32G32B32A32=15]="R32G32B32A32",y[y.R32G32B32=30]="R32G32B32",y[y.R16G16B16A16=17]="R16G16B16A16",y[y.R16G16B16=31]="R16G16B16",y[y.ASTC4x4=18]="ASTC4x4",y[y.ASTC4x4SRGB=23]="ASTC4x4SRGB",y[y.ASTC6x6=19]="ASTC6x6",y[y.ASTC6x6SRGB=24]="ASTC6x6SRGB",y[y.ASTC8x8=20]="ASTC8x8",y[y.ASTC8x8SRGB=25]="ASTC8x8SRGB",y[y.ASTC10x10=21]="ASTC10x10",y[y.ASTC10x10SRGB=26]="ASTC10x10SRGB",y[y.ASTC12x12=22]="ASTC12x12",y[y.ASTC12x12SRGB=27]="ASTC12x12SRGB",y[y.KTXTEXTURE=-1]="KTXTEXTURE",y[y.PVRTEXTURE=-2]="PVRTEXTURE";class T{constructor(){this._flag=0,this._items=[]}add(t,e,r){let i=this._items,s=i.findIndex(((r,i,s)=>r==t&&s[i+1]==e));-1!=s?(i[s+2]=r,i[s+3]=1):i.push(t,e,r,1)}once(t,e,r){let i=this._items,s=i.findIndex(((r,i,s)=>r==t&&s[i+1]==e));-1!=s?(i[s+2]=r,i[s+3]=2):i.push(t,e,r,2)}remove(t,e){let r=this._items,i=r.findIndex(((r,i,s)=>r==t&&s[i+1]==e));-1!=i&&(0!=this._flag?(r[i+3]=0,this._flag=2):r.splice(i,4))}clear(){let t=this._items;0!=this._flag?(t.forEach(((t,e,r)=>{e%4==3&&(r[e]=0)})),this._flag=2):t.length=0}clearForTarget(t){if(!t)return;let e=this._items;if(0!=this._flag)e.forEach(((e,r,i)=>{r%4==1&&i[r]==t&&(i[r+2]=0)})),this._flag=2;else{let r=e.length-4;for(;r>=0;)e[r+1]==t&&e.splice(r,4),r-=4}}get count(){return this._items.length/4}invoke(...t){if(0!=this._flag)return;this._flag=1;let e=this._items,r=e.length;for(let i=0;i<r;i+=4){if(0==e[i+3])continue;let r=e[i+2];try{null!=r?e[i].call(e[i+1],...r,...t):e[i].call(e[i+1],...t)}catch(t){console.error(t)}2==e[i+3]&&(e[i+3]=0,this._flag=2)}if(2==this._flag){let t=e.length,r=0;for(;r<t;)0!=e[r+3]?r+=4:(e.splice(r,4),t-=4)}this._flag=0}}const x=[];class v{onStartListeningToType(t){}hasListener(t){let e=this._events&&this._events[t];return!!e&&e.count>0}event(t,e){let r=this._events&&this._events[t];if(!r)return!1;let i=r.count>0;if(Array.isArray(e))r.invoke(...e);else if(void 0!==e)r.invoke(e);else if(e===s.EMPTY){let e=x.length>0?x.pop():new s;r.invoke(e.setTo(t,this,this)),e.target=e.currentTarget=null,x.push(e)}else r.invoke();return i}on(t,e,r,i){2==arguments.length&&(r=e,e=null),this._events||(this._events={});let s=this._events[t];return s||(this.onStartListeningToType(t),this._events[t]=s=new T),s.add(r,e,i),this}once(t,e,r,i){2==arguments.length&&(r=e,e=null),this._events||(this._events={});let s=this._events[t];return s||(this.onStartListeningToType(t),this._events[t]=s=new T),s.once(r,e,i),this}off(t,e,r){2==arguments.length&&(r=e,e=null);let i=this._events&&this._events[t];return i&&i.remove(r,e),this}offAll(t){if(null==t)this._events=null;else{let e=this._events&&this._events[t];e&&e.clear()}return this}offAllCaller(t){if(t&&this._events)for(let e in this._events)this._events[e].clearForTarget(t);return this}}var S,E=0,w=0,D=0;class b extends v{static get cpuMemory(){return b._cpuMemory}static get gpuMemory(){return b._gpuMemory}static _addCPUMemory(t){b._cpuMemory+=t}static _addGPUMemory(t){b._gpuMemory+=t}static _addMemory(t,e){b._cpuMemory+=t,b._gpuMemory+=e}static destroyUnusedResources(){w=0,D=0,e.loader.loading?e.timer.frameLoop(1,b,b._destroyUnusedResources):b._destroyUnusedResources(!0)}static _destroyUnusedResources(t){if(!t&&e.loader.loading)return;e.timer.clear(b,b._destroyUnusedResources);let r=0;for(let t in b._idResourcesMap){let e=b._idResourcesMap[t];e.lock||0!==e._referenceCount||(e.destroy(),r++)}b.DEBUG&&r>0&&console.debug(`destroyUnusedResources(${r})`),r>0&&D<5&&(D++,e.timer.frameLoop(1,b,b._destroyUnusedResources))}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(t){this._obsolute!=t&&(this._obsolute=t,t&&!n.isPlaying&&this.event("obsolute"))}get deps(){return this._deps}get referenceCount(){return this._referenceCount}constructor(t){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++E,this._destroyed=!1,this._referenceCount=0,(null==t||t)&&(b._idResourcesMap[this._id]=this),this.lock=!1,this.destroyedImmediately=!0,this._deps=[],this._traceDeps=!1}_setCPUMemory(t){var e=t-this._cpuMemory;this._cpuMemory=t,b._addCPUMemory(e)}_setGPUMemory(t){var e=t-this._gpuMemory;this._gpuMemory=t,b._addGPUMemory(e)}_setCreateURL(t,e){this.url=t,this.uuid=e}isCreateFromURL(t){return this.uuid&&t.length===this.uuid.length+6&&t.endsWith(this.uuid)||this.url===t}_addReference(t=1){this._referenceCount+=t}_removeReference(t=1){this._referenceCount-=t,w>0&&this._referenceCount<=0&&!this.lock&&this.destroyedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}addDep(t){t instanceof b&&(t._addReference(),this._deps.push(t),!n.isPlaying&&t._traceDeps&&t.on("obsolute",this,this.onDepObsolute))}addDeps(t){for(let e of t)e instanceof b&&(e._addReference(),this._deps.push(e),!n.isPlaying&&e._traceDeps&&e.on("obsolute",this,this.onDepObsolute))}onDepObsolute(){this.obsolute=!0}_disposeResource(){}destroy(){if(!this._destroyed){this._destroyed=!0,this.lock=!1,w++,this._disposeResource();for(let t of this._deps)t._removeReference(),!n.isPlaying&&t._traceDeps&&t.off("obsolute",this,this.onDepObsolute);w--,this.offAll(),delete b._idResourcesMap[this.id],this.url&&(b.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),e.loader.clearRes(this.url,this))}}}b._idResourcesMap={},b._cpuMemory=0,b._gpuMemory=0,b.DEBUG=!1;class R extends b{get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(t){this._texture.anisoLevel=t}get filterMode(){return this._texture.filterMode}set filterMode(t){this._texture.filterMode=t}get wrapModeU(){return this._texture.wrapU}set wrapModeU(t){this._texture.wrapU=t}get wrapModeV(){return this._texture.wrapV}set wrapModeV(t){this._texture.wrapV=t}get wrapModeW(){return this._texture.wrapW}set wrapModeW(t){this._texture.wrapW=t}get compareMode(){return this._texture.compareMode}set compareMode(t){this._texture.compareMode=l.textureContext.setTextureCompareMode(this._texture,t)}get gammaCorrection(){return this._texture.gammaCorrection}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set baseMipmapLevel(t){this._texture.baseMipmapLevel=t}get maxMipmapLevel(){return this._texture.maxMipmapLevel}set maxMipmapLevel(t){this._texture.maxMipmapLevel=t}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}constructor(e,r,i){super(),this._gammaSpace=!1,this._width=e,this._height=r,this._format=i,this.destroyedImmediately=f.destroyResourceImmediatelyDefault,this.hdrEncodeFormat=t.HDREncodeFormat.NONE}gpuCompressFormat(){switch(this._format){case t.TextureFormat.R8G8B8:case t.TextureFormat.R8G8B8A8:case t.TextureFormat.R16G16B16:case t.TextureFormat.R16G16B16A16:case t.TextureFormat.R32G32B32:case t.TextureFormat.R32G32B32A32:case t.TextureFormat.R5G6B5:case t.TextureFormat.Alpha8:return!1;case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:case t.TextureFormat.ETC1RGB:case t.TextureFormat.ETC2RGB:case t.TextureFormat.ETC2RGBA:case t.TextureFormat.ETC2SRGB_Alpha8:case t.TextureFormat.ETC2SRGB:case t.TextureFormat.ETC2RGB_Alpha1:case t.TextureFormat.ETC2SRGB_Alpha1:case t.TextureFormat.PVRTCRGB_2BPPV:case t.TextureFormat.PVRTCRGBA_2BPPV:case t.TextureFormat.PVRTCRGB_4BPPV:case t.TextureFormat.PVRTCRGBA_4BPPV:case t.TextureFormat.ASTC4x4:case t.TextureFormat.ASTC4x4SRGB:case t.TextureFormat.ASTC6x6:case t.TextureFormat.ASTC6x6SRGB:case t.TextureFormat.ASTC8x8:case t.TextureFormat.ASTC8x8SRGB:case t.TextureFormat.ASTC10x10:case t.TextureFormat.ASTC10x10SRGB:case t.TextureFormat.ASTC12x12:case t.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case t.TextureFormat.R8G8B8:return 3;case t.TextureFormat.R8G8B8A8:return 4;case t.TextureFormat.R5G6B5:case t.TextureFormat.Alpha8:return 1;case t.TextureFormat.R16G16B16A16:return 2;case t.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}_getSource(){return this._texture.resource}get defaultTexture(){throw"defaulte"}_disposeResource(){this._texture.dispose()}}t.DepthTextureMode=void 0,(S=t.DepthTextureMode||(t.DepthTextureMode={}))[S.None=0]="None",S[S.Depth=1]="Depth",S[S.DepthNormals=2]="DepthNormals",S[S.DepthAndDepthNormals=3]="DepthAndDepthNormals",S[S.MotionVectors=4]="MotionVectors";class C extends R{static createFromPool(t,e,r,i,s=!1,a=1,n=!1,l=!1){s=s&&!(t&t-1)&&!(e&e-1);let o=C._pool.length;for(let h=0;h<o;h++){let u=C._pool[h];if(u.width==t&&u.height==e&&u.colorFormat==r&&u.depthStencilFormat==i&&u._generateMipmap==s&&u.multiSamples==a&&u.generateDepthTexture==n&&u._gammaSpace==l){u._inPool=!1;let t=C._pool[o-1];return C._pool[h]=t,C._pool.length-=1,C._poolMemory-=u._renderTarget.gpuMemory/1024/1024,u}}let h=new C(t,e,r,i,s,a,n,l);return h.lock=!0,h}static recoverToPool(t){t._inPool||t.destroyed||(C._pool.push(t),C._poolMemory+=t._renderTarget.gpuMemory/1024/1024,t._inPool=!0)}static clearPool(){if(!(C._poolMemory<_.defaultCacheRTMemory)){for(var t in C._pool)C._pool[t].destroy();C._pool=[],C._poolMemory=0}}static get bindCanvasRender(){return C._bindCanvasRender}static set bindCanvasRender(t){t!=this._bindCanvasRender&&(this._bindCanvasRender=t)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(e){this.depthStencilFormat!=t.RenderTargetFormat.None?(e&&!this._depthStencilTexture&&(this._depthStencilTexture=new R(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=t.TextureDimension.Tex2D,this._depthStencilTexture._texture=l.textureContext.createRenderTargetDepthTexture(this._renderTarget,t.TextureDimension.Tex2D,this.width,this.height)),this._generateDepthTexture=e):this._generateDepthTexture=!1}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}constructor(e,r,i,s,a=!1,n=1,l=!1,o=!1){super(e,r,i),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._gammaSpace=o,this._depthStencilFormat=null==s?t.RenderTargetFormat.None:s,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=l,this._createRenderTarget()}_createRenderTarget(){this._dimension=t.TextureDimension.Tex2D,this._renderTarget=l.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._generateMipmap=this._renderTarget._generateMipmap,this._renderTarget._texturesResolve?this._texture=this._renderTarget._texturesResolve[0]:this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(e,r,i,s,a=!1,n=1,l=!1,o=!1){this._width=e,this._height=r,this._format=i,this._gammaSpace=o,this._depthStencilFormat=null==s?t.RenderTargetFormat.None:s,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=l,this._disposeResource(),this._createRenderTarget()}getData(t,e,r,i,s){return l.textureContext.readRenderTargetPixelData(this._renderTarget,t,e,r,i,s),s}getDataAsync(t,e,r,i,s){return l.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,t,e,r,i,s)}_disposeResource(){var t;this._renderTarget.dispose(),this._renderTarget=null,null===(t=this._depthStencilTexture)||void 0===t||t.destroy(),this._depthStencilTexture=null}}C._pool=[],C._poolMemory=0;class A{static __init__(){var t;let r=window.Laya||e.Laya;if(A._window)return A._window;let i,s=A._window=window,a=A._document=s.document,n=A.userAgent=s.navigator.userAgent,l=s.navigator.maxTouchPoints||0,o=s.navigator.platform;window.conch&&"conchUseWXAdapter"in A.window&&(i=["wxMiniGame","MiniAdpter","wx"]),"my"in A.window&&(n.indexOf("TB/")>-1||n.indexOf("Taobao/")>-1||n.indexOf("TM/")>-1?i=["tbMiniGame","TBMiniAdapter","my"]:n.indexOf("AlipayMiniGame")>-1&&(i=["aliPayMiniGame","ALIMiniAdapter","my"])),(-1==n.indexOf("OPPO")&&n.indexOf("MiniGame")>-1||-1!=n.indexOf("runtime")||-1!=n.indexOf("miniprogram")&&window.isWXMiMi)&&"wx"in A.window&&(i="tt"in A.window?["ttMiniGame","TTMiniAdapter","tt"]:"bl"in A.window?["biliMiniGame","BLMiniAdapter",null]:"qq"in A.window?["qqMiniGame","QQMiniAdapter",null]:["wxMiniGame","MiniAdpter","wx"]),"hbs"in A.window&&(i=["hwMiniGame","HWMiniAdapter",null]),n.indexOf("SwanGame")>-1&&(i=["bdMiniGame","BMiniAdapter",null]),n.indexOf("QuickGame")>-1&&(i=["miMiniGame","KGMiniAdapter","qg"]),n.indexOf("OPPO")>-1&&n.indexOf("MiniGame")>-1&&(i=["qgMiniGame","QGMiniAdapter","qg"],f.fixedFrames=!1),n.indexOf("VVGame")>-1&&(i=["vvMiniGame","VVMiniAdapter","qg"],f.fixedFrames=!1),null!=i&&(A.window[i[0]](r,r),r[i[1]].enable(),A.miniGameContext=A.window[i[2]]),s.trace=console.log,s.requestAnimationFrame=s.requestAnimationFrame||s.webkitRequestAnimationFrame||s.mozRequestAnimationFrame||s.oRequestAnimationFrame||s.msRequestAnimationFrame||function(t){return s.setTimeout(t,1e3/60)};var h=a.body.style;h.margin=0,h.overflow="hidden",h["-webkit-user-select"]="none",h["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";var u=a.getElementsByTagName("meta");let d,c={width:"device-width","initial-scale":"1.0","minimum-scale":"1.0","maximum-scale":"1.0","user-scalable":"no"};for(const t of u)if("viewport"==t.name){d=t;break}if(d){let t=(d.content||"").split(",");for(let e of t){let t=e.split("=");c[t[0].trim()]||(c[t[0]]=t[1])}}else d=a.createElement("meta"),d.name="viewport",null===(t=a.getElementsByTagName("head")[0])||void 0===t||t.appendChild(d);return d.content=Object.keys(c).map((t=>t+"="+c[t])),A.onMobile=!!window.conch||n.indexOf("Mobile")>-1,A.onIOS=!!n.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),A.onIPhone=n.indexOf("iPhone")>-1,A.onMac=n.indexOf("Mac OS X")>-1,A.onIPad=n.indexOf("iPad")>-1||"MacIntel"===o&&l>1,A.onAndroid=n.indexOf("Android")>-1||n.indexOf("Adr")>-1,A.onOpenHarmonyOS=n.indexOf("OpenHarmony")>-1,A.onWP=n.indexOf("Windows Phone")>-1,A.onQQBrowser=n.indexOf("QQBrowser")>-1,A.onMQQBrowser=n.indexOf("MQQBrowser")>-1||n.indexOf("Mobile")>-1&&n.indexOf("QQ")>-1,A.onIE=!!s.ActiveXObject||"ActiveXObject"in s,A.onWeiXin=n.indexOf("MicroMessenger")>-1,A.onSafari=n.indexOf("Safari")>-1&&-1===n.indexOf("Chrome"),A.onChrome=n.indexOf("Chrome")>-1,A.onPC=!A.onMobile,A.onFirefox=n.indexOf("Firefox")>-1,A.onEdge=n.indexOf("Edge")>-1||n.indexOf("Edg")>-1,A.onMiniGame=n.indexOf("MiniGame")>-1,A.onBDMiniGame=n.indexOf("SwanGame")>-1,A.onLayaRuntime=!!window.conch,n.indexOf("OPPO")>-1&&n.indexOf("MiniGame")>-1?(A.onQGMiniGame=!0,A.onMiniGame=!1):"qq"in A.window&&n.indexOf("MiniGame")>-1?(A.onQQMiniGame=!0,A.onMiniGame=!1):"bl"in A.window&&n.indexOf("MiniGame")>-1?(A.onBLMiniGame=!0,A.onMiniGame=!1):"tt"in A.window&&n.indexOf("MiniGame")>-1&&(A.onTTMiniGame=!0,A.onMiniGame=!1),A.onHWMiniGame="hbs"in A.window,A.onVVMiniGame=n.indexOf("VVGame")>-1,A.onKGMiniGame=n.indexOf("QuickGame")>-1,n.indexOf("AlipayMiniGame")>-1&&(A.onAlipayMiniGame=!0,A.onMiniGame=!1),(n.indexOf("TB/")>-1||n.indexOf("Taobao/")>-1||n.indexOf("TM/")>-1)&&(A.onTBMiniGame=!0),(A.onAndroid||A.onIOS)&&(!o||-1==o.indexOf("Win")&&-1==o.indexOf("Mac"))?A.onAndroid?A.platform=A.PLATFORM_ANDROID:A.platform=A.PLATFORM_IOS:A.platform=A.PLATFORM_PC,s}static get _isMiniGame(){return A.onMiniGame||A.onBDMiniGame||A.onQGMiniGame||A.onKGMiniGame||A.onVVMiniGame||A.onAlipayMiniGame||A.onQQMiniGame||A.onBLMiniGame||A.onTTMiniGame||A.onHWMiniGame||A.onTBMiniGame||A.window&&A.window.isWXMiMi}static createElement(t){return A.__init__(),A._document.createElement(t)}static getElementById(t){return A.__init__(),A._document.getElementById(t)}static removeElement(t){t&&t.parentNode&&t.parentNode.removeChild(t)}static now(){return Date.now()}static get clientWidth(){return A.__init__(),A._clientWidth||A._window.innerWidth||A._document.body.clientWidth}static set clientWidth(t){A._clientWidth=t}static get clientHeight(){return A.__init__(),A._clientHeight||A._window.innerHeight||A._document.body.clientHeight||A._document.documentElement.clientHeight}static set clientHeight(t){A._clientHeight=t}static get width(){return A.__init__(),(e.stage&&e.stage.canvasRotation?A.clientHeight:A.clientWidth)*A.pixelRatio}static get height(){return A.__init__(),(e.stage&&e.stage.canvasRotation?A.clientWidth:A.clientHeight)*A.pixelRatio}static get pixelRatio(){return A._pixelRatio<0&&(A.__init__(),A.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?A._pixelRatio=2:(A._pixelRatio=A._window.devicePixelRatio||1,A._pixelRatio<1&&(A._pixelRatio=1))),A._pixelRatio}static get container(){return A._container||(A.__init__(),A._container=A.createElement("div"),A._container.id="layaContainer",A._document.body.appendChild(A._container)),A._container}static set container(t){A._container=t}static get window(){return A._window||A.__init__()}static get document(){return A.__init__(),A._document}static getQueryString(t){if(A.onMiniGame)return null;if(!window.location||!window.location.search)return null;var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),r=window.location.search.substring(1).match(e);return null!=r?unescape(r[2]):null}static getSafariToolbarOffset(){return(A.window.__innerHeight||A.document.body.clientHeight||A.document.documentElement.clientHeight)-A.window.innerHeight}static loadLib(t){return new Promise(((e,r)=>{let i=A.document.createElement("script");i.onload=function(){e()},i.onerror=function(){r(`load ${t} failed`)},i.src=t,A.document.body.appendChild(i)}))}}A.PLATFORM_PC=0,A.PLATFORM_ANDROID=1,A.PLATFORM_IOS=2,A.bundles=new Map,A._pixelRatio=-1,A.mainCanvas=null,A.hanzi=new RegExp("^[一-龥]$"),A.fontMap={},A.measureText=function(t,e){let r=A.hanzi.test(t);if(r&&A.fontMap[e])return A.fontMap[e];let i=A.context;i.font=e;let s=i.measureText(t);return r&&(A.fontMap[e]=s),s};let I=window;I.__getBundle_=function(t){let e=A.bundles.get(t);return e||A.bundles.set(t,e={}),e},I.__setBundle_=function(t,e,r){let i=A.bundles.get(t);i&&function(t,e,r){var i;if(e&&"object"==typeof e||"function"==typeof e)for(let s of Object.getOwnPropertyNames(e))t.hasOwnProperty(s)||s===r||Object.defineProperty(t,s,{get:()=>e[s],enumerable:!(i=Object.getOwnPropertyDescriptor(e,s))||i.enumerable})}(i,e,"default"),A.bundles.set(t,e),r&&(I[r]=e)};var M=1;const B=180/Math.PI,L=Math.PI/180;class P{static toRadian(t){return t*L}static toAngle(t){return t*B}static toHexColor(t){if(t<0||isNaN(t))return null;for(var e=t.toString(16);e.length<6;)e="0"+e;return"#"+e}static fromStringColor(t){if(!t)return 0;if(t.indexOf("rgba(")>=0||t.indexOf("rgb(")>=0){let e=t.indexOf("("),r=t.indexOf(")");if(-1==e||-1==r)return 0;let i=(t=t.substring(e+1,r)).split(","),s=i.length;for(let t=0;t<s;t++)i[t]=parseFloat(i[t]),isNaN(i[t])&&(i[t]=0);return 4==i.length?(i[0]<<24)+(i[1]<<16)+(i[2]<<8)+Math.round(255*i[3]):(i[0]<<16)+(i[1]<<8)+i[2]}{"#"===t.charAt(0)&&(t=t.substring(1));let e=t.length;if(3===e||4===e){let r="";for(let i=0;i<e;i++)r+=t[i]+t[i];t=r}return parseInt(t,16)}}static getGID(){return M++}static copyArray(t,e){if(t||(t=[]),!e)return t;t.length=e.length;var r=e.length;for(let i=0;i<r;i++)t[i]=e[i];return t}static transPointList(t,e,r){var i,s=t.length;for(i=0;i<s;i+=2)t[i]+=e,t[i+1]+=r}static parseInt(t,e=0){var r=parseInt(t,e);return isNaN(r)?0:r}static getBaseName(t){let e=t.lastIndexOf("/");return-1!=e&&(t=t.substring(e+1)),e=t.indexOf("?"),-1!=e&&(t=t.substring(0,e)),t}static getFileExtension(t){let e=t.lastIndexOf(".");if(-1!=e){let r=t.substring(e+1).toLowerCase(),i=r.indexOf("?");if(-1!=i&&(r=r.substring(0,i)),"ls"===r){let i=t.lastIndexOf(".",e-1);if(-1!=i){let s=t.substring(i+1,e+1)+r;if("lanit.ls"===s||"ltcb.ls"===s)return s}}return r}return""}static replaceFileExtension(t,e,r){if(!t)return t;let i=t.lastIndexOf(".");if(e.length>0&&!r&&(e="."+e),-1!=i){let r=t.indexOf("?",i);return-1!=r?t.substring(0,i)+e+t.substring(r):t.substring(0,i)+e}return t+e}static isUUID(t){return t&&t.length>=36&&45===t.charCodeAt(8)&&45===t.charCodeAt(13)}static uint8ArrayToArrayBuffer(e){let r;const i=e.width,s=e.height,a=i*s*4,n=e instanceof C?e.colorFormat:e.getColorFormat();switch(n){case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:r=new Uint8Array(a);break;case t.RenderTargetFormat.R16G16B16A16:r=new Float32Array(a);break;default:throw"this function is not surpprt "+e.format.toString()+"format Material"}if(l.textureContext.readRenderTargetPixelData(e._renderTarget,0,0,e.width,e.height,r),n===t.RenderTargetFormat.R16G16B16A16){const t=r,e=new Uint8Array(a);for(let r=0,i=t.length;r<i;r++)e[r]=Math.min(Math.floor(255*t[r]),255);r=e}const o=r,h=A.createElement("canvas");h.height=s,h.width=i;const u=h.getContext("2d"),d=u.createImageData(i,s);d.data.set(new Uint8ClampedArray(o)),u.putImageData(d,0,0);const c=h.toDataURL();return h.remove(),c}static uint8ArrayToArrayBufferAsync(e){let r;const i=e.width,s=e.height,a=i*s*4,n=e instanceof C?e.colorFormat:e.getColorFormat();switch(n){case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:r=new Uint8Array(a);break;case t.RenderTargetFormat.R16G16B16A16:r=new Float32Array(a);break;default:throw"this function is not surpprt "+e.format.toString()+"format Material"}return e.getDataAsync(0,0,i,s,r).then((()=>{if(n===t.RenderTargetFormat.R16G16B16A16){const t=r,e=new Uint8Array(a);for(let r=0,i=t.length;r<i;r++)e[r]=Math.min(Math.floor(255*t[r]),255);r=e}const e=r,l=A.createElement("canvas");l.height=s,l.width=i;const o=l.getContext("2d"),h=o.createImageData(i,s);h.data.set(new Uint8ClampedArray(e)),o.putImageData(h,0,0);const u=l.toDataURL();return l.remove(),Promise.resolve(u)}))}}class N{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={}}UUID_to_URL(t){return this.uuidMap[t]}UUID_to_URL_async(t){return Promise.resolve(null)}URL_to_UUID_async(t){return Promise.resolve(null)}resolveURL(t,e){if(t.startsWith("res://")){let r=t.substring(6);return N.inst.UUID_to_URL_async(r).then((t=>(e&&e(t),t)))}return e&&e(t),Promise.resolve(t)}shaderName_to_URL(t){return this.shaderNameMap[t]}shaderName_to_URL_async(t){return Promise.resolve(null)}getMeta(t,e){return Promise.resolve(null)}getSubAssetURL(t,e,r,i){return r?`${P.replaceFileExtension(t,"")}@${r}.${i}`:t}}N.inst=new N;class O{static __init__(){null==O.basePath&&(O.basePath=location&&null!=location.protocol&&""!=location.protocol?O.getPath(location.protocol+"//"+location.host+location.pathname):"")}static initMiniGameExtensionOverrides(){n.isPreview||(Object.assign(this.overrideFileExts,this.safeFileExtConversionMap),this.hasExtOverrides=!0,this.usingSafeFileExts=!0)}constructor(t){this._url=O.formatURL(t),this._path=O.getPath(t)}get url(){return this._url}get path(){return this._path}static get rootPath(){return O.basePaths["~/"]}static set rootPath(t){O.basePaths["~/"]=t}static formatURL(t,e){if(!t)return e||O.basePath||"";if(t.startsWith("res://")){let e=t.substring(6),r=N.inst.UUID_to_URL(e);if(!r)return t;t=r}if(-1==t.indexOf(":")&&47!==t.charCodeAt(0)){null!=O.customFormat&&(t=O.customFormat(t));let r=O.version[t];if(null!=r){let e=t.lastIndexOf(".");t=t.substring(0,e)+"-"+r+t.substring(e)}if(null==e){e=O.basePath;for(let r in O.basePaths)if(t.startsWith(r)){126===r.charCodeAt(0)&&(t=t.substring(r.length)),e=O.basePaths[r];break}}t=O.join(e,t)}return t}static postFormatURL(t){if(O.hasExtOverrides){let e=P.getFileExtension(t),r=O.overrideFileExts[e];null!=r&&(t=P.replaceFileExtension(t,r))}return t}static normalize(t){if(-1==t.indexOf("./"))return t;let e=t.split("/"),r=e.length,i=0;for(;i<r;)if("."!=e[i]){if(".."==e[i]){let t=i-1;if(t>=0&&".."!==e[t]){e.splice(t,2),r-=2,i--;continue}}i++}else e.splice(i,1),r--;return e.length=r,e.join("/")}static getResURLByUUID(t){return P.isUUID(t)?"res://"+t:t}static join(t,e){if(!e)return"";if(e.indexOf(":")>0)return e;if(t){let r=e.charCodeAt(0);126!==r&&47!==r&&(e=47!==t.charCodeAt(t.length-1)?t+"/"+e:t+e)}return O.normalize(e)}static getPath(t){var e=t.lastIndexOf("/");return e>0?t.substring(0,e+1):""}static getFileName(t){var e=t.lastIndexOf("/");return e>0?t.substring(e+1):t}static getURLVerion(t){var e=t.indexOf("?");return e>=0?t.substring(e):null}static overrideExtension(t,e,r){if(!r||O.usingSafeFileExts){for(let r of t)O.overrideFileExts[r]=e;O.hasExtOverrides=!0}else for(let r of t)O.safeFileExtConversionMap[r]=e}}O.version={},O.basePaths={},O.overrideFileExts={},O.hasExtOverrides=!1,O.usingSafeFileExts=!1,O.safeFileExtConversionMap={rendertexture:"rt.json",videotexture:"rt.json",controller:"controller.json",mc:"mc.bin",mcc:"mcc.json",shader:"shader.json",fui:"fui.json",glsl:"glsl.txt",skel:"skel.bin",lavm:"lavm.json"},O.customFormat=function(t){return t};class F{constructor(t=0,e=0,r=0,i=0){this.x=t,this.y=e,this.width=r,this.height=i}get right(){return this.x+this.width}get bottom(){return this.y+this.height}setTo(t,e,r,i){return this.x=t,this.y=e,this.width=r,this.height=i,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=F.TEMP&&this!=F.EMPTY&&r.recover("Rectangle",this.reset())}static create(){return r.getItemByClass("Rectangle",F)}copyFrom(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}contains(t,e){return!(this.width<=0||this.height<=0)&&(t>=this.x&&t<this.right&&e>=this.y&&e<this.bottom)}intersects(t){return!(t.x>this.x+this.width||t.x+t.width<this.x||t.y>this.y+this.height||t.y+t.height<this.y)}intersection(t,e=null){return this.intersects(t)?(e||(e=new F),e.x=Math.max(this.x,t.x),e.y=Math.max(this.y,t.y),e.width=Math.min(this.right,t.right)-e.x,e.height=Math.min(this.bottom,t.bottom)-e.y,e):null}union(t,e=null){return e||(e=new F),this.clone(e),t.width<=0||t.height<=0?e:(e.addPoint(t.x,t.y),e.addPoint(t.right,t.bottom),this)}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(t){return!(!t||t.x!==this.x||t.y!==this.y||t.width!==this.width||t.height!==this.height)}addPoint(t,e){return this.x>t&&(this.width+=this.x-t,this.x=t),this.y>e&&(this.height+=this.y-e,this.y=e),this.width<t-this.x&&(this.width=t-this.x),this.height<e-this.y&&(this.height=e-this.y),this}_getBoundPoints(){return U.length=0,0==this.width||0==this.height||U.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),U}static _getBoundPointS(t,e,r,i,s){return k.length=0,0==r||0==i||(s&&(t*=s.width,e*=s.height,r*=s.width,i*=s.height),k.push(t,e,t+r,e,t,e+i,t+r,e+i)),k}static _getWrapRec(t,e=null){if(!t||t.length<1)return e?e.setTo(0,0,0,0):F.TEMP.setTo(0,0,0,0);e=e||F.create();var r,s,a,n,l,o=t.length,h=i.TEMP;for(a=l=-(s=n=99999),r=0;r<o;r+=2)h.x=t[r],h.y=t[r+1],s=s<h.x?s:h.x,n=n<h.y?n:h.y,a=a>h.x?a:h.x,l=l>h.y?l:h.y;return e.setTo(s,n,a-s,l-n)}isEmpty(){return this.width<=0||this.height<=0}clone(t=null){return t||(t=new F),this.cloneTo(t),t}cloneTo(t){t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height}}F.EMPTY=new F,F.TEMP=new F;const U=[],k=[];class G{constructor(t=1,e=0,r=0,i=1,s=0,a=0,n=0){if(this._bTransform=!1,null!=G._createFun)return G._createFun(t,e,r,i,s,a,n);this.a=t,this.b=e,this.c=r,this.d=i,this.tx=s,this.ty=a,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(t,e){return this.tx=t,this.ty=e,this}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this._bTransform=!0,this}rotate(t){var e=Math.cos(t),r=Math.sin(t),i=this.a,s=this.c,a=this.tx;return this.a=i*e-this.b*r,this.b=i*r+this.b*e,this.c=s*e-this.d*r,this.d=s*r+this.d*e,this.tx=a*e-this.ty*r,this.ty=a*r+this.ty*e,this._bTransform=!0,this}skew(t,e){var r=Math.tan(t),i=Math.tan(e),s=this.a,a=this.b;return this.a+=i*this.c,this.b+=i*this.d,this.c+=r*s,this.d+=r*a,this}invertTransformPoint(t){var e=this.a,r=this.b,i=this.c,s=this.d,a=this.tx,n=e*s-r*i,l=s/n,o=-r/n,h=-i/n,u=e/n,d=(i*this.ty-s*a)/n,c=-(e*this.ty-r*a)/n;return t.setTo(l*t.x+h*t.y+d,o*t.x+u*t.y+c)}transformPoint(t){return t.setTo(this.a*t.x+this.c*t.y+this.tx,this.b*t.x+this.d*t.y+this.ty)}transformPointN(t){return t.setTo(this.a*t.x+this.c*t.y,this.b*t.x+this.d*t.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var t=this.a,e=this.b,r=this.c,i=this.d,s=this.tx,a=t*i-e*r;return this.a=i/a,this.b=-e/a,this.c=-r/a,this.d=t/a,this.tx=(r*this.ty-i*s)/a,this.ty=-(t*this.ty-e*s)/a,this}setTo(t,e,r,i,s,a){return this.a=t,this.b=e,this.c=r,this.d=i,this.tx=s,this.ty=a,this}concat(t){var e=this.a,r=this.c,i=this.tx;return this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,this.c=r*t.a+this.d*t.c,this.d=r*t.b+this.d*t.d,this.tx=i*t.a+this.ty*t.c+t.tx,this.ty=i*t.b+this.ty*t.d+t.ty,this}static mul(t,e,r){var i=t.a,s=t.b,a=t.c,n=t.d,l=t.tx,o=t.ty,h=e.a,u=e.b,d=e.c,c=e.d,_=e.tx,p=e.ty;return 0!==u||0!==d?(r.a=i*h+s*d,r.b=i*u+s*c,r.c=a*h+n*d,r.d=a*u+n*c,r.tx=h*l+d*o+_,r.ty=u*l+c*o+p):(r.a=i*h,r.b=s*c,r.c=a*h,r.d=n*c,r.tx=h*l+_,r.ty=c*o+p),r}static mul16(t,e,r){var i=t.a,s=t.b,a=t.c,n=t.d,l=t.tx,o=t.ty,h=e.a,u=e.b,d=e.c,c=e.d,_=e.tx,p=e.ty;return 0!==u||0!==d?(r[0]=i*h+s*d,r[1]=i*u+s*c,r[4]=a*h+n*d,r[5]=a*u+n*c,r[12]=h*l+d*o+_,r[13]=u*l+c*o+p):(r[0]=i*h,r[1]=s*c,r[4]=a*h,r[5]=n*c,r[12]=h*l+_,r[13]=c*o+p),r}scaleEx(t,e){var r=this.a,i=this.b,s=this.c,a=this.d;0!==i||0!==s?(this.a=t*r,this.b=t*i,this.c=e*s,this.d=e*a):(this.a=t*r,this.b=0*a,this.c=0*r,this.d=e*a),this._bTransform=!0}rotateEx(t){var e=Math.cos(t),r=Math.sin(t),i=this.a,s=this.b,a=this.c,n=this.d;0!==s||0!==a?(this.a=e*i+r*a,this.b=e*s+r*n,this.c=-r*i+e*a,this.d=-r*s+e*n):(this.a=e*i,this.b=r*n,this.c=-r*i,this.d=e*n),this._bTransform=!0}clone(){var t=G.create();return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t._bTransform=this._bTransform,t}copyTo(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t._bTransform=this._bTransform,t}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){r.recover("Matrix",this.identity())}static create(){return r.getItemByClass("Matrix",G)}}G.EMPTY=new G,G.TEMP=new G,G._createFun=null;class V extends Error{constructor(){super("Not implemented.")}}class H extends Error{constructor(t){super(`Index out of range: ${t}`)}}class z extends Error{constructor(){super("readable flag need to be true.")}}class W{static getSystemEndian(){if(!W._sysEndian){var t=new ArrayBuffer(2);new DataView(t).setInt16(0,256,!0),W._sysEndian=256===new Int16Array(t)[0]?W.LITTLE_ENDIAN:W.BIG_ENDIAN}return W._sysEndian}constructor(t=null){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,t?(this._u8d_=new Uint8Array(t),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}get buffer(){var t=this._d_.buffer;return t.byteLength===this._length?t:t.slice(0,this._length)}get endian(){return this._xd_?W.LITTLE_ENDIAN:W.BIG_ENDIAN}set endian(t){this._xd_=t===W.LITTLE_ENDIAN}set length(t){this._allocated_<t?this._resizeBuffer(this._allocated_=Math.floor(Math.max(t,2*this._allocated_))):this._allocated_>t&&this._resizeBuffer(this._allocated_=t),this._length=t}get length(){return this._length}_resizeBuffer(t){try{var e=new Uint8Array(t);null!=this._u8d_&&(this._u8d_.length<=t?e.set(this._u8d_):e.set(this._u8d_.subarray(0,t))),this._u8d_=e,this._d_=new DataView(e.buffer)}catch(e){throw"Invalid typed array length:"+t}}getString(){return this.readString()}readString(){return this._rUTF(this.getUint16())}getFloat32Array(t,e){return this.readFloat32Array(t,e)}readFloat32Array(t,e){var r=t+e;r=r>this._length?this._length:r;var i=new Float32Array(this._d_.buffer.slice(t,r));return this._pos_=r,i}getUint8Array(t,e){return this.readUint8Array(t,e)}readUint8Array(t,e){var r=t+e;r=r>this._length?this._length:r;var i=new Uint8Array(this._d_.buffer.slice(t,r));return this._pos_=r,i}getInt16Array(t,e){return this.readInt16Array(t,e)}readInt16Array(t,e){var r=t+e;r=r>this._length?this._length:r;var i=new Int16Array(this._d_.buffer.slice(t,r));return this._pos_=r,i}getFloat32(){return this.readFloat32()}readFloat32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var t=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,t}getFloat64(){return this.readFloat64()}readFloat64(){if(this._pos_+8>this._length)throw new H(this._pos_+8);var t=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,t}writeFloat32(t){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,t,this._xd_),this._pos_+=4}writeFloat64(t){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,t,this._xd_),this._pos_+=8}getInt32(){return this.readInt32()}readInt32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var t=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,t}getUint32(){return this.readUint32()}readUint32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var t=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,t}writeInt32(t){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,t,this._xd_),this._pos_+=4}writeUint32(t){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,t,this._xd_),this._pos_+=4}getInt16(){return this.readInt16()}readInt16(){if(this._pos_+2>this._length)throw new H(this._pos_+2);var t=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,t}getUint16(){return this.readUint16()}readUint16(){if(this._pos_+2>this._length)throw new H(this._pos_+2);var t=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,t}writeUint16(t){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,t,this._xd_),this._pos_+=2}writeInt16(t){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,t,this._xd_),this._pos_+=2}getUint8(){return this.readUint8()}readUint8(){if(this._pos_+1>this._length)throw new H(this._pos_+1);return this._u8d_[this._pos_++]}writeUint8(t){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,t),this._pos_++}_getUInt8(t){return this._readUInt8(t)}_readUInt8(t){return this._d_.getUint8(t)}_getUint16(t){return this._readUint16(t)}_readUint16(t){return this._d_.getUint16(t,this._xd_)}_getMatrix(){return this._readMatrix()}_readMatrix(){return new G(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}_rUTF(t){var e,r,i=this._pos_+t,s=String.fromCharCode,a=this._u8d_,n=[],l=0;for(n.length=1e3;this._pos_<i;)if((e=a[this._pos_++])<128)0!=e&&(n[l++]=s(e));else if(e<224)n[l++]=s((63&e)<<6|127&a[this._pos_++]);else if(e<240)r=a[this._pos_++],n[l++]=s((31&e)<<12|(127&r)<<6|127&a[this._pos_++]);else{const t=(15&e)<<18|(127&(r=a[this._pos_++]))<<12|(127&a[this._pos_++])<<6|127&a[this._pos_++];if(t>=65536){const e=t-65536,r=55296|e>>10,i=56320|1023&e;n[l++]=s(r),n[l++]=s(i)}else n[l++]=s(t)}return n.length=l,n.join("")}getCustomString(t){return this.readCustomString(t)}readCustomString(t){for(var e,r="",i=0,s=String.fromCharCode,a=this._u8d_;t>0;)if((e=a[this._pos_])<128)r+=s(e),this._pos_++,t--;else for(i=e-128,this._pos_++,t-=i;i>0;)e=a[this._pos_++],r+=s(a[this._pos_++]<<8|e),i--;return r}get pos(){return this._pos_}set pos(t){this._pos_=t}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}__getBuffer(){return this._d_.buffer}writeUTFBytes(t){for(var e=0,r=(t+="").length;e<r;e++){var i=t.charCodeAt(e);if(i<=127)this.writeByte(i);else if(i<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|i>>6,128|63&i],this._pos_),this._pos_+=2;else if(i>=55296&&i<=56319){e++;const r=t.charCodeAt(e);if(!Number.isNaN(r)&&r>=56320&&r<=57343){const t=64+(1023&i),e=1023&r,s=240|t>>8&63,a=128|t>>2&63,n=128|(3&t)<<4|e>>6&15,l=128|63&e;this._ensureWrite(this._pos_+4),this._u8d_.set([s,a,n,l],this._pos_),this._pos_+=4}}else i<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|i>>12,128|i>>6&63,128|63&i],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i],this._pos_),this._pos_+=4)}}writeUTFString(t){var e=this.pos;this.writeUint16(1),this.writeUTFBytes(t);var r=this.pos-e-2;this._d_.setUint16(e,r,this._xd_)}writeUTFString32(t){var e=this.pos;this.writeUint32(1),this.writeUTFBytes(t);var r=this.pos-e-4;this._d_.setUint32(e,r,this._xd_)}readUTFString(){return this.readUTFBytes(this.getUint16())}readUTFString32(){return this.readUTFBytes(this.getUint32())}getUTFString(){return this.readUTFString()}readUTFBytes(t=-1){if(0===t)return"";var e=this.bytesAvailable;if(t>e)throw new H(this._pos_+t);return t=t>0?t:e,this._rUTF(t)}getUTFBytes(t=-1){return this.readUTFBytes(t)}writeByte(t){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,t),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw new H(this._pos_+1);return this._d_.getInt8(this._pos_++)}getByte(){return this.readByte()}_ensureWrite(t){this._length<t&&(this._length=t),this._allocated_<t&&(this.length=t)}writeArrayBuffer(t,e=0,r=0){if(e<0||r<0)throw new H(e+r);0==r&&(r=t.byteLength-e),this._ensureWrite(this._pos_+r);var i=new Uint8Array(t);this._u8d_.set(i.subarray(e,e+r),this._pos_),this._pos_+=r}readArrayBuffer(t){var e;return e=this._u8d_.buffer.slice(this._pos_,this._pos_+t),this._pos_=this._pos_+t,e}}W.BIG_ENDIAN="bigEndian",W.LITTLE_ENDIAN="littleEndian",W._sysEndian=null;class Y{static __init__(){for(var t=0;t<256;++t){var e=t-127;e<-27?($[0|t]=0,$[256|t]=32768,K[0|t]=24,K[256|t]=24):e<-14?($[0|t]=1024>>-e-14,$[256|t]=1024>>-e-14|32768,K[0|t]=-e-1,K[256|t]=-e-1):e<=15?($[0|t]=e+15<<10,$[256|t]=e+15<<10|32768,K[0|t]=13,K[256|t]=13):e<128?($[0|t]=31744,$[256|t]=64512,K[0|t]=24,K[256|t]=24):($[0|t]=31744,$[256|t]=64512,K[0|t]=13,K[256|t]=13)}for(Q[0]=0,t=1;t<1024;++t){var r=t<<13;for(e=0;!(8388608&r);)e-=8388608,r<<=1;r&=-8388609,e+=947912704,Q[t]=r|e}for(t=1024;t<2048;++t)Q[t]=939524096+(t-1024<<13);for(Z[0]=0,t=1;t<31;++t)Z[t]=t<<23;for(Z[31]=1199570944,Z[32]=2147483648,t=33;t<63;++t)Z[t]=2147483648+(t-32<<23);for(Z[63]=3347054592,J[0]=0,t=1;t<64;++t)J[t]=32===t?0:1024}static roundToFloat16Bits(t){j[0]=t;var e=q[0],r=e>>23&511;return $[r]+((8388607&e)>>K[r])}static convertToNumber(t){var e=t>>10;return q[0]=Q[J[e]+(1023&t)]+Z[e],j[0]}}const X=new ArrayBuffer(4),j=new Float32Array(X),q=new Uint32Array(X),$=new Uint32Array(512),K=new Uint32Array(512),Q=new Uint32Array(2048),Z=new Uint32Array(64),J=new Uint32Array(64);var tt,et;t.FilterMode=void 0,(tt=t.FilterMode||(t.FilterMode={}))[tt.Point=0]="Point",tt[tt.Bilinear=1]="Bilinear",tt[tt.Trilinear=2]="Trilinear",t.RenderCapable=void 0,(et=t.RenderCapable||(t.RenderCapable={}))[et.Element_Index_Uint32=0]="Element_Index_Uint32",et[et.TextureFormat_R32G32B32A32=1]="TextureFormat_R32G32B32A32",et[et.TextureFormat_R16G16B16A16=2]="TextureFormat_R16G16B16A16",et[et.Texture_anisotropic=3]="Texture_anisotropic",et[et.RenderTextureFormat_R16G16B16A16=4]="RenderTextureFormat_R16G16B16A16",et[et.RenderTextureFormat_R32G32B32A32=5]="RenderTextureFormat_R32G32B32A32",et[et.RenderTextureFormat_Depth=6]="RenderTextureFormat_Depth",et[et.RenderTextureFormat_ShadowMap=7]="RenderTextureFormat_ShadowMap",et[et.Vertex_VAO=8]="Vertex_VAO",et[et.DrawElement_Instance=9]="DrawElement_Instance",et[et.Shader_TextureLod=10]="Shader_TextureLod",et[et.COMPRESS_TEXTURE_S3TC=11]="COMPRESS_TEXTURE_S3TC",et[et.COMPRESS_TEXTURE_S3TC_SRGB=12]="COMPRESS_TEXTURE_S3TC_SRGB",et[et.COMPRESS_TEXTURE_PVRTC=13]="COMPRESS_TEXTURE_PVRTC",et[et.COMPRESS_TEXTURE_ETC1=14]="COMPRESS_TEXTURE_ETC1",et[et.COMPRESS_TEXTURE_ETC=15]="COMPRESS_TEXTURE_ETC",et[et.COMPRESS_TEXTURE_ASTC=16]="COMPRESS_TEXTURE_ASTC",et[et.Texture_SRGB=17]="Texture_SRGB",et[et.MSAA=18]="MSAA",et[et.UnifromBufferObject=19]="UnifromBufferObject",et[et.Texture3D=20]="Texture3D",et[et.Texture_FloatLinearFiltering=21]="Texture_FloatLinearFiltering",et[et.Texture_HalfFloatLinearFiltering=22]="Texture_HalfFloatLinearFiltering";const rt=827611204,it=861165636,st=877942852,at=894720068,nt=131072;class lt{constructor(t,e,r,i,s,a,n,l,o,h){this.width=t,this.height=e,this.mipmapCount=r,this.isCube=i,this.blockBytes=a,this.dataOffset=n,this.format=l,this.source=h,this.bpp=s,this.compressed=o}static getDDSTextureInfo(e){let r=new Int32Array(e,0,31),i=r[4],s=r[3],a=1;131072&r[2]&&(a=Math.max(1,r[7]));let n=r[21],o=!(4&~r[20]),h=!(64&~r[20]),u=(r[20]&nt)===nt,d=!(512&~r[28]),c=n===rt||n===it||n===at||n===st,_=t.TextureFormat.DXT1,p=r[1]+4,f=1;switch(n){case rt:_=t.TextureFormat.DXT1,f=8;break;case it:_=t.TextureFormat.DXT3,f=16;break;case st:case at:_=t.TextureFormat.DXT5,f=16;break;case 113:_=t.TextureFormat.R16G16B16A16,f=4;break;case 116:_=t.TextureFormat.R32G32B32A32,f=4;break;default:throw"Unsupported format "+(g=n,String.fromCharCode(255&g,g>>8&255,g>>16&255,g>>24&255))}var g;if(542327876!==r[0])throw"Invalid magic number in DDS header";if(!o&&!h&&!u)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let m=l.renderEngine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC)||l.renderEngine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(c&&!m)throw"Compressed textures are not supported on this platform.";return new lt(i,s,a,d,0,f,p,_,c,e)}}const ot=6408,ht=6407,ut=5121;class dt{static getLayaFormat(e,r,i,s){if(0!=e){if(e==ot&&32856==r&&i==ut)return{format:t.TextureFormat.R8G8B8A8,sRGB:!1};if(e==ot&&35907==r&&i==ut)return{format:t.TextureFormat.R8G8B8A8,sRGB:!0};if(e==ot&&34836==r&&5126==i)return{format:t.TextureFormat.R32G32B32A32,sRGB:!1};if(e==ot&&34842==r&&5131==i)return{format:t.TextureFormat.R16G16B16A16,sRGB:!1};if(e==ht&&34837==r&&5126==i)return{format:t.TextureFormat.R32G32B32,sRGB:!1};if(e==ht&&34843==r&&5131==i)return{format:t.TextureFormat.R16G16B16,sRGB:!1};if(e==ht&&35905==r&&i==ut)return{format:t.TextureFormat.R8G8B8,sRGB:!0};if(e==ht&&32849==r&&i==ut)return{format:t.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(r){case 36196:return{format:t.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:t.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:t.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:t.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:t.TextureFormat.ETC2SRGB,sRGB:!0};case 37494:return{format:t.TextureFormat.ETC2RGB_Alpha1,sRGB:!1};case 37495:return{format:t.TextureFormat.ETC2SRGB_Alpha1,sRGB:!0};case 37808:return{format:t.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:t.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:t.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:t.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:t.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:t.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:t.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:t.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:t.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:t.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(t){let e=new Uint8Array(t,0,12);if(171===e[0]&&75===e[1]&&84===e[2]&&88===e[3]&&32===e[4]&&50===e[5]&&48===e[6]&&187===e[7]&&13===e[8]&&10===e[9]&&26===e[10]&&10===e[11])throw"ktx2 !";if(171===e[0]&&75===e[1]&&84===e[2]&&88===e[3]&&32===e[4]&&49===e[5]&&49===e[6]&&187===e[7]&&13===e[8]&&10===e[9]&&26===e[10]&&10===e[11])return dt.createKTX1Info(t);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(e){let r=Uint32Array.BYTES_PER_ELEMENT,i=new DataView(e,12,13*r),s=67305985==i.getUint32(0,!0),a=i.getUint32(1*r,s),n=i.getUint32(2*r,s),l=i.getUint32(3*r,s),o=i.getUint32(4*r,s);i.getUint32(5*r,s);let h=i.getUint32(6*r,s),u=i.getUint32(7*r,s);i.getUint32(8*r,s);let d=i.getUint32(9*r,s),c=i.getUint32(10*r,s),_=i.getUint32(11*r,s),p=i.getUint32(12*r,s),f=dt.getLayaFormat(l,o,a,n),g=f.format,m=f.sRGB,y=t.TextureDimension.Tex2D;c>1&&d>1?y=t.TextureDimension.CubeArray:c>1&&d<=1?y=t.TextureDimension.Cube:c<=1&&d>1&&(y=t.TextureDimension.Texture2DArray);return new dt(e,0==l,m,y,h,u,g,_||1,p,64)}constructor(t,e,r,i,s,a,n,l,o,h){this.source=t,this.compress=e,this.sRGB=r,this.dimension=i,this.width=s,this.height=a,this.format=n,this.mipmapCount=l,this.bytesOfKeyValueData=o,this.headerOffset=h}}class ct extends R{static __init__(){var e=new Uint8Array(4);if(e[0]=128,e[1]=128,e[2]=128,e[3]=255,ct.grayTexture=new ct(1,1,t.TextureFormat.R8G8B8A8,!1,!1),ct.grayTexture.setPixelsData(e,!1,!1),ct.grayTexture.lock=!0,ct.grayTexture.name="Default_Gray",e[0]=255,e[1]=255,e[2]=255,e[3]=255,ct.whiteTexture=new ct(1,1,t.TextureFormat.R8G8B8A8,!1,!1),ct.whiteTexture.setPixelsData(e,!1,!1),ct.whiteTexture.lock=!0,ct.whiteTexture.name="Default_White",e[0]=0,e[1]=0,e[2]=0,e[3]=255,ct.blackTexture=new ct(1,1,t.TextureFormat.R8G8B8A8,!1,!1),ct.blackTexture.setPixelsData(e,!1,!1),ct.blackTexture.lock=!0,ct.blackTexture.name="Default_Black",l.renderEngine.getCapable(t.RenderCapable.TextureFormat_R16G16B16A16)){let e=new Uint16Array(4);e[0]=14336,e[1]=14336,e[2]=15360,e[3]=15360,ct.normalTexture=new ct(1,1,t.TextureFormat.R16G16B16A16,!1,!1,!1),ct.normalTexture.setPixelsData(e,!1,!1)}else e[0]=128,e[1]=128,e[2]=255,e[3]=255,ct.normalTexture=new ct(1,1,t.TextureFormat.R8G8B8A8,!1,!1,!1),ct.normalTexture.setPixelsData(e,!1,!1);ct.normalTexture.lock=!0,ct.normalTexture.name="Default_Normal",ct.errorTexture=ct.whiteTexture}static _SimpleAnimatorTextureParse(e,r=null,i=null){var s,a,n=new W(e);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var o,h=n.readInt32(),u=n.readInt32();s=new Float32Array(h*h*4),a=new Float32Array(n.readArrayBuffer(4*u)),s.set(a,0),(o=new ct(h,h,t.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(s,!1,!1),o.filterMode=t.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":h=n.readInt32(),u=n.readInt32();if(s=new Uint16Array(n.readArrayBuffer(2*u)),l.renderEngine.getCapable(t.RenderCapable.TextureFormat_R16G16B16A16))(a=new Uint16Array(h*h*4)).set(s,0),(o=new ct(h,h,t.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=t.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),l.renderEngine.getCapable(t.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),a=new Float32Array(h*h*4);for(var d=0,c=s.length;d<c;d++)a[d]=Y.convertToNumber(s[d]);(o=new ct(h,h,t.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=t.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return o}static _parseImage(r,i=null,s=null){let a=s?s[2]:t.TextureFormat.R8G8B8A8,l=!s||s[3],o=!!s&&s[4],h=!!s&&s[5],u=!!i&&i.premultiplyAlpha,d=new ct(r.width,r.height,a,l,o,h,u);return i?(d.setImageData(r,u,!1),d.setProperties(i)):d.setImageData(r,!1,!1),o&&(n.isConch&&r._nativeObj?d._pixels=new Uint8Array(r._nativeObj.getImageData(0,0,r.width,r.height)):(e.Browser.canvas.size(r.width,r.height),e.Browser.canvas.clear(),e.Browser.context.drawImage(r,0,0,r.width,r.height),d._pixels=new Uint8Array(e.Browser.context.getImageData(0,0,r.width,r.height).data.buffer))),d}static _parseDDS(t,e=null,r=null){let i=lt.getDDSTextureInfo(t),s=r[5],a=new ct(i.width,i.height,i.format,i.mipmapCount>1,!1,s);return a.setDDSData(i),e&&a.setProperties(e),a}static _parseKTX(t,e=null,r=null){let i=dt.getKTXTextureInfo(t),s=new ct(i.width,i.height,i.format,i.mipmapCount>1,!1,i.sRGB);return s.setKTXData(i),e&&s.setProperties(e),s}static _parsePVR(t,e=null,r=null){throw"pvr !"}static load(t,r){e.loader.load(t,r,null,e.Loader.TEXTURE2D)}constructor(e,r,i,s=!0,a,n=!1,o=!1){super(e,r,i),this._canRead=!1,this._premultiplyAlpha=!1,this._dimension=t.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=a,this._premultiplyAlpha=o,this._texture=l.textureContext.createTextureInternal(this._dimension,e,r,i,s,n,o)}setImageData(t,e,r){let i=this._texture;l.textureContext.setTextureImageData(i,t,e,r)}setPixelsData(t,e,r){let i=this._texture;l.textureContext.setTexturePixelsData(i,t,e,r)}setSubPixelsData(t,e,r,i,s,a,n,o,h){let u=this._texture;l.textureContext.setTextureSubPixelsData(u,s,a,n,t,e,r,i,o,h)}setDDSData(t){let e=this._texture;l.textureContext.setTextureDDSData(e,t)}setKTXData(t){let e=this._texture;l.textureContext.setTextureKTXData(e,t)}setHDRData(t){let e=this._texture;l.textureContext.setTextureHDRData(e,t)}get defaultTexture(){return ct.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(t){t&&(null!=t.wrapModeU&&(this.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(this.wrapModeV=t.wrapModeV),null!=t.filterMode&&(this.filterMode=t.filterMode),null!=t.anisoLevel&&(this.anisoLevel=t.anisoLevel))}}ct.TEXTURE2D="TEXTURE2D",ct.grayTexture=null,ct.whiteTexture=null,ct.blackTexture=null,ct.normalTexture=null,ct.errorTexture=null;class _t{static gammaToLinearSpace(t){return t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)}static linearToGammaSpace(t){return t<=0?0:t<=.0031308?12.92*t:t<=1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)}constructor(t=1,e=1,r=1,i=1){this.r=t,this.g=e,this.b=r,this.a=i}equal(t){if(!t)return!1;const e=(t,e)=>{var r=1e-5;return-r<t-e&&t-e<r};return e(t.r,this.r)&&e(t.g,this.g)&&e(t.b,this.b)&&e(t.a,this.a)}toLinear(t){t.r=_t.gammaToLinearSpace(this.r),t.g=_t.gammaToLinearSpace(this.g),t.b=_t.gammaToLinearSpace(this.b),t.a=this.a}toGamma(t){t.r=_t.linearToGammaSpace(this.r),t.g=_t.linearToGammaSpace(this.g),t.b=_t.linearToGammaSpace(this.b),t.a=this.a}cloneTo(t){t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}scale(t){return this.r=this.r*t,this.g=this.g*t,this.b=this.b*t,this}setValue(t,e,r,i){this.r=t,this.g=e,this.b=r,this.a=i}fromArray(t,e=0){this.r=t[e+0],this.g=t[e+1],this.b=t[e+2],this.a=t[e+3]}toArray(){return[this.r,this.g,this.b,this.a]}clone(){var t=new _t;return this.cloneTo(t),t}}_t.RED=new _t(1,0,0,1),_t.GREEN=new _t(0,1,0,1),_t.BLUE=new _t(0,0,1,1),_t.CYAN=new _t(0,1,1,1),_t.YELLOW=new _t(1,.92,.016,1),_t.MAGENTA=new _t(1,0,1,1),_t.GRAY=new _t(.5,.5,.5,1),_t.WHITE=new _t(1,1,1,1),_t.BLACK=new _t(0,0,0,1),_t.CLEAR=new _t(0,0,0,0);class pt extends R{static get currentActive(){return pt._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return ct.grayTexture}getIsReady(){return!0}getColorFormat(){return this._colorFormat}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(e,r,i=t.RenderTargetFormat.R8G8B8,s=t.RenderTargetFormat.None){super(e,r,i),this._mgrKey=0,this._invertY=!1,this._colorFormat=i,this._depthStencilFormat=s,0!=e&&0!=r&&this._create(),this.lock=!0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new V}_end(){throw new V}_create(){this._renderTarget=l.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!1,1),this._texture=this._renderTarget._textures[0],this._texture.gammaCorrection=2.2}clear(t=0,e=0,r=0,i=1){pt._clearColor.r=t,pt._clearColor.g=e,pt._clearColor.b=r,pt._clearColor.a=i,pt._clear=!0}getData(e,r,i,s){const a=i*s*4;let n;switch(this._renderTarget.colorFormat){case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:n=new Uint8Array(a);break;case t.RenderTargetFormat.R16G16B16A16:n=new Float32Array(a);break;default:throw"this function is not surpprt "+this._renderTarget.colorFormat.toString()+"format Material"}return l.textureContext.readRenderTargetPixelData(this._renderTarget,e,r,i,s,n),n}getDataAsync(t,e,r,i,s){return l.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,t,e,r,i,s)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}pt._clearColor=new _t(0,0,0,0),pt._clear=!1,pt._clearLinearColor=new _t,pt.defuv=[0,0,1,0,1,1,0,1],pt.flipyuv=[0,1,1,1,1,0,0,0];const ft=new F,gt=new F;class mt extends b{static create(t,e,r,i,s,a=0,n=0,l=0,o=0){return mt._create(t,e,r,i,s,a,n,l,o)}static _create(t,e,r,i,s,a=0,n=0,l=0,o=0,h=null){var u,d=t instanceof mt,c=d?t.uv:mt.DEF_UV,_=d?t.bitmap:t;_.width&&e+i>_.width&&(i=_.width-e),_.height&&r+s>_.height&&(s=_.height-r),h?(u=h).setTo(_,null,l||i,o||s):u=new mt(_,null,l||i,o||s),u.width=i,u.height=s,u.offsetX=a,u.offsetY=n;var p=1/_.width,f=1/_.height;e*=p,r*=f,i*=p,s*=f;var g=u.uv[0],m=u.uv[1],y=u.uv[4],T=u.uv[5],x=y-g,v=T-m,S=function(t,e,r){for(var i=0;i<8;i+=2)r[i]+=t,r[i+1]+=e;return r}(c[0],c[1],[e,r,e+i,r,e+i,r+s,e,r+s]);u.uv=new Float32Array([g+S[0]*x,m+S[1]*v,y-(1-S[2])*x,m+S[3]*v,y-(1-S[4])*x,T-(1-S[5])*v,g+S[6]*x,T-(1-S[7])*v]);var E=t.scaleRate;return E&&1!=E?(u.sourceWidth/=E,u.sourceHeight/=E,u.width/=E,u.height/=E,u.scaleRate=E,u.offsetX/=E,u.offsetY/=E):u.scaleRate=1,u}static createFromTexture(t,e,r,i,s){var a=t.scaleRate;1!=a&&(e*=a,r*=a,i*=a,s*=a);var n=F.TEMP.setTo(e-t.offsetX,r-t.offsetY,i,s),l=n.intersection(ft.setTo(0,0,t.width,t.height),gt);return l?mt.create(t,l.x,l.y,l.width,l.height,l.x-n.x,l.y-n.y,i,s):null}get uv(){return this._uv}set uv(t){this.uvrect[0]=Math.min(t[0],t[2],t[4],t[6]),this.uvrect[1]=Math.min(t[1],t[3],t[5],t[7]),this.uvrect[2]=Math.max(t[0],t[2],t[4],t[6])-this.uvrect[0],this.uvrect[3]=Math.max(t[1],t[3],t[5],t[7])-this.uvrect[1],this._uv=t}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==mt.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(t){this._w=t,this.sourceWidth||(this.sourceWidth=t)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==mt.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(t){this._h=t,this.sourceHeight||(this.sourceHeight=t)}get bitmap(){return this._bitmap}set bitmap(t){this._bitmap!=t&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=t,t&&t._addReference(this._referenceCount))}constructor(t=null,e=null,r=0,i=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let s=t instanceof mt?t.bitmap:t;this.setTo(s,e,r,i)}_addReference(t=1){var e,r;super._addReference(t),null===(e=this._bitmap)||void 0===e||e._addReference(t),null===(r=this._atlas)||void 0===r||r._addReference(t)}_removeReference(t=1){var e,r;null===(e=this._bitmap)||void 0===e||e._removeReference(t),null===(r=this._atlas)||void 0===r||r._removeReference(t),super._removeReference(t)}_getSource(t=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(t),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(t=null,e=null,r=0,i=0){this.bitmap=t,this.sourceWidth=r,this.sourceHeight=i,t&&(this._w=t.width,this._h=t.height,this.sourceWidth=this.sourceWidth||t.width,this.sourceHeight=this.sourceHeight||t.height),this.uv=e||mt.DEF_UV}load(t,r){return this._destroyed?Promise.resolve():e.loader.load(t).then((t=>{let e=t.bitmap;this.bitmap=e,this.sourceWidth=this._w=e.width,this.sourceHeight=this._h=e.height,r&&r.run(),this.event(s.READY,this)}))}getTexturePixels(r,i,s,a){var n,l,o,h=this.bitmap,u=this._w,d=this._h,c=this.sourceWidth,_=this.sourceHeight,p=h.width,f=h.height,g=this.offsetX,m=this.offsetY;let y=s,T=a;if(r+s>u+g&&(y-=r+s-u-g),r+s>c&&(s-=r+s-c),i+a>d+m&&(T-=i+a-d-m),i+a>_&&(a-=i+a-_),s<=0||a<=0)return null;let x=g>r?g-r:0,v=m>i?m-i:0,S=r>g?r-g:0,E=i>m?i-m:0;y-=x,T-=v;var w=4*s,D=null;try{D=h.getPixels()}catch(t){}if(D){if(0==r&&0==i&&s==p&&a==f)return D;let t=this._uv.slice(),e=Math.round(t[0]*p),h=Math.round(t[1]*f);var b=new Uint8Array(s*a*4);for(n=4*e+4*S+(l=(h+E)*(w=4*p)),o=0;o<T;o++)b.set(D.slice(n,n+4*y),4*s*(o+v)+4*x),n+=w;return b}var R=new e.Context;R.size(s,a);let C=new pt(s,a,t.RenderTargetFormat.R8G8B8A8);R.render2D=R.render2D.clone(C);var A=null;if(0!=r||0!=i||s!=p||a!=f){var I=(A=this._uv.slice())[0],M=A[1],B=(A[2]-I)/u,L=(A[7]-M)/d;A=[I+S*B,M+E*L,I+(S+y)*B,M+E*L,I+(S+y)*B,M+(E+T)*L,I+S*B,M+(E+T)*L]}R.startRender(),R._drawTextureM(this,x,v,y,T,null,1,A,4294967295),R.endRender();var P=C.getData(0,0,s,a);for(R.destroy(),C.destroy(),b=new Uint8Array(s*a*4),n=0,l=(a-1)*w,o=a-1;o>=0;o--)b.set(P.slice(l,l+w),n),n+=w,l-=w;return b}getPixels(t,e,r,i){return this.getTexturePixels(t,e,r,i)}recoverBitmap(t){var r=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!r||e.loader.load(r).then((e=>{this.bitmap=e.bitmap,t&&t()}))}disposeBitmap(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(t){this._obsolute=t}_disposeResource(){let t=this._bitmap;this._bitmap=null,t&&t._removeReference(this._referenceCount);let e=this._atlas;this._atlas=null,e&&e._removeReference(this._referenceCount)}getCachedClip(t,e,r,i){if(this.destroyed)return null;let s=`${t}_${e}_${r}_${i}`;this._clipCache||(this._clipCache=new Map);let a=this._clipCache.get(s);return a||(a=mt.createFromTexture(this,t,e,r,i),a&&(a._sizeGrid=this._sizeGrid),this._clipCache.size>100&&this._clipCache.clear(),this._clipCache.set(s,a),a)}}mt.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),mt.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),mt.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]);class yt{static enable(t,r=null){e.loader.fetch(t,"json").then((t=>{t&&(yt.addAtlases(t),r&&r.run())}))}static addAtlases(t){let e=yt._fileLoadDic;for(let r in t){let i=t[r],s=O.formatURL(i[0]),a=i[1],n=a.length,l={url:r};for(let t=0;t<n;t++)e[s+a[t]]=l}}static addAtlas(t,e,r){e=O.formatURL(e);let i=yt._fileLoadDic,s={url:t};for(let t of r)i[e+t]=s}static getFileLoadPath(t){return yt._fileLoadDic[t]}}yt._fileLoadDic={};class Tt{static workerSupported(){return!!Worker}static get enable(){return Tt._enable}static set enable(t){if(Tt._enable!=t){if(t){if(!Worker)return;Tt._worker||(Tt._worker=new Worker(g.workerLoaderLib||Tt.workerPath),Tt._worker.onmessage=Tt.workerMessage,Tt._dispatcher=new v)}Tt._enable=t}}static load(t,e){return new Promise(((r,i)=>{Tt._worker.postMessage({url:t,options:e}),Tt._dispatcher.once(t,(t=>{t.imageBitmap?r(t.imageBitmap):i(t.msg)}))}))}static workerMessage(t){let e=t.data;if(e)switch(e.type){case"Image":Tt._dispatcher.event(e.url,e);break;case"Disable":Tt.enable=!1}}}Tt.workerPath="libs/laya.workerloader.js",Tt._enable=!1;class xt extends b{constructor(t,e,r){super(),this.dir=t,this.textures=e,this.frames=r;for(let t of r)t._addReference(),t._atlas=this;for(let t of e)t._addReference(),t._atlas=this}_disposeResource(){for(let t of this.textures)t._atlas=null,t._removeReference();for(let t of this.frames)t._atlas=null,t._removeReference();this.frames.length=0,this.textures.length=0}}class vt{constructor(t){this._callback=t,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(t){let e=this._items.length;return this._items.push(0),null==t?this._weights.push(null):this._weights.push(Math.max(0,Math.min(t,1))),t=>this.update(e,t)}update(t,e){if(-1!=t){this._items[t]=Math.max(0,Math.min(e,1));let r=0,i=this._items,s=this._weights,a=1/i.length;for(let t=0;t<i.length;t++){let e=i[t],n=s[t];null!=e&&(r+=e*(null!=n?n:a))}(e=r)>1&&(e=1)}e>this._progress&&(this._progress=e,this._callback(e))}}class St{constructor(t=null,e=null,r=null,i=!1){this.once=!1,this._id=0,this.setTo(t,e,r,i)}setTo(t,e,r,i=!1){return this._id=St._gid++,this.caller=t,this.method=e,this.args=r,this.once=i,this}run(){if(null==this.method)return null;var t=this._id,e=this.method.apply(this.caller,this.args);return this._id===t&&this.once&&this.recover(),e}runWith(t){if(null==this.method)return null;var e=this._id;if(null==t)var r=this.method.apply(this.caller,this.args);else r=this.args||t.unshift?this.args?this.method.apply(this.caller,this.args.concat(t)):this.method.apply(this.caller,t):this.method.call(this.caller,t);return this._id===e&&this.once&&this.recover(),r}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,St._pool.push(this.clear()))}static create(t,e,r=null,i=!0){return St._pool.length?St._pool.pop().setTo(t,e,r,i):new St(t,e,r,i)}}St._pool=[],St._gid=1;class Et{static compareVersion(t,e){let r=t.split("."),i=e.split(".");const s=Math.max(r.length,i.length);for(;r.length<s;)r.push("0");for(;i.length<s;)i.push("0");for(let t=0;t<s;t++){const e=parseInt(r[t]),s=parseInt(i[t]);if(e>s)return!0;if(e<s)return!1}return!0}static get isSupport(){if(A._isMiniGame){var t=A.window.wx.getSystemInfoSync().SDKVersion;return Et.compareVersion(t,"2.14.0")}return!!A.onLayaRuntime||!!A.window.Blob&&!!A.window.Blob}static arrayBufferToURL(t,e){if(!Et.isSupport)return t;if(Et.data[t])return Et.data[t];var r="";if(A._isMiniGame||A.onLayaRuntime)r=A.window.wx.createBufferURL(e);else if(A.window.Blob){let t=new Blob([e],{type:"application/octet-binary"});r=A.window.URL.createObjectURL(t)}return Et.isSavaData&&(Et.data[t]=r),r}static _arrayBufferToURL(t){if(!Et.isSupport)return null;var e="";if(A._isMiniGame||A.onLayaRuntime)e=A.window.wx.createBufferURL(t);else if(A.window.Blob){let r=new Blob([t],{type:"application/octet-binary"});e=A.window.URL.createObjectURL(r)}return e}static destroy(t){if(Et.isSupport){var e=Et.data[t];e&&(A._isMiniGame||A.onLayaRuntime?A.window.wx.revokeBufferURL(e):A.window.Blob&&A.window.URL.revokeObjectURL(e),delete Et.data[t])}}}Et.data={},Et.isSavaData=!1;class wt{static decodeString(t){let e=t.length,r="",i=0,s=0;for(;;){if(s=t.indexOf("&",i),-1==s){r+=t.substring(i);break}r+=t.substring(i,s),i=s+1,s=i;let a=Math.min(e,s+10);for(;s<a&&";"!=t[s];s++);if(s<a&&s>i){let e=t.substring(i,s),a=0;if("#"==e[0])e.length>1?(a="x"==e[1]?parseInt(e.substring(2),16):parseInt(e.substring(1)),r+=String.fromCharCode(a),i=s+1):r+="&";else{switch(e){case"amp":a=38;break;case"apos":a=39;break;case"gt":a=62;break;case"lt":a=60;break;case"nbsp":a=32;break;case"quot":a=34}a>0?(r+=String.fromCharCode(a),i=s+1):r+="&"}}else r+="&"}return r}static encodeString(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}static getString(t,e,r){if(null==t)return null==r?null:r;let i=t[e];return null!=i?""+i:null==r?null:r}static getInt(t,e,r){let i=this.getString(t,e);if(null!=i&&i.length>0)if("%"==i[i.length-1]){let t=parseInt(i.substring(0,i.length-1));if(!isNaN(t))return Math.ceil(t/100*r)}else{let t=parseInt(i);if(!isNaN(t))return t}return null==r?0:r}static getFloat(t,e,r){let i=this.getString(t,e);if(null==i||0==i.length)return null==r?0:r;let s=parseFloat(i);return isNaN(s)?null==r?0:r:s}static getBool(t,e,r){let i=this.getString(t,e);return null==i||0==i.length?null!=r&&r:"true"==i||"1"==i||"false"!=i&&"0"!=i&&(null!=r&&r)}}var Dt;t.XMLTagType=void 0,(Dt=t.XMLTagType||(t.XMLTagType={}))[Dt.Start=0]="Start",Dt[Dt.End=1]="End",Dt[Dt.Void=2]="Void",Dt[Dt.CDATA=3]="CDATA",Dt[Dt.Comment=4]="Comment",Dt[Dt.Instruction=5]="Instruction";class bt{static begin(t,e){bt.source=t,bt.lowerCaseName=e,this.sourceLen=t.length,this.parsePos=0,this.lastTagEnd=0,this.tagPos=0,this.tagLength=0,this.tagName=null}static nextTag(){let e,r,i="";for(this.tagType=t.XMLTagType.Start,this.lastTagEnd=this.parsePos,this.attrParsed=!1,this.lastTagName=this.tagName;-1!=(e=this.source.indexOf("<",this.parsePos))&&(this.parsePos=e,e++,e!=this.sourceLen);){if(r=this.source[e],"!"==r){if(this.sourceLen>e+7&&"<![CDATA["==this.source.substring(e-1,e+8))return e=this.source.indexOf("]]>",e),this.tagType=t.XMLTagType.CDATA,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==e?this.sourceLen-this.parsePos:e+3-this.parsePos,this.parsePos+=this.tagLength,!0;if(this.sourceLen>e+2&&"\x3c!--"==this.source.substring(e-1,e+3))return e=this.source.indexOf("--\x3e",e),this.tagType=t.XMLTagType.Comment,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==e?this.sourceLen-this.parsePos:e+3-this.parsePos,this.parsePos+=this.tagLength,!0;e++,this.tagType=t.XMLTagType.Instruction}else"/"==r?(e++,this.tagType=t.XMLTagType.End):"?"==r&&(e++,this.tagType=t.XMLTagType.Instruction);for(;e<this.sourceLen&&(r=this.source[e],-1==" \t\n\r\v".indexOf(r)&&">"!=r&&"/"!=r);e++);if(e==this.sourceLen)break;i+=this.source.substring(this.parsePos+1,e),i.length>0&&"/"==i[0]&&(i=i.substring(1));let s=!1,a=!1,n=-1;for(;e<this.sourceLen;e++)if(r=this.source[e],'"'==r?s||(a=!a):"'"==r&&(a||(s=!s)),">"==r){if(!s&&!a){n=-1;break}n=e}else if("<"==r)break;if(-1!=n&&(e=n),e==this.sourceLen)break;return"/"==this.source[e-1]&&(this.tagType=t.XMLTagType.Void),this.tagName=i,this.lowerCaseName&&(this.tagName=this.tagName.toLowerCase()),this.tagPos=this.parsePos,this.tagLength=e+1-this.parsePos,this.parsePos+=this.tagLength,!0}return this.tagPos=this.sourceLen,this.tagLength=0,this.tagName=null,!1}static getTagSource(){return this.source.substring(this.tagPos,this.tagPos+this.tagLength)}static getRawText(t){if(this.lastTagEnd==this.tagPos)return"";if(t){let t=this.lastTagEnd;for(;t<this.tagPos;t++){let e=this.source[t];if(-1==" \t\n\r\v".indexOf(e))break}return t==this.tagPos?"":this.source.substring(t,this.tagPos).trim()}return this.source.substring(this.lastTagEnd,this.tagPos)}static getText(t){if(this.lastTagEnd==this.tagPos)return"";if(t){let t=this.lastTagEnd;for(;t<this.tagPos;t++){let e=this.source[t];if(-1==" \t\n\r\v".indexOf(e))break}return t==this.tagPos?"":wt.decodeString(this.source.substring(t,this.tagPos)).trimEnd()}return wt.decodeString(this.source.substring(this.lastTagEnd,this.tagPos))}static get attributes(){if(!this.attrParsed){for(let t in this._attrs)delete this._attrs[t];this.parseAttributes(this._attrs),this.attrParsed=!0}return this._attrs}static getAttribute(t){return this.attributes[t]}static parseAttributes(t){let e,r=0,i=0,s=!1,a=0,n="",l=this.tagPos,o=this.tagPos+this.tagLength;if(l<o&&"<"==this.source[l])for(;l<o;l++){let t=this.source[l];if(-1!=" \t\n\r\v".indexOf(t)||">"==t||"/"==t)break}for(;l<o;l++){let h=this.source[l];if("="==h){r=-1,i=-1,a=0;for(let t=l+1;t<o;t++){let e=this.source[t];if(-1!=" \t\n\r\v".indexOf(e)){if(-1!=r&&0==a){i=t-1;break}}else if(">"==e){if(0==a){i=t-1;break}}else if('"'==e)if(-1!=r){if(1!=a){i=t-1;break}}else a=2,r=t+1;else if("'"==e)if(-1!=r){if(2!=a){i=t-1;break}}else a=1,r=t+1;else-1==r&&(r=t)}if(-1==r||-1==i)break;e=n,this.lowerCaseName&&(e=e.toLowerCase()),n="",t[e]=wt.decodeString(this.source.substring(r,i+1)),l=i+1}else-1==" \t\n\r\v".indexOf(h)?((s||"/"==h||">"==h)&&(n.length>0&&(e=n,this.lowerCaseName&&(e=e.toLowerCase()),t[e]="",n=""),s=!1),"/"!=h&&">"!=h&&(n+=h)):n.length>0&&(s=!0)}}}bt._attrs={},String.prototype.trimEnd||(String.prototype.trimEnd=function(){return this.replace(/\s+$/g,"")});class Rt{constructor(t){t&&this.parse(t)}get attributes(){return this._attrs||(this._attrs={}),this._attrs}getAttrString(t,e){return wt.getString(this._attrs,t,e)}getAttrInt(t,e){return wt.getInt(this._attrs,t,e)}getAttrFloat(t,e){return wt.getFloat(this._attrs,t,e)}getAttrBool(t,e){return wt.getBool(this._attrs,t,e)}setAttribute(t,e){this._attrs||(this._attrs={}),this._attrs[t]=e}getNode(t){return this._children?this._children.find((e=>e.name==t)):null}elements(t){return this._children||(this._children=new Array),t?this._children.filter((e=>e.name==t)):this._children}parse(e){let r;this.reset();let i=new Array;for(bt.begin(e);bt.nextTag();)if(bt.tagType==t.XMLTagType.Start||bt.tagType==t.XMLTagType.Void){let e;if(r)e=new Rt;else{if(null!=this.name)throw this.reset(),new Error("Invalid xml format - no root node.");e=this}e.name=bt.tagName,e._attrs=Object.assign({},bt.attributes),r&&(bt.tagType!=t.XMLTagType.Void&&i.push(r),null==r._children&&(r._children=new Array),r._children.push(e)),bt.tagType!=t.XMLTagType.Void&&(r=e)}else if(bt.tagType==t.XMLTagType.End){if(null==r||r.name!=bt.tagName)throw this.reset(),new Error("Invalid xml format - <"+bt.tagName+"> dismatched.");null!=r._children&&0!=r._children.length||(r.text=bt.getText()),r=i.length>0?i.pop():null}}reset(){this._attrs=null,null!=this._children&&this._children.length,this.text=null}}class Ct extends v{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(t,e=null,r="get",i="text",s){this._responseType=i,this._data=null,(A.onVVMiniGame||A.onQGMiniGame||A.onQQMiniGame||A.onAlipayMiniGame||A.onBLMiniGame||A.onHWMiniGame||A.onTTMiniGame||A.onTBMiniGame)&&(t=Ct._urlEncode(t)),this._url=t;let a=this._http;if(a.open(r,t,!0),e?"string"==typeof e?a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(a.setRequestHeader("Content-Type","application/json"),e instanceof ArrayBuffer||(e=JSON.stringify(e))):A.onBLMiniGame&&A.onAndroid&&(e={}),s)for(let t=0;t<s.length;t++)a.setRequestHeader(s[t++],s[t]);let n="arraybuffer"!==i?"text":"arraybuffer";a.responseType=n,a.dataType&&(a.dataType=n),a.onerror=t=>{this._onError(t)},a.onabort=t=>{this._onAbort(t)},a.onprogress=t=>{this._onProgress(t)},a.onload=t=>{this._onLoad(t)},a.send(e)}_onProgress(t){t&&t.lengthComputable&&this.event(s.PROGRESS,t.loaded/t.total)}_onAbort(t){this.error("Request was aborted by user")}_onError(t){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(t){var e=this._http,r=void 0!==e.status?e.status:200;200===r||204===r||0===r?this.complete():this.error("["+e.status+"]"+e.statusText+":"+e.responseURL)}error(t){this.clear(),this.event(s.ERROR,t)}complete(){this.clear();var t=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=new Rt(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(e){t=!1,this.error(e.message)}t&&this.event(s.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var t=this._http;t.onerror=t.onabort=t.onprogress=t.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}Ct._urlEncode=encodeURI;class At{constructor(){this.httpRequestPool=[]}common(t,e,r,i,a,n){let l=this.getRequestInst();l.on(s.COMPLETE,(()=>{let t=l.data;this.returnRequestInst(l),n(t)})),l.on(s.ERROR,null,(t=>{this.returnRequestInst(l),n(null,t)})),a&&l.on(s.PROGRESS,a),l.send(e,null,"get",i),t.$ref=l}image(t,e,r,i,s){let a=new A.window.Image;a.crossOrigin="",a.onload=()=>{a.onload=null,a.onerror=null,s(a)},a.onerror=()=>{a.onload=null,a.onerror=null,s(null,"")},a.src=e,t.$ref=a}imageWithBlob(t,e,r,i,s){let a=Et.arrayBufferToURL(r,e);this.image(t,a,r,i,s)}imageWithWorker(t,e,r,i,s){Tt.enable=!0,Tt.enable?Tt.load(e,t.workerLoaderOptions).then(s).catch((t=>s(null,t))):this.image(t,e,r,i,s)}audio(t,e,r,i,s){let a=A.createElement("audio");a.crossOrigin="",a.oncanplaythrough=()=>{a.oncanplaythrough=null,a.onerror=null,s(a)},a.onerror=()=>{a.oncanplaythrough=null,a.onerror=null,s(null,"")},a.src=e,t.$ref=a}getRequestInst(){return 0==this.httpRequestPool.length||A.onVVMiniGame||A.onHWMiniGame?new Ct:this.httpRequestPool.pop()}returnRequestInst(t){t.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(t)}}var It=0;const Mt={ext:null,typeId:null,main:!1,loaderType:null};class Bt extends v{static registerLoader(t,e,r,i){let s;r?(s=Bt.typeMap[r],s?s.loaderType!=e&&(s={typeId:s.typeId,loaderType:e}):Bt.typeMap[r]=s={typeId:It++,loaderType:e}):s={typeId:It++,loaderType:e},i&&(Bt.hotReloadableFlags[s.typeId]=!0);for(let i of t){let t=Bt.extMap[i];if(t&&r){let r=t.findIndex((t=>t.typeId==s.typeId));-1==r?t.push(s):t[r].loaderType=e}else Bt.extMap[i]=[s]}}constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}get loading(){return this._loadings.size>0}load(t,e,r,i,s,a,n,l,o){let h,u,d,c,_=Nt;if(e instanceof St?(h=e,u=i):"string"==typeof e?u=e:null!=e&&(u=e.type,_=e),null==s&&null==a&&null==l&&null==n&&null==o||(_=_===Nt?{priority:s,cache:a,ignoreCache:l,group:n,useWorkerLoader:o}:Object.assign(_,{priority:s,cache:a,ignoreCache:l,group:n,useWorkerLoader:o})),!1===_.cache&&(_.ignoreCache=!0),d=r instanceof St?t=>r.runWith(t):r,Array.isArray(t)){let e;d&&(e=new vt(d));let r=[];for(let i=0;i<t.length;i++){let s=t[i];s&&("string"==typeof s?r.push(this._load1(s,u,_,null==e?void 0:e.createCallback())):r.push(this._load1(s.url,s.type||u,_!==Nt?Object.assign({},_,s):s,null==e?void 0:e.createCallback())))}c=Promise.all(r)}else c="string"==typeof t?this._load1(t,u,_,d):this._load1(t.url,t.type||u,_!==Nt?Object.assign({},_,t):t,d);return h?c.then((t=>(h.runWith(t),t))):c}_load1(t,e,r,i){if(n.isPreview){if(t.startsWith("res://")){let s=t.substring(6);return N.inst.UUID_to_URL_async(s).then((a=>{var n;return a?this._load2(a,s,e,r,i):(!r.silent&&Bt.warnFailed(t,void 0,null===(n=r.initiator)||void 0===n?void 0:n.url),Promise.resolve(null))}))}return N.inst.URL_to_UUID_async(t).then((s=>this._load2(t,s,e,r,i)))}return this._load2(t,null,e,r,i)}_load2(t,e,r,i,a){var n,l;let{ext:o,typeId:h,main:u,loaderType:d}=Bt.getURLInfo(t,r);if(!d)return!i.silent&&Bt.warnFailed(t,void 0,null===(n=i.initiator)||void 0===n?void 0:n.url),Promise.resolve(null);let c,_=O.formatURL(t);if(i.group){let t=Bt.groupMap[i.group];t||(t=Bt.groupMap[i.group]=new Set),t.add(_)}if(!i.ignoreCache){let t=Bt._getRes(_,r);if(void 0!==t){if(null==t)return Promise.resolve(null);if(!(t instanceof b))return Promise.resolve(t);if(t.obsolute&&(c=t),!(c||t.uuid&&e&&e!=t.uuid))return Promise.resolve(t)}}let p=_;u||(p+="@"+h);let f=this._loadings.get(p);if(f){let t=i.initiator;for(;t;){if(t===f)return Promise.resolve();t=t.options.initiator}return null!=f.result?f.result:(a&&f.onProgress.add(a),new Promise((t=>f.onComplete.add(t))))}let g=yt.getFileLoadPath(_);if(g)return this.load(g.url,{type:Bt.ATLAS,baseUrl:g.baseUrl}).then((()=>Bt.getRes(t,r)));f=Pt.length>0?Pt.pop():new Lt,f.type=r,f.url=t,f.uuid=e,f.ext=o,delete(i=Object.assign(f.options,i)).type,null==i.priority&&(i.priority=0),null==i.useWorkerLoader&&(i.useWorkerLoader=Tt.enable),a&&f.onProgress.add(a),f.loader=this,f.obsoluteInst=c;let m,y=new d;this._loadings.set(p,f);try{Bt.LoaderStat_LoaderResourceCount++,this._tempTime=performance.now(),m=y.load(f)}catch(e){!i.silent&&Bt.warnFailed(t,e,null===(l=i.initiator)||void 0===l?void 0:l.url),m=Promise.resolve(null)}return m.then((r=>(Bt.LoaderStat_LoadResourceTime+=performance.now()-this._tempTime,r instanceof b&&(r.obsolute=!1,r._setCreateURL(t,e)),!1!==f.options.cache&&Bt._cacheRes(_,r,h,u),null!=r&&null!=y.postLoad?(f.result=r,y.postLoad(f,r).then((()=>(f.progress.update(-1,1),f.onComplete.invoke(r),r)))):(f.progress.update(-1,1),f.onComplete.invoke(r),r)))).catch((e=>{var r;return!i.silent&&Bt.warnFailed(t,e,null===(r=i.initiator)||void 0===r?void 0:r.url),!1!==f.options.cache&&Bt._cacheRes(_,null,h,u),f.onComplete.invoke(null),null})).then((t=>(this._loadings.delete(p),f.reset(),Pt.push(f),0==this._loadings.size&&this.event(s.COMPLETE),t)))}fetch(t,e,r,i){var s;let a={originalUrl:t,url:t,contentType:e,priority:null!==(s=(i=i||Nt).priority)&&void 0!==s?s:1,retryCnt:0,onProgress:r,onComplete:null};return i.useWorkerLoader&&(a.useWorkerLoader=!0,a.workerLoaderOptions=i.workerLoaderOptions),i.blob&&(a.blob=i.blob),i.noRetry&&(a.retryCnt=-1),i.silent&&(a.silent=!0),N.inst.resolveURL(t).then((t=>t?new Promise((e=>{a.url=O.formatURL(t),a.onComplete=e,this.queueToDownload(a)})):null))}queueToDownload(t){if(this._downloadings.size<this.maxLoader)return void this.download(t);let e=t.priority;if(0==e)this._queue.push(t);else{let r=this._queue.findIndex((t=>t.priority<e));-1!=r?this._queue.splice(r,0,t):this._queue.push(t)}}download(t){this._downloadings.add(t),Bt.LoaderStat_LoadRequestCount++,t.startTime=performance.now();let e=O.postFormatURL(t.url);if("image"==t.contentType){let r=Bt.preLoadedMap[t.url];if(r){if(!(r instanceof ArrayBuffer))return void this.completeItem(t,r);t.blob=r}t.blob?Bt.downloader.imageWithBlob(t,t.blob,t.originalUrl,t.onProgress,((e,r)=>{e||(t.retryCnt=-1),this.completeItem(t,e,r)})):t.useWorkerLoader?Bt.downloader.imageWithWorker(t,e,t.originalUrl,t.onProgress,((e,r)=>{e||(t.useWorkerLoader=!1,t.silent||Bt.warnFailed(t.url,r)),this.completeItem(t,e,r)})):Bt.downloader.image(t,e,t.originalUrl,t.onProgress,((e,r)=>this.completeItem(t,e,r)))}else if("sound"==t.contentType)Bt.downloader.audio(t,e,t.originalUrl,t.onProgress,((e,r)=>this.completeItem(t,e,r)));else{let r=Bt.preLoadedMap[t.url];if(r)return void this.completeItem(t,r);Bt.downloader.common(t,e,t.originalUrl,t.contentType,t.onProgress,((e,r)=>this.completeItem(t,e,r)))}}completeItem(t,r,i){this._downloadings.delete(t),Bt.LoaderStat_LoadRequestTime+=performance.now()-t.startTime,r?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),t.onProgress&&t.onProgress(1),t.onComplete(r)):-1!=t.retryCnt&&t.retryCnt<this.retryNum?(t.retryCnt++,t.silent||console.debug(`Retry to load ${t.url} (${t.retryCnt})`),e.systemTimer.once(this.retryDelay,this,this.queueToDownload,[t],!1)):(!t.silent&&Bt.warnFailed(t.url,i),t.onProgress&&t.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),t.onComplete(null))}static getURLInfo(t,e){let r,i,s,a,n=t.startsWith("data:")?"png":P.getFileExtension(t);if(n.length>0&&(r=Bt.extMap[n]),e){let t=Bt.typeMap[e];if(!t)return Mt;i=t.typeId;let n=0;r?r[0].typeId===i||-1!=(n=r.findIndex((t=>t.typeId===i)))?(s=0==n,a=r[n].loaderType):(s=!1,a=t.loaderType):(s=e!=Bt.TEXTURE2D,a=t.loaderType)}else{if(!r)return Mt;s=!0,i=r[0].typeId,a=r[0].loaderType}return{ext:n,main:s,typeId:i,loaderType:a}}static warnFailed(t,e,r){r?this.warn(`Failed to load '${t}' (in '${r}')`,e):this.warn(`Failed to load '${t}'`,e)}static warn(t,e){e?console.warn(t,e):console.warn(t)}static getRes(t,e){return t=O.formatURL(t),Bt._getRes(t,e)||null}static _getRes(t,e){let r,i=Bt.loadedMap[t];if(i){if(e){let t=Bt.typeMap[e];if(!t)return;if(2==i.length)i[0]==t.typeId&&(r=i[1]);else{let e=i.indexOf(t.typeId);-1!=e&&(r=i[e+1])}}else r=i[1];return r instanceof b&&r.destroyed?void 0:r}}static getTexture2D(t){return Bt.getRes(t,Bt.TEXTURE2D)}static getBaseTexture(t){return Bt.getRes(t,Bt.TEXTURE2D)}static getAtlas(t){return Bt.getRes(t,Bt.ATLAS)}getRes(t,e){return Bt.getRes(t,e)}static createNodes(t){var e;return null===(e=Bt.getRes(t))||void 0===e?void 0:e.create()}static cacheRes(t,e,r){t=O.formatURL(t);let i=Bt.getURLInfo(t,r);null!=i.typeId&&Bt._cacheRes(t,e,i.typeId,i.main)}static _cacheRes(t,e,r,i){let s=Bt.loadedMap[t];if(i)s?(s[0]=r,s[1]=e):s=Bt.loadedMap[t]=[r,e];else if(s){let t=s.findIndex((t=>t===r));-1!=t?s[t+1]=e:s.push(r,e)}else s=Bt.loadedMap[t]=[null,void 0,r,e]}cacheRes(t,e,r){Bt.cacheRes(t,e,r)}static clearRes(t,e){t=O.formatURL(t),Bt._clearRes(t,e)}clearRes(t,e){t=O.formatURL(t),Bt._clearRes(t,e)}static _clearRes(t,e){let r=Bt.loadedMap[t];if(r)if(e){if(r[1]==e)2==r.length?delete Bt.loadedMap[t]:r[1]=void 0;else{let i=r.indexOf(e);if(-1==i)return;4==r.length&&null==r[0]?delete Bt.loadedMap[t]:r.splice(i-1,2)}e instanceof b&&!e.destroyed&&e.destroy()}else if(delete Bt.loadedMap[t],r.length>2)for(let t=1;t<r.length;t+=2){let e=r[t];e instanceof b&&!e.destroyed&&e.destroy()}else{let t=r[1];t instanceof b&&!t.destroyed&&t.destroy()}}clearTextureRes(t){t=O.formatURL(t);let e=Bt.loadedMap[t];if(!e)return;let r=e[1];if(r instanceof mt)r.disposeBitmap();else if(r instanceof xt)for(let t of r.textures)t.disposeBitmap()}static setGroup(t,e){t=O.formatURL(t);let r=Bt.groupMap[e];r||(r=Bt.groupMap[e]=new Set),r.add(t)}static clearResByGroup(t){let e=Bt.groupMap[t];if(e)for(let t of e)Bt._clearRes(t)}clearUnLoaded(){if(0==this._queue.length)return;let t=this._queue.concat();this._queue.length=0;for(let e of t)e.onComplete(null)}cancelLoadByUrls(t){if(t)for(var e=0,r=t.length;e<r;e++)this.cancelLoadByUrl(t[e])}cancelLoadByUrl(t){t=O.formatURL(t);let e=this._queue.findIndex((e=>e.url==t));if(-1!=e){let t=this._queue[e];this._queue.splice(e,1),t.onComplete(null)}}loadPackage(t,r,i){let s,a;if("string"==typeof r?(a=r,s=i):s=i||r,a)return a.endsWith("/")||(a+="/"),O.basePaths[t.length>0?t+"/":t]=a,this._loadSubFileConfig(t,null,s);{if(n.isPreview)return Promise.resolve();let r=e.Browser.miniGameContext;return null==r?this._loadSubFileConfig(t,null,s):this._loadMiniPackage(r,t,s).then((()=>this._loadSubFileConfig(t,r,s)))}}_loadMiniPackage(t,e,r){return t.subPkgNameSeperator&&(e=e.replace(/\//g,t.subPkgNameSeperator)),e.length>0?new Promise(((i,s)=>{let a=t.loadSubpackage({name:e,success:t=>{i(t)},fail:t=>{s(t)}});a.onProgressUpdate&&a.onProgressUpdate((t=>{r&&r(t)}))})):Promise.resolve()}_loadSubFileConfig(t,r,i){return r&&r.subPkgPathSeperator&&(t=t.replace(/\//g,r.subPkgPathSeperator)),t.length>0&&(t+="/"),this.fetch(t+"fileconfig.json","json",i).then((i=>{let s=[],a=i.files;for(let t in a)if(t.length>0)for(let e of a[t])s.push(t+"/"+e);else for(let e of a[t])s.push(e);if(i.hash){let t=0,e=O.version;for(let r of i.hash)null!=r&&(e[s[t]]=r),t++}let n,l,o=i.config,h=o.length,u=0,d=0,c=0,_=0,p=0,f=N.inst.metaMap;for(;;){if(null==n){if(u>=h)break;l=o[u],n=l.i,Array.isArray(n)?p=n.length:(c=n,p=0,_=1),d=0}if(0==_){if(d>=p){u++,n=null;continue}_=n[d++],_>0?(c=_,_=0):_=-_}else _--;let t=s[c+_];switch(l.t){case 0:f[t]=l;break;case 1:yt.addAtlas(t,l.prefix,l.frames);break;case 2:N.inst.shaderNameMap[l.shaderName]=t;break;case 3:Bt.preLoadedMap[O.formatURL(t)]=l}}return!r&&i.entry?e.Browser.loadLib(O.formatURL(t+i.entry)):Promise.resolve()}))}}Bt.TEXT="text",Bt.JSON="json",Bt.XML="xml",Bt.BUFFER="arraybuffer",Bt.IMAGE="image",Bt.SOUND="sound",Bt.VIDEO="video",Bt.ATLAS="atlas",Bt.FONT="font",Bt.TTF="ttf",Bt.HIERARCHY="HIERARCHY",Bt.MESH="MESH",Bt.MATERIAL="MATERIAL",Bt.TEXTURE2D="TEXTURE2D",Bt.TEXTURECUBE="TEXTURE2D",Bt.TEXTURE2DARRAY="TEXTURE2D",Bt.ANIMATIONCLIP="ANIMATIONCLIP",Bt.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Bt.TERRAINRES="TERRAIN",Bt.SPINE="SPINE",Bt.extMap={},Bt.typeMap={},Bt.hotReloadableFlags={},Bt.downloader=new At,Bt.groupMap={},Bt.loadedMap={},Bt.preLoadedMap={};class Lt{constructor(){this.options={},this.onProgress=new T,this.onComplete=new T,this.progress=new vt((t=>this.onProgress.invoke(t)))}reset(){for(let t in this.options)delete this.options[t];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null,this.result=null}}const Pt=[],Nt={};class Ot{static regClass(t,e){Ot._classMap[t]=e}static getClass(t){return Ot._classMap[t]}static getInstance(t){var e=Ot.getClass(t);return e?new e:(console.warn("[error] Undefined class:",t),null)}}function Ft(){}Ot._classMap={};class Ut{}Ut.ENUM_TEXTALIGN_DEFAULT=0,Ut.ENUM_TEXTALIGN_CENTER=1,Ut.ENUM_TEXTALIGN_RIGHT=2,Ut.INDEX_BYTES=2,Ut.MAX_CLIP_SIZE=99999999;class kt{}kt.NOT_ACTIVE=1,kt.ACTIVE_INHIERARCHY=2,kt.AWAKED=4,kt.NOT_READY=8,kt.DISPLAY=16,kt.HAS_ZORDER=32,kt.HAS_MOUSE=64,kt.DISPLAYED_INSTAGE=128,kt.DRAWCALL_OPTIMIZE=256,kt.PROCESS_COLLISIONS=512,kt.PROCESS_TRIGGERS=1024,kt.HAS_SCRIPT=2048,kt.ESCAPE_DRAWING_TO_TEXTURE=4096,kt.DISABLE_INNER_CLIPPING=8192,kt.DISABLE_OUTER_CLIPPING=16384,kt.DISABLE_VISIBILITY=32768,kt.EDITING_NODE=65536,kt.HIDE_BY_EDITOR=131072,kt.LOCK_BY_EDITOR=262144;class Gt{}var Vt,Ht,zt,Wt,Yt,Xt,jt,qt;Gt.HideInHierarchy=1,Gt.HideInInspector=2,Gt.DontSave=4,Gt.HideAndDontSave=7,t.RenderParams=void 0,(Vt=t.RenderParams||(t.RenderParams={}))[Vt.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",Vt[Vt.Max_Uniform_Count=1]="Max_Uniform_Count",Vt[Vt.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",Vt[Vt.MAX_Texture_Size=3]="MAX_Texture_Size",Vt[Vt.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",Vt[Vt.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",Vt[Vt.FLOAT=6]="FLOAT",Vt[Vt.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",Vt[Vt.BYTE=8]="BYTE",Vt[Vt.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class $t{static __init__(){$t._elementInfos={single:[1,l.renderEngine.getParams(t.RenderParams.FLOAT),0],vector2:[2,l.renderEngine.getParams(t.RenderParams.FLOAT),0],vector3:[3,l.renderEngine.getParams(t.RenderParams.FLOAT),0],vector4:[4,l.renderEngine.getParams(t.RenderParams.FLOAT),0],color:[4,l.renderEngine.getParams(t.RenderParams.FLOAT),0],byte4:[4,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte3:[3,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte2:[2,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte:[1,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],short2:[2,l.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),0],short4:[4,l.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,l.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,l.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,l.renderEngine.getParams(t.RenderParams.FLOAT),0],halfvector4:[4,l.renderEngine.getParams(t.RenderParams.FLOAT),0],nbyte4:[4,l.renderEngine.getParams(t.RenderParams.BYTE),1],ubyte4:[4,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),1]}}static getElementInfos(t){var e=$t._elementInfos[t];if(e)return e;throw"VertexElementFormat: this vertexElementFormat is not implement."}}$t.Single="single",$t.Vector2="vector2",$t.Vector3="vector3",$t.Vector4="vector4",$t.Color="color",$t.Byte4="byte4",$t.Byte3="byte3",$t.Byte2="byte2",$t.ByteOne="byte",$t.Short2="short2",$t.Short4="short4",$t.NormalizedShort2="normalizedshort2",$t.NormalizedShort4="normalizedshort4",$t.HalfVector2="halfvector2",$t.HalfVector4="halfvector4",$t.NorByte4="nbyte4",$t.NorUByte4="ubyte4";class Kt{}class Qt{get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}constructor(t,e){this._id=++Qt._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=e,this._VAElements=[];var r=e.length;this._shaderValues={};for(var i=0;i<r;i++){var s=e[i],a=s._elementUsage;this._vertexElementsDic[a]=s;var n=new Kt,l=$t.getElementInfos(s._elementFormat);n.elementString=s._elementFormat,n.elementCount=l[0],n.elementType=l[1],n.normalized=l[2],n.vertexStride=this._vertexStride,n.elementOffset=s._offset,this._shaderValues[a]=n,this._VAElements.push({format:s._elementFormat,stride:s._offset,shaderLocation:a})}}getVertexElementByIndex(t){return this._vertexElements[t]}getVertexElementByUsage(t){return this._vertexElementsDic[t]}}Qt._uniqueIDCounter=1;class Zt{get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}constructor(t,e,r){this._offset=t,this._elementFormat=e,this._elementUsage=r}}class Jt{constructor(t,e,r){this._stride=0,this._vertNum=0,this._indexNum=0,this._stride=t,this._VBBuff=new ArrayBuffer(e||32),this._IBBuff=new ArrayBuffer(r||8),this.onVBRealloc(this._VBBuff),this.onIBRealloc(this._IBBuff)}get vbBuffer(){return this._VBBuff}get ibBuffer(){return this._IBBuff}get indexNum(){return this._indexNum}get vertexNum(){return this._vertNum}clearMesh(){this._vertNum=0,this._indexNum=0}expVBSize(t){if(t){let e=this._vertNum*this._stride;if(e+t>this._VBBuff.byteLength){let r=this._VBBuff;this._VBBuff=new ArrayBuffer(e+8*t),new Uint8Array(this._VBBuff,0,e).set(new Uint8Array(r,0,e)),this.onVBRealloc(this._VBBuff)}}}expIBSize(t){if(t){let e=2*this._indexNum;if(e+t>this._IBBuff.byteLength){let r=this._IBBuff;this._IBBuff=new ArrayBuffer(e+8*t),new Uint8Array(this._IBBuff,0,e).set(new Uint8Array(r,0,e)),this.onIBRealloc(this._IBBuff)}}}}class te extends Jt{static __int__(){te._fixib=function(t){let e=new W(6*t*2),r=new Uint16Array(e.buffer);for(var i=0,s=0,a=0;a<t;a++)r[i++]=s,r[i++]=s+2,r[i++]=s+1,r[i++]=s,r[i++]=s+3,r[i++]=s+2,s+=4;return r}(te._maxIB),te.VertexDeclarition=new Qt(48,[new Zt(0,$t.Vector4,0),new Zt(16,$t.Vector4,1),new Zt(32,$t.Vector4,2)])}constructor(t=4){super(te.const_stride,t,4),this._curVBPos=0}onVBRealloc(t){this._vbFloat32Array=new Float32Array(t)}onIBRealloc(t){}addQuad(t,e,r,i){this.expVBSize(te.const_stride);var s=this._vbFloat32Array;let a=(r>>>16&255)/255,n=(r>>>8&255)/255,l=(255&r)/255,o=(r>>>24)/255;var h=this._curVBPos,u=i?1:0;s[h++]=t[0],s[h++]=t[1],s[h++]=e[0],s[h++]=e[1],s[h++]=l,s[h++]=n,s[h++]=a,s[h++]=o,s[h++]=u,h+=3,s[h++]=t[2],s[h++]=t[3],s[h++]=e[2],s[h++]=e[3],s[h++]=l,s[h++]=n,s[h++]=a,s[h++]=o,s[h++]=u,h+=3,s[h++]=t[4],s[h++]=t[5],s[h++]=e[4],s[h++]=e[5],s[h++]=l,s[h++]=n,s[h++]=a,s[h++]=o,s[h++]=u,h+=3,s[h++]=t[6],s[h++]=t[7],s[h++]=e[6],s[h++]=e[7],s[h++]=l,s[h++]=n,s[h++]=a,s[h++]=o,s[h++]=u,h+=3,this._curVBPos=h,this._vertNum+=4,this._indexNum+=6}clearMesh(){super.clearMesh(),this._curVBPos=0}get ibBuffer(){return te._fixib.buffer}get vertexDeclarition(){return te.VertexDeclarition}}te.const_stride=48,te._maxIB=16384;class ee extends v{constructor(){super(),this.left=0,this.top=0,this.width=0,this.height=0;let t=this._rectMeshNormY=new te;t.addQuad([0,0,1,0,1,1,0,1],[0,0,1,0,1,1,0,1],4294967295,!0),this._rectMeshVBNormY=new Float32Array(t.vbBuffer);let e=this._rectMeshInvY=new te;e.addQuad([0,0,1,0,1,1,0,1],[0,1,1,1,1,0,0,0],4294967295,!0),this._rectMeshVBInvY=new Float32Array(e.vbBuffer),this.useFlipY(!1)}onChange(){this.event(ee.EVENT_CHANGE)}useFlipY(t){this._rectMesh=t?this._rectMeshInvY:this._rectMeshNormY,this._rectMeshVB=t?this._rectMeshVBInvY:this._rectMeshVBNormY}set render2D(t){this._render2D=t}get type(){return-1}}ee.COLOR=32,ee.EVENT_CHANGE="change",ee._filter=function(t,e,r,i){var s=this._next;if(!s)return;var a=t.filters,n=a.length;if(1==n&&a[0].type==ee.COLOR)return e.save(),e.setColorFilter(a[0]),s._fun.call(s,t,e,r,i),void e.restore();let l=t._getCacheStyle(),o=0,h=0;if(this._renderNextToCacheRT(t,e,16,16,16,16)){o=l.cacheRect.x,h=l.cacheRect.y;let t=l.renderTexture,r=t,i=t.width,s=t.height,d=e.render2D.out;for(let l=0;l<n;l++){t=r;var u=a[l];u._render2D=e.render2D,u.useFlipY(0!=l),u.render(t,i,s),i=u.width,s=u.height,r=u.texture,o+=u.left,h+=u.top}e.render2D.setRenderTarget(d),l.renderTexture=r,l.renderTexOffx=o,l.renderTexOffy=h}l.renderTexture&&e._drawRenderTexture(l.renderTexture,r+l.renderTexOffx,i+l.renderTexOffy,l.renderTexture.width,l.renderTexture.height,null,1,pt.defuv)};class re{static multiply(t,e,r){return(t.x-r.x)*(e.y-r.y)-(e.x-r.x)*(t.y-r.y)}static dis(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}static _getPoints(t,e=!1,r=null){for(re._mPointList||(re._mPointList=[]);re._mPointList.length<t;)re._mPointList.push(new i);return r||(r=[]),r.length=0,e?re.getFrom(r,re._mPointList,t):re.getFromR(r,re._mPointList,t),r}static getFrom(t,e,r){var i;for(i=0;i<r;i++)t.push(e[i]);return t}static getFromR(t,e,r){var i;for(i=0;i<r;i++)t.push(e.pop());return t}static pListToPointList(t,e=!1){var r,i=t.length/2,s=re._getPoints(i,e,re._tempPointList);for(r=0;r<i;r++)s[r].setTo(t[r+r],t[r+r+1]);return s}static pointListToPlist(t){var e,r,i=t.length,s=re._temPList;for(s.length=0,e=0;e<i;e++)r=t[e],s.push(r.x,r.y);return s}static scanPList(t){return P.copyArray(t,re.pointListToPlist(re.scan(re.pListToPointList(t,!0))))}static scan(t){var e,r,i,s,a,n=0,l=t.length,o={};for((s=re._temArr).length=0,e=(l=t.length)-1;e>=0;e--)(a=(i=t[e]).x+"_"+i.y)in o||(o[a]=!0,s.push(i));for(l=s.length,P.copyArray(t,s),e=1;e<l;e++)(t[e].y<t[n].y||t[e].y==t[n].y&&t[e].x<t[n].x)&&(n=e);for(i=t[0],t[0]=t[n],t[n]=i,e=1;e<l-1;e++){for(n=e,r=e+1;r<l;r++)(re.multiply(t[r],t[n],t[0])>0||0==re.multiply(t[r],t[n],t[0])&&re.dis(t[0],t[r])<re.dis(t[0],t[n]))&&(n=r);i=t[e],t[e]=t[n],t[n]=i}if((s=re._temArr).length=0,t.length<3)return P.copyArray(s,t);for(s.push(t[0],t[1],t[2]),e=3;e<l;e++){for(;s.length>=2&&re.multiply(t[e],s[s.length-1],s[s.length-2])>=0;)s.pop();t[e]&&s.push(t[e])}return s}}re._tempPointList=[],re._temPList=[],re._temArr=[];class ie{}ie.ALPHA=1,ie.TRANSFORM=2,ie.BLEND=4,ie.CANVAS=8,ie.FILTERS=16,ie.MASK=32,ie.CLIP=64,ie.TEXTURE=128,ie.GRAPHICS=256,ie.RENDERNODE2D=512,ie.CUSTOM=1024,ie.HITAREA=2048,ie.CHILDS=4096,ie.REPAINT_NONE=0,ie.REPAINT_NODE=1,ie.REPAINT_CACHE=2,ie.REPAINT_ALL=3,t.GPUEngineStatisticsInfo=void 0,(Ht=t.GPUEngineStatisticsInfo||(t.GPUEngineStatisticsInfo={}))[Ht.C_UniformBufferUploadCount=0]="C_UniformBufferUploadCount",Ht[Ht.C_GeometryBufferUploadCount=1]="C_GeometryBufferUploadCount",Ht[Ht.C_TriangleCount=2]="C_TriangleCount",Ht[Ht.C_SetRenderPassCount=3]="C_SetRenderPassCount",Ht[Ht.C_DrawCallCount=4]="C_DrawCallCount",Ht[Ht.C_Instancing_DrawCallCount=5]="C_Instancing_DrawCallCount",Ht[Ht.C_ShaderCompile=6]="C_ShaderCompile",Ht[Ht.T_ShaderCompile=7]="T_ShaderCompile",Ht[Ht.FrameClearCount=8]="FrameClearCount",Ht[Ht.M_GPUMemory=9]="M_GPUMemory",Ht[Ht.M_GPUBuffer=10]="M_GPUBuffer",Ht[Ht.M_VertexBuffer=11]="M_VertexBuffer",Ht[Ht.M_IndexBuffer=12]="M_IndexBuffer",Ht[Ht.M_UniformBlockBuffer=13]="M_UniformBlockBuffer",Ht[Ht.RC_GPUBuffer=14]="RC_GPUBuffer",Ht[Ht.RC_VertexBuffer=15]="RC_VertexBuffer",Ht[Ht.RC_IndexBuffer=16]="RC_IndexBuffer",Ht[Ht.RC_UniformBlockBuffer=17]="RC_UniformBlockBuffer",Ht[Ht.M_ALLTexture=18]="M_ALLTexture",Ht[Ht.M_Texture2D=19]="M_Texture2D",Ht[Ht.M_TextureCube=20]="M_TextureCube",Ht[Ht.M_Texture3D=21]="M_Texture3D",Ht[Ht.M_Texture2DArray=22]="M_Texture2DArray",Ht[Ht.RC_ALLTexture=23]="RC_ALLTexture",Ht[Ht.RC_Texture2D=24]="RC_Texture2D",Ht[Ht.RC_TextureCube=25]="RC_TextureCube",Ht[Ht.RC_Texture3D=26]="RC_Texture3D",Ht[Ht.RC_Texture2DArray=27]="RC_Texture2DArray",Ht[Ht.M_ALLRenderTexture=28]="M_ALLRenderTexture",Ht[Ht.RC_ALLRenderTexture=29]="RC_ALLRenderTexture",Ht[Ht.Count=30]="Count",t.RenderPassStatisticsInfo=void 0,(zt=t.RenderPassStatisticsInfo||(t.RenderPassStatisticsInfo={}))[zt.T_CameraRender=0]="T_CameraRender",zt[zt.T_Render_OpaqueRender=1]="T_Render_OpaqueRender",zt[zt.T_Render_TransparentRender=2]="T_Render_TransparentRender",zt[zt.T_Render_PostProcess=3]="T_Render_PostProcess",zt[zt.T_Render_CameraEventCMD=4]="T_Render_CameraEventCMD",zt[zt.T_Render_ShadowPassMode=5]="T_Render_ShadowPassMode",zt[zt.T_Render_CameraOtherDest=6]="T_Render_CameraOtherDest",zt[zt.T_RenderPreUpdate=7]="T_RenderPreUpdate",zt[zt.T_OtherRender=8]="T_OtherRender",zt[zt.T_OnlyMeshRender=9]="T_OnlyMeshRender",zt[zt.T_OnlySkinnedMeshRender=10]="T_OnlySkinnedMeshRender",zt[zt.T_OnlyShurikenParticleRender=11]="T_OnlyShurikenParticleRender",zt[zt.T_CameraMainCull=12]="T_CameraMainCull",zt[zt.T_ShadowMapCull=13]="T_ShadowMapCull",zt[zt.RenderPassStatisticCount=14]="RenderPassStatisticCount";class se{static show(t,r,i){se.checkUI()&&(this.hide(),se._show=!0,l.renderEngine._enableStatistics=!0,se._currentShowArray=i||se.AllShow,se._statUI.show(t,r,se._currentShowArray),e.systemTimer.frameLoop(1,null,se.loop),e.timer.frameLoop(1,null,se.clear))}static showToggle(t,r,i){se.checkUI()&&(this.hide(),se._show=!0,se._currentToggleArray=i,se._statUI.showToggle(t,r,i),e.systemTimer.frameLoop(1,null,se.loop),e.timer.frameLoop(1,null,se.clear))}static checkUI(){if(!se._statUI){let t=Ot.getClass("StatUI");if(!t)return console.error("StatUI not found"),!1;se._statUI=new t}return!0}static hide(){se._show&&(se._show=!1,se._currentShowArray=null,se._currentToggleArray=null,e.timer.clear(null,se.loop),e.timer.clear(null,se.clear),se._statUI&&se._statUI.hide())}static loop(){se._count++;let t=A.now();if(t-se._timer<1e3)return;let e=se._count;if(se.FPS=Math.round(1e3*e/(t-se._timer)),se._show){se.updateEngineData();let t=se.FPS>0?Math.floor(1e3/se.FPS).toString():" ";se._fpsStr=se.FPS+(se.renderSlow?" slow":"")+" "+t+"ms",se._statUI.update()}se._count=0,se._timer=t}static updateEngineData(){se.trianglesFaces+=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount),se.drawCall+=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount),se.instanceDrawCall+=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount),se.gpuMemory=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory),se.textureMemory=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLTexture),se.renderTextureMemory=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLRenderTexture),se.bufferMemory=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUBuffer)}static clear(){se._currentShowArray&&!se._count&&(se._currentShowArray.forEach((t=>{"average"==t.mode&&(se[t.value]=0)})),l.renderEngine.clearStatisticsInfo(),se.renderPassStatArray.fill(0))}static render(t,e,r){se._show&&se._statUI.render(t,e,r)}}se.FPSStatUIParams={title:"FPS",value:"_fpsStr",color:"yellow",units:"int",mode:"summit"},se.NodeStatUIParams={title:"Node",value:"spriteCount",color:"white",units:"int",mode:"summit"},se.Sprite3DStatUIParams={title:"Sprite3D",value:"sprite3DCount",color:"white",units:"int",mode:"summit"},se.DrawCall={title:"DrawCall",value:"drawCall",color:"white",units:"int",mode:"average"},se.TriangleFace={title:"TriangleFace",value:"trianglesFaces",color:"white",units:"int",mode:"average"},se.RenderNode={title:"RenderNode",value:"renderNode",color:"white",units:"int",mode:"summit"},se.SkinRenderNode={title:"SkinRenderNode",value:"skinRenderNode",color:"white",units:"int",mode:"summit"},se.ParticleRenderNode={title:"ParticleRenderNode",value:"particleRenderNode",color:"white",units:"int",mode:"summit"},se.FrustumCulling={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int",mode:"average"},se.UniformUpload={title:"UniformUpload",value:"uniformUpload",color:"white",units:"int",mode:"average"},se.OpaqueDrawCall={title:"OpaqueDrawCall",value:"opaqueDrawCall",color:"white",units:"int",mode:"average"},se.TransDrawCall={title:"TransDrawCall",value:"transDrawCall",color:"white",units:"int",mode:"average"},se.DepthCastDrawCall={title:"DepthCastDrawCall",value:"depthCastDrawCall",color:"white",units:"int",mode:"average"},se.ShadowDrawCall={title:"ShadowDrawCall",value:"shadowMapDrawCall",color:"white",units:"int",mode:"average"},se.InstanceDrawCall={title:"InstanceDrawCall",value:"instanceDrawCall",color:"white",units:"int",mode:"average"},se.CMDDrawCall={title:"CMDDrawCall",value:"cmdDrawCall",color:"white",units:"int",mode:"average"},se.BlitDrawCall={title:"BlitDrawCall",value:"blitDrawCall",color:"white",units:"int",mode:"average"},se.GPUMemory={title:"GPUMemory",value:"gpuMemory",color:"white",units:"M",mode:"summit"},se.TextureMemeory={title:"TextureMemory",value:"textureMemory",color:"white",units:"M",mode:"summit"},se.RenderTextureMemory={title:"RenderTextureMemory",value:"renderTextureMemory",color:"white",units:"M",mode:"summit"},se.BufferMemory={title:"BufferMemory",value:"bufferMemory",color:"white",units:"M",mode:"summit"},se.uploadUniformNum={title:"UploadUniformNum",value:"uploadUniform",color:"white",units:"int",mode:"average"},se.AllShow=[se.FPSStatUIParams,se.NodeStatUIParams,se.Sprite3DStatUIParams,se.DrawCall,se.TriangleFace,se.RenderNode,se.SkinRenderNode,se.ParticleRenderNode,se.FrustumCulling,se.OpaqueDrawCall,se.TransDrawCall,se.ShadowDrawCall,se.DepthCastDrawCall,se.InstanceDrawCall,se.CMDDrawCall,se.BlitDrawCall,se.GPUMemory,se.TextureMemeory,se.RenderTextureMemory,se.BufferMemory,se.uploadUniformNum],se.memoryShow=[se.GPUMemory,se.TextureMemeory,se.RenderTextureMemory,se.BufferMemory],se.renderShow=[se.DrawCall,se.TriangleFace,se.OpaqueDrawCall,se.TransDrawCall,se.ShadowDrawCall,se.DepthCastDrawCall,se.InstanceDrawCall,se.CMDDrawCall,se.BlitDrawCall],se.toogle_Shadow={title:"Shadow",value:"enableShadow",color:"white"},se.toogle_MulLight={title:"MulLight",value:"enableMulLight",color:"white"},se.toogle_Light={title:"Light",value:"enableLight",color:"white"},se.toogle_Postprocess={title:"Postprocess",value:"enablePostprocess",color:"white"},se.toogle_AnimatorUpdate={title:"AnimatorUpdate",value:"enableAnimatorUpdate",color:"white"},se.toogle_PhysicsUpdate={title:"PhysicsUpdate",value:"enablePhysicsUpdate",color:"white"},se.toogle_Skin={title:"Skin",value:"enableSkin",color:"white"},se.toogle_Transparent={title:"Transparent",value:"enableTransparent",color:"white"},se.toogle_Particle={title:"Particle",value:"enableParticle",color:"white"},se.toogle_msaa={title:"MSAA",value:"enablemsaa",color:"white"},se.toogle_CameraCMD={title:"CameraCMD",value:"enableCameraCMD",color:"white"},se.toogle_Opaque={title:"Opaque",value:"enableOpaque",color:"white"},se.AllToggle=[se.toogle_Shadow,se.toogle_Light,se.toogle_MulLight,se.toogle_Postprocess,se.toogle_AnimatorUpdate,se.toogle_PhysicsUpdate,se.toogle_Opaque,se.toogle_Transparent,se.toogle_CameraCMD,se.toogle_Skin,se.toogle_Particle,se.toogle_msaa],se.RenderModeToggle=[se.toogle_Shadow,se.toogle_Light,se.toogle_MulLight,se.toogle_Postprocess,se.toogle_AnimatorUpdate,se.toogle_PhysicsUpdate],se.RenderFuncToggle=[se.toogle_Opaque,se.toogle_Transparent,se.toogle_CameraCMD,se.toogle_Skin,se.toogle_Particle,se.toogle_msaa],se.FPS=0,se.loopCount=0,se.spriteRenderUseCacheCount=0,se.canvasNormal=0,se.canvasBitmap=0,se.canvasReCache=0,se.renderSlow=!1,se._timer=0,se._count=0,se._fpsStr="",se.spriteCount=0,se.sprite3DCount=0,se.drawCall=0,se.draw2D=0,se.trianglesFaces=0,se.renderNode=0,se.meshRenderNode=0,se.skinRenderNode=0,se.particleRenderNode=0,se.frustumCulling=0,se.uniformUpload=0,se.opaqueDrawCall=0,se.transDrawCall=0,se.depthCastDrawCall=0,se.shadowMapDrawCall=0,se.instanceDrawCall=0,se.cmdDrawCall=0,se.blitDrawCall=0,se.renderPassStatArray=[],se.enableRenderPassStatArray=!1,se.textureMemory=0,se.renderTextureMemory=0,se.bufferMemory=0,se.uploadUniform=0,se.enableShadow=!0,se.enableMulLight=!0,se.enableLight=!0,se.enableCameraCMD=!0,se.enablePostprocess=!0,se.enableSkin=!0,se.enableTransparent=!0,se.enableParticle=!0,se.enableAnimatorUpdate=!0,se.enablePhysicsUpdate=!0,se.enablemsaa=!0,se.enableOpaque=!0,window.Stat=se,t.BufferTargetType=void 0,(Wt=t.BufferTargetType||(t.BufferTargetType={}))[Wt.ARRAY_BUFFER=0]="ARRAY_BUFFER",Wt[Wt.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",Wt[Wt.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",Wt[Wt.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",Wt[Wt.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",Wt[Wt.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",t.BufferUsage=void 0,(Yt=t.BufferUsage||(t.BufferUsage={}))[Yt.Static=0]="Static",Yt[Yt.Dynamic=1]="Dynamic",Yt[Yt.Stream=2]="Stream",t.DrawType=void 0,(Xt=t.DrawType||(t.DrawType={}))[Xt.DrawArray=0]="DrawArray",Xt[Xt.DrawArrayInstance=1]="DrawArrayInstance",Xt[Xt.DrawElement=2]="DrawElement",Xt[Xt.DrawElementInstance=3]="DrawElementInstance",t.IndexFormat=void 0,(jt=t.IndexFormat||(t.IndexFormat={}))[jt.UInt8=0]="UInt8",jt[jt.UInt16=1]="UInt16",jt[jt.UInt32=2]="UInt32",t.MeshTopology=void 0,(qt=t.MeshTopology||(t.MeshTopology={}))[qt.Points=0]="Points",qt[qt.Lines=1]="Lines",qt[qt.LineLoop=2]="LineLoop",qt[qt.LineStrip=3]="LineStrip",qt[qt.Triangles=4]="Triangles",qt[qt.TriangleStrip=5]="TriangleStrip",qt[qt.TriangleFan=6]="TriangleFan";const ae=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];class ne{static restoreTempArray(){ae[0]=1,ae[1]=0,ae[4]=0,ae[5]=1,ae[12]=0,ae[13]=0}static clear(){ne.worldAlpha=1}}ne.worldMatrix4=ae,ne.worldMatrix=new G,ne.matWVP=null,ne.worldAlpha=1,ne.worldScissorTest=!1,ne.width=0,ne.height=0,ne.InvertY=!1;class le{constructor(t=null){this._renderTexture=null,this._renderTexture=t}setRenderTarget(t){}get out(){return this._renderTexture}}class oe extends le{constructor(t=null){super(t),oe.rendercontext2D||(oe.rendercontext2D=l.render2DRenderPassFactory.createRenderContext2D()),this._renderElement=l.render2DRenderPassFactory.createRenderElement2D()}clone(t){return new oe(t)}_createMesh(e){let r=l.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),i=l.renderDeviceFactory.createBufferState();r.bufferState=i;let s=l.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic);s.vertexDeclaration=e;let a=l.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Dynamic);return i.applyState([s],a),r.indexFormat=t.IndexFormat.UInt16,r}getGeo(t){let e=oe._geoMap[t.id];return null==e&&(e=this._createMesh(t),oe._geoMap[t.id]=e),e}renderStart(t,e){this._renderTexture?(oe.rendercontext2D.invertY=this._renderTexture._invertY,oe.rendercontext2D.setRenderTarget(this._renderTexture._renderTarget,t,e)):(oe.rendercontext2D.invertY=!1,oe.rendercontext2D.setOffscreenView(ne.width,ne.height),oe.rendercontext2D.setRenderTarget(null,t,e)),pt._clear=!1}setRenderTarget(t){oe.rendercontext2D.setRenderTarget(null==t?void 0:t._renderTarget,!1,pt._clearColor)}drawMesh(t,e){se.draw2D++,this._renderElement.geometry=t,this._renderElement.value2DShaderData=e.shaderData,this._renderElement.subShader=e._shader.getSubShaderAt(0),this._renderElement.materialShaderData=e.shaderData,oe.rendercontext2D.drawRenderElementOne(this._renderElement)}drawElement(t){oe.rendercontext2D.drawRenderElementOne(t)}draw(t,e,r,i,s,a,n){se.draw2D++;let l=this.getGeo(t.vertexDeclarition),o=l.bufferState,h=o._vertexBuffers[0],u=o._bindedIndexBuffer;h.setDataLength(r),h.setData(t.vbBuffer,e,0,r),u._setIndexDataLength(s),u._setIndexData(new Uint16Array(t.ibBuffer,i,s/2),0),l.clearRenderParams(),l.setDrawElemenParams(s/2,0);let d=n;this._renderElement.geometry=l,this._renderElement.value2DShaderData=a.shaderData,d?(this._renderElement.subShader=d._shader.getSubShaderAt(0),this._renderElement.materialShaderData=d.shaderData):(this._renderElement.subShader=a._defaultShader.getSubShaderAt(0),this._renderElement.materialShaderData=null),oe.rendercontext2D.drawRenderElementOne(this._renderElement)}renderEnd(){}}oe._geoMap={};class he{constructor(){this.elements=[],this.length=0}_add(t){this.length===this.elements.length?this.elements.push(t):this.elements[this.length]=t}add(t){let e=this.elements.indexOf(t);"number"!=typeof t&&-1!=e&&e<this.length||(this.length===this.elements.length?this.elements.push(t):this.elements[this.length]=t,this.length++)}indexof(t){let e=this.elements.indexOf(t);return-1!=e&&e<this.length?e:-1}remove(t){let e=this.elements.indexOf(t);-1!=e&&e<this.length&&(this.elements[e]=this.elements[this.length-1],this.elements[this.length-1]=null,this.length--)}clear(){this.elements=[],this.length=0}clean(){this.elements.length=this.length}destroy(){this.elements=null}}class ue extends he{add(t){this._add(t),this.length++}}class de{constructor(){this.batchFun=null,this.batch=!1,this.indexStart=-1,this.elementLenth=0}static create(){return 0!=this._pool.length?this._pool.pop():new de}static recover(t){this._pool.push(t)}}de._pool=[];class ce{static regisBatch(t,e){if(ce._batchMapManager[t])throw"Overlapping batch optimization";ce._batchMapManager[t]=e}get list(){return this._list}set list(t){this._list=t}constructor(){this._lastRenderNodeType=-1,this._renderEnd=!0,this.list=new ue,this._renderElementList=new ue,this._batchInfoList=new ue}addRenderObject(t){this.list.add(t)}removeRenderObject(t){this.list.remove(t)}clearList(){this._list.clear(),this._renderElementList.clear();for(var t=0,e=this._batchInfoList.length;t<e;t++){let e=this._batchInfoList.elements[t];e.batch&&e.batchFun.recover(),de.recover(e)}this._batchInfoList.clear()}renderUpdate(){var t=oe.rendercontext2D;let e=this._list.elements;for(let r=0,i=this._list.length;r<i;r++){let i=e[r];i.renderUpdate&&i._renderUpdateMask!=se.loopCount&&(i.renderUpdate(t),i._renderUpdateMask=se.loopCount)}}render(t){this.renderUpdate();for(var e=0,r=this._list.length;e<r;e++)this._cull(this._list.elements[e],t);this._batch(),t.drawRenderElementList(this._renderElementList),this.endRender()}_cull(t,e){{t.preRenderUpdate&&t.preRenderUpdate(e);let i=t._renderElements.length;if(1==i)this._batchStart(t._renderType,1),this._renderElementList.add(t._renderElements[0]);else{this._batchStart(t._renderType,i);for(var r=0;r<i;r++)this._renderElementList.add(t._renderElements[r])}}}_batch(){this._batchInfoList.add(this._lastbatch2DInfo),this._renderElementList.length=0;for(var t=0,e=this._batchInfoList.length;t<e;t++){let e=this._batchInfoList.elements[t];if(e.batch)e.batchFun.batchRenderElement(this._renderElementList,e.indexStart,e.elementLenth);else for(let t=e.indexStart,r=e.elementLenth+e.indexStart;t<r;t++)this._renderElementList.add(this._renderElementList.elements[t])}}_batchStart(t,e){if(-1==this._lastRenderNodeType)return this._lastbatch2DInfo=de.create(),this._lastbatch2DInfo.batch=!1,this._lastbatch2DInfo.batchFun=ce._batchMapManager[t],this._lastbatch2DInfo.indexStart=0,this._lastbatch2DInfo.elementLenth=e,void(this._lastRenderNodeType=t);this._lastRenderNodeType==t?(this._lastbatch2DInfo.batch=!!this._lastbatch2DInfo.batchFun,this._lastbatch2DInfo.elementLenth+=e):(this._batchInfoList.add(this._lastbatch2DInfo),this._lastbatch2DInfo=de.create(),this._lastbatch2DInfo.batch=!1,this._lastbatch2DInfo.batchFun=ce._batchMapManager[t],this._lastbatch2DInfo.indexStart=this._renderElementList.length,this._lastbatch2DInfo.elementLenth=e,this._lastRenderNodeType=t)}endRender(){this.clearList(),this._renderEnd=!0,this._lastRenderNodeType=-1}}var _e,pe,fe,ge,me,ye,Te;ce._batchMapManager={},t.BlendEquationSeparate=void 0,(_e=t.BlendEquationSeparate||(t.BlendEquationSeparate={}))[_e.ADD=0]="ADD",_e[_e.SUBTRACT=1]="SUBTRACT",_e[_e.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",_e[_e.MIN=3]="MIN",_e[_e.MAX=4]="MAX",t.BlendFactor=void 0,(pe=t.BlendFactor||(t.BlendFactor={}))[pe.Zero=0]="Zero",pe[pe.One=1]="One",pe[pe.SourceColor=2]="SourceColor",pe[pe.OneMinusSourceColor=3]="OneMinusSourceColor",pe[pe.DestinationColor=4]="DestinationColor",pe[pe.OneMinusDestinationColor=5]="OneMinusDestinationColor",pe[pe.SourceAlpha=6]="SourceAlpha",pe[pe.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",pe[pe.DestinationAlpha=8]="DestinationAlpha",pe[pe.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",pe[pe.SourceAlphaSaturate=10]="SourceAlphaSaturate",pe[pe.BlendColor=11]="BlendColor",pe[pe.OneMinusBlendColor=12]="OneMinusBlendColor",t.BlendType=void 0,(fe=t.BlendType||(t.BlendType={}))[fe.BLEND_DISABLE=0]="BLEND_DISABLE",fe[fe.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",fe[fe.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",t.CompareFunction=void 0,(ge=t.CompareFunction||(t.CompareFunction={}))[ge.Never=0]="Never",ge[ge.Less=1]="Less",ge[ge.Equal=2]="Equal",ge[ge.LessEqual=3]="LessEqual",ge[ge.Greater=4]="Greater",ge[ge.NotEqual=5]="NotEqual",ge[ge.GreaterEqual=6]="GreaterEqual",ge[ge.Always=7]="Always",ge[ge.Off=8]="Off",t.CullMode=void 0,(me=t.CullMode||(t.CullMode={}))[me.Off=0]="Off",me[me.Front=1]="Front",me[me.Back=2]="Back",t.FrontFace=void 0,(ye=t.FrontFace||(t.FrontFace={}))[ye.CW=0]="CW",ye[ye.CCW=1]="CCW",t.StencilOperation=void 0,(Te=t.StencilOperation||(t.StencilOperation={}))[Te.Keep=0]="Keep",Te[Te.Zero=1]="Zero",Te[Te.Replace=2]="Replace",Te[Te.IncrementSaturate=3]="IncrementSaturate",Te[Te.DecrementSaturate=4]="DecrementSaturate",Te[Te.Invert=5]="Invert",Te[Te.IncrementWrap=6]="IncrementWrap",Te[Te.DecrementWrap=7]="DecrementWrap";class xe{get cull(){return this._cull}set cull(t){this._cull=t}get blend(){return this._blend}set blend(t){this._blend=t}get srcBlend(){return this._srcBlend}set srcBlend(t){this._srcBlend=t}get dstBlend(){return this._dstBlend}set dstBlend(t){this._dstBlend=t}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(t){this._srcBlendRGB=t}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(t){this._dstBlendRGB=t}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(t){this._srcBlendAlpha=t}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(t){this._dstBlendAlpha=t}get blendEquation(){return this._blendEquation}set blendEquation(t){this._blendEquation=t}get blendEquationRGB(){return this._blendEquationRGB}set blendEquationRGB(t){this._blendEquationRGB=t}get blendEquationAlpha(){return this._blendEquationAlpha}set blendEquationAlpha(t){this._blendEquationAlpha=t}get depthTest(){return this._depthTest}set depthTest(t){this._depthTest=t}get depthWrite(){return this._depthWrite}set depthWrite(t){this._depthWrite=t}get stencilWrite(){return this._stencilWrite}set stencilWrite(t){this._stencilWrite=t}get stencilTest(){return this._stencilTest}set stencilTest(t){this._stencilTest=t}get stencilRef(){return this._stencilRef}set stencilRef(t){this._stencilRef=t}get stencilOp(){return this._stencilOp}set stencilOp(t){this._stencilOp=t}createObj(){}constructor(){this._stencilOp=new d,this.createObj(),this.cull=xe.CULL_BACK,this.blend=xe.BLEND_DISABLE,this.srcBlend=xe.BLENDPARAM_ONE,this.dstBlend=xe.BLENDPARAM_ZERO,this.srcBlendRGB=xe.BLENDPARAM_ONE,this.dstBlendRGB=xe.BLENDPARAM_ZERO,this.srcBlendAlpha=xe.BLENDPARAM_ONE,this.dstBlendAlpha=xe.BLENDPARAM_ZERO,this.blendEquation=xe.BLENDEQUATION_ADD,this.blendEquationRGB=xe.BLENDEQUATION_ADD,this.blendEquationAlpha=xe.BLENDEQUATION_ADD,this.depthTest=xe.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=xe.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new d(xe.STENCILOP_KEEP,xe.STENCILOP_KEEP,xe.STENCILOP_REPLACE)}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp.set(null,null,null)}cloneTo(t){t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.stencilRef=this.stencilRef,t.stencilTest=this.stencilTest,t.stencilWrite=this.stencilWrite,this.stencilOp.cloneTo(t.stencilOp)}clone(){var t=new xe;return this.cloneTo(t),t}}xe.CULL_NONE=t.CullMode.Off,xe.CULL_FRONT=t.CullMode.Front,xe.CULL_BACK=t.CullMode.Back,xe.BLEND_DISABLE=t.BlendType.BLEND_DISABLE,xe.BLEND_ENABLE_ALL=t.BlendType.BLEND_ENABLE_ALL,xe.BLEND_ENABLE_SEPERATE=t.BlendType.BLEND_ENABLE_SEPERATE,xe.BLENDPARAM_ZERO=t.BlendFactor.Zero,xe.BLENDPARAM_ONE=t.BlendFactor.One,xe.BLENDPARAM_SRC_COLOR=t.BlendFactor.SourceColor,xe.BLENDPARAM_ONE_MINUS_SRC_COLOR=t.BlendFactor.OneMinusSourceColor,xe.BLENDPARAM_DST_COLOR=t.BlendFactor.DestinationColor,xe.BLENDPARAM_ONE_MINUS_DST_COLOR=t.BlendFactor.OneMinusDestinationColor,xe.BLENDPARAM_SRC_ALPHA=t.BlendFactor.SourceAlpha,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA=t.BlendFactor.OneMinusSourceAlpha,xe.BLENDPARAM_DST_ALPHA=t.BlendFactor.DestinationAlpha,xe.BLENDPARAM_ONE_MINUS_DST_ALPHA=t.BlendFactor.OneMinusDestinationAlpha,xe.BLENDPARAM_SRC_ALPHA_SATURATE=t.BlendFactor.SourceAlphaSaturate,xe.BLENDPARAM_BLENDCOLOR=t.BlendFactor.BlendColor,xe.BLENDPARAM_BLEND_ONEMINUS_COLOR=t.BlendFactor.OneMinusBlendColor,xe.BLENDEQUATION_ADD=t.BlendEquationSeparate.ADD,xe.BLENDEQUATION_SUBTRACT=t.BlendEquationSeparate.SUBTRACT,xe.BLENDEQUATION_REVERSE_SUBTRACT=t.BlendEquationSeparate.REVERSE_SUBTRACT,xe.BLENDEQUATION_MIN=t.BlendEquationSeparate.MIN,xe.BLENDEQUATION_MAX=t.BlendEquationSeparate.MAX,xe.DEPTHTEST_OFF=t.CompareFunction.Off,xe.DEPTHTEST_NEVER=t.CompareFunction.Never,xe.DEPTHTEST_LESS=t.CompareFunction.Less,xe.DEPTHTEST_EQUAL=t.CompareFunction.Equal,xe.DEPTHTEST_LEQUAL=t.CompareFunction.LessEqual,xe.DEPTHTEST_GREATER=t.CompareFunction.Greater,xe.DEPTHTEST_NOTEQUAL=t.CompareFunction.NotEqual,xe.DEPTHTEST_GEQUAL=t.CompareFunction.GreaterEqual,xe.DEPTHTEST_ALWAYS=t.CompareFunction.Always,xe.STENCILTEST_OFF=t.CompareFunction.Off,xe.STENCILTEST_NEVER=t.CompareFunction.Never,xe.STENCILTEST_LESS=t.CompareFunction.Less,xe.STENCILTEST_EQUAL=t.CompareFunction.Equal,xe.STENCILTEST_LEQUAL=t.CompareFunction.LessEqual,xe.STENCILTEST_GREATER=t.CompareFunction.Greater,xe.STENCILTEST_NOTEQUAL=t.CompareFunction.NotEqual,xe.STENCILTEST_GEQUAL=t.CompareFunction.GreaterEqual,xe.STENCILTEST_ALWAYS=t.CompareFunction.Always,xe.STENCILOP_KEEP=t.StencilOperation.Keep,xe.STENCILOP_ZERO=t.StencilOperation.Zero,xe.STENCILOP_REPLACE=t.StencilOperation.Replace,xe.STENCILOP_INCR=t.StencilOperation.IncrementSaturate,xe.STENCILOP_INCR_WRAP=t.StencilOperation.IncrementWrap,xe.STENCILOP_DECR=t.StencilOperation.DecrementSaturate,xe.STENCILOP_DECR_WRAP=t.StencilOperation.DecrementWrap,xe.STENCILOP_INVERT=t.StencilOperation.Invert,xe.Default=new xe;class ve{static splitToWords(t,e){for(var r,i,s=[],a=-1,n=0,l=t.length;n<l;n++)if(r=t.charAt(n)," \t=+-*/&%!<>()'\",;".indexOf(r)>=0){if(a>=0&&n-a>1&&(i=t.substr(a,n-a),s.push(i)),'"'==r||"'"==r){var o=t.indexOf(r,n+1);if(o<0)throw"Sharder err:"+t;s.push(t.substr(n+1,o-n-1)),n=o,a=-1;continue}"("==r&&e&&s.length>0&&(i=s[s.length-1]+";","vec4;main;".indexOf(i)<0&&(e.useFuns+=i)),a=-1}else a<0&&(a=n);return a<l&&l-a>1&&(i=t.substr(a,l-a),s.push(i)),s}constructor(t){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=t;for(var e,r,i=0;!((i=t.indexOf("#begin",i))<0);){for(r=i+5;!((r=t.indexOf("#end",r))<0)&&"i"===t.charAt(r+4);)r+=5;if(r<0)throw"add include err,no #end:"+t;e=t.indexOf("\n",i);var s=ve.splitToWords(t.substr(i,e-i),null);"code"==s[1]?this.codes[s[2]]=t.substr(e+1,r-e-1):"function"==s[1]&&(e=t.indexOf("function",i),e+=8,this.funs[s[3]]=t.substr(e+1,r-e-1),this.funnames+=s[3]+";"),i=r+1}}getWith(t=null){var e=t?this.codes[t]:this.script;if(!e)throw"get with error:"+t;return e}getFunsScript(t){var e="";for(var r in this.funs)t.indexOf(r+";")>=0&&(e+=this.funs[r]);return e}}class Se{constructor(t){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=t}setParent(t){t.childs.push(this),this.z=t.z+1,this.parent=t}setCondition(t,e){t&&(this.conditionType=e,t=t.replace(/(\s*$)/g,""),this.condition=function(){return this[t]},this.condition.__condition=t)}toscript(t,e){return this._toscript(t,e,++Se.__id)}_toscript(t,e,r){if(this.childs.length<1&&!this.text)return e;if(e.length,this.condition){var i=!!this.condition.call(t);if(2===this.conditionType&&(i=!i),!i&&Se.__noCompileEnable)return e}if(!this.noCompile&&Se.__noCompileEnable||this.text&&e.push(this.text),this.childs.length>0&&this.childs.forEach((function(i,s,a){i._toscript(t,e,r)})),this.includefiles.length>0&&this.useFuns.length>0)for(var s,a=0,n=this.includefiles.length;a<n;a++)this.includefiles[a].curUseID!=r&&(s=this.includefiles[a].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[a].curUseID=r,e[0]=s+e[0]);return e}}Se.__id=1,Se.__noCompileEnable=!0;const Ee=new RegExp("\r","g"),we=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g"),De={Back:t.CullMode.Back,Front:t.CullMode.Front,Off:t.CullMode.Off},be={Disable:t.BlendType.BLEND_DISABLE,All:t.BlendType.BLEND_ENABLE_ALL,Seperate:t.BlendType.BLEND_ENABLE_SEPERATE},Re={Zero:t.BlendFactor.Zero,One:t.BlendFactor.One,SourceColor:t.BlendFactor.SourceColor,OneMinusSourceColor:t.BlendFactor.OneMinusSourceColor,DestinationColor:t.BlendFactor.DestinationColor,OneMinusDestinationColor:t.BlendFactor.OneMinusDestinationColor,SourceAlpha:t.BlendFactor.SourceAlpha,OneMinusSourceAlpha:t.BlendFactor.OneMinusSourceAlpha,DestinationAlpha:t.BlendFactor.DestinationAlpha,OneMinusDestinationAlpha:t.BlendFactor.OneMinusDestinationAlpha,SourceAlphaSaturate:t.BlendFactor.SourceAlphaSaturate,BlendColor:t.BlendFactor.BlendColor,OneMinusBlendColor:t.BlendFactor.OneMinusBlendColor},Ce={Add:t.BlendEquationSeparate.ADD,Subtract:t.BlendEquationSeparate.SUBTRACT,Reverse_substract:t.BlendEquationSeparate.REVERSE_SUBTRACT,Min:t.BlendEquationSeparate.MIN,Max:t.BlendEquationSeparate.MAX},Ae={Never:t.CompareFunction.Never,Less:t.CompareFunction.Less,Equal:t.CompareFunction.Equal,LessEqual:t.CompareFunction.LessEqual,Greater:t.CompareFunction.Greater,NotEqual:t.CompareFunction.NotEqual,GreaterEqual:t.CompareFunction.GreaterEqual,Always:t.CompareFunction.Always,Off:t.CompareFunction.Off},Ie={Keep:t.StencilOperation.Keep,Zero:t.StencilOperation.Zero,Replace:t.StencilOperation.Replace,IncrementSaturate:t.StencilOperation.IncrementSaturate,DecrementSaturate:t.StencilOperation.DecrementSaturate,Invert:t.StencilOperation.Invert,IncrementWrap:t.StencilOperation.IncrementWrap,DecrementWrap:t.StencilOperation.DecrementWrap};class Me{static addInclude(t,e,r){if(!e||0===e.length)return console.error("shader include file err:"+t),null;if(!r&&Me.includes[t])return console.warn("shader include file already exists:"+t),Me.includes[t];e=e.replace(Ee,"");let i=new ve(e);return Me.includes[t]=i,i}static compile(t,e,r){let i={vsNode:new Se([]),psNode:new Se([]),includeNames:new Set,defs:new Set},s=[];t=t.replace(Ee,""),e=e.replace(Ee,""),Me._compileToTree(i.vsNode,t,i.defs,s,r),Me._compileToTree(i.psNode,e,i.defs,s,r);for(let t of s)t.file?i.includeNames.add(t.name):console.warn(`ShaderCompile missing file ${t.name}`);return i}static compileAsync(t,e,r){let i={vsNode:new Se([]),psNode:new Se([]),includeNames:new Set,defs:new Set},s=[];return t=t.replace(Ee,""),e=e.replace(Ee,""),Me._compileToTree(i.vsNode,t,i.defs,s,r),Me._compileToTree(i.psNode,e,i.defs,s,r),this._loadIncludesDeep(i,s,0)}static _loadIncludesDeep(t,r,i){let s,a=r.length;for(let e=i;e<a;e++){let i=r[e];i.file?t.includeNames.add(i.name):(s||(s=[]),s.push(i))}return s?e.loader.load(s.map((t=>t.name))).then((e=>{let i=s.length;for(let a=0;a<i;a++){let i=s[a],n=e[a];if(n){t.includeNames.add(i.name);let e=n.getWith(i.codeName);i.node.condition?i.node.text=e:(Me._compileToTree(i.node,e,t.defs,r,O.getPath(i.name)),i.node.text="")}else{let t=i.node.parent.childs;t.splice(t.indexOf(i.node),1)}}return r.length>a?Me._loadIncludesDeep(t,r,a):t})):Promise.resolve(t)}static _compileToTree(t,e,r,i,s){let a,n,l,o,h,u,d,c,_,p,f=e.split("\n");for(c=0;c<f.length;c++)if(l=f[c],!(l.length<1)&&(u=l.indexOf("//"),0!==u))if(u>=0&&(l=l.substr(0,u)),(u=l.indexOf("#"))<0){n=t.childs[t.childs.length-1];let e=t.includefiles;if(n&&!n.name){e.length>0&&ve.splitToWords(l,n),n.text+="\n"+l;continue}a=new Se(e),a.text=l,a.noCompile=!0,e.length>0&&ve.splitToWords(l,a),a.setParent(t)}else{for(a=new Se(t.includefiles),a.text=l,a.noCompile=!0,o="#",p=u+1,_=l.length;p<_;p++){let t=l.charAt(p);if(" "===t||"\t"===t||"?"===t)break;o+=t}switch(a.name=o,o){case"#ifdef":case"#ifndef":for(a.src=l,a.noCompile=null!=l.match(/[!&|()=<>]/),a.noCompile?console.log("function():Boolean{return "+l.substr(u+a.name.length)+"}"):(d=l.replace(/^\s*/,"").split(/\s+/),a.setCondition(d[1],"#ifdef"===o?Me.IFDEF_YES:Me.IFDEF_ELSE),a.text=a.text),a.setParent(t),t=a,d=l.substr(p).split(we),p=0;p<d.length;p++)l=d[p],l.length&&r.add(l);break;case"#if":case"#elif":for(a.src=l,a.noCompile=!0,"#elif"==o&&(n=(t=t.parent).childs[t.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),a.setParent(t),t=a,d=l.substr(p).split(we),p=0;p<d.length;p++)l=d[p],l.length&&"defined"!=l&&r.add(l);break;case"#else":a.src=l,n=(t=t.parent).childs[t.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.condition=n.condition,a.conditionType=n.conditionType==Me.IFDEF_YES?Me.IFDEF_ELSE:Me.IFDEF_YES),a.setParent(t),t=a;break;case"#endif":n=(t=t.parent).childs[t.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.text=a.text),a.setParent(t);break;case"#include":d=ve.splitToWords(l,null);let e,c=d[1];c.startsWith(".")?c=O.join(s,c):c.startsWith("/")?c=O.formatURL(c.substring(1)):(e=Me.includes[c],e||(c="internal/"+c)),e=Me.includes[c],!e&&Me.loadIncludeFileSync&&(Me.loadIncludeFileSync(c),e=Me.includes[c]);let _="with"==d[2]?d[3]:null;i.push({name:c,codeName:_,node:a,file:e}),a.setParent(t),(u=d[0].indexOf("?"))<0?(e&&(l=e.getWith(_),this._compileToTree(a,l,r,i,O.getPath(c))),a.text=""):(a.setCondition(d[0].substr(u+1),Me.IFDEF_YES),e&&(a.text=e.getWith(_)));break;case"#import":d=ve.splitToWords(l,null),h=d[1],a.includefiles.push({node:a,file:Me.includes[h],ofs:a.text.length});break;default:a.setParent(t)}}}static getRenderState(t,e){if(!t)return;e.cull=De[t.cull],e.blend=be[t.blend],e.srcBlend=Re[t.srcBlend],e.dstBlend=Re[t.dstBlend],e.srcBlendRGB=Re[t.srcBlendRGB],e.dstBlendRGB=Re[t.dstBlendRGB],e.srcBlendAlpha=Re[t.srcBlendAlpha],e.dstBlendAlpha=Re[t.dstBlendAlpha],e.blendEquation=Ce[t.blendEquation],e.blendEquationRGB=Ce[t.blendEquationRGB],e.blendEquationAlpha=Ce[t.blendEquationAlpha],e.depthTest=Ae[t.depthTest],e.depthWrite=t.depthWrite,e.stencilRef=t.stencilRef,e.stencilTest=Ae[t.stencilTest],e.stencilWrite=t.stencilWrite;let r=t.stencilOp,i=r?r[0]:null,s=r?r[1]:null,a=r?r[2]:null;e.stencilOp.x=Ie[i],e.stencilOp.y=Ie[s],e.stencilOp.z=Ie[a]}}Me.IFDEF_NO=0,Me.IFDEF_YES=1,Me.IFDEF_ELSE=2,Me.IFDEF_PARENT=3,Me.includes={};const Be=new Float32Array([1,0,0,0,1,0,0,0,1]),Le=new d,Pe=new d,Ne=new d;class Oe{static createRotationQuaternion(t,e){var r=t.x,i=t.y,s=t.z,a=t.w,n=r*r,l=i*i,o=s*s,h=r*i,u=s*a,d=s*r,c=i*a,_=i*s,p=r*a,f=e.elements;f[0]=1-2*(l+o),f[1]=2*(h+u),f[2]=2*(d-c),f[3]=2*(h-u),f[4]=1-2*(o+n),f[5]=2*(_+p),f[6]=2*(d+c),f[7]=2*(_-p),f[8]=1-2*(l+n)}static createFromTranslation(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=t.x,r[7]=t.y,r[8]=1}static createFromRotation(t,e){var r=e.elements,i=Math.sin(t),s=Math.cos(t);r[0]=s,r[1]=i,r[2]=0,r[3]=-i,r[4]=s,r[5]=0,r[6]=0,r[7]=0,r[8]=1}static createFromScaling(t,e){var r=e.elements;r[0]=t.x,r[1]=0,r[2]=0,r[3]=0,r[4]=t.y,r[5]=0,r[6]=0,r[7]=0,r[8]=t.z}static createFromMatrix4x4(t,e){var r=t.elements,i=e.elements;i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[4],i[4]=r[5],i[5]=r[6],i[6]=r[8],i[7]=r[9],i[8]=r[10]}static multiply(t,e,r){var i=t.elements,s=e.elements,a=r.elements,n=i[0],l=i[1],o=i[2],h=i[3],u=i[4],d=i[5],c=i[6],_=i[7],p=i[8],f=s[0],g=s[1],m=s[2],y=s[3],T=s[4],x=s[5],v=s[6],S=s[7],E=s[8];a[0]=f*n+g*h+m*c,a[1]=f*l+g*u+m*S,a[2]=f*o+g*d+m*p,a[3]=y*n+T*h+x*c,a[4]=y*l+T*u+x*_,a[5]=y*o+T*d+x*p,a[6]=v*n+S*h+E*c,a[7]=v*l+S*u+E*_,a[8]=v*o+S*d+E*p}constructor(t=!0){t&&(this.elements=Be.slice())}cloneByArray(t){this.elements.set(t)}determinant(){var t=this.elements,e=t[0],r=t[1],i=t[2],s=t[3],a=t[4],n=t[5],l=t[6],o=t[7],h=t[8];return e*(h*a-n*o)+r*(-h*s+n*l)+i*(o*s-a*l)}translate(t,e){var r=e.elements,i=this.elements,s=i[0],a=i[1],n=i[2],l=i[3],o=i[4],h=i[5],u=i[6],d=i[7],c=i[8],_=t.x,p=t.y;r[0]=s,r[1]=a,r[2]=n,r[3]=l,r[4]=o,r[5]=h,r[6]=_*s+p*l+u,r[7]=_*a+p*o+d,r[8]=_*n+p*h+c}rotate(t,e){var r=e.elements,i=this.elements,s=i[0],a=i[1],n=i[2],l=i[3],o=i[4],h=i[5],u=i[6],d=i[7],c=i[8],_=Math.sin(t),p=Math.cos(t);r[0]=p*s+_*l,r[1]=p*a+_*o,r[2]=p*n+_*h,r[3]=p*l-_*s,r[4]=p*o-_*a,r[5]=p*h-_*n,r[6]=u,r[7]=d,r[8]=c}scale(t,e){var r=e.elements,i=this.elements,s=t.x,a=t.y;r[0]=s*i[0],r[1]=s*i[1],r[2]=s*i[2],r[3]=a*i[3],r[4]=a*i[4],r[5]=a*i[5],r[6]=i[6],r[7]=i[7],r[8]=i[8]}invert(t){var e=t.elements,r=this.elements,i=r[0],s=r[1],a=r[2],n=r[3],l=r[4],o=r[5],h=r[6],u=r[7],d=r[8],c=d*l-o*u,_=-d*n+o*h,p=u*n-l*h,f=i*c+s*_+a*p;f&&(f=1/f,e[0]=c*f,e[1]=(-d*s+a*u)*f,e[2]=(o*s-a*l)*f,e[3]=_*f,e[4]=(d*i-a*h)*f,e[5]=(-o*i+a*n)*f,e[6]=p*f,e[7]=(-u*i+s*h)*f,e[8]=(l*i-s*n)*f)}transpose(t){var e=t.elements,r=this.elements;if(t===this){var i=r[1],s=r[2],a=r[5];e[1]=r[3],e[2]=r[6],e[3]=i,e[5]=r[7],e[6]=s,e[7]=a}else e[0]=r[0],e[1]=r[3],e[2]=r[6],e[3]=r[1],e[4]=r[4],e[5]=r[7],e[6]=r[2],e[7]=r[5],e[8]=r[8]}identity(){this.elements.set(Be)}cloneTo(t){var e,r;(e=this.elements)!==(r=t.elements)&&r.set(e)}clone(){var t=new Oe(!1);return t.elements=this.elements.slice(),t}static lookAt(t,e,r,i){d.subtract(t,e,Le),d.normalize(Le,Le),d.cross(r,Le,Pe),d.normalize(Pe,Pe),d.cross(Le,Pe,Ne);var s=Le,a=Pe,n=Ne,l=i.elements;l[0]=a.x,l[3]=a.y,l[6]=a.z,l[1]=n.x,l[4]=n.y,l[7]=n.z,l[2]=s.x,l[5]=s.y,l[8]=s.z}static forwardLookAt(t,e,r,i){var s=Pe,a=Ne,n=Le;e.vsub(t,n).normalize(),r.cross(n,s).normalize(),n.cross(s,a);var l=i.elements;l[0]=s.x,l[1]=s.y,l[2]=s.z,l[3]=a.x,l[4]=a.y,l[5]=a.z,l[6]=n.x,l[7]=n.y,l[8]=n.z}}Oe.DEFAULT=new Oe,Oe.Temp=new Oe;const Fe=new d,Ue=new d,ke=new d,Ge=new d,Ve=new Oe;class He{static createFromYawPitchRoll(t,e,r,i){var s=.5*r,a=.5*e,n=.5*t,l=Math.sin(s),o=Math.cos(s),h=Math.sin(a),u=Math.cos(a),d=Math.sin(n),c=Math.cos(n);i.x=c*h*o+d*u*l,i.y=d*u*o-c*h*l,i.z=c*u*l-d*h*o,i.w=c*u*o+d*h*l}static multiply(t,e,r){var i=t.x,s=t.y,a=t.z,n=t.w,l=e.x,o=e.y,h=e.z,u=e.w,d=s*h-a*o,c=a*l-i*h,_=i*o-s*l,p=i*l+s*o+a*h;r.x=i*u+l*n+d,r.y=s*u+o*n+c,r.z=a*u+h*n+_,r.w=n*u-p}static rotationAxisAngle(t,e,r){const i=d._tempVector3;d.normalize(t,i),e*=.5;const s=Math.sin(e);r.x=i.x*s,r.y=i.y*s,r.z=i.z*s,r.w=Math.cos(e)}static arcTanAngle(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):t<0?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0}static angleTo(t,e,r){d.subtract(e,t,Fe),d.normalize(Fe,Fe),r.x=Math.asin(Fe.y),r.y=He.arcTanAngle(-Fe.z,-Fe.x)}static createFromAxisAngle(t,e,r){e*=.5;var i=Math.sin(e);r.x=i*t.x,r.y=i*t.y,r.z=i*t.z,r.w=Math.cos(e)}static createFromMatrix4x4(t,e){var r,i,s=t.elements,a=s[0]+s[5]+s[10];a>0?(r=Math.sqrt(a+1),e.w=.5*r,r=.5/r,e.x=(s[6]-s[9])*r,e.y=(s[8]-s[2])*r,e.z=(s[1]-s[4])*r):s[0]>=s[5]&&s[0]>=s[10]?(i=.5/(r=Math.sqrt(1+s[0]-s[5]-s[10])),e.x=.5*r,e.y=(s[1]+s[4])*i,e.z=(s[2]+s[8])*i,e.w=(s[6]-s[9])*i):s[5]>s[10]?(i=.5/(r=Math.sqrt(1+s[5]-s[0]-s[10])),e.x=(s[4]+s[1])*i,e.y=.5*r,e.z=(s[9]+s[6])*i,e.w=(s[8]-s[2])*i):(i=.5/(r=Math.sqrt(1+s[10]-s[0]-s[5])),e.x=(s[8]+s[2])*i,e.y=(s[9]+s[6])*i,e.z=.5*r,e.w=(s[1]-s[4])*i)}static slerp(t,e,r,i){var s,a,n,l,o,h=t.x,u=t.y,d=t.z,c=t.w,_=e.x,p=e.y,f=e.z,g=e.w;return(a=h*_+u*p+d*f+c*g)<0&&(a=-a,_=-_,p=-p,f=-f,g=-g),1-a>1e-6?(s=Math.acos(a),n=Math.sin(s),l=Math.sin((1-r)*s)/n,o=Math.sin(r*s)/n):(l=1-r,o=r),i.x=l*h+o*_,i.y=l*u+o*p,i.z=l*d+o*f,i.w=l*c+o*g,i}static lerp(t,e,r,i){var s=1-r;He.dot(t,e)>=0?(i.x=s*t.x+r*e.x,i.y=s*t.y+r*e.y,i.z=s*t.z+r*e.z,i.w=s*t.w+r*e.w):(i.x=s*t.x-r*e.x,i.y=s*t.y-r*e.y,i.z=s*t.z-r*e.z,i.w=s*t.w-r*e.w),i.normalize(i)}static add(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z,r.w=t.w+e.w}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}constructor(t=0,e=0,r=0,i=1){this.x=t,this.y=e,this.z=r,this.w=i}setValue(t,e,r,i){this.x=t,this.y=e,this.z=r,this.w=i}set(t,e,r,i){return this.x=t,this.y=e,this.z=r,this.w=i,this}scaling(t,e){e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t}normalize(t){var e=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;e>0&&(e=1/Math.sqrt(e),t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e.x=this.x*i+this.w*r,e.y=this.y*i+this.z*r,e.z=this.z*i-this.y*r,e.w=this.w*i-this.x*r}rotateY(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e.x=this.x*i-this.z*r,e.y=this.y*i+this.w*r,e.z=this.z*i+this.x*r,e.w=this.w*i-this.y*r}rotateZ(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e.x=this.x*i+this.y*r,e.y=this.y*i-this.x*r,e.z=this.z*i+this.w*r,e.w=this.w*i-this.z*r}getYawPitchRoll(t){d.transformQuat(d.ForwardRH,this,Ue),d.transformQuat(d.Up,this,ke);var e=ke;He.angleTo(d.ZERO,Ue,Ge);var r=Ge;r.x==Math.PI/2?(r.y=He.arcTanAngle(e.z,e.x),r.z=0):r.x==-Math.PI/2?(r.y=He.arcTanAngle(-e.z,-e.x),r.z=0):($e.createRotationY(-r.y,$e.TEMPMatrix0),$e.createRotationX(-r.x,$e.TEMPMatrix1),d.transformCoordinate(ke,$e.TEMPMatrix0,ke),d.transformCoordinate(ke,$e.TEMPMatrix1,ke),r.z=He.arcTanAngle(e.y,-e.x)),r.y<=-Math.PI&&(r.y=Math.PI),r.z<=-Math.PI&&(r.z=Math.PI),r.y>=Math.PI&&r.z>=Math.PI&&(r.y=0,r.z=0,r.x=Math.PI-r.x);var i=t;i.x=r.y,i.y=r.x,i.z=r.z}invert(t){var e=this.x,r=this.y,i=this.z,s=this.w,a=e*e+r*r+i*i+s*s,n=a?1/a:0;t.x=-e*n,t.y=-r*n,t.z=-i*n,t.w=s*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3]}cloneTo(t){this!==t&&(t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w)}clone(){var t=new He;return this.cloneTo(t),t}equals(t){return h.nearEqual(this.x,t.x)&&h.nearEqual(this.y,t.y)&&h.nearEqual(this.z,t.z)&&h.nearEqual(this.w,t.w)}static rotationLookAt(t,e,r){He.lookAt(d.ZERO,t,e,r)}static lookAt(t,e,r,i){Oe.lookAt(t,e,r,Ve),He.rotationMatrix(Ve,i)}static forwardLookAt(t,e,r,i){Oe.forwardLookAt(t,e,r,Ve),He.rotationMatrix(Ve,i)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(t,e){var r=t.lengthSquared();h.isZero(r)||(r=1/r,e.x=-t.x*r,e.y=-t.y*r,e.z=-t.z*r,e.w=t.w*r)}static rotationMatrix(t,e){var r,i,s=t.elements,a=s[0],n=s[1],l=s[2],o=s[3],h=s[4],u=s[5],d=s[6],c=s[7],_=s[8],p=a+h+_;p>0?(r=Math.sqrt(p+1),e.w=.5*r,r=.5/r,e.x=(u-c)*r,e.y=(d-l)*r,e.z=(n-o)*r):a>=h&&a>=_?(i=.5/(r=Math.sqrt(1+a-h-_)),e.x=.5*r,e.y=(n+o)*i,e.z=(l+d)*i,e.w=(u-c)*i):h>_?(i=.5/(r=Math.sqrt(1+h-a-_)),e.x=(o+n)*i,e.y=.5*r,e.z=(c+u)*i,e.w=(d-l)*i):(i=.5/(r=Math.sqrt(1+_-a-h)),e.x=(d+l)*i,e.y=(c+u)*i,e.z=.5*r,e.w=(n-o)*i)}}He.TEMP=new He,He.DEFAULT=new He,He.NAN=new He(NaN,NaN,NaN,NaN);const ze=new d,We=new d,Ye=new d,Xe=new d,je=new He,qe=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class $e{static createRotationX(t,e){var r=e.elements,i=Math.sin(t),s=Math.cos(t);r[1]=r[2]=r[3]=r[4]=r[7]=r[8]=r[11]=r[12]=r[13]=r[14]=0,r[0]=r[15]=1,r[5]=r[10]=s,r[6]=i,r[9]=-i}static createRotationY(t,e){var r=e.elements,i=Math.sin(t),s=Math.cos(t);r[1]=r[3]=r[4]=r[6]=r[7]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[5]=r[15]=1,r[0]=r[10]=s,r[2]=-i,r[8]=i}static createRotationZ(t,e){var r=e.elements,i=Math.sin(t),s=Math.cos(t);r[2]=r[3]=r[6]=r[7]=r[8]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[10]=r[15]=1,r[0]=r[5]=s,r[1]=i,r[4]=-i}static createRotationYawPitchRoll(t,e,r,i){He.createFromYawPitchRoll(t,e,r,je),$e.createRotationQuaternion(je,i)}static createRotationAxis(t,e,r){var i=t.x,s=t.y,a=t.z,n=Math.cos(e),l=Math.sin(e),o=i*i,h=s*s,u=a*a,d=i*s,c=i*a,_=s*a,p=r.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=o+n*(1-o),p[1]=d-n*d+l*a,p[2]=c-n*c-l*s,p[4]=d-n*d-l*a,p[5]=h+n*(1-h),p[6]=_-n*_+l*i,p[8]=c-n*c+l*s,p[9]=_-n*_-l*i,p[10]=u+n*(1-u)}static createRotationQuaternion(t,e){var r=e.elements,i=t.x,s=t.y,a=t.z,n=t.w,l=i*i,o=s*s,h=a*a,u=i*s,d=a*n,c=a*i,_=s*n,p=s*a,f=i*n;r[3]=r[7]=r[11]=r[12]=r[13]=r[14]=0,r[15]=1,r[0]=1-2*(o+h),r[1]=2*(u+d),r[2]=2*(c-_),r[4]=2*(u-d),r[5]=1-2*(h+l),r[6]=2*(p+f),r[8]=2*(c+_),r[9]=2*(p-f),r[10]=1-2*(o+l)}static createTranslate(t,e){var r=e.elements;r[4]=r[8]=r[1]=r[9]=r[2]=r[6]=r[3]=r[7]=r[11]=0,r[0]=r[5]=r[10]=r[15]=1,r[12]=t.x,r[13]=t.y,r[14]=t.z}static createScaling(t,e){var r=e.elements;r[0]=t.x,r[5]=t.y,r[10]=t.z,r[1]=r[4]=r[8]=r[12]=r[9]=r[13]=r[2]=r[6]=r[14]=r[3]=r[7]=r[11]=0,r[15]=1}static multiply(t,e,r){var i=e.elements,s=t.elements,a=r.elements,n=i[0],l=i[1],o=i[2],h=i[3],u=i[4],d=i[5],c=i[6],_=i[7],p=i[8],f=i[9],g=i[10],m=i[11],y=i[12],T=i[13],x=i[14],v=i[15],S=s[0],E=s[1],w=s[2],D=s[3],b=s[4],R=s[5],C=s[6],A=s[7],I=s[8],M=s[9],B=s[10],L=s[11],P=s[12],N=s[13],O=s[14],F=s[15];a[0]=n*S+l*b+o*I+h*P,a[1]=n*E+l*R+o*M+h*N,a[2]=n*w+l*C+o*B+h*O,a[3]=n*D+l*A+o*L+h*F,a[4]=u*S+d*b+c*I+_*P,a[5]=u*E+d*R+c*M+_*N,a[6]=u*w+d*C+c*B+_*O,a[7]=u*D+d*A+c*L+_*F,a[8]=p*S+f*b+g*I+m*P,a[9]=p*E+f*R+g*M+m*N,a[10]=p*w+f*C+g*B+m*O,a[11]=p*D+f*A+g*L+m*F,a[12]=y*S+T*b+x*I+v*P,a[13]=y*E+T*R+x*M+v*N,a[14]=y*w+T*C+x*B+v*O,a[15]=y*D+T*A+x*L+v*F}static createFromQuaternion(t,e){var r=e.elements,i=t.x,s=t.y,a=t.z,n=t.w,l=i+i,o=s+s,h=a+a,u=i*l,d=s*l,c=s*o,_=a*l,p=a*o,f=a*h,g=n*l,m=n*o,y=n*h;r[0]=1-c-f,r[1]=d+y,r[2]=_-m,r[3]=0,r[4]=d-y,r[5]=1-u-f,r[6]=p+g,r[7]=0,r[8]=_+m,r[9]=p-g,r[10]=1-u-c,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}static createAffineTransformation(t,e,r,i){var s=i.elements,a=e.x,n=e.y,l=e.z,o=e.w,h=a+a,u=n+n,d=l+l,c=a*h,_=a*u,p=a*d,f=n*u,g=n*d,m=l*d,y=o*h,T=o*u,x=o*d,v=r.x,S=r.y,E=r.z;s[0]=(1-(f+m))*v,s[1]=(_+x)*v,s[2]=(p-T)*v,s[3]=0,s[4]=(_-x)*S,s[5]=(1-(c+m))*S,s[6]=(g+y)*S,s[7]=0,s[8]=(p+T)*E,s[9]=(g-y)*E,s[10]=(1-(c+f))*E,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1}static createLookAt(t,e,r,i){var s=i.elements,a=ze,n=We,l=Ye;d.subtract(t,e,l),d.normalize(l,l),d.cross(r,l,a),d.normalize(a,a),d.cross(l,a,n),s[3]=s[7]=s[11]=0,s[15]=1,s[0]=a.x,s[4]=a.y,s[8]=a.z,s[1]=n.x,s[5]=n.y,s[9]=n.z,s[2]=l.x,s[6]=l.y,s[10]=l.z,s[12]=-d.dot(a,t),s[13]=-d.dot(n,t),s[14]=-d.dot(l,t)}static createPerspective(t,e,r,i,s){var a=1/Math.tan(.5*t),n=r/(a/e),l=r/a;$e.createPerspectiveOffCenter(-n,n,-l,l,r,i,s)}static createPerspectiveOffCenter(t,e,r,i,s,a,n){var l=n.elements,o=a/(a-s);l[1]=l[2]=l[3]=l[4]=l[6]=l[7]=l[12]=l[13]=l[15]=0,l[0]=2*s/(e-t),l[5]=2*s/(i-r),l[8]=(t+e)/(e-t),l[9]=(i+r)/(i-r),l[10]=-o,l[11]=-1,l[14]=-s*o}static createOrthoOffCenter(t,e,r,i,s,a,n){var l=n.elements,o=1/(a-s);l[1]=l[2]=l[3]=l[4]=l[6]=l[8]=l[7]=l[9]=l[11]=0,l[15]=1,l[0]=2/(e-t),l[5]=2/(i-r),l[10]=-o,l[12]=(t+e)/(t-e),l[13]=(i+r)/(r-i),l[14]=-s*o}constructor(t=1,e=0,r=0,i=0,s=0,a=1,n=0,l=0,o=0,h=0,u=1,d=0,c=0,_=0,p=0,f=1,g=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var m=this.elements=g||new Float32Array(16);m[0]=t,m[1]=e,m[2]=r,m[3]=i,m[4]=s,m[5]=a,m[6]=n,m[7]=l,m[8]=o,m[9]=h,m[10]=u,m[11]=d,m[12]=c,m[13]=_,m[14]=p,m[15]=f}}else this.elements=qe.slice()}getElementByRowColumn(t,e){if(t<0||t>3)throw new Error("row for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column for matrices run from 0 to 3, inclusive.");return this.elements[4*t+e]}setElementByRowColumn(t,e,r){if(t<0||t>3)throw new Error("row for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column for matrices run from 0 to 3, inclusive.");this.elements[4*t+e]=r}setRotation(t){var e=t.x,r=t.y,i=t.z,s=t.w,a=e*e,n=r*r,l=i*i,o=e*r,h=i*s,u=i*e,d=r*s,c=r*i,_=e*s,p=this.elements;p[0]=1-2*(n+l),p[1]=2*(o+h),p[2]=2*(u-d),p[4]=2*(o-h),p[5]=1-2*(l+a),p[6]=2*(c+_),p[8]=2*(u+d),p[9]=2*(c-_),p[10]=1-2*(n+a)}setPosition(t){var e=this.elements;e[12]=t.x,e[13]=t.y,e[14]=t.z}equalsOtherMatrix(t){var e=this.elements,r=t.elements;return h.nearEqual(e[0],r[0])&&h.nearEqual(e[1],r[1])&&h.nearEqual(e[2],r[2])&&h.nearEqual(e[3],r[3])&&h.nearEqual(e[4],r[4])&&h.nearEqual(e[5],r[5])&&h.nearEqual(e[6],r[6])&&h.nearEqual(e[7],r[7])&&h.nearEqual(e[8],r[8])&&h.nearEqual(e[9],r[9])&&h.nearEqual(e[10],r[10])&&h.nearEqual(e[11],r[11])&&h.nearEqual(e[12],r[12])&&h.nearEqual(e[13],r[13])&&h.nearEqual(e[14],r[14])&&h.nearEqual(e[15],r[15])}decomposeTransRotScale(t,e,r){var i=Ke;return this.decomposeTransRotMatScale(t,i,r)?(He.createFromMatrix4x4(i,e),!0):(e.identity(),!1)}decomposeTransRotMatScale(t,e,r){var i=this.elements,s=t,a=e.elements,n=r;s.x=i[12],s.y=i[13],s.z=i[14];var l=i[0],o=i[1],u=i[2],c=i[4],_=i[5],p=i[6],f=i[8],g=i[9],m=i[10],y=n.x=Math.sqrt(l*l+o*o+u*u),T=n.y=Math.sqrt(c*c+_*_+p*p),x=n.z=Math.sqrt(f*f+g*g+m*m);if(h.isZero(y)||h.isZero(T)||h.isZero(x))return a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=a[12]=a[13]=a[14]=0,a[0]=a[5]=a[10]=a[15]=1,!1;var v=ze;v.x=f/x,v.y=g/x,v.z=m/x;var S=We;S.x=l/y,S.y=o/y,S.z=u/y;var E=Ye;d.cross(v,S,E);var w=We;return d.cross(E,v,w),a[3]=a[7]=a[11]=a[12]=a[13]=a[14]=0,a[15]=1,a[0]=w.x,a[1]=w.y,a[2]=w.z,a[4]=E.x,a[5]=E.y,a[6]=E.z,a[8]=v.x,a[9]=v.y,a[10]=v.z,a[0]*l+a[1]*o+a[2]*u<0&&(n.x=-y),a[4]*c+a[5]*_+a[6]*p<0&&(n.y=-T),a[8]*f+a[9]*g+a[10]*m<0&&(n.z=-x),!0}decomposeYawPitchRoll(t){var e=Math.asin(-this.elements[9]);t.y=e,Math.cos(e)>h.zeroTolerance?(t.z=Math.atan2(this.elements[1],this.elements[5]),t.x=Math.atan2(this.elements[8],this.elements[10])):(t.z=Math.atan2(-this.elements[4],this.elements[0]),t.x=0)}normalize(){var t=this.elements,e=t[0],r=t[1],i=t[2],s=Math.sqrt(e*e+r*r+i*i);if(!s)return t[0]=0,t[1]=0,void(t[2]=0);1!=s&&(s=1/s,t[0]=e*s,t[1]=r*s,t[2]=i*s)}transpose(){var t,e;return e=(t=this.elements)[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}invert(t){var e=this.elements,r=t.elements,i=e[0],s=e[1],a=e[2],n=e[3],l=e[4],o=e[5],h=e[6],u=e[7],d=e[8],c=e[9],_=e[10],p=e[11],f=e[12],g=e[13],m=e[14],y=e[15],T=i*o-s*l,x=i*h-a*l,v=i*u-n*l,S=s*h-a*o,E=s*u-n*o,w=a*u-n*h,D=d*g-c*f,b=d*m-_*f,R=d*y-p*f,C=c*m-_*g,A=c*y-p*g,I=_*y-p*m,M=T*I-x*A+v*C+S*R-E*b+w*D;0!==Math.abs(M)&&(M=1/M,r[0]=(o*I-h*A+u*C)*M,r[1]=(a*A-s*I-n*C)*M,r[2]=(g*w-m*E+y*S)*M,r[3]=(_*E-c*w-p*S)*M,r[4]=(h*R-l*I-u*b)*M,r[5]=(i*I-a*R+n*b)*M,r[6]=(m*v-f*w-y*x)*M,r[7]=(d*w-_*v+p*x)*M,r[8]=(l*A-o*R+u*D)*M,r[9]=(s*R-i*A-n*D)*M,r[10]=(f*E-g*v+y*T)*M,r[11]=(c*v-d*E-p*T)*M,r[12]=(o*b-l*C-h*D)*M,r[13]=(i*C-s*b+a*D)*M,r[14]=(g*x-f*S-m*T)*M,r[15]=(d*S-c*x+_*T)*M)}static billboard(t,e,r,i,s){d.subtract(t,e,ze);var a=d.scalarLengthSquared(ze);h.isZero(a)?(d.scale(i,-1,We),We.cloneTo(ze)):d.scale(ze,1/Math.sqrt(a),ze),d.cross(r,ze,Ye),d.normalize(Ye,Ye),d.cross(ze,Ye,Xe);var n=Ye,l=Xe,o=ze,u=t,c=s.elements;c[0]=n.x,c[1]=n.y,c[2]=n.z,c[3]=0,c[4]=l.x,c[5]=l.y,c[6]=l.z,c[7]=0,c[8]=o.x,c[9]=o.y,c[10]=o.z,c[11]=0,c[12]=u.x,c[13]=u.y,c[14]=u.z,c[15]=1}identity(){this.elements.set(qe)}isIdentity(){let t=this.elements,e=$e.DEFAULT.elements;for(let s=0,a=t.length;s<a;s++)if(r=t[s],i=e[s],!(Math.abs(r-i)<1e-7))return!1;var r,i;return!0}cloneTo(t){this.elements!==t.elements&&t.elements.set(this.elements)}cloneByArray(t){this.elements.set(t)}clone(){var t=new $e(null);return t.elements=this.elements.slice(),t}static translation(t,e){var r=e.elements;r[0]=r[5]=r[10]=r[15]=1,r[12]=t.x,r[13]=t.y,r[14]=t.z}getTranslationVector(t){var e=this.elements;t.x=e[12],t.y=e[13],t.z=e[14]}setTranslationVector(t){var e=this.elements,r=t;e[12]=r.x,e[13]=r.y,e[14]=r.z}getForward(t){var e=this.elements;t.x=-e[8],t.y=-e[9],t.z=-e[10]}setForward(t){var e=this.elements;e[8]=-t.x,e[9]=-t.y,e[10]=-t.z}getInvertFront(){this.decomposeTransRotScale(ze,je,We);var t=We,e=t.x<0;return t.y<0&&(e=!e),t.z<0&&(e=!e),e}}$e.TEMPMatrix0=new $e,$e.TEMPMatrix1=new $e,$e.DEFAULT=new $e,$e.DEFAULTINVERT=new $e(-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),$e.ZERO=new $e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Ke=new $e;class Qe{constructor(t=0,e=0){this.x=t,this.y=e}setValue(t,e){this.x=t,this.y=e}static scale(t,e,r){r.x=t.x*e,r.y=t.y*e}static equals(t,e){return h.nearEqual(t.x,e.x)&&h.nearEqual(t.y,e.y)}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1]}toArray(){return[this.x,this.y]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y}cloneTo(t){t.x=this.x,t.y=this.y}static dot(t,e){return t.x*e.x+t.y*e.y}static normalize(t,e){var r=t.x,i=t.y,s=r*r+i*i;s>0&&(s=1/Math.sqrt(s),e.x=r*s,e.y=i*s)}static scalarLength(t){var e=t.x,r=t.y;return Math.sqrt(e*e+r*r)}clone(){var t=new Qe;return this.cloneTo(t),t}}var Ze,Je,tr;function er(e){switch(e){case t.ShaderDataType.Int:return 0;case t.ShaderDataType.Bool:return!1;case t.ShaderDataType.Float:return 0;case t.ShaderDataType.Vector2:return Qe.ZERO;case t.ShaderDataType.Vector3:return d.ZERO;case t.ShaderDataType.Vector4:return u.ZERO;case t.ShaderDataType.Color:return _t.BLACK;case t.ShaderDataType.Matrix4x4:return $e.DEFAULT;case t.ShaderDataType.Matrix3x3:return Oe.DEFAULT}return null}Qe.ZERO=new Qe(0,0),Qe.ONE=new Qe(1,1),Qe.TempVector2=new Qe,t.ShaderDataType=void 0,(Ze=t.ShaderDataType||(t.ShaderDataType={}))[Ze.None=0]="None",Ze[Ze.Int=1]="Int",Ze[Ze.Bool=2]="Bool",Ze[Ze.Float=3]="Float",Ze[Ze.Vector2=4]="Vector2",Ze[Ze.Vector3=5]="Vector3",Ze[Ze.Vector4=6]="Vector4",Ze[Ze.Color=7]="Color",Ze[Ze.Matrix4x4=8]="Matrix4x4",Ze[Ze.Texture2D=9]="Texture2D",Ze[Ze.Texture3D=10]="Texture3D",Ze[Ze.TextureCube=11]="TextureCube",Ze[Ze.Buffer=12]="Buffer",Ze[Ze.Matrix3x3=13]="Matrix3x3",Ze[Ze.Texture2DArray=14]="Texture2DArray";t.UniformBufferParamsType=void 0,(Je=t.UniformBufferParamsType||(t.UniformBufferParamsType={}))[Je.Number=0]="Number",Je[Je.Vector2=1]="Vector2",Je[Je.Vector3=2]="Vector3",Je[Je.Vector4=3]="Vector4",Je[Je.Matrix4x4=4]="Matrix4x4",Je[Je.Vector4Array=5]="Vector4Array",Je[Je.MatrixArray=6]="MatrixArray";class rr{constructor(t){this._uniformParamsState=new Map(t),this._createBuffer(),this._updateFlag=new Qe,this._resetUpdateFlag()}_createBuffer(){var t=0;this._layoutMap={};this._uniformParamsState.forEach(((e,r)=>{t+=this._addUniformParams(r,e,t)})),this._bytelength=4*Math.ceil(t/4)*4,this._buffer=new Float32Array(t)}_getArraySize(t){let e=t.indexOf("["),r=t.indexOf("]");if(-1!=e&&-1!=r&&e<r)return parseFloat(t.substring(e+1,r));throw t+" is illegal "}_addUniformParams(e,r,i){let s,a=0,n=0,l=i%4;switch(r){case t.UniformBufferParamsType.Number:a=1,n=1;break;case t.UniformBufferParamsType.Vector2:switch(a=2,l){case 0:case 2:n=2;break;case 1:case 3:i+=1,n=3}break;case t.UniformBufferParamsType.Vector3:switch(a=3,n=3,l){case 1:case 2:case 3:i+=4-l,n=4-l+3}break;case t.UniformBufferParamsType.Vector4:switch(a=4,l){case 0:n=4;break;case 1:i+=3,n=7;break;case 2:i+=2,n=6;break;case 3:i+=1,n=5}break;case t.UniformBufferParamsType.Matrix4x4:a=16,s=l?4-l:l,i+=s,n=a+s;break;case t.UniformBufferParamsType.Vector4Array:a=4*this._getArraySize(dr.propertyIDToName(e)),s=l?4-l:l,i+=s,n=a+s;break;case t.UniformBufferParamsType.MatrixArray:a=16*this._getArraySize(dr.propertyIDToName(e)),s=l?4-l:l,i+=s,n=a+s;break;default:throw"Unifrom Buffer Params Type is illegal "}const o=new Qe(i,a);return this._layoutMap[e]=o,n}_getParamsInfo(t){return this._layoutMap[t]}_setUpdateFlag(t,e){t<this._updateFlag.x&&(this._updateFlag.x=t),e>this._updateFlag.y&&(this._updateFlag.y=e)}destroy(){delete this._buffer,this._uniformParamsState.clear(),this._uniformParamsState=null,this._layoutMap=null,this._updateFlag=null}_resetUpdateFlag(){this._updateFlag.setValue(this._buffer.length,0)}_has(t){return!!this._getParamsInfo(t)}_setData(e,r){switch(this._uniformParamsState.get(e)){case t.UniformBufferParamsType.Number:this.setNumberbyIndex(e,r);break;case t.UniformBufferParamsType.Vector2:this.setVector2byIndex(e,r);break;case t.UniformBufferParamsType.Vector3:this.setVector3byIndex(e,r);break;case t.UniformBufferParamsType.Vector4:this.setVector4byIndex(e,r);break;case t.UniformBufferParamsType.Matrix4x4:this.setMatrixbyIndex(e,r);break;case t.UniformBufferParamsType.Vector4Array:this.setVector4ArraybyIndex(e,r);break;case t.UniformBufferParamsType.MatrixArray:this.setMatrixArraybyIndex(e,r)}}getbyteLength(){return this._bytelength}setVector4Array(t,e){const r=dr.propertyNameToID(t);this.setVector4ArraybyIndex(r,e)}setVector4ArraybyIndex(t,e){const r=this._getParamsInfo(t);if(!r)return;let i=r.x,s=r.y/4;for(let t=0;t<s;t++){let r=e[t];this._buffer[i++]=r.x,this._buffer[i++]=r.y,this._buffer[i++]=r.z,this._buffer[i++]=r.w}this._setUpdateFlag(r.x,i)}setMatrixArray(t,e){const r=dr.propertyNameToID(t);this.setMatrixArraybyIndex(r,e)}setMatrixArraybyIndex(t,e){const r=this._getParamsInfo(t);if(!r)return;let i=r.x,s=r.y/4;for(let t=0;t<s;t++){let r=e[t];this._buffer.set(r.elements,i),i+=16}this._setUpdateFlag(r.x,i)}setNumber(t,e){const r=dr.propertyNameToID(t);this.setNumberbyIndex(r,e)}setNumberbyIndex(t,e){const r=this._getParamsInfo(t);if(!r)return;let i=r.x;this._buffer[i++]=e,this._setUpdateFlag(r.x,i)}setVector2(t,e){const r=dr.propertyNameToID(t);this.setVector2byIndex(r,e)}setVector2byIndex(t,e){const r=this._getParamsInfo(t);if(!r)return;let i=r.x;this._buffer[i++]=e.x,this._buffer[i++]=e.y,this._setUpdateFlag(r.x,i)}setVector3(t,e){const r=dr.propertyNameToID(t);this.setVector3byIndex(r,e)}setVector3byIndex(t,e){const r=this._getParamsInfo(t);if(!r)return;let i=r.x;this._buffer[i++]=e.x,this._buffer[i++]=e.y,this._buffer[i++]=e.z,this._setUpdateFlag(r.x,i)}setVector4(t,e){const r=dr.propertyNameToID(t);this.setVector4byIndex(r,e)}setVector4byIndex(t,e){const r=this._getParamsInfo(t);if(!r)return;let i=r.x;this._buffer[i++]=e.x,this._buffer[i++]=e.y,this._buffer[i++]=e.z,this._buffer[i++]=e.w,this._setUpdateFlag(r.x,i)}setColor(t,e){const r=dr.propertyNameToID(t);this.setColorbyIndex(r,e)}setColorbyIndex(t,e){const r=this._getParamsInfo(t);if(!r)return;let i=r.x;this._buffer[i++]=_t.gammaToLinearSpace(e.r),this._buffer[i++]=_t.gammaToLinearSpace(e.g),this._buffer[i++]=_t.gammaToLinearSpace(e.b),this._buffer[i++]=_t.gammaToLinearSpace(e.a),this._setUpdateFlag(r.x,i)}setMatrix(t,e){const r=dr.propertyNameToID(t);this.setMatrixbyIndex(r,e)}setMatrixbyIndex(t,e){const r=this._getParamsInfo(t);if(!r)return;let i=r.x;this._buffer.set(e.elements,i),i+=16,this._setUpdateFlag(r.x,i)}clone(){let t=new rr(this._uniformParamsState);return this.cloneTo(t),t}cloneTo(t){t._bytelength==this._bytelength&&(t._buffer=Float32Array.from(this._buffer),this._updateFlag.setValue(0,this._buffer.length))}}class ir{}class sr{constructor(t,e,r){this._owner=t,this.name=e,this._VS=r.vsNode,this._PS=r.psNode,this._defs=r.defs,this._validDefine=l.unitRenderModuleDataFactory.createDefineDatas();for(let t of r.defs)this._validDefine.add(dr.getDefineByName(t))}withCompile(t){return null}}sr._defineStrings=[];class ar{get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}constructor(t,e,r,i){this._subShaderIndex=0,this._passIndex=0,this.setValue(t,e,r,i)}setValue(t,e,r,i){if(!t)throw"ShaderVariantInfo:Shader can't be null.";var s=t.getSubShaderAt(e);if(!s)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${e}.`;var a=s._passes[r];if(!a)throw`ShaderVariantInfo:Shader don't have passIndex of ${r}.`;for(var n=a._validDefine,l=0,o=i.length;l<o;l++){var h=i[l];if(!n.has(dr.getDefineByName(h)))throw`ShaderVariantInfo:Invalid defineName ${h} in ${t._name} subShaderIndex of ${e} passIndex of ${r}.`}this._shader=t,this._subShaderIndex=e,this._passIndex=r,this._defineNames=i}equal(t){if(this._shader!==t._shader||this._subShaderIndex!==t._subShaderIndex||this._passIndex!==t._passIndex)return!1;var e=this._defineNames,r=t._defineNames;if(e.length!==r.length)return!1;for(var i=0,s=this._defineNames.length;i<s;i++)if(e[i]!==r[i])return!1;return!0}clone(){return new ar(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class nr{constructor(t){this.items=t||{}}add(t,e){let r=t._owner._owner,i=r._subShaders.indexOf(t._owner),s=t._owner._passes.indexOf(t),a=t.nodeCommonMap;if(!a)return;e=e.filter((t=>!dr._configDefineValues.has(dr.getDefineByName(t))));let n=this.items[r._name];n||(n=[],this.items[r._name]=n),n.some((t=>t.subShaderIndex===i&&t.passIndex===s&&t.defines.length===e.length&&t.defines.every(((t,r)=>t===e[r]))&&t.nodeCommonMap.length===a.length&&t.nodeCommonMap.every(((t,e)=>t===a[e]))))||(n.push({subShaderIndex:i,passIndex:s,defines:e,nodeCommonMap:a.concat()}),console.debug(`Shader variant: ${r._name}/${i}/${s}/${e.join(",")}/${a?a.join(","):""}`))}compileAll(){let t=this.items;for(let e in t){let r=t[e];for(let t of r){let r=dr.compileShaderByDefineNames(e,t.subShaderIndex,t.passIndex,t.defines,t.nodeCommonMap),i=`${e}/${t.subShaderIndex}/${t.passIndex}/${t.defines.join(",")}/${t.nodeCommonMap?t.nodeCommonMap.join(","):""}`;r?console.debug("Warm up",i):console.warn("Warm up failed!",i)}}}}nr.active=new nr;class lr extends sr{get pipelineMode(){return this._pipelineMode}set pipelineMode(t){this._pipelineMode=t,this.moduleData.pipelineMode=t}set nodeCommonMap(t){this._nodeUniformCommonMap=t,this.moduleData.nodeCommonMap=t}get nodeCommonMap(){return this._nodeUniformCommonMap}get statefirst(){return this._statefirst}set statefirst(t){this._statefirst=t,this.moduleData.statefirst=t}get renderState(){return this.moduleData.renderState}constructor(t,e){super(t,null,e),this._statefirst=!1,this.moduleData=l.unitRenderModuleDataFactory.createShaderPass(this),this.moduleData.validDefine=this._validDefine}static createShaderInstance(t,e,r){let i=new ir;i.is2D=e,i.vs=t._VS,i.ps=t._PS,i.attributeMap=t._owner._attributeMap,i.uniformMap=t._owner._uniformMap;var s=sr._defineStrings;return s.length=0,dr._getNamesByDefineData(r,s),i.defineString=s,dr.debugMode&&nr.active.add(t,s),l.renderDeviceFactory.createShaderInstance(i,t)}withCompile(t,e=!1){var r=this.moduleData.getCacheShader(t);return r||(r=lr.createShaderInstance(this,e,t),this.moduleData.setCacheShader(t,r),r)}}lr._debugDefineStrings=[],lr._debugDefineMasks=[];class or{static __init__(){or.instanceWorldMatrixDeclaration=new Qt(64,[new Zt(0,$t.Vector4,or.MESH_WORLDMATRIX_ROW0),new Zt(16,$t.Vector4,or.MESH_WORLDMATRIX_ROW1),new Zt(32,$t.Vector4,or.MESH_WORLDMATRIX_ROW2),new Zt(48,$t.Vector4,or.MESH_WORLDMATRIX_ROW3)]),or.instanceSimpleAnimatorDeclaration=new Qt(16,[new Zt(0,$t.Vector4,or.MESH_SIMPLEANIMATOR)]),or.instanceLightMapScaleOffsetDeclaration=new Qt(16,[new Zt(0,$t.Vector4,or.MESH_LIGHTMAPSCALEOFFSET)])}static getVertexDeclaration(t,e=!0){var r=or._vertexDeclarationMap[t+(e?"_0":"_1")];if(!r){for(var i=t.split(","),s=0,a=[],n=0,l=i.length;n<l;n++){var o;switch(i[n]){case"POSITION":o=new Zt(s,$t.Vector3,or.MESH_POSITION0),s+=12;break;case"NORMAL":o=new Zt(s,$t.Vector3,or.MESH_NORMAL0),s+=12;break;case"COLOR":o=new Zt(s,$t.Vector4,or.MESH_COLOR0),s+=16;break;case"UV":o=new Zt(s,$t.Vector2,or.MESH_TEXTURECOORDINATE0),s+=8;break;case"UV1":o=new Zt(s,$t.Vector2,or.MESH_TEXTURECOORDINATE1),s+=8;break;case"BLENDWEIGHT":o=new Zt(s,$t.Vector4,or.MESH_BLENDWEIGHT0),s+=16;break;case"BLENDINDICES":e?(o=new Zt(s,$t.Vector4,or.MESH_BLENDINDICES0),s+=16):(o=new Zt(s,$t.Byte4,or.MESH_BLENDINDICES0),s+=4);break;case"TANGENT":o=new Zt(s,$t.Vector4,or.MESH_TANGENT0),s+=16;break;case"NORMAL_BYTE":o=new Zt(s,$t.NorByte4,or.MESH_NORMAL0),s+=4;break;default:throw"VertexMesh: unknown vertex flag."}a.push(o)}r=new Qt(s,a),or._vertexDeclarationMap[t+(e?"_0":"_1")]=r}return r}}or.MESH_POSITION0=0,or.MESH_COLOR0=1,or.MESH_TEXTURECOORDINATE0=2,or.MESH_NORMAL0=3,or.MESH_TANGENT0=4,or.MESH_BLENDINDICES0=5,or.MESH_BLENDWEIGHT0=6,or.MESH_TEXTURECOORDINATE1=7,or.MESH_WORLDMATRIX_ROW0=8,or.MESH_WORLDMATRIX_ROW1=9,or.MESH_WORLDMATRIX_ROW2=10,or.MESH_WORLDMATRIX_ROW3=11,or.MESH_SIMPLEANIMATOR=12,or.MESH_LIGHTMAPSCALEOFFSET=13,or.MESH_CUSTOME0=12,or.MESH_CUSTOME1=13,or.MESH_CUSTOME2=14,or.MESH_CUSTOME3=15,or._vertexDeclarationMap={};class hr{static regIncludeBindUnifrom(t,e,r){let i={},s=i[t]={};s.uniformMap=e,s.defaultValue=r,Object.assign(hr.IncludeUniformMap,i)}constructor(e=hr.DefaultAttributeMap,r={},i=null){this._uniformBufferDataMap=new Map,this._flags={},this._passes=[],this.moduleData=l.unitRenderModuleDataFactory.createSubShader(),this._attributeMap=e,this._uniformMap=r,this._uniformDefaultValue=i,this._uniformTypeMap=new Map;for(const e in r)if("object"==typeof r[e]){let t=r[e],i=new Map;for(const e in t){let r=ur(t[e]);i.set(e,r),this._uniformTypeMap.set(e,t[e])}let s=new Map;i.forEach(((t,e)=>{s.set(dr.propertyNameToID(e),t)}));let a=new rr(s);this._uniformBufferDataMap.set(e,a)}else{let i=r[e];if(this._uniformTypeMap.set(e,i),i==t.ShaderDataType.Texture2D||i==t.ShaderDataType.TextureCube||i==t.ShaderDataType.Texture3D||i==t.ShaderDataType.Texture2DArray){let t=dr.getDefineByName(`Gamma_${e}`),r=dr.propertyNameToID(e);l.renderEngine.addTexGammaDefine(r,t)}}}addShaderPass(t,e,r="Forward"){return this._addShaderPass(Me.compile(t,e),r)}_addShaderPass(t,e="Forward"){var r=new lr(this,t);return r.pipelineMode=e,this._passes.push(r),this.moduleData.addShaderPass(r.moduleData),this._addIncludeUniform(t.includeNames),r}_addIncludeUniform(t){for(let r of t)if(hr.IncludeUniformMap[r]){let t=hr.IncludeUniformMap[r],i=t.uniformMap,s=t.defaultValue;for(var e in i)this._uniformTypeMap.has(e)||(this._uniformTypeMap.set(e,i[e]),this._uniformMap[e]=i[e]);for(var e in s)this._uniformDefaultValue[e]||(this._uniformDefaultValue[e]=s[e])}}}function ur(e){switch(e){case t.ShaderDataType.Float:return t.UniformBufferParamsType.Number;case t.ShaderDataType.Vector2:return t.UniformBufferParamsType.Vector2;case t.ShaderDataType.Vector3:return t.UniformBufferParamsType.Vector3;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:return t.UniformBufferParamsType.Vector4;case t.ShaderDataType.Matrix4x4:return t.UniformBufferParamsType.Matrix4x4;default:throw"ShaderDataType can not be in UniformBuffer."}}hr.IncludeUniformMap={},hr.DefaultAttributeMap={a_Position:[or.MESH_POSITION0,t.ShaderDataType.Vector4],a_Normal:[or.MESH_NORMAL0,t.ShaderDataType.Vector3],a_Tangent0:[or.MESH_TANGENT0,t.ShaderDataType.Vector4],a_Texcoord0:[or.MESH_TEXTURECOORDINATE0,t.ShaderDataType.Vector2],a_Texcoord1:[or.MESH_TEXTURECOORDINATE1,t.ShaderDataType.Vector2],a_Color:[or.MESH_COLOR0,t.ShaderDataType.Vector4],a_BoneWeights:[or.MESH_BLENDWEIGHT0,t.ShaderDataType.Vector4],a_BoneIndices:[or.MESH_BLENDINDICES0,t.ShaderDataType.Vector4],a_WorldMat:[or.MESH_WORLDMATRIX_ROW0,t.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[or.MESH_SIMPLEANIMATOR,t.ShaderDataType.Vector4],a_LightmapScaleOffset:[or.MESH_LIGHTMAPSCALEOFFSET,t.ShaderDataType.Vector4]},t.ShaderFeatureType=void 0,(tr=t.ShaderFeatureType||(t.ShaderFeatureType={}))[tr.DEFAULT=0]="DEFAULT",tr[tr.D3=1]="D3",tr[tr.D2=2]="D2",tr[tr.PostProcess=3]="PostProcess",tr[tr.Sky=4]="Sky",tr[tr.Effect=5]="Effect";class dr{static init(){dr._configDefineValues=l.unitRenderModuleDataFactory.createDefineDatas(),dr.SHADERDEFINE_BLITSCREEN_INVERTY=dr.getDefineByName("BLITSCREEN_INVERTY"),dr.SHADERDEFINE_REMAP_POSITIONZ=dr.getDefineByName("REMAP_Z"),dr.SHADERDEFINE_LOD_TEXTURE_SAMPLE=dr.getDefineByName("LOD_TEXTURE_SAMPLE"),dr.SHADERDEFINE_BREAK_TEXTURE_SAMPLE=dr.getDefineByName("BREAK_TEXTURE_SAMPLE"),l.renderEngine._remapZ&&dr._configDefineValues.add(dr.SHADERDEFINE_REMAP_POSITIONZ),l.renderEngine._screenInvertY,l.renderEngine._lodTextureSample&&dr._configDefineValues.add(dr.SHADERDEFINE_LOD_TEXTURE_SAMPLE),l.renderEngine._breakTextureSample&&dr._configDefineValues.add(dr.SHADERDEFINE_BREAK_TEXTURE_SAMPLE),dr._compileDefineDatas=l.unitRenderModuleDataFactory.createDefineDatas()}static _getNamesByDefineData(t,e){return l.renderEngine.getNamesByDefineData(t,e),e}static getDefineByName(t){return l.renderEngine.getDefineByName(t)}static propertyNameToID(t){return l.renderEngine.propertyNameToID(t)}static propertyIDToName(t){return l.renderEngine.propertyIDToName(t)}static addInclude(t,e){Me.addInclude(t,e)}static compileShaderByDefineNames(t,e,r,i,s){var a=dr.find(t);if(a){var n=a.getSubShaderAt(e);if(n){var l=n._passes[r];if(l.nodeCommonMap=s,l){var o=dr._compileDefineDatas;dr._configDefineValues.cloneTo(o);for(let t of i)o.add(dr.getDefineByName(t));return l.withCompile(o),!0}}}return!1}static add(t,e=!1,r=!1){return dr._preCompileShader[t]=new dr(t,e,r)}static find(t){return dr._preCompileShader[t]}static parse(t,e){var r;t.name||console.warn("shader name is empty",t),t.uniformMap||console.warn(`${t.name}: uniformMap is empty`);let i=dr.add(t.name,t.enableInstancing,t.supportReflectionProbe);i._surportVolumetricGI=t.surportVolumetricGI;let s=new hr(t.attributeMap?t.attributeMap:hr.DefaultAttributeMap,t.uniformMap,t.defaultValue);i.addSubShader(s);let a=t.shaderPass;for(var n in a){let i=a[n];if(!i.VS){console.warn(`${t.name}: VS of pass ${n} is empty`);continue}if(!i.FS){console.warn(`${t.name}: FS of pass ${n} is empty`);continue}let l=s._addShaderPass(Me.compile(i.VS,i.FS,e),i.pipeline);l.statefirst=null!==(r=i.statefirst)&&void 0!==r&&r,Me.getRenderState(i.renderState,l.renderState)}return i}get name(){return this._name}constructor(t,e,r){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._surportVolumetricGI=!1,this._subShaders=[],this._name=t,this._enableInstancing=e,this._supportReflectionProbe=r}addSubShader(t){this._subShaders.push(t),t._owner=this,t.moduleData.enableInstance=this._enableInstancing}getSubShaderAt(t){return this._subShaders[t]}}dr.PERIOD_CUSTOM=0,dr.PERIOD_MATERIAL=1,dr.PERIOD_SPRITE=2,dr.PERIOD_CAMERA=3,dr.PERIOD_SCENE=4,dr._propertyNameMap={},dr._propertyNameCounter=0,dr._preCompileShader={},dr.debugMode=!1;class cr{constructor(){this._controlPoints=[new i,new i,new i],this._calFun=this.getPoint2}_switchPoint(t,e){var r=this._controlPoints.shift();r.setTo(t,e),this._controlPoints.push(r)}getPoint2(t,e){var r=this._controlPoints[0],i=this._controlPoints[1],s=this._controlPoints[2],a=Math.pow(1-t,2)*r.x+2*t*(1-t)*i.x+Math.pow(t,2)*s.x,n=Math.pow(1-t,2)*r.y+2*t*(1-t)*i.y+Math.pow(t,2)*s.y;e.push(a,n)}getPoint3(t,e){var r=this._controlPoints[0],i=this._controlPoints[1],s=this._controlPoints[2],a=this._controlPoints[3],n=Math.pow(1-t,3)*r.x+3*i.x*t*(1-t)*(1-t)+3*s.x*t*t*(1-t)+a.x*Math.pow(t,3),l=Math.pow(1-t,3)*r.y+3*i.y*t*(1-t)*(1-t)+3*s.y*t*t*(1-t)+a.y*Math.pow(t,3);e.push(n,l)}insertPoints(t,e){var r,i;for(i=1/(t=t>0?t:5),r=0;r<=1;r+=i)this._calFun(r,e)}getBezierPoints(t,e=5,r=2){var s,a;if((a=t.length)<2*(r+1))return[];var n=[];switch(r){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=r;)this._controlPoints.push(i.create());for(s=0;s<2*r;s+=2)this._switchPoint(t[s],t[s+1]);for(s=2*r;s<a;s+=2)this._switchPoint(t[s],t[s+1]),s/2%r==0&&this.insertPoints(e,n);return n}}cr.I=new cr;class _r{static __init__(){}static setDepthTest(t){l.renderEngine._GLRenderState.setDepthTest(t)}static setDepthMask(t){l.renderEngine._GLRenderState.setDepthMask(t)}static setDepthFunc(t){l.renderEngine._GLRenderState.setDepthFunc(t)}static setStencilTest(t){l.renderEngine._GLRenderState.setStencilTest(t)}static setStencilMask(t){l.renderEngine._GLRenderState.setStencilMask(t)}static setStencilFunc(t,e){l.renderEngine._GLRenderState.setStencilFunc(t,e)}static setstencilOp(t,e,r){l.renderEngine._GLRenderState.setstencilOp(t,e,r)}static setBlend(t){l.renderEngine._GLRenderState.setBlend(t)}static setBlendEquation(t){l.renderEngine._GLRenderState.setBlendEquation(t)}static setBlendEquationSeparate(t,e){l.renderEngine._GLRenderState.setBlendEquationSeparate(t,e)}static setBlendFunc(t,e){l.renderEngine._GLRenderState.setBlendFunc(t,e)}static setBlendFuncSeperate(t,e,r,i){l.renderEngine._GLRenderState.setBlendFuncSeperate(t,e,r,i)}static setCullFace(t){l.renderEngine._GLRenderState.setCullFace(t)}static setFrontFace(t){l.renderEngine._GLRenderState.setFrontFace(t)}}_r.stencilFuncArray=new Array(2),_r.blendEquationSeparateArray=new Array(2),_r.blenfunArray=new Array(2),_r.blendFuncSeperateArray=new Array(4),_r.stencilOpArray=new Array(3);class pr{static _init_(){pr.fns=[pr.BlendNormal,pr.BlendAdd,pr.BlendMultiply,pr.BlendScreen,pr.BlendOverlay,pr.BlendLight,pr.BlendMask,pr.BlendDestinationOut,pr.BlendAddOld,pr.BlendSourceAlpha],pr.targetFns=[pr.BlendNormalTarget,pr.BlendAddTarget,pr.BlendMultiplyTarget,pr.BlendScreenTarget,pr.BlendOverlayTarget,pr.BlendLightTarget,pr.BlendMask,pr.BlendDestinationOut,pr.BlendAddTargetOld,pr.BlendSourceAlpha]}static BlendNormal(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha)}static BlendAddOld(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.DestinationAlpha)}static BlendAdd(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendMultiply(){_r.setBlendFunc(t.BlendFactor.DestinationColor,t.BlendFactor.OneMinusSourceAlpha)}static BlendScreen(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendOverlay(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha)}static BlendLight(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendNormalTarget(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha)}static BlendAddTargetOld(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.DestinationAlpha)}static BlendAddTarget(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendMultiplyTarget(){_r.setBlendFunc(t.BlendFactor.DestinationColor,t.BlendFactor.OneMinusSourceAlpha)}static BlendScreenTarget(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendOverlayTarget(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceColor)}static BlendLightTarget(){_r.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendMask(){_r.setBlendFunc(t.BlendFactor.Zero,t.BlendFactor.SourceAlpha)}static BlendDestinationOut(){_r.setBlendFunc(t.BlendFactor.Zero,t.BlendFactor.Zero)}static BlendSourceAlpha(){_r.setBlendFunc(t.BlendFactor.SourceAlpha,t.BlendFactor.OneMinusSourceAlpha)}}pr.activeBlendFunction=null,pr.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],pr.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},pr.NORMAL="normal",pr.MASK="mask",pr.LIGHTER="lighter";const fr={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"};class gr{constructor(t){if(this.arrColor=[],gr._DEFAULT||gr._initDefault(),null==t||"none"==t)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);let e;"string"==typeof t?(e=P.fromStringColor(t),this.strColor=t):(e=t,this.strColor=P.toHexColor(e)),this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&e)>>>24)/255,((16711680&e)>>16)/255,((65280&e)>>8)/255,(255&e)/255],this.numColor=(4278190080&e)>>>24|(16711680&e)>>8|(65280&e)<<8|(255&e)<<24):(this.arrColor=[((16711680&e)>>16)/255,((65280&e)>>8)/255,(255&e)/255,1],this.numColor=4278190080|(16711680&e)>>16|65280&e|(255&e)<<16)}static _initDefault(){for(var t in gr._DEFAULT={},fr)gr._SAVE[t]=gr._DEFAULT[t]=new gr(fr[t]);return gr._DEFAULT}static _initSaveMap(){gr._SAVE_SIZE=0,gr._SAVE=Object.assign({},gr._DEFAULT)}static create(t){let e=t+"",r=gr._SAVE[e];return null!=r?r:(gr._SAVE_SIZE>500&&gr._initSaveMap(),gr._SAVE_SIZE++,gr._SAVE[e]=new gr(t))}}gr._SAVE={},gr._SAVE_SIZE=0;class mr{static _Defaultinit(){mr.DEFAULT=new mr("#000000")}static create(t){if(t){var e=t instanceof gr?t:gr.create(t);return e._drawStyle||(e._drawStyle=new mr(t))}return mr.DEFAULT}constructor(t){this.setValue(t)}setValue(t){this._color=t?t instanceof gr?t:gr.create(t):gr.create("#000000")}reset(){this._color=gr.create("#000000")}toInt(){return this._color.numColor}equal(t){return"string"==typeof t?this._color.strColor===t:t instanceof gr&&this._color.numColor===t.numColor}toColorStr(){return this._color.strColor}}class yr{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(t){this.paths.length=1,this._curPath=this.paths[0]=new Tr,this._curPath.convex=t}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new Tr,this.paths.push(this._curPath)}addPoint(t,e){this._curPath.path.push(t,e)}push(t,e){this._curPath?this._curPath.path.length>0&&(this._curPath=new Tr,this.paths.push(this._curPath)):(this._curPath=new Tr,this.paths.push(this._curPath));var r=this._curPath;r.path=t.slice(),r.convex=e}reset(){this.paths.length=0}}class Tr{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class xr{constructor(){}static _createArray(){var t=[];return t._length=0,t}static _init(){var t=xr._namemap={};return t[xr.TYPE_ALPHA]="ALPHA",t[xr.TYPE_FILESTYLE]="fillStyle",t[xr.TYPE_FONT]="font",t[xr.TYPE_LINEWIDTH]="lineWidth",t[xr.TYPE_STROKESTYLE]="strokeStyle",t[xr.TYPE_ENABLEMERGE]="_mergeID",t[xr.TYPE_MARK]=t[xr.TYPE_TRANSFORM]=t[xr.TYPE_TRANSLATE]=[],t[xr.TYPE_TEXTBASELINE]="textBaseline",t[xr.TYPE_TEXTALIGN]="textAlign",t[xr.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",t[xr.TYPE_SHADER]="shader",t[xr.TYPE_FILTERS]="filters",t[xr.TYPE_COLORFILTER]="_colorFiler",t}isSaveMark(){return!1}restore(t){this._dataObj[this._valueName]=this._value,xr.POOL[xr.POOL._length++]=this,this._newSubmit&&(t.stopMerge=!0)}static save(t,e,r,i){if((t._saveMark._saveuse&e)!==e){t._saveMark._saveuse|=e;var s=xr.POOL,a=s._length>0?s[--s._length]:new xr;a._value=r[a._valueName=xr._namemap[e]],a._dataObj=r,a._newSubmit=i;var n=t._save;n[n._length++]=a}}}xr.TYPE_ALPHA=1,xr.TYPE_FILESTYLE=2,xr.TYPE_FONT=8,xr.TYPE_LINEWIDTH=256,xr.TYPE_STROKESTYLE=512,xr.TYPE_MARK=1024,xr.TYPE_TRANSFORM=2048,xr.TYPE_TRANSLATE=4096,xr.TYPE_ENABLEMERGE=8192,xr.TYPE_TEXTBASELINE=16384,xr.TYPE_TEXTALIGN=32768,xr.TYPE_GLOBALCOMPOSITEOPERATION=65536,xr.TYPE_CLIPRECT=131072,xr.TYPE_CLIPRECT_STENCIL=262144,xr.TYPE_IBVB=524288,xr.TYPE_SHADER=1048576,xr.TYPE_FILTERS=2097152,xr.TYPE_FILTERS_TYPE=4194304,xr.TYPE_COLORFILTER=8388608,xr.POOL=xr._createArray(),xr._namemap=xr._init();class vr{constructor(){this._globalClipMatrix=new G,this._clipInfoID=-1,this._clipRect=new F}isSaveMark(){return!1}restore(t){this._globalClipMatrix.copyTo(t._globalClipMatrix),this._clipRect.clone(t._clipRect),t._clipInfoID=this._clipInfoID,vr.POOL[vr.POOL._length++]=this}static save(t){if((t._saveMark._saveuse&xr.TYPE_CLIPRECT)!=xr.TYPE_CLIPRECT){t._saveMark._saveuse|=xr.TYPE_CLIPRECT;var e=vr.POOL,r=e._length>0?e[--e._length]:new vr;t._globalClipMatrix.copyTo(r._globalClipMatrix),t._clipRect.clone(r._clipRect),r._clipInfoID=t._clipInfoID;var i=t._save;i[i._length++]=r}}}vr.POOL=xr._createArray();class Sr{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(t){t._saveMark=this._preSaveMark,Sr.POOL[Sr.POOL._length++]=this}static Create(t){var e=Sr.POOL,r=e._length>0?e[--e._length]:new Sr;return r._saveuse=0,r._preSaveMark=t._saveMark,t._saveMark=r,r}}Sr.POOL=xr._createArray();class Er{constructor(){this._matrix=new G}isSaveMark(){return!1}restore(t){t._curMat=this._savematrix,Er.POOL[Er.POOL._length++]=this}static save(t){var e=t._saveMark;if((e._saveuse&xr.TYPE_TRANSFORM)!==xr.TYPE_TRANSFORM){e._saveuse|=xr.TYPE_TRANSFORM;var r=Er.POOL,i=r._length>0?r[--r._length]:new Er;i._savematrix=t._curMat,t._curMat=t._curMat.copyTo(i._matrix);var s=t._save;s[s._length++]=i}}}Er.POOL=xr._createArray();class wr{constructor(){this._mat=new G}isSaveMark(){return!1}restore(t){this._mat.copyTo(t._curMat),wr.POOL[wr.POOL._length++]=this}static save(t){var e=wr.POOL,r=e._length>0?e[--e._length]:new wr;t._curMat.copyTo(r._mat);var i=t._save;i[i._length++]=r}}wr.POOL=xr._createArray();var Dr;class br{destroy(){}static __init__(){dr.addInclude("Sprite2DFrag.glsl","vec3 gammaToLinear(in vec3 value)\r\n{\r\n    return pow((value + 0.055) / 1.055, vec3(2.4));\r\n}\r\n\r\nvec4 gammaToLinear(in vec4 value)\r\n{\r\n    return vec4(gammaToLinear(value.rgb), value.a);\r\n}\r\n\r\nvec3 linearToGamma(in vec3 value)\r\n{\r\n    return vec3(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))));\r\n\r\n    // return pow(value, vec3(1.0 / 2.2));\r\n    // return pow(value, vec3(0.455));\r\n}\r\n\r\nvec4 linearToGamma(in vec4 value)\r\n{\r\n    return vec4(linearToGamma(value.rgb), value.a);\r\n}\r\n\r\nvec4 transspaceColor(vec4 color)\r\n{\r\n     \r\n #ifndef GAMMATEXTURE\r\n     //是linear数据\r\n     #ifdef GAMMASPACE\r\n         color.xyz = linearToGamma(color.xyz);    \r\n     #endif\r\n #else\r\n     //gamma数据\r\n     #ifndef GAMMASPACE\r\n         color.xyz = gammaToLinear(color.xyz);\r\n     #endif\r\n #endif\r\n     return color;\r\n }\r\n\r\n#if defined(PRIMITIVEMESH)\r\n    varying vec4 v_color;\r\n    varying vec2 v_cliped;\r\n  \r\n\r\n    vec4 getGlColor(vec4 color){\r\n        #ifdef GAMMASPACE\r\n            return color;\r\n        #else\r\n            return gammaToLinear(color);\r\n        #endif\r\n    }\r\n\r\n#elif defined(TEXTUREVS)\r\n    varying vec2 v_cliped;\r\n    varying vec4 v_texcoordAlpha;\r\n    varying vec4 v_color;\r\n    varying float v_useTex;\r\n    \r\n    //uniform\r\n    uniform sampler2D u_spriteTexture;\r\n\r\n    #ifdef BLUR_FILTER\r\n        uniform vec4 u_strength_sig2_2sig2_gauss1; // TODO模糊的过程中会导致变暗变亮\r\n        uniform vec2 u_blurInfo;\r\n        #define PI 3.141593\r\n    #endif\r\n\r\n    #ifdef COLOR_FILTER\r\n        uniform vec4 u_colorAlpha;\r\n        uniform mat4 u_colorMat;\r\n    #endif\r\n\r\n    #ifdef GLOW_FILTER\r\n        uniform vec4 u_color;\r\n        uniform vec4 u_blurInfo1;\r\n        uniform vec4 u_blurInfo2;\r\n    #endif\r\n\r\n    #ifdef COLOR_ADD\r\n        uniform vec4 u_colorAdd;\r\n    #endif\r\n\r\n    #ifdef FILLTEXTURE\r\n        uniform vec4 u_TexRange; // startu,startv,urange, vrange\r\n    #endif\r\n\r\n\r\n    #ifdef BLUR_FILTER\r\n        float getGaussian(float x, float y)\r\n        {\r\n            return u_strength_sig2_2sig2_gauss1.w * exp(-(x * x + y * y) / u_strength_sig2_2sig2_gauss1.z);\r\n        }\r\n\r\n        vec4 blur()\r\n        {\r\n            const float blurw = 9.0;\r\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\r\n            vec2 halfsz = vec2(blurw, blurw) / 2.0 / u_blurInfo;\r\n            vec2 startpos = v_texcoordAlpha.xy - halfsz;\r\n            vec2 ctexcoord = startpos;\r\n            vec2 step = 1.0 / u_blurInfo; //每个像素\r\n\r\n            for (float y = 0.0; y <= blurw; ++y)\r\n            {\r\n                ctexcoord.x = startpos.x;\r\n                for (float x = 0.0; x <= blurw; ++x)\r\n                {\r\n                    // TODO 纹理坐标的固定偏移应该在vs中处理\r\n                    vec4Color +=transspaceColor(texture2D(u_spriteTexture, ctexcoord) * getGaussian(x - blurw / 2.0, y - blurw / 2.0));\r\n                    ctexcoord.x += step.x;\r\n                }\r\n                ctexcoord.y += step.y;\r\n            }\r\n            // vec4Color.w=1.0;  这个会导致丢失alpha。以后有时间再找模糊会导致透明的问题\r\n            return vec4Color;\r\n        }\r\n    #endif\r\n\r\n    vec4 getSpriteTextureColor(){\r\n        #ifdef FILLTEXTURE\r\n            vec4 color = texture2D(u_spriteTexture, fract(v_texcoordAlpha.xy) * u_TexRange.zw + u_TexRange.xy);\r\n        #else\r\n            vec4 color = texture2D(u_spriteTexture, v_texcoordAlpha.xy);\r\n        #endif\r\n        return transspaceColor(color);\r\n    }\r\n\r\n    void setglColor(in vec4 color){\r\n        if (v_useTex <= 0.)\r\n            color = vec4(1., 1., 1., 1.);\r\n\r\n        color.a *= v_color.w;\r\n        // color.rgb*=v_color.w;\r\n        vec4 transColor = v_color;\r\n        #ifndef GAMMASPACE\r\n            transColor = gammaToLinear(v_color);\r\n        #endif\r\n        color.rgb *= transColor.rgb;\r\n        gl_FragColor = color;\r\n\r\n        #ifdef COLOR_ADD\r\n            gl_FragColor = vec4(u_colorAdd.rgb, u_colorAdd.a * gl_FragColor.a);\r\n            gl_FragColor.xyz *= u_colorAdd.a;\r\n        #endif\r\n\r\n        #ifdef BLUR_FILTER\r\n            gl_FragColor = blur();\r\n            gl_FragColor.w *= v_color.w;\r\n        #endif\r\n\r\n        #ifdef COLOR_FILTER\r\n            mat4 alphaMat = u_colorMat;\r\n\r\n            alphaMat[0][3] *= gl_FragColor.a;\r\n            alphaMat[1][3] *= gl_FragColor.a;\r\n            alphaMat[2][3] *= gl_FragColor.a;\r\n\r\n            gl_FragColor = gl_FragColor * alphaMat;\r\n            gl_FragColor += u_colorAlpha / 255.0 * gl_FragColor.a;\r\n        #endif\r\n\r\n        #ifdef GLOW_FILTER\r\n            const float c_IterationTime = 10.0;\r\n            float floatIterationTotalTime = c_IterationTime * c_IterationTime;\r\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\r\n            vec2 vec2FilterDir = vec2(-u_blurInfo1.z / u_blurInfo2.x, -u_blurInfo1.w / u_blurInfo2.y);\r\n            vec2 vec2FilterOff = vec2(u_blurInfo1.x / u_blurInfo2.x / c_IterationTime * 2.0, u_blurInfo1.y / u_blurInfo2.y / c_IterationTime * 2.0);\r\n            float maxNum = u_blurInfo1.x * u_blurInfo1.y;\r\n            vec2 vec2Off = vec2(0.0, 0.0);\r\n            float floatOff = c_IterationTime / 2.0;\r\n            for (float i = 0.0; i <= c_IterationTime; ++i){\r\n                for (float j = 0.0; j <= c_IterationTime; ++j){\r\n                    vec2Off = vec2(vec2FilterOff.x * (i - floatOff), vec2FilterOff.y * (j - floatOff));\r\n                    vec4Color += transspaceColor(texture2D(u_spriteTexture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off))  ;\r\n                }\r\n            }\r\n            vec4Color /= floatIterationTotalTime;\r\n            gl_FragColor = vec4(u_color.rgb, vec4Color.a * u_blurInfo2.z);\r\n            gl_FragColor.rgb *= gl_FragColor.a;\r\n        #endif\r\n    }\r\n#endif\r\n\r\n\r\n\r\nvoid clip(){\r\n    if(v_cliped.x<0.) discard;\r\n    if(v_cliped.x>1.) discard;\r\n    if(v_cliped.y<0.) discard;\r\n    if(v_cliped.y>1.) discard;\r\n}"),dr.addInclude("Sprite2DVertex.glsl",'#include "Sprite2DShaderInfo.glsl";\r\nuniform vec4 u_clipMatDir;\r\nuniform vec2 u_clipMatPos;// 这个是全局的，不用再应用矩阵了。\r\nuniform vec2 u_size;\r\nuniform float u_VertAlpha;\r\nvarying vec2 v_cliped;\r\n#ifdef WORLDMAT\r\n    uniform mat4 u_mmat;\r\n    vec4 transedPos;\r\n#endif\r\nvarying vec4 v_color;\r\n\r\n\r\n#if defined(PRIMITIVEMESH)\r\n    // attribute vec4 a_position;\r\n    // attribute vec4 a_attribColor;\r\n\r\n    void getVertexInfo(inout vertexInfo info){\r\n        info.color = a_attribColor;\r\n        info.color.a*=u_VertAlpha;\r\n        float clipw = length(u_clipMatDir.xy);\r\n        float cliph = length(u_clipMatDir.zw);\r\n        #ifdef WORLDMAT\r\n            vec2 clippos = transedPos.xy - u_clipMatPos.xy;\r\n        #else\r\n        vec2 clippos = a_position.xy - u_clipMatPos.xy;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\r\n        #endif\r\n\r\n        if(clipw>20000. && cliph>20000.)\r\n            info.cliped = vec2(0.5,0.5);\r\n        else {\r\n            //clipdir是带缩放的方向，由于上面clippos是在缩放后的空间计算的，所以需要把方向先normalize一下\r\n            info.cliped =vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\r\n        }\r\n    }\r\n\r\n    void getPosition(inout vec4 pos){\r\n        pos = vec4(a_position.xy,0.,1.);\r\n        #ifdef WORLDMAT\r\n            pos = u_mmat*pos;\r\n            transedPos=pos;\r\n            pos = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,pos.z,1.0);\r\n        #else\r\n            pos = vec4((a_position.x/u_size.x-0.5)*2.0,(0.5-a_position.y/u_size.y)*2.0,a_position.z,1.0);\r\n        #endif\r\n    }\r\n\r\n#elif defined(TEXTUREVS)\r\n\t//texture和fillrect使用的。\r\n    // attribute vec4 a_posuv;\r\n    // attribute vec4 a_attribColor;\r\n    // attribute vec4 a_attribFlags;\r\n    #ifdef MVP3D\r\n        uniform mat4 u_MvpMatrix;\r\n    #endif\r\n\r\n    varying vec4 v_texcoordAlpha;\r\n    varying float v_useTex;\r\n\r\n    void getVertexInfo(inout vertexInfo info){\r\n       \t//texcoordAlpha\r\n        info.texcoordAlpha.xy = a_posuv.zw;\r\n        //color\r\n        info.color = a_attribColor;\r\n        info.color.a*=u_VertAlpha;\r\n\t    info.color.xyz*= info.color.w;//反正后面也要预乘\r\n        //useTex\r\n        info.useTex = a_attribFlags.r;\r\n\r\n        //clip\r\n    \tfloat clipw = length(u_clipMatDir.xy);\r\n    \tfloat cliph = length(u_clipMatDir.zw);\r\n\t    vec2 clpos = u_clipMatPos.xy;\r\n        #ifdef WORLDMAT\r\n            vec2 clippos = transedPos.xy - clpos;\r\n        #else\r\n        vec2 clippos = a_posuv.xy - clpos;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\r\n        #endif\r\n        if(clipw>20000. && cliph>20000.)\r\n            info.cliped = vec2(0.5,0.5);\r\n        else {\r\n            //转成0到1之间。/clipw/clipw 表示clippos与normalize之后的clip朝向点积之后，再除以clipw\r\n            info.cliped = vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\r\n        }\r\n    }\r\n\r\n    void getPosition(inout vec4 glPosition){\r\n        vec4 pos = vec4(a_posuv.xy,0.,1.);\r\n        #ifdef WORLDMAT\r\n            pos= u_mmat * pos;\r\n            transedPos=pos;//vec4(pos.x,pos.y,0.0,1.0);\r\n        #endif\r\n        vec4 pos1 = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,0.,1.0);\r\n        #ifdef MVP3D\r\n            glPosition = u_MvpMatrix * pos1;\r\n        #else\r\n            glPosition = pos1;\r\n        #endif\r\n        \r\n        #ifdef INVERTY\r\n            glPosition.y = -glPosition.y;\r\n        #endif\r\n    }\r\n\r\n#endif'),dr.addInclude("Sprite2DShaderInfo.glsl","\r\n#if defined(PRIMITIVEMESH)\r\n    struct vertexInfo {\r\n        vec4 color;\r\n        vec2 cliped;\r\n    };\r\n#elif defined(TEXTUREVS)\r\n   struct vertexInfo {\r\n        vec4 color;\r\n        vec2 cliped;\r\n        vec4 texcoordAlpha;\r\n        float useTex;\r\n    };\r\n#endif"),br.textureShader=dr.add("Sprite2DTexture",!1,!1),br.textureShader.shaderType=t.ShaderFeatureType.D2;let e=new hr(br.textureAttribute,{},{});br.textureShader.addSubShader(e),e.addShaderPass('#define SHADER_NAME TextureVS2D\r\n#include "Sprite2DVertex.glsl";\r\n\r\nvoid main() {\r\n\tvec4 pos;\r\n\t//先计算位置，再做裁剪\r\n\tgetPosition(pos);\r\n\tvertexInfo info;\r\n\tgetVertexInfo(info);\r\n\r\n\tv_cliped = info.cliped;\r\n\tv_texcoordAlpha = info.texcoordAlpha;\r\n\tv_useTex = info.useTex;\r\n\tv_color = info.color;\r\n\r\n\tgl_Position = pos;\r\n\r\n}\r\n','#define SHADER_NAME TextureFS2D\r\n//texture和fillrect使用的。\r\n#if defined(GL_FRAGMENT_PRECISION_HIGH) // 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\n#include "Sprite2DFrag.glsl";\r\n\r\nvoid main()\r\n{\r\n    clip();\r\n    vec4 color = getSpriteTextureColor();\r\n    setglColor(color);\r\n}\r\n'),br.primitiveShader=dr.add("Sprite2DPrimitive",!1,!1),br.primitiveShader.shaderType=t.ShaderFeatureType.D2,e=new hr(br.primitiveAttribute,{},{}),br.primitiveShader.addSubShader(e),e.addShaderPass('#define SHADER_NAME PrimitiveVS2D\r\n#include "Sprite2DVertex.glsl";\r\n\r\n\r\n#ifdef WORLDMAT\r\n\tuniform mat4 mmat;\r\n#endif\r\n\r\nvoid main(){\r\n\tvec4 pos;\r\n\t//先计算位置，再做裁剪\r\n\tgetPosition(pos);\r\n\tvertexInfo info;\r\n\tgetVertexInfo(info);\r\n\t\r\n\t//Update \r\n\tv_color = info.color;\r\n\tv_cliped = info.cliped;\r\n\t\r\n\tgl_Position = pos;\r\n}','#define SHADER_NAME PrimitiveFS2D\r\nprecision mediump float;\r\n\r\n#include "Sprite2DFrag.glsl";\r\n\r\nvoid main(){\r\n\tclip();\r\n\tgl_FragColor = getGlColor(v_color);\r\n\tgl_FragColor.rgb*=gl_FragColor.a;\r\n}')}}br.primitiveAttribute={a_position:[0,t.ShaderDataType.Vector4],a_attribColor:[1,t.ShaderDataType.Vector4]},br.textureAttribute={a_posuv:[0,t.ShaderDataType.Vector4],a_attribColor:[1,t.ShaderDataType.Vector4],a_attribFlags:[2,t.ShaderDataType.Vector4]};class Rr{static __init__(){Rr.TEXTURE2D=dr.getDefineByName("TEXTURE2D"),Rr.PRIMITIVE=dr.getDefineByName("PRIMITIVE"),Rr.FILTERGLOW=dr.getDefineByName("GLOW_FILTER"),Rr.FILTERBLUR=dr.getDefineByName("BLUR_FILTER"),Rr.FILTERCOLOR=dr.getDefineByName("COLOR_FILTER"),Rr.COLORADD=dr.getDefineByName("COLOR_ADD"),Rr.WORLDMAT=dr.getDefineByName("WORLDMAT"),Rr.FILLTEXTURE=dr.getDefineByName("FILLTEXTURE"),Rr.MVP3D=dr.getDefineByName("MVP3D"),Rr.GAMMASPACE=dr.getDefineByName("GAMMASPACE"),Rr.INVERTY=dr.getDefineByName("INVERTY"),Rr.GAMMATEXTURE=dr.getDefineByName("GAMMATEXTURE"),Rr.TEXTURESHADER=dr.getDefineByName("TEXTUREVS"),Rr.PRIMITIVESHADER=dr.getDefineByName("PRIMITIVEMESH"),Rr.initSprite2DCommandEncoder()}static initSprite2DCommandEncoder(){Rr.UNIFORM_MMAT=dr.propertyNameToID("u_mmat"),Rr.UNIFORM_CLIPMATDIR=dr.propertyNameToID("u_clipMatDir"),Rr.UNIFORM_CLIPMATPOS=dr.propertyNameToID("u_clipMatPos"),Rr.UNIFORM_MMAT2=dr.propertyNameToID("u_mmat2"),Rr.UNIFORM_SIZE=dr.propertyNameToID("u_size"),Rr.UNIFORM_VERTALPHA=dr.propertyNameToID("u_VertAlpha"),Rr.UNIFORM_MVPMatrix=dr.propertyNameToID("u_MvpMatrix"),Rr.UNIFORM_SPRITETEXTURE=dr.propertyNameToID("u_spriteTexture"),Rr.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1=dr.propertyNameToID("u_strength_sig2_2sig2_gauss1"),Rr.UNIFORM_BLURINFO=dr.propertyNameToID("u_blurInfo"),Rr.UNIFORM_COLORALPHA=dr.propertyNameToID("u_colorAlpha"),Rr.UNIFORM_COLORMAT=dr.propertyNameToID("u_colorMat"),Rr.UNIFORM_COLOR=dr.propertyNameToID("u_color"),Rr.UNIFORM_BLURINFO1=dr.propertyNameToID("u_blurInfo1"),Rr.UNIFORM_BLURINFO2=dr.propertyNameToID("u_blurInfo2"),Rr.UNIFORM_COLORADD=dr.propertyNameToID("u_colorAdd"),Rr.UNIFORM_TEXRANGE=dr.propertyNameToID("u_TexRange");const e=l.renderDeviceFactory.createGlobalUniformMap("Sprite2D");e.addShaderUniform(Rr.UNIFORM_MMAT,"u_mmat",t.ShaderDataType.Matrix4x4),e.addShaderUniform(Rr.UNIFORM_CLIPMATDIR,"u_clipMatDir",t.ShaderDataType.Vector4),e.addShaderUniform(Rr.UNIFORM_CLIPMATPOS,"u_clipMatPos",t.ShaderDataType.Vector2),e.addShaderUniform(Rr.UNIFORM_MMAT2,"u_mmat2",t.ShaderDataType.Matrix4x4),e.addShaderUniform(Rr.UNIFORM_SIZE,"u_size",t.ShaderDataType.Vector2),e.addShaderUniform(Rr.UNIFORM_VERTALPHA,"u_VertAlpha",t.ShaderDataType.Float),e.addShaderUniform(Rr.UNIFORM_MVPMatrix,"u_MvpMatrix",t.ShaderDataType.Matrix4x4),e.addShaderUniform(Rr.UNIFORM_SPRITETEXTURE,"u_spriteTexture",t.ShaderDataType.Texture2D),e.addShaderUniform(Rr.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,"u_strength_sig2_2sig2_gauss1",t.ShaderDataType.Vector4),e.addShaderUniform(Rr.UNIFORM_BLURINFO,"u_blurInfo",t.ShaderDataType.Vector2),e.addShaderUniform(Rr.UNIFORM_COLORALPHA,"u_colorAlpha",t.ShaderDataType.Vector4),e.addShaderUniform(Rr.UNIFORM_COLORMAT,"u_colorMat",t.ShaderDataType.Matrix4x4),e.addShaderUniform(Rr.UNIFORM_COLOR,"u_color",t.ShaderDataType.Vector4),e.addShaderUniform(Rr.UNIFORM_BLURINFO1,"u_blurInfo1",t.ShaderDataType.Vector4),e.addShaderUniform(Rr.UNIFORM_BLURINFO2,"u_blurInfo2",t.ShaderDataType.Vector4),e.addShaderUniform(Rr.UNIFORM_COLORADD,"u_colorAdd",t.ShaderDataType.Vector4),e.addShaderUniform(Rr.UNIFORM_TEXRANGE,"u_TexRange",t.ShaderDataType.Vector4)}}t.RenderSpriteData=void 0,(Dr=t.RenderSpriteData||(t.RenderSpriteData={}))[Dr.Zero=0]="Zero",Dr[Dr.Texture2D=1]="Texture2D",Dr[Dr.Primitive=2]="Primitive";class Cr{constructor(e){this._needRelease=!1,this.mainID=t.RenderSpriteData.Zero,this.ref=1,this._cacheID=0,this.mainID=e,Cr.prototype.initialize.call(this)}initialize(){let e=this.mainID;this.shaderData=this.shaderData||l.renderDeviceFactory.createShaderData(null),this.mainID==t.RenderSpriteData.Texture2D&&this.shaderData.addDefine(Rr.TEXTURESHADER),this.mainID==t.RenderSpriteData.Primitive&&this.shaderData.addDefine(Rr.PRIMITIVESHADER),this.textureHost=null,this.clipMatDir=new u(Ut.MAX_CLIP_SIZE,0,0,Ut.MAX_CLIP_SIZE),this.clipMatPos=new Qe,this._cacheID=e;let r=Cr._cache[this._cacheID];e>0&&!r&&(r=Cr._cache[this._cacheID]=[],r._length=0),this.shaderData.setBool(dr.DEPTH_WRITE,!1),this.shaderData.setInt(dr.DEPTH_TEST,xe.DEPTHTEST_OFF),this.shaderData.setInt(dr.BLEND,xe.BLEND_ENABLE_ALL),this.shaderData.setInt(dr.BLEND_EQUATION,xe.BLENDEQUATION_ADD),this.shaderData.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ONE),this.shaderData.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA),this.shaderData.setNumber(Rr.UNIFORM_VERTALPHA,1),this.shaderData.setInt(dr.CULL,xe.CULL_NONE)}reinit(){this.initialize()}static _initone(t,e){Cr._compileDefine=l.unitRenderModuleDataFactory.createDefineDatas(),Cr._typeClass[t]=e,Cr._cache[t]=[],Cr._cache[t]._length=0}static create(t){var e=Cr._cache[t]?Cr._cache[t]:[];if(e._length){let t=e[--e._length];return t.reinit(),t}return new Cr._typeClass[t]}set size(t){this.shaderData.setVector2(Rr.UNIFORM_SIZE,t)}get size(){return this.shaderData.getVector2(Rr.UNIFORM_SIZE)}set vertAlpha(t){this.shaderData.setNumber(Rr.UNIFORM_VERTALPHA,t)}get vertAlpha(){return this.shaderData.getNumber(Rr.UNIFORM_VERTALPHA)}set mmat(t){this.shaderData.setMatrix4x4(Rr.UNIFORM_MMAT,t)}get mmat(){return this.shaderData.getMatrix4x4(Rr.UNIFORM_MMAT)}set u_MvpMatrix(t){this.shaderData.setMatrix4x4(Rr.UNIFORM_MVPMatrix,t)}get u_MvpMatrix(){return this.shaderData.getMatrix4x4(Rr.UNIFORM_MVPMatrix)}get textureHost(){return this._textureHost}set textureHost(t){this._textureHost=t;let e,r=!1;this.textureHost&&(this.textureHost instanceof R?r=1!=this.textureHost.gammaCorrection:this.textureHost instanceof mt&&this.textureHost.bitmap&&(r=1!=this.textureHost.bitmap.gammaCorrection)),r?this.shaderData.addDefine(Rr.GAMMATEXTURE):this.shaderData.removeDefine(Rr.GAMMATEXTURE),e=t instanceof mt?t.bitmap:t,this.shaderData.setTexture(Rr.UNIFORM_SPRITETEXTURE,e)}set color(t){t&&this.shaderData.setVector(Rr.UNIFORM_COLOR,t)}get color(){return this.shaderData.getVector(Rr.UNIFORM_COLOR)}set colorAdd(t){this.shaderData.setVector(Rr.UNIFORM_COLORADD,t)}get colorAdd(){return this.shaderData.getVector(Rr.UNIFORM_COLORADD)}set clipMatDir(t){this.shaderData.setVector(Rr.UNIFORM_CLIPMATDIR,t)}get clipMatDir(){return this.shaderData.getVector(Rr.UNIFORM_CLIPMATDIR)}set clipMatPos(t){this.shaderData.setVector2(Rr.UNIFORM_CLIPMATPOS,t)}get clipMatPos(){return this.shaderData.getVector2(Rr.UNIFORM_CLIPMATPOS)}upload(t,e){}setFilter(t){t&&this.shaderData.addDefine(t.typeDefine)}clear(){this.shaderData&&this.shaderData.clearDefine(),this.textureHost=null}blendNormal(){this.shaderData.setInt(dr.BLEND_SRC,xe.BLENDPARAM_SRC_ALPHA),this.shaderData.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}blendPremulAlpha(){this.shaderData.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ONE),this.shaderData.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}blendAdd(){this.shaderData.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ONE),this.shaderData.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE)}blendMask(){this.shaderData.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ZERO),this.shaderData.setInt(dr.BLEND_DST,xe.BLENDPARAM_SRC_ALPHA)}release(){if(--this.ref<1){let t=Cr._cache[this._cacheID];t&&(t[t._length++]=this),this.clear(),this.filters=null,this.ref=1}}}Cr._cache=[],Cr._typeClass=[];const Ar=15*Math.PI/180,Ir=new Array(256),Mr=new Array(4),Br=new Qe;class Lr{static _checkMinAngle(t,e,r,i,s,a){const n=r-t,l=i-e,o=s-r,h=a-i,u=(n*o+l*h)/(Math.sqrt(n*n+l*l)*Math.sqrt(o*o+h*h)),d=Math.acos(Math.abs(u));return Math.abs(d)<Ar}static createLine2(t,e,r,i,s,a){if(t.length<4)return null;let n=i;var l=Ir.length>t.length+2?Ir:new Array(t.length+2);l[0]=t[0],l[1]=t[1];var o=2,h=0,u=t.length;for(h=2;h<u;h+=2)Math.abs(t[h]-t[h-2])+Math.abs(t[h+1]-t[h-1])>.01&&(l[o++]=t[h],l[o++]=t[h+1]);let d=Math.abs(t[0]-l[o-2])+Math.abs(t[1]-l[o-1]);a&&d>0&&(d>1e-13?(l[o++]=t[0],l[o++]=t[1]):(l[o-2]=t[0],l[o-1]=t[1]));var c=s;u=o/2;var _,p,f,g,m,y,T=r/2;for(_=l[0],p=l[1],f=l[2],g=l[3],this.getNormal(_,p,f,g,T,Br),c.push(_-Br.x,p-Br.y,_+Br.x,p+Br.y),h=1;h<u-1;h++)_=l[2*(h-1)],p=l[2*(h-1)+1],f=l[2*h],g=l[2*h+1],m=l[2*(h+1)],y=l[2*(h+1)+1],e.push(i+0,i+1,i+3,i+3,i+2,i+0),i+=2,i+=this._setMiddleVertexs(_,p,f,g,m,y,T,c,Br,e,i);if(_=l[o-4],p=l[o-3],f=l[o-2],g=l[o-1],this.getNormal(_,p,f,g,T,Br),c.push(f-Br.x,g-Br.y,f+Br.x,g+Br.y),e.push(i+0,i+1,i+3,i+3,i+2,i+0),f==l[0]&&g==l[1]){m=l[2],y=l[3];let t=c.length/2;i+=4,Mr[0]=n+t-2,Mr[1]=n+t-1,Mr[2]=n,Mr[3]=n+1,this._setMiddleVertexs(_,p,f,g,m,y,T,c,Br,e,i,Mr)}return c}static _setMiddleVertexs(t,e,r,i,s,a,n,l,o,h,u,d=null){this.getNormal(t,e,r,i,n,o);let c=o.x,_=o.y;this.getNormal(r,i,s,a,n,o);let p=o.x,f=o.y;if(this._checkMinAngle(t,e,r,i,s,a))return d?h.push(d[0],d[1],d[3],d[3],d[2],d[0]):(l.push(r-c,i-_,r+c,i+_),l.push(r-p,i-f,r+p,i+f),h.push(u+0,u+1,u+3,u+3,u+2,u+0)),2;let g=-_+e-(-_+i),m=-c+r-(-c+t),y=(-c+t)*(-_+i)-(-c+r)*(-_+e),T=-f+a-(-f+i),x=-p+r-(-p+s),v=(-p+s)*(-f+i)-(-p+r)*(-f+a),S=g*x-T*m;if(S=g*x-T*m,Math.abs(S)<.1)return S+=10.1,l.push(r-c,i-_,r+c,i+_),0;let E=(m*v-x*y)/S,w=(T*y-g*v)/S;return d?S>0?(l.push(E,w,r,i),h.push(d[0],u+0,d[2]),h.push(d[2],u+1,d[0])):(l.push(r-(E-r),i-(w-i),r,i),h.push(d[1],u+0,d[3]),h.push(d[3],u+1,d[1])):(l.push(r-c,i-_,r+c,i+_),S>0?(l.push(E,w,r,i),h.push(u+0,u+2,u+4),h.push(u+4,u+3,u+0)):(l.push(r-(E-r),i-(w-i),r,i),h.push(u+1,u+2,u+5),h.push(u+5,u+3,u+1)),l.push(r-p,i-f,r+p,i+f)),4}static getNormal(t,e,r,i,s,a){a||(a=new Qe);let n=i-e,l=t-r,o=Math.sqrt(n*n+l*l);return a.x=n/o*s,a.y=l/o*s,a}static createLineTriangle(t,e,r,i,s,a,n){var l=t.slice(),o=l.length,h=l[0],u=l[1],d=l[2],c=(l[2],0),_=0,p=0,f=0,g=o/2;if(!(g<=1)&&2!=g){for(var m=new Array(4*g),y=0,T=0,x=0;x<g-1;x++)h=l[T++],u=l[T++],d=l[T++],f=l[T++]-u,0!=(p=d-h)&&0!=f&&(c=Math.sqrt(p*p+f*f))>.001&&(m[_=4*y]=h,m[_+1]=u,m[_+2]=p/c,m[_+3]=f/c,y++);for(i?(h=l[o-2],u=l[o-1],d=l[0],f=l[1]-u,0!=(p=d-h)&&0!=f&&(c=Math.sqrt(p*p+f*f))>.001&&(m[_=4*y]=h,m[_+1]=u,m[_+2]=p/c,m[_+3]=f/c,y++)):(m[_=4*y]=h,m[_+1]=u,m[_+2]=p/c,m[_+3]=f/c,y++),T=0,x=0;x<g;x++)h=l[T],u=l[T+1],d=l[T+2],l[T+3]}}}class Pr{constructor(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class Nr{static earcut(t,e,r){r=r||2;var i,s,a,n,l,o,h,u=e&&e.length,d=u?e[0]*r:t.length,c=Nr.linkedList(t,0,d,r,!0),_=[];if(!c)return _;if(u&&(c=Nr.eliminateHoles(t,e,c,r)),t.length>80*r){i=a=t[0],s=n=t[1];for(var p=r;p<d;p+=r)(l=t[p])<i&&(i=l),(o=t[p+1])<s&&(s=o),l>a&&(a=l),o>n&&(n=o);h=0!==(h=Math.max(a-i,n-s))?1/h:0}return Nr.earcutLinked(c,_,r,i,s,h),_}static linkedList(t,e,r,i,s){var a,n;if(s===Nr.signedArea(t,e,r,i)>0)for(a=e;a<r;a+=i)n=Nr.insertNode(a,t[a],t[a+1],n);else for(a=r-i;a>=e;a-=i)n=Nr.insertNode(a,t[a],t[a+1],n);return n&&Nr.equals(n,n.next)&&(Nr.removeNode(n),n=n.next),n}static filterPoints(t,e){if(!t)return t;e||(e=t);var r,i=t;do{if(r=!1,i.steiner||!Nr.equals(i,i.next)&&0!==Nr.area(i.prev,i,i.next))i=i.next;else{if(Nr.removeNode(i),(i=e=i.prev)===i.next)break;r=!0}}while(r||i!==e);return e}static earcutLinked(t,e,r,i,s,a,n=null){if(t){!n&&a&&Nr.indexCurve(t,i,s,a);for(var l,o,h=t;t.prev!==t.next;)if(l=t.prev,o=t.next,a?Nr.isEarHashed(t,i,s,a):Nr.isEar(t))e.push(l.i/r),e.push(t.i/r),e.push(o.i/r),Nr.removeNode(t),t=o.next,h=o.next;else if((t=o)===h){n?1===n?(t=Nr.cureLocalIntersections(t,e,r),Nr.earcutLinked(t,e,r,i,s,a,2)):2===n&&Nr.splitEarcut(t,e,r,i,s,a):Nr.earcutLinked(Nr.filterPoints(t,null),e,r,i,s,a,1);break}}}static isEar(t){var e=t.prev,r=t,i=t.next;if(Nr.area(e,r,i)>=0)return!1;for(var s=t.next.next;s!==t.prev;){if(Nr.pointInTriangle(e.x,e.y,r.x,r.y,i.x,i.y,s.x,s.y)&&Nr.area(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}static isEarHashed(t,e,r,i){var s=t.prev,a=t,n=t.next;if(Nr.area(s,a,n)>=0)return!1;for(var l=s.x<a.x?s.x<n.x?s.x:n.x:a.x<n.x?a.x:n.x,o=s.y<a.y?s.y<n.y?s.y:n.y:a.y<n.y?a.y:n.y,h=s.x>a.x?s.x>n.x?s.x:n.x:a.x>n.x?a.x:n.x,u=s.y>a.y?s.y>n.y?s.y:n.y:a.y>n.y?a.y:n.y,d=Nr.zOrder(l,o,e,r,i),c=Nr.zOrder(h,u,e,r,i),_=t.nextZ;_&&_.z<=c;){if(_!==t.prev&&_!==t.next&&Nr.pointInTriangle(s.x,s.y,a.x,a.y,n.x,n.y,_.x,_.y)&&Nr.area(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=t.prevZ;_&&_.z>=d;){if(_!==t.prev&&_!==t.next&&Nr.pointInTriangle(s.x,s.y,a.x,a.y,n.x,n.y,_.x,_.y)&&Nr.area(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}static cureLocalIntersections(t,e,r){var i=t;do{var s=i.prev,a=i.next.next;!Nr.equals(s,a)&&Nr.intersects(s,i,i.next,a)&&Nr.locallyInside(s,a)&&Nr.locallyInside(a,s)&&(e.push(s.i/r),e.push(i.i/r),e.push(a.i/r),Nr.removeNode(i),Nr.removeNode(i.next),i=t=a),i=i.next}while(i!==t);return i}static splitEarcut(t,e,r,i,s,a){var n=t;do{for(var l=n.next.next;l!==n.prev;){if(n.i!==l.i&&Nr.isValidDiagonal(n,l)){var o=Nr.splitPolygon(n,l);return n=Nr.filterPoints(n,n.next),o=Nr.filterPoints(o,o.next),Nr.earcutLinked(n,e,r,i,s,a),void Nr.earcutLinked(o,e,r,i,s,a)}l=l.next}n=n.next}while(n!==t)}static eliminateHoles(t,e,r,i){var s,a,n,l,o,h=[];for(s=0,a=e.length;s<a;s++)n=e[s]*i,l=s<a-1?e[s+1]*i:t.length,(o=Nr.linkedList(t,n,l,i,!1))===o.next&&(o.steiner=!0),h.push(Nr.getLeftmost(o));for(h.sort(Nr.compareX),s=0;s<h.length;s++)Nr.eliminateHole(h[s],r),r=Nr.filterPoints(r,r.next);return r}static compareX(t,e){return t.x-e.x}static eliminateHole(t,e){if(e=Nr.findHoleBridge(t,e)){var r=Nr.splitPolygon(e,t);Nr.filterPoints(r,r.next)}}static findHoleBridge(t,e){var r,i=e,s=t.x,a=t.y,n=-1/0;do{if(a<=i.y&&a>=i.next.y&&i.next.y!==i.y){var l=i.x+(a-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(l<=s&&l>n){if(n=l,l===s){if(a===i.y)return i;if(a===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!r)return null;if(s===n)return r.prev;var o,h=r,u=r.x,d=r.y,c=1/0;for(i=r.next;i!==h;)s>=i.x&&i.x>=u&&s!==i.x&&Nr.pointInTriangle(a<d?s:n,a,u,d,a<d?n:s,a,i.x,i.y)&&((o=Math.abs(a-i.y)/(s-i.x))<c||o===c&&i.x>r.x)&&Nr.locallyInside(i,t)&&(r=i,c=o),i=i.next;return r}static indexCurve(t,e,r,i){var s=t;do{null===s.z&&(s.z=Nr.zOrder(s.x,s.y,e,r,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,Nr.sortLinked(s)}static sortLinked(t){var e,r,i,s,a,n,l,o,h=1;do{for(r=t,t=null,a=null,n=0;r;){for(n++,i=r,l=0,e=0;e<h&&(l++,i=i.nextZ);e++);for(o=h;l>0||o>0&&i;)0!==l&&(0===o||!i||r.z<=i.z)?(s=r,r=r.nextZ,l--):(s=i,i=i.nextZ,o--),a?a.nextZ=s:t=s,s.prevZ=a,a=s;r=i}a.nextZ=null,h*=2}while(n>1);return t}static zOrder(t,e,r,i,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*s)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}static getLeftmost(t){var e=t,r=t;do{e.x<r.x&&(r=e),e=e.next}while(e!==t);return r}static pointInTriangle(t,e,r,i,s,a,n,l){return(s-n)*(e-l)-(t-n)*(a-l)>=0&&(t-n)*(i-l)-(r-n)*(e-l)>=0&&(r-n)*(a-l)-(s-n)*(i-l)>=0}static isValidDiagonal(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!Nr.intersectsPolygon(t,e)&&Nr.locallyInside(t,e)&&Nr.locallyInside(e,t)&&Nr.middleInside(t,e)}static area(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}static equals(t,e){return t.x===e.x&&t.y===e.y}static intersects(t,e,r,i){return!!(Nr.equals(t,e)&&Nr.equals(r,i)||Nr.equals(t,i)&&Nr.equals(r,e))||Nr.area(t,e,r)>0!=Nr.area(t,e,i)>0&&Nr.area(r,i,t)>0!=Nr.area(r,i,e)>0}static intersectsPolygon(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&Nr.intersects(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}static locallyInside(t,e){return Nr.area(t.prev,t,t.next)<0?Nr.area(t,e,t.next)>=0&&Nr.area(t,t.prev,e)>=0:Nr.area(t,e,t.prev)<0||Nr.area(t,t.next,e)<0}static middleInside(t,e){var r=t,i=!1,s=(t.x+e.x)/2,a=(t.y+e.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&s<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==t);return i}static splitPolygon(t,e){var r=new Pr(t.i,t.x,t.y),i=new Pr(e.i,e.x,e.y),s=t.next,a=e.prev;return t.next=e,e.prev=t,r.next=s,s.prev=r,i.next=r,r.prev=i,a.next=i,i.prev=a,i}static insertNode(t,e,r,i){var s=new Pr(t,e,r);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}static removeNode(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}static signedArea(t,e,r,i){for(var s=0,a=e,n=r-i;a<r;a+=i)s+=(t[n]-t[a])*(t[a+1]+t[n+1]),n=a;return s}}class Or{constructor(){this.clear()}clear(){this.submitType=-1,this.blendShader=this.other=0}}class Fr{constructor(){this.clipInfoID=-1,this.blendType=-1,this._id=0,this._renderType=0,this._key=new Or,this._startIdx=0,this._numEle=0,this._colorFiler=null,this.shaderValue=null,this._id=++Fr.ID}static create(t,e,r){var i=new Fr;i._mesh=e,i._key.clear(),i._key.submitType=Fr.KEY_DRAWTEXTURE,i._startIdx=e.indexNum*Ut.INDEX_BYTES,i._numEle=0;var s=t._nBlendType;return i._key.blendShader=s,i.shaderValue=r,i.material=t._material,i._colorFiler=t._colorFiler,i}}Fr.KEY_ONCE=-1,Fr.KEY_FILLRECT=1,Fr.KEY_DRAWTEXTURE=2,Fr.KEY_VG=3,Fr.KEY_TRIANGLES=4,Fr.ID=1,Fr.RENDERBASE=new Fr;class Ur{}Ur.loopStTm=0,Ur.loopCount=0;class kr{constructor(t){this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new G,this._enable=!1,this._clipid=t._clipInfoID,t._globalClipMatrix.copyTo(this._clipMatrix)}clear(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}destroy(){this.clear(),this._data.length=0,this._data=null}add(t,e,r,i,s,a){this._ndata>0&&(this._tex!=e||this._imgId!=r||this._clipid>=0&&this._clipid!=t._clipInfoID)&&this.submit(t),this._clipid=t._clipInfoID,t._globalClipMatrix.copyTo(this._clipMatrix),this._tex=e,this._imgId=r,this._colorFiler=t._colorFiler,this._data[this._ndata]=i,this._data[this._ndata+1]=s,this._data[this._ndata+2]=a,this._ndata+=3}getPos(){return 0==kr.__nPosPool?new Array(8):kr.__posPool[--kr.__nPosPool]}enable(t,e){t!==this._enable&&(this._enable=t,this._enable||this.submit(e))}submit(e){var r=this._ndata;if(!r)return;e.drawLeftData();let i=Cr.create(t.RenderSpriteData.Texture2D);e.fillShaderValue(i),i.textureHost=this._tex;let s=e._mesh=e._meshQuatTex,a=e._curSubmit=Fr.create(e,s,i);a._key.other=this._imgId,a._colorFiler=this._colorFiler;var n=i.clipMatDir;let l=this._clipMatrix;n.x=l.a,n.y=l.b,n.z=l.c,n.w=l.d,i.clipMatDir=n;var o=i.clipMatPos;o.x=l.tx,o.y=l.ty,i.clipMatPos=o,a.clipInfoID=this._clipid;for(var h=0;h<r;h+=3)s.addQuad(this._data[h],this._data[h+1],this._data[h+2],!0),kr.__posPool[kr.__nPosPool++]=this._data[h];this._ndata=0,Ur.loopCount%100==0&&(this._data.length=0),e.drawLeftData()}}kr.__posPool=[],kr.__nPosPool=0;class Gr{constructor(){this.isRandomTouch=!0,this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}touch(){var t=Ur.loopCount;this.touchTick!=t&&(this.texture.touchRect(this,t),this.touchTick=t)}}var Vr=[0,0,0,0];const Hr=new Gr;class zr{constructor(t){this.charRender=t}getFontSizeInfo(t,e){let r="bold "+e+"px "+t;Vr[0]=e/2,Vr[1]=e/2,Vr[2]=e,Vr[3]=e;this.charRender.scale(1,1),Hr.height=e,this.charRender.fontsz=e;var i=this.charRender.getCharBmp("g",r,0,"red",null,Hr,16,16,16,16);return this.bmpData32=new Uint32Array(i.data.buffer),this.updateBbx(i,Vr,!1),i=this.charRender.getCharBmp("有",r,0,"red",null,Hr,16,16,16,16),this.bmpData32=new Uint32Array(i.data.buffer),Vr[2]<16+Hr.width&&(Vr[2]=16+Hr.width),this.updateBbx(i,Vr,!1),Math.max(16-Vr[0],0)<<24|Math.max(16-Vr[1],0)<<16|Vr[2]-Vr[0]<<8|Vr[3]-Vr[1]}checkBmpLine(t,e,r,i){this.bmpData32.buffer!=t.data.buffer&&(this.bmpData32=new Uint32Array(t.data.buffer));for(var s=t.width*e+r,a=r;a<i;a++)if(0!=this.bmpData32[s++])return!0;return!1}updateBbx(t,e,r=!1){var i=t.width,s=t.height,a=0,n=e[1],l=0,o=n;if(this.checkBmpLine(t,n,0,i))for(;;){if((o=(n+l)/2|0)+1>=n){e[1]=o;break}this.checkBmpLine(t,o,0,i)?n=o:l=o}if(e[3]>s)e[3]=s;else if(o=n=e[3],l=s,this.checkBmpLine(t,n,0,i))for(;;){if((o=(n+l)/2|0)-1<=n){e[3]=o;break}this.checkBmpLine(t,o,0,i)?n=o:l=o}if(!r){var h=e[0],u=i*e[1];for(o=e[1];o<e[3];o++){for(a=0;a<h;a++)if(0!=this.bmpData32[u+a]){h=a;break}u+=i}e[0]=h;var d=e[2];for(u=i*e[1],o=e[1];o<e[3];o++){for(a=d;a<i;a++)if(0!=this.bmpData32[u+a]){d=a;break}u+=i}e[2]=d}}}class Wr{constructor(t=0,e=0,r=0){this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=r,this._init(t,e)}addRect(t,e,r,i){return!!this._get(e,r,i)&&(this._fill(i.x,i.y,e,r,t),this._texCount++,!0)}_release(){this._cells=null,this._rowInfo=null}_init(t,e){return this._width=t,this._height=e,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}_get(t,e,r){if(t>this._width||e>this._height)return!1;for(var i=-1,s=-1,a=this._width,n=this._height,l=this._cells,o=0;o<n;o++)if(!(this._rowInfo[o]<t))for(var h=0;h<a;){var u=3*(o*a+h);if(0!=l[u]||l[u+1]<t||l[u+2]<e)h+=l[u+1];else{i=h,s=o;for(var d=0;d<t;d++)if(l[3*d+u+2]<e){i=-1;break}if(!(i<0))return r.x=i,r.y=s,!0;h+=l[u+1]}}return!1}_fill(t,e,r,i,s){var a=this._width,n=this._height;this._check(t+r<=a&&e+i<=n);for(var l=e;l<i+e;++l){this._check(this._rowInfo[l]>=r),this._rowInfo[l]-=r;for(var o=0;o<r;o++){var h=3*(t+l*a+o);this._check(0==this._cells[h]),this._cells[h]=s,this._cells[h+1]=r,this._cells[h+2]=i}}if(t>0)for(l=0;l<i;++l){var u=0;for(o=t-1;o>=0&&0==this._cells[3*((e+l)*a+o)];--o,++u);for(o=u;o>0;--o)this._cells[3*((e+l)*a+t-o)+1]=o,this._check(o>0)}if(e>0)for(o=t;o<t+r;++o){for(u=0,l=e-1;l>=0&&0==this._cells[3*(o+l*a)];--l,u++);for(l=u;l>0;--l)this._cells[3*(o+(e-l)*a)+2]=l,this._check(l>0)}this._used+=r*i/(this._width*this._height)}_check(t){0==t&&console.log("xtexMerger 错误啦")}_clear(){this._texCount=0;for(var t=0;t<this._height;t++)this._rowInfo[t]=this._width;for(var e=0;e<this._height;e++)for(var r=0;r<this._width;r++){var i=3*(e*this._width+r);this._cells[i]=0,this._cells[i+1]=this._width-r,this._cells[i+2]=this._width-e}}}var Yr;t.WrapMode=void 0,(Yr=t.WrapMode||(t.WrapMode={}))[Yr.Repeat=0]="Repeat",Yr[Yr.Clamp=1]="Clamp",Yr[Yr.Mirrored=2]="Mirrored";class Xr extends ct{constructor(e=ti.atlasWidth,r=ti.atlasWidth){super(e,r,t.TextureFormat.R8G8B8A8,!1,!1,!0,!0),this._discardTm=0,this.genID=0,this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=0,this.ri=null,this.setPixelsData(null,!0,!1),this.lock=!0,this.filterMode=t.FilterMode.Bilinear,this.wrapModeU=t.WrapMode.Clamp,this.wrapModeV=t.WrapMode.Clamp,ti.debugUV&&this.fillWhite()}addChar(t,e,r,i=null){if(ti.isWan1Wan)return this.addCharCanvas(t,e,r,i);var s,a,n,o,h=t.data;return t.data instanceof Uint8ClampedArray&&(h=new Uint8Array(h.buffer)),l.textureContext.setTextureSubPixelsData(this._texture,h,0,!1,e,r,t.width,t.height,!0,!1),s=e/this.width,a=r/this.height,n=(e+t.width)/this.width,o=(r+t.height)/this.height,(i=i||new Array(8))[0]=s,i[1]=a,i[2]=n,i[3]=a,i[4]=n,i[5]=o,i[6]=s,i[7]=o,i}addCharCanvas(t,e,r,i=null){var s,a,o,h;return l.textureContext.setTextureSubImageData(this._texture,t,e,r,!0,!1),n.isConch?(s=e/this.width,a=r/this.height,o=(e+t.width)/this.width,h=(r+t.height)/this.height):(s=(e+1)/this.width,a=(r+1)/this.height,o=(e+t.width-1)/this.width,h=(r+t.height-1)/this.height),(i=i||new Array(8))[0]=s,i[1]=a,i[2]=o,i[3]=a,i[4]=o,i[5]=h,i[6]=s,i[7]=h,i}fillWhite(){var t=new Uint8Array(this.width*this.height*4);t.fill(255),l.textureContext.setTextureImageData(this._getSource(),t,!0,!1)}discard(){e.stage.setGlobalRepaint(),this.destroy()}static getTextTexture(t,e){return new Xr(t,e)}static clean(){var t=Ur.loopStTm;if(0===Xr.cleanTm&&(Xr.cleanTm=t),t-Xr.cleanTm>=ti.checkCleanTextureDt){for(let r=0;r<Xr.poolLen;r++){var e=Xr.pool[r];t-e._discardTm>=ti.destroyUnusedTextureDt&&(e.destroy(),Xr.pool[r]=Xr.pool[Xr.poolLen-1],Xr.poolLen--,r--)}Xr.cleanTm=t}}touchTexture(){let t=Ur.loopCount;this.lastTouchTm!=t&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=t)}touchRect(t,e){this.lastTouchTm!=e&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=e);var r=ti.atlasWidth*ti.atlasWidth,i=jr.atlasGridW*jr.atlasGridW;this.curUsedCovRate+=t.bmpWidth*t.bmpHeight/r,this.curUsedCovRateAtlas+=Math.ceil(t.bmpWidth/jr.atlasGridW)*Math.ceil(t.bmpHeight/jr.atlasGridW)/(r/i)}}Xr.pool=new Array(10),Xr.poolLen=0,Xr.cleanTm=0,Xr.EVENT_REUSE="texture_recycling";class jr{constructor(){this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=ti.atlasWidth,this.texture=Xr.getTextTexture(this.texWidth,this.texHeight),this.texWidth/jr.atlasGridW>256&&(jr.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new Wr(this.texWidth/jr.atlasGridW,this.texHeight/jr.atlasGridW,this.texture.id)}setProtecteDist(t){}getAEmpty(t,e,r){var i=this.atlasgrid.addRect(1,Math.ceil(t/jr.atlasGridW),Math.ceil(e/jr.atlasGridW),r);return i&&(r.x*=jr.atlasGridW,r.y*=jr.atlasGridW),i}get usedRate(){return this.atlasgrid._used}destroy(){for(var t in this.charMaps){this.charMaps[t].deleted=!0}this.texture.discard()}printDebugInfo(){}}jr.atlasGridW=16;class qr{static parse(t){if(t===Kr)return $r;let e=qr._cache[t];return e||(e=qr._cache[t]=new qr(t)),Kr=t,$r=e,e}constructor(t){this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this.setFont(t||"14px Arial")}setFont(t){this._font=t;var e=t.split(" "),r=e.length;if(r<2)1==r&&e[0].indexOf("px")>0&&(this._size=parseInt(e[0]));else{var i=-1;for(let s=0;s<r;s++)if(e[s].indexOf("px")>0||e[s].indexOf("pt")>0){i=s,this._size=parseInt(e[s]),this._size<=0&&(console.debug("font parse error:"+t),this._size=14);break}var s=i+1,a=e[s];for(s++;s<r;s++)a+=" "+e[s];this._family=a.split(",")[0],this._italic=e.indexOf("italic")>=0,this._bold=e.indexOf("bold")>=0}}}qr._cache={};var $r,Kr="";class Qr{constructor(){this.pagecharsCtx=null,this.width=-1,this.pageChars=[],this.scalex=1,this.scaley=1}setText(t){this.text=t,this._nativeObj?this._nativeObj._text=t:this.width=-1,this.cleanCache()}toString(){return this.text}get length(){return this.text?this.text.length:0}cleanCache(){if(this._nativeObj)return void this._nativeObj.cleanCache();let t=this.pageChars;if(t.length>0){for(var e in t){let r=t[e];if(!r)continue;let i=r.tex,s=r.words;s&&1==s.length&&i&&i.ri&&i.destroy()}this.pageChars=[]}this.scalex=1,this.scaley=1}get splitRender(){return this._splitRender}set splitRender(t){this._splitRender=t,this._nativeObj&&(this._nativeObj.splitRender=t)}}class Zr{constructor(){this.fontsz=16}getWidth(t,e){return 0}scale(t,e){}get canvasWidth(){return 0}set canvasWidth(t){}getCharBmp(t,e,r,i,s,a,n,l,o,h,u=null){return null}}class Jr extends Zr{constructor(t,e,r=!0,i=!0,s=!1){super(),this.ctx=null,this.lastScaleX=1,this.lastScaleY=1,this.maxTexW=0,this.maxTexH=0,this.scaleFontSize=!0,this.showDbgInfo=!1,this.supportImageData=!0,this.maxTexW=t,this.maxTexH=e,this.scaleFontSize=r,this.supportImageData=i,this.showDbgInfo=s,Jr.canvas||(Jr.canvas=A.createElement("canvas"),Jr.canvas.width=1024,Jr.canvas.height=512,Jr.canvas.style.left="-10000px",Jr.canvas.style.position="absolute",window.document.body.appendChild(Jr.canvas),this.ctx=Jr.canvas.getContext("2d",{willReadFrequently:!0}))}get canvasWidth(){return Jr.canvas.width}set canvasWidth(t){Jr.canvas.width!=t&&(Jr.canvas.width=t,t>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}getWidth(t,e){return this.ctx?(this.ctx._lastFont!=t&&(this.ctx.font=t,this.ctx._lastFont=t),this.ctx.measureText(e).width):0}scale(t,e){if(!this.supportImageData)return this.lastScaleX=t,void(this.lastScaleY=e);this.lastScaleX==t&&this.lastScaleY==e||(this.ctx.setTransform(t,0,0,e,0,0),this.lastScaleX=t,this.lastScaleY=e)}getCharBmp(t,e,r,i,s,a,n,l,o,h,u=null){if(!this.supportImageData)return this.getCharCanvas(t,e,r,i,s,a,n,l,o,h);var d=this.ctx,c=this.fontsz;d.font!=e&&(d.font=e,d._lastFont=e),a.width=d.measureText(t).width;var _=a.width*this.lastScaleX,p=a.height*this.lastScaleY;_+=(n+o)*this.lastScaleX,p+=(l+h)*this.lastScaleY,_=Math.ceil(_),p=Math.ceil(p);var f=(_=Math.min(_,Jr.canvas.width))+2*r+1,g=(p=Math.min(p,Jr.canvas.height))+2*r+1;u&&(f=Math.max(f,u[0]+u[2]+1),g=Math.max(g,u[1]+u[3]+1)),d.clearRect(0,0,f/this.lastScaleX+1,g/this.lastScaleY+1),d.save(),d.textBaseline="middle",r>0&&(d.lineJoin="round",d.strokeStyle=s,d.lineWidth=r,d.strokeText(t,n,l+c/2)),i&&(d.fillStyle=i,d.fillText(t,n,l+c/2)),this.showDbgInfo&&(d.strokeStyle="#ff0000",d.strokeRect(1,1,_-2,p-2),d.strokeStyle="#00ff00",d.strokeRect(n,l,a.width,a.height)),u&&(u[2]<=0&&(u[2]=Math.ceil(-u[2]+(a.width+2*r)*this.lastScaleX)),u[2]<=0&&(u[2]=1));var m=u?d.getImageData(u[0],u[1],u[2],u[3]+1):d.getImageData(0,0,_,p+1);return d.restore(),a.bmpWidth=m.width,a.bmpHeight=m.height,m}getCharCanvas(t,e,r,i,s,a,n,l,o,h){var u=this.ctx;u.font!=e&&(u.font=e,u._lastFont=e),A.window.isIOSHighPerformanceModePlus&&(u.font=e),a.width=u.measureText(t).width;var d=a.width*this.lastScaleX,c=a.height*this.lastScaleY;d+=(n+o)*this.lastScaleX,c+=(l+h)*this.lastScaleY+1,d=Math.min(d,this.maxTexW),c=Math.min(c,this.maxTexH),Jr.canvas.width=Math.min(d+1,this.maxTexW),Jr.canvas.height=Math.min(c+1,this.maxTexH),u.font=e,u.clearRect(0,0,d+1+r,c+1+r),u.setTransform(1,0,0,1,0,0),u.save(),this.scaleFontSize&&u.scale(this.lastScaleX,this.lastScaleY),u.translate(n,l),u.textAlign="left";var _=this.fontsz;return u.textBaseline="middle",r>0?(u.lineJoin="round",u.strokeStyle=s,u.fillStyle=i,u.lineWidth=r,u.fillAndStrokeText?u.fillAndStrokeText(t,0,_/2):(u.strokeText(t,0,_/2),u.fillText(t,0,_/2))):i&&(u.fillStyle=i,u.fillText(t,0,_/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(0,0,d,c),u.strokeStyle="#00ff00",u.strokeRect(0,0,a.width,a.height)),u.restore(),a.bmpWidth=Jr.canvas.width,a.bmpHeight=Jr.canvas.height,Jr.canvas}}Jr.canvas=null;class ti extends v{constructor(){super(),this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this._fontMeasure=null;var t=!1,r=e.Laya.MiniAdpter;r&&r.systemInfo&&r.systemInfo.system&&(t="ios 10.1.1"===r.systemInfo.system.toLowerCase()),(e.Browser.onMiniGame||e.Browser.onTTMiniGame||e.Browser.onBLMiniGame||e.Browser.onAlipayMiniGame||e.Browser.onTBMiniGame)&&!t&&(ti.isWan1Wan=!0),this.charRender=new Jr(2048,2048,ti.scaleFontWithCtx,!ti.isWan1Wan,!1),ti.textRenderInst=this,e.Laya.textRender=this}set fontMeasure(t){this._fontMeasure=t}get fontMeasure(){return this._fontMeasure}_wan1wansz(t,e){let r="bold "+e+"px "+t;var i=1.5*this.charRender.getWidth(r,"有")<<8|1.5*e;return this.fontSizeInfo[t]=i,i}getFontSizeInfo(t){var e=this.fontSizeInfo[t];return e||(e=ti.isWan1Wan?this._wan1wansz(t,ti.standardFontSize):this._fontMeasure.getFontSizeInfo(t,ti.standardFontSize),this.fontSizeInfo[t]=e),e}setFont(t){if(this.lastFont!=t){this.lastFont=t;var e=this.getFontSizeInfo(t._family),r=e>>24,i=e>>16&255,s=e>>8&255,a=255&e,n=t._size/ti.standardFontSize;this.fontSizeOffX=Math.ceil(r*n),this.fontSizeOffY=Math.ceil(i*n),this.fontSizeW=Math.ceil(s*n),this.fontSizeH=Math.ceil(a*n),t._font.indexOf("italic")>=0?this.fontStr=t._font.replace("italic",""):this.fontStr=t._font}}getNextChar(t){var e=t.length,r=this._curStrPos;if(!t.substring)return null;if(r>=e)return null;for(var i=r,s=0;i<e;i++){var a=t.charCodeAt(i);if(a>>>11==27){if(1==s)break;s=1,i++}else if(65038===a||65039===a);else if(8205==a)s=2;else if(0==s)s=1;else if(1==s)break}return this._curStrPos=i,t.substring(r,i)}filltext(t,e,r,i,s,a,n,l,o){if(!(e.length<=0)){var h=qr.parse(s),u=0;switch(o){case"center":u=Ut.ENUM_TEXTALIGN_CENTER;break;case"right":u=Ut.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(t,e,r,i,h,a,n,l,u)}}_fast_filltext(t,e,r,i,s,a,n,l,o){if(e&&!(e.length>=1))return;if(l<0&&(l=0),this.setFont(s),this.fontScaleX=this.fontScaleY=1,ti.scaleFontWithCtx){let e=t.getMatScaleX(),r=t.getMatScaleY();if(e<1e-4||r<.1)return;e>1&&(this.fontScaleX=Math.min(ti.maxFontScale,e)),r>1&&(this.fontScaleY=Math.min(ti.maxFontScale,r))}s._italic&&(t._italicDeg=13);let h=e,u=e instanceof Qr,d=e&&e.toString(),c=u?h.pageChars:[],_=0;switch(u?(d=h.text,_=h.width,_<0&&(_=h.width=this.charRender.getWidth(this.fontStr,d))):_=d?this.charRender.getWidth(this.fontStr,d):0,o){case Ut.ENUM_TEXTALIGN_CENTER:r-=_/2;break;case Ut.ENUM_TEXTALIGN_RIGHT:r-=_}u&&(this.hasFreedText(c)||h.pagecharsCtx!=t)&&(c=h.pageChars=[]);let p=this.renderPerChar=!u||ti.forceSplitRender||u&&h.splitRender;if(!c||c.length<1){if(u&&(h.scalex=this.fontScaleX,h.scaley=this.fontScaleY),p){let t,e=0,r=0;for(this._curStrPos=0;t=this.getNextChar(d),t;){let i=this.getCharRenderInfo(t,s,a,n,l,!1);if(!i)break;if(i.isSpace);else{var f=c[i.texture.id];if(f)f=f.words;else{var g={texgen:i.texture.genID,tex:i.texture,words:new Array};c[i.texture.id]=g,f=g.words}f.push({ri:i,x:e,y:r,w:i.bmpWidth/this.fontScaleX,h:i.bmpHeight/this.fontScaleY}),e+=i.width}}}else{let t=s._size/3|0,e=ti.noAtlas||(_+t+t)*this.fontScaleX>ti.atlasWidth,r=this.getCharRenderInfo(d,s,a,n,l,e);c[0]={texgen:r.texture.genID,tex:r.texture,words:[{ri:r,x:0,y:0,w:r.bmpWidth/this.fontScaleX,h:r.bmpHeight/this.fontScaleY}]}}u&&(h.pagecharsCtx=t)}this._drawResortedWords(t,r,i,c),t._italicDeg=0}_drawResortedWords(t,e,r,i){var s=!!t._charSubmitCache&&t._charSubmitCache._enable,a=t._curMat;for(var n in i){var l=i[n];if(l){var o=l.words;if(o){var h=o.length;if(!(h<=0))for(var u=i[n].tex,d=0;d<h;d++){var c=o[d],_=c.ri;_.isSpace||(t.touchRes(_),t.drawTexAlign=!0,t._inner_drawTexture(u,u.id,e+c.x-_.orix,r+c.y-_.oriy,c.w,c.h,a,_.uv,1,s,4294967295))}}}}}hasFreedText(t){for(let i in t){var e=t[i];if(e){var r=e.tex;if(r&&(r.destroyed||r.genID!=e.texgen))return!0}}return!1}getCharRenderInfo(t,e,r,i,s,a=!1){var n=this.mapFont[e._family];null==n&&(this.mapFont[e._family]=n=this.fontID++);var l=t+"_"+n+"_"+e._size+"_"+r;s>0&&(l+="_"+i+s),e._bold&&(l+="P"),1==this.fontScaleX&&1==this.fontScaleY||(l+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var o,h,u=0,d=this.textAtlases.length;if(!a)for(u=0;u<d;u++)if(o=(h=this.textAtlases[u]).charMaps[l])return o.touch(),o;o=new Gr,this.charRender.scale(this.fontScaleX,this.fontScaleY),o.char=t,o.height=e._size;var c=e._size/3|0,_=null;s||(s=0);var p=Math.ceil((this.charRender.getWidth(this.fontStr,t)+2*s)*this.fontScaleX);let f=Math.min(2048,p+2*c*this.fontScaleX);if(f>this.charRender.canvasWidth&&(this.charRender.canvasWidth=f),a){if(this.charRender.fontsz=e._size,_=this.charRender.getCharBmp(t,this.fontStr,s,r,i,o,c,c,c,c,null)){var g=Xr.getTextTexture(_.width,_.height);g.addChar(_,0,0,o.uv),o.texture=g,o.orix=c,o.oriy=c,g.ri=o,this.isoTextures.push(g)}}else{var m=t.length,y=1*s,T=Math.ceil((this.fontSizeW+2*y)*this.fontScaleX),x=Math.ceil((this.fontSizeH+2*y)*this.fontScaleY);ti.imgdtRect[0]=(c-this.fontSizeOffX-y)*this.fontScaleX|0,ti.imgdtRect[1]=(c-this.fontSizeOffY-y)*this.fontScaleY|0,this.renderPerChar||1==m?(ti.imgdtRect[2]=Math.max(p,T),ti.imgdtRect[3]=Math.max(p,x)):(ti.imgdtRect[2]=-this.fontSizeOffX*this.fontScaleX,ti.imgdtRect[3]=x),this.charRender.fontsz=e._size,(_=this.charRender.getCharBmp(t,this.fontStr,s,r,i,o,c,c,c,c,ti.imgdtRect))&&(h=this.addBmpData(_,o),ti.isWan1Wan?(o.orix=c,o.oriy=c):(o.orix=this.fontSizeOffX+y,o.oriy=this.fontSizeOffY+y),h.charMaps[l]=o)}return o}addBmpData(t,e){for(var r,i=t.width,s=t.height,a=this.textAtlases.length,n=!1,l=0;l<a&&!(n=(r=this.textAtlases[l]).getAEmpty(i,s,ei));l++);if(!n){if(r=new jr,this.textAtlases.push(r),!(n=r.getAEmpty(i,s,ei)))throw"err1";this.cleanAtlases()}return n&&(r.texture.addChar(t,ei.x,ei.y,e.uv),e.texture=r.texture),r}GC(){for(var t=0,e=this.textAtlases.length,r=ti.destroyAtlasDt,i=0,s=Ur.loopCount,a=-1,n=0,l=null,o=null;t<e;t++){if(l=(o=this.textAtlases[t]).texture){i+=l.curUsedCovRateAtlas;var h=o.usedRate-l.curUsedCovRateAtlas;n<h&&(n=h,a=t)}s-o.texture.lastTouchTm>r&&(ti.showLog&&console.log(o.texture.id),o.destroy(),this.textAtlases[t]=this.textAtlases[e-1],e--,t--,a=-1)}for(this.textAtlases.length=e,e=this.isoTextures.length,t=0;t<e;t++)s-(l=this.isoTextures[t]).lastTouchTm>ti.destroyUnusedTextureDt&&(l.ri.deleted=!0,l.ri.texture=null,l.destroy(),this.isoTextures[t]=this.isoTextures[e-1],e--,t--);this.isoTextures.length=e;var u=this.textAtlases.length>1&&this.textAtlases.length-i>=2;(ti.atlasWidth*ti.atlasWidth*4*this.textAtlases.length>ti.cleanMem||u||ti.simClean)&&(ti.simClean=!1,ti.showLog&&console.log("清理使用率低的贴图。总使用率:",i,":",this.textAtlases.length,"最差贴图:"+a),a>=0&&((o=this.textAtlases[a]).destroy(),this.textAtlases[a]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1,this.event("GC")))}cleanAtlases(){}printDbgInfo(){for(var t in console.log("图集个数:"+this.textAtlases.length+",每个图集大小:"+ti.atlasWidth+"x"+ti.atlasWidth," 用canvas:",ti.isWan1Wan),console.log("图集占用空间:"+ti.atlasWidth*ti.atlasWidth*4/1024/1024*this.textAtlases.length+"M"),console.log("缓存用到的字体:"),this.mapFont){var e=this.getFontSizeInfo(t),r=e>>24,i=e>>16&255,s=e>>8&255,a=255&e;console.log("    "+t," off:",r,i," size:",s,a)}var n=0;console.log("缓存数据:");var l=0,o=0;this.textAtlases.forEach((function(t){var e=t.texture.id,r=Ur.loopCount-t.texture.lastTouchTm,i=r>0?r+"帧以前":"当前帧";for(var s in l+=t.texture.curUsedCovRate,o+=t.texture.curUsedCovRateAtlas,console.log("--图集(id:"+e+",当前使用率:"+(1e3*t.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*t.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*t.usedRate|0,"%, 使用于:"+i+")--:"),t.charMaps){var a=t.charMaps[s];console.log("     off:",a.orix,a.oriy," bmp宽高:",a.bmpWidth,a.bmpHeight,"无效:",a.deleted,"touchdt:",Ur.loopCount-a.touchTick,"位置:",a.uv[0]*ti.atlasWidth|0,a.uv[1]*ti.atlasWidth|0,"字符:",a.char,"key:",s),n++}})),console.log("独立贴图文字("+this.isoTextures.length+"个):"),this.isoTextures.forEach((function(t){console.log("    size:",t.width,t.height,"touch间隔:",Ur.loopCount-t.lastTouchTm,"char:",t.ri.char)})),console.log("总缓存:",n,"总使用率:",l,"总当前图集使用率:",o)}showAtlas(t,r,i,s,a,n){if(!this.textAtlases[t])return console.log("没有这个图集"),null;var l=new Ds,o=this.textAtlases[t].texture,h={width:ti.atlasWidth,height:ti.atlasWidth,sourceWidth:ti.atlasWidth,sourceHeight:ti.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return o._getSource()},bitmap:{id:o.id},_uv:mt.DEF_UV};return l.size=function(t,e){return this.width=t,this.height=e,l.graphics.clear(),l.graphics.drawRect(0,0,l.width,l.height,r),l.graphics.drawTexture(h,0,0,l.width,l.height),this},l.graphics.drawRect(0,0,a,n,r),l.graphics.drawTexture(h,0,0,a,n),l.pos(i,s),e.stage.addChild(l),l}}ti.useOldCharBook=!1,ti.atlasWidth=1024,ti.noAtlas=!1,ti.forceSplitRender=!1,ti.forceWholeRender=!1,ti.scaleFontWithCtx=!0,ti.maxFontScale=4,ti.standardFontSize=32,ti.destroyAtlasDt=10,ti.checkCleanTextureDt=2e3,ti.destroyUnusedTextureDt=3e3,ti.cleanMem=104857600,ti.isWan1Wan=!1,ti.showLog=!1,ti.debugUV=!1,ti.imgdtRect=[0,0,0,0],ti.simClean=!1;const ei=new i;class ri extends Jt{static __init__(){ri.VertexDeclarition=new Qt(48,[new Zt(0,$t.Vector4,0),new Zt(16,$t.Vector4,1),new Zt(32,$t.Vector4,2)])}constructor(){super(ri.const_stride,4,4)}onVBRealloc(t){this._vbFloat32Array=new Float32Array(t)}onIBRealloc(t){this._ibU16Array=new Uint16Array(t)}addData(t,e,r,i,s,a=null){let n=t.length/2;this.expVBSize(n*ri.const_stride);var l=t.length>>1,o=this._vertNum*ri.const_stride>>2,h=this._vbFloat32Array,u=0,d=i.a,c=i.b,_=i.c,p=i.d,f=i.tx,g=i.ty,m=0;let y=0,T=0,x=1,v=1;a&&(y=a[0],T=a[1],x=a[2],v=a[3]);let S=(s>>>16&255)/255,E=(s>>>8&255)/255,w=(255&s)/255,D=(s>>>24)/255;for(m=0;m<l;m++){var b=t[u],R=t[u+1];h[o]=b*d+R*_+f,h[o+1]=b*c+R*p+g,h[o+2]=y+e[u]*x,h[o+3]=T+e[u+1]*v,h[o+4]=w,h[o+5]=E,h[o+6]=S,h[o+7]=D,h[o+8]=255,o+=12,u+=2}var C=this._vertNum,A=this._indexNum;this.expIBSize(r.byteLength);var I=this._ibU16Array;if(C>0)for(let t=A,e=0,i=A+r.length;t<i;t++,e++)I[t]=r[e]+C;else I.set(r);this._vertNum+=l,this._indexNum+=r.length}get vertexDeclarition(){return ri.VertexDeclarition}}ri.const_stride=48,ri.VertexDeclarition=null;class ii extends Jt{static __init__(){ii.vertexDeclaration=new Qt(24,[new Zt(0,$t.Vector2,0),new Zt(8,$t.Vector4,1)])}constructor(){super(ii.const_stride,4,4),this._vbFloat32Array=null}onVBRealloc(t){this._vbFloat32Array=new Float32Array(t)}onIBRealloc(t){}addVertAndIBToMesh(t,e,r){var i=this._vertNum*ii.const_stride;this.expVBSize(t.length/2*ii.const_stride);var s=i>>2,a=this._vbFloat32Array,n=0;let l=(e>>>16&255)/255,o=(e>>>8&255)/255,h=(255&e)/255,u=(e>>>24)/255;for(var d=t.length/2,c=0;c<d;c++)a[s++]=t[n],a[s++]=t[n+1],n+=2,a[s++]=h,a[s++]=o,a[s++]=l,a[s++]=u;this.expIBSize(2*r.length),new Uint16Array(this._IBBuff,2*this._indexNum,r.length).set(new Uint16Array(r)),this._vertNum+=d,this._indexNum+=r.length}get vertexDeclarition(){return ii.vertexDeclaration}}ii.const_stride=24,ii.vertexDeclaration=null;const si=new G(Ut.MAX_CLIP_SIZE,0,0,Ut.MAX_CLIP_SIZE,0,0),ai=[0,0,0,0,0,0,0,0],ni=new G;class li{static __init__(){if(li.MAXCLIPRECT=new F(0,0,Ut.MAX_CLIP_SIZE,Ut.MAX_CLIP_SIZE),oi.DEFAULT=new oi,!li._textRender){let t=li._textRender=new ti;t.fontMeasure=new zr(t.charRender)}}constructor(){if(this._alpha=1,this._material=null,this._fillStyle=mr.DEFAULT,this._strokeStyle=mr.DEFAULT,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._other=null,this._path=null,this._drawCount=1,this._width=Ut.MAX_CLIP_SIZE,this._height=Ut.MAX_CLIP_SIZE,this._renderCount=0,this.stopMerge=!0,this._curSubmit=Fr.RENDERBASE,this._submitKey=new Or,this._meshQuatTex=new te,this._meshVG=new ii,this._meshTex=new ri,this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=li.MAXCLIPRECT,this._globalClipMatrix=si.clone(),this._clipInfoID=0,this._clipID_Gen=0,this._matBuffer=new Float32Array(6),this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new br,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this._isMain=!1,this._render2D=null,this._clearColor=new _t(0,0,0,0),this._clear=!1,this._shaderValueNeedRelease=[],this.render2D=new oe,li._contextcount++,!this.defTexture){var e=new ct(2,2,t.TextureFormat.R8G8B8A8,!0,!1,!1);e.setPixelsData(new Uint8Array(16),!1,!1),e.lock=!0,this.defTexture=new mt(e)}this._lastTex=this.defTexture,this._other=oi.DEFAULT,this._curMat=G.create(),this._charSubmitCache=new kr(this),this._mesh=this._meshQuatTex,this._mesh.clearMesh(),this._save=[Sr.Create(this)],this._save.length=10,this.clear(),this._render2DManager=new ce}copyState(t){}set isMain(t){this._isMain=t}get isMain(){return this._isMain}set render2D(t){this._render2D=t}get render2D(){return this._render2D}get lineJoin(){return""}set lineJoin(t){}get lineCap(){return""}set lineCap(t){}get miterLimit(){return""}set miterLimit(t){}touchRes(t){t.touch()}transformByMatrix(t,e,r){this.transform(t.a,t.b,t.c,t.d,t.tx+e,t.ty+r)}drawRect(t,e,r,i,s,a,n){var l=this;null!=s&&(l.fillStyle=s,l.fillRect(t,e,r,i)),null!=a&&(l.strokeStyle=a,l.lineWidth=n,l.strokeRect(t,e,r,i))}alpha(t){this.globalAlpha*=t}_transform(t,e,r){this.translate(e,r),this.transform(t.a,t.b,t.c,t.d,t.tx,t.ty),this.translate(-e,-r)}_rotate(t,e,r){this.translate(e,r),this.rotate(t),this.translate(-e,-r)}_scale(t,e,r,i){this.translate(r,i),this.scale(t,e),this.translate(-r,-i)}_drawLine(t,e,r,i,s,a,n,l,o){this.beginPath(),this.strokeStyle=n,this.lineWidth=l,this.moveTo(t+r,e+i),this.lineTo(t+s,e+a),this.stroke()}_drawLines(t,e,r,i,s,a){this.beginPath(),this.strokeStyle=i,this.lineWidth=s,this.addPath(r.slice(),!1,!1,t,e),this.stroke()}drawCurves(t,e,r,i,s){this.beginPath(),this.strokeStyle=i,this.lineWidth=s,this.moveTo(t+r[0],e+r[1]);for(var a=2,n=r.length;a<n;)this.quadraticCurveTo(t+r[a++],e+r[a++],t+r[a++],e+r[a++]);this.stroke()}_fillAndStroke(t,e,r,i=!1){null!=t&&(this.fillStyle=t,this.fill()),null!=e&&r>0&&(this.strokeStyle=e,this.lineWidth=r,this.stroke())}_drawCircle(t,e,r,i,s,a,n){this.beginPath(!0),this.arc(t,e,r,r,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(i,s,a)}_drawEllipse(t,e,r,i,s,a,n){this.beginPath(!0),this.arc(t,e,r,i,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(s,a,n)}_drawRoundRect(t,e,r,i,s,a,n,l,o,h,u){this.beginPath(!0);var d=this._getPath();0>=s?d.addPoint(t,e):this.arc(t+s,e+s,s,s,Math.PI,Math.PI+.5*Math.PI);let c=t+r-a;0>=a?d.addPoint(c,e):this.arc(c,e+a,a,a,Math.PI+.5*Math.PI,2*Math.PI),c=t+r-l;let _=e+i-l;0>=l?d.addPoint(c,_):this.arc(c,_,l,l,0,.5*Math.PI),c=t+n,_=e+i-n,0>=n?d.addPoint(c,_):this.arc(c,_,n,n,Math.PI-.5*Math.PI,Math.PI),d.addPoint(t,e+s),this.closePath(),this._fillAndStroke(o,h,u)}_drawPie(t,e,r,i,s,a,n,l,o){this.beginPath(),this.moveTo(t,e),this.arc(t,e,r,r,i,s),this.closePath(),this._fillAndStroke(a,n,l)}_drawPoly(t,e,r,i,s,a,n,l){this.beginPath(),this.addPath(r.slice(),!0,n,t,e),this.closePath(),this._fillAndStroke(i,s,a,n)}_drawPath(t,e,r,i,s){this.beginPath();for(var a=0,n=r.length;a<n;a++){var l=r[a];switch(l[0]){case"moveTo":this.moveTo(t+l[1],e+l[2]);break;case"lineTo":this.lineTo(t+l[1],e+l[2]);break;case"arcTo":this.arcTo(t+l[1],e+l[2],t+l[3],e+l[4],l[5]);break;case"closePath":this.closePath()}}null!=i&&(this.fillStyle=i.fillStyle,this.fill()),null!=s&&(this.strokeStyle=s.strokeStyle,this.lineWidth=s.lineWidth||1,this.lineJoin=s.lineJoin,this.lineCap=s.lineCap,this.miterLimit=s.miterLimit,this.stroke())}static set2DRenderConfig(){}clearBG(t,e,r,i){null==t||null==t?this._clear=!1:(this._clearColor.setValue(t,e,r,i),this._clear=!0)}_releaseMem(){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear(),this._path=null,this._save=null,this.sprite=null}destroy(){--li._contextcount,this.sprite=null,this._charSubmitCache&&this._charSubmitCache.destroy(),this.defTexture&&(this.defTexture.bitmap&&this.defTexture.bitmap.destroy(),this.defTexture.destroy());for(var t=0,e=this._shaderValueNeedRelease.length;t<e;t++)this._shaderValueNeedRelease[t]&&this._shaderValueNeedRelease[t].release()}clear(){this._submitKey.clear(),this._drawCount=1,this._other=oi.DEFAULT,this._alpha=1,this._nBlendType=0,this._clipRect=li.MAXCLIPRECT,this._fillStyle=this._strokeStyle=mr.DEFAULT,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}size(t,e){this._width==t&&this._height==e||(this._width=t,this._height=e,this.isMain&&(ne.width=t,ne.height=e)),0===t&&0===e&&this._releaseMem()}get width(){return this._width}set width(t){this.size(t,this._height)}get height(){return this._height}set height(t){this.size(this._width,t)}getMatScaleX(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}getFillColor(){return this._fillColor}set fillStyle(t){this._fillStyle.equal(t)||(xr.save(this,xr.TYPE_FILESTYLE,this._shader2D,!1),this._fillStyle=mr.create(t),this._submitKey.other=-this._fillStyle.toInt())}get fillStyle(){return this._fillStyle}set globalAlpha(t){(t=Math.floor(1e3*t)/1e3)!=this._alpha&&(xr.save(this,xr.TYPE_ALPHA,this._shader2D,!1),this._alpha=t)}get globalAlpha(){return this._alpha}set textAlign(t){this._other.textAlign===t||(this._other=this._other.make(),xr.save(this,xr.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=t)}get textAlign(){return this._other.textAlign}set textBaseline(t){this._other.textBaseline===t||(this._other=this._other.make(),xr.save(this,xr.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=t)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(t){this._drawToRender2D(this._curSubmit);var e=pr.TOINT[t];null==e||this._nBlendType===e||(xr.save(this,xr.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=Fr.RENDERBASE,this._nBlendType=e)}get globalCompositeOperation(){return pr.NAMES[this._nBlendType]}set strokeStyle(t){this._strokeStyle.equal(t)||(xr.save(this,xr.TYPE_STROKESTYLE,this._shader2D,!1),this._strokeStyle=mr.create(t),this._submitKey.other=-this._strokeStyle.toInt())}get strokeStyle(){return this._strokeStyle}translate(t,e){0===t&&0===e||(wr.save(this),this._curMat._bTransform?(Er.save(this),this._curMat.tx+=t*this._curMat.a+e*this._curMat.c,this._curMat.ty+=t*this._curMat.b+e*this._curMat.d):(this._curMat.tx=t,this._curMat.ty=e))}set lineWidth(t){this._other.lineWidth===t||(this._other=this._other.make(),xr.save(this,xr.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=t)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=Sr.Create(this)}restore(){var t=this._save._length,e=this._nBlendType;if(!(t<1)){for(var r=t-1;r>=0;r--){var i=this._save[r];if(i.restore(this),i.isSaveMark())return void(this._save._length=r)}e!=this._nBlendType&&(this.stopMerge=!0)}}fillText(t,e,r,i,s,a,n=0,l=""){li._textRender.filltext(this,t,e,r,i,s,l,n,a)}drawText(t,e,r,i,s,a){li._textRender.filltext(this,t,e,r,i,s,null,0,a)}strokeWord(t,e,r,i,s,a,n){li._textRender.filltext(this,t,e,r,i,null,s,a,n)}fillBorderText(t,e,r,i,s,a,n,l){li._textRender.filltext(this,t,e,r,i,s,a,n,l)}_fast_filltext(t,e,r,i,s,a,n,l){li._textRender._fast_filltext(this,t,e,r,i,s,a,n,l)}_fillRect(e,r,i,s,a){var n=this._curSubmit,l=this._mesh.vertexNum+4<li._MAXVERTNUM&&n&&n._key.submitType===Fr.KEY_DRAWTEXTURE&&n._key.blendShader===this._nBlendType&&!this.isStopMerge(n)&&this._curSubmit.material==this._material;l||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex);let o=this._mesh;this.transformQuad(e,r,i,s,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(l||(n=this._curSubmit=Fr.create(this,o,Cr.create(t.RenderSpriteData.Texture2D)),this.fillShaderValue(n.shaderValue),this._copyClipInfo(n.shaderValue),n.clipInfoID=this._clipInfoID,!this._lastTex||this._lastTex.destroyed?n.shaderValue.textureHost=this.defTexture:n.shaderValue.textureHost=this._lastTex,n._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1),o.addQuad(this._transedPoints,mt.NO_UV,a,!1),this._curSubmit._numEle+=6)}fillRect(t,e,r,i,s){var a=s?mr.create(s):this._fillStyle,n=this.mixRGBandAlpha(a.toInt());this._fillRect(t,e,r,i,n)}fillTexture(t,r,i,s,a,n,l,o){t._getSource()?this._fillTexture(t,t.width,t.height,t.uvrect,r,i,s,a,n,l.x,l.y,o):this.sprite&&e.systemTimer.callLater(this,this._repaintSprite)}_fillTexture(e,r,i,s,a,n,l,o,h,d,c,_){var p=this._curSubmit;this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex;var f=!0,g=!0;switch(h){case"repeat":break;case"repeat-x":g=!1;break;case"repeat-y":f=!1;break;case"no-repeat":f=g=!1}var m=this._temp4Points,y=0,T=0,x=0,v=0,S=0,E=0;if(d<0?(x=a,y=-d%r/r):x=a+d,c<0?(v=n,T=-c%i/i):v=n+c,S=a+l,E=n+o,!f&&(S=Math.min(S,a+d+r)),!g&&(E=Math.min(E,n+c+i)),!(S<a||E<n||x>S||v>E)){var w=(S-a-d)/r,D=(E-n-c)/i;if(this.transformQuad(x,v,S-x,E-v,0,this._curMat,this._transedPoints),m[0]=y,m[1]=T,m[2]=w,m[3]=T,m[4]=w,m[5]=D,m[6]=y,m[7]=D,!this.clipedOff(this._transedPoints)){var b=Cr.create(t.RenderSpriteData.Texture2D);b.shaderData.addDefine(Rr.FILLTEXTURE);var R=s.concat();u.tempVec4.setValue(R[0],R[1],R[2],R[3]),b.u_TexRange=u.tempVec4,p=this._curSubmit=Fr.create(this,this._mesh,b),this.fillShaderValue(b),p.clipInfoID=this._clipInfoID,p.shaderValue.textureHost=e;var C=this._mixRGBandAlpha(_,this._alpha);this._mesh.addQuad(this._transedPoints,m,C,!0),this._curSubmit._numEle+=6}this.breakNextMerge()}}setColorFilter(t){xr.save(this,xr.TYPE_COLORFILTER,this,!0),this._colorFiler=t,this.stopMerge=!0}drawTexture(t,e,r,i,s,a=4294967295){this._drawTextureM(t,e,r,i,s,null,1,null,a)}drawTextures(t,r,i,s,a){if(t._getSource())for(var n=r.length/2,l=0,o=t.bitmap.id,h=0;h<n;h++){const e="number"==typeof a[h]?a[h]:4294967295;this._inner_drawTexture(t,o,r[l++]+i,r[l++]+s,0,0,null,null,1,!1,e)}else this.sprite&&e.systemTimer.callLater(this,this._repaintSprite)}_drawTextureM(t,e,r,i,s,a,n,l,o){var h=this.sprite;return!!t._getSource((function(){h&&h.repaint()}))&&this._inner_drawTexture(t,t.bitmap.id,e,r,i,s,a,l,n,!1,o)}_drawRenderTexture(t,e,r,i,s,a,n,l,o=4294967295){return this._inner_drawTexture(t,-1,e,r,i,s,a,l,n,!1,o)}_copyClipInfo(t){let e=this._globalClipMatrix;var r=t.clipMatDir;r.x=e.a,r.y=e.b,r.z=e.c,r.w=e.d,t.clipMatDir=r;var i=t.clipMatPos;i.x=e.tx,i.y=e.ty,t.clipMatPos=i}_copyClipInfoToShaderData(t){let e=this._globalClipMatrix;u.tempVec4.setValue(e.a,e.b,e.c,e.d),t.setVector(Rr.UNIFORM_CLIPMATDIR,u.tempVec4),Qe.TempVector2.setValue(e.tx,e.ty),t.setVector2(Rr.UNIFORM_CLIPMATPOS,Qe.TempVector2)}isStopMerge(t){return this.stopMerge||t.clipInfoID!==this._clipInfoID}drawCallOptimize(t){return this._charSubmitCache.enable(t,this),t}_drawToRender2D(t){let e=this._mesh;if(e.indexNum<=0)return;let r=t.shaderValue,i=r.shaderData;switch(t._key.blendShader){case 1:case 3:case 5:i.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ONE),i.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE);break;case 2:i.setInt(dr.BLEND_SRC,xe.BLENDPARAM_DST_COLOR),i.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:i.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ZERO),i.setInt(dr.BLEND_DST,xe.BLENDPARAM_SRC_ALPHA);break;case 7:i.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ZERO),i.setInt(dr.BLEND_DST,xe.BLENDPARAM_ZERO);break;case 9:i.setInt(dr.BLEND_SRC,xe.BLENDPARAM_SRC_ALPHA),i.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:i.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ONE),i.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}if(t._colorFiler){var s=t._colorFiler;r.setFilter(s),$e.TEMPMatrix0.cloneByArray(s._mat),i.setMatrix4x4(Rr.UNIFORM_COLORMAT,$e.TEMPMatrix0),u.tempVec4.setValue(s._alpha[0],s._alpha[1],s._alpha[2],s._alpha[3]),i.setVector(Rr.UNIFORM_COLORALPHA,u.tempVec4)}this._drawMesh(e,0,e.vertexNum,t._startIdx,e.indexNum,t.shaderValue,t.material),this.stopMerge=!1,this._drawCount++}_drawMesh(t,e,r,i,s,a,n){this._render2DManager._renderEnd||this._render2DManager.render(oe.rendercontext2D),t.indexNum&&this._render2D.draw(t,e,r*t.vertexDeclarition.vertexStride,i,2*s,a,n),t.clearMesh(),a._needRelease||(a._needRelease=!0,this._shaderValueNeedRelease.push(a))}_inner_drawTexture(e,r,i,s,a,n,l,o,h,u,d){if(a<=0||n<=0)return!1;var c=this._curSubmit._key;if(o=o||e._uv,c.submitType===Fr.KEY_TRIANGLES&&c.other===r){var _=this._drawTexToDrawTri_Vert;_[0]=i,_[1]=s,_[2]=i+a,_[3]=s,_[4]=i+a,_[5]=s+n,_[6]=i,_[7]=s+n,this._drawTriUseAbsMatrix=!0;var p=this._tempUV;return p[0]=o[0],p[1]=o[1],p[2]=o[2],p[3]=o[3],p[4]=o[4],p[5]=o[5],p[6]=o[6],p[7]=o[7],this.drawTriangles(e,0,0,_,p,this._drawTexToDrawTri_Index,l||this._curMat,h,null,4294967295),this._drawTriUseAbsMatrix=!1,!0}var f=this._curSubmit,g=u?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(i,s,a||e.width,n||e.height,this._italicDeg,l||this._curMat,g),this.drawTexAlign){var m=Math.round;g[0]=m(g[0]),g[1]=m(g[1]),g[2]=m(g[2]),g[3]=m(g[3]),g[4]=m(g[4]),g[5]=m(g[5]),g[6]=m(g[6]),g[7]=m(g[7]),this.drawTexAlign=!1}var y=this._mixRGBandAlpha(d,this._alpha*h);if(u)return this._charSubmitCache.add(this,e,r,g,o,y),!0;var T=r>=0&&c.submitType===Fr.KEY_DRAWTEXTURE&&c.other===r&&!this.isStopMerge(this._curSubmit)&&this._mesh.vertexNum+4<li._MAXVERTNUM&&this._curSubmit.material==this._material;if(T||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex),this._lastTex=e,!T){let i=Cr.create(t.RenderSpriteData.Texture2D);this.fillShaderValue(i),i.textureHost=e,this._curSubmit=f=Fr.create(this,this._mesh,i),f._key.other=r,this._copyClipInfo(f.shaderValue),f.clipInfoID=this._clipInfoID}return this._mesh.addQuad(g,o,y,!0),f._numEle+=6,!0}fillShaderValue(t){t.size=new Qe(this._width,this._height),this._copyClipInfo(t)}clipedOff(t){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(t,e,r,i,s,a,n){var l=0;0!=s&&(l=Math.tan(s*Math.PI/180)*i);var o=t+r,h=e+i,u=a.tx,d=a.ty,c=a.a,_=a.b,p=a.c,f=a.d,g=t+l,m=e,y=o+l,T=e,x=o,v=h,S=t,E=h;a._bTransform?(n[0]=g*c+m*p+u,n[1]=g*_+m*f+d,n[2]=y*c+T*p+u,n[3]=y*_+T*f+d,n[4]=x*c+v*p+u,n[5]=x*_+v*f+d,n[6]=S*c+E*p+u,n[7]=S*_+E*f+d):(n[0]=g+u,n[1]=m+d,n[2]=y+u,n[3]=T+d,n[4]=x+u,n[5]=v+d,n[6]=S+u,n[7]=E+d)}breakNextMerge(){this.stopMerge=!0}_repaintSprite(){this.sprite&&this.sprite.repaint()}drawTextureWithTransform(t,e,r,i,s,a,n,l,o,h,u,d=4294967295){var c,_=this._curMat;if(h&&(c=this.globalCompositeOperation,this.globalCompositeOperation=h),!a)return this._drawTextureM(t,e+n,r+l,i,s,_,o,u,d),void(h&&(this.globalCompositeOperation=c));ni.a=a.a,ni.b=a.b,ni.c=a.c,ni.d=a.d,ni.tx=a.tx+n,ni.ty=a.ty+l,ni._bTransform=a._bTransform,a&&_._bTransform?(G.mul(ni,_,ni),(a=ni)._bTransform=!0):(ni.tx+=_.tx,ni.ty+=_.ty,a=ni),this._drawTextureM(t,e,r,i,s,a,o,u,d),h&&(this.globalCompositeOperation=c)}drawGeo(t,e,r,i){this.drawLeftData();let s=this._curMat,a=this._matBuffer;a[0]=s.a,a[1]=s.b,a[2]=s.tx+s.a*r+s.c*i,a[3]=s.c,a[4]=s.d,a[5]=s.ty+s.b*r+s.d*i,e.setBuffer("u_NMatrix",a),e.setVector2("u_size",new Qe(this._width,this._height)),this._render2D.drawMesh(t,e)}drawGeos(t,e,r,i){this.drawLeftData();let s=this._curMat,a=this._matBuffer;a[0]=s.a,a[1]=s.b,a[2]=s.tx+s.a*r+s.c*i,a[3]=s.c,a[4]=s.d,a[5]=s.ty+s.b*r+s.d*i;for(let r=0,i=e.length;r<i;r++){let i=e[r][0];i.setBuffer("u_NMatrix",a),i.setVector2("u_size",new Qe(this._width,this._height)),t.clearRenderParams(),t.setDrawElemenParams(e[r][1],e[r][2]),this._render2D.drawMesh(t,i)}}drawTriangles(r,i,s,a,n,l,o,h,u,d=4294967295){if(null==h&&(h=1),r._getSource()){var c=null;u&&(c=this.globalCompositeOperation,this.globalCompositeOperation=u);var _=r.bitmap,p=this._curSubmit._key,f=p.submitType===Fr.KEY_TRIANGLES&&p.other===_.id&&p.blendShader==this._nBlendType&&this._mesh.vertexNum+a.length/2<li._MAXVERTNUM&&this._curSubmit.material==this._material;if(f||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshTex),!f){var g=this._curSubmit=Fr.create(this,this._mesh,Cr.create(t.RenderSpriteData.Texture2D));g.shaderValue.textureHost=r,this.fillShaderValue(g.shaderValue),g._key.submitType=Fr.KEY_TRIANGLES,g._key.other=_.id,this._copyClipInfo(g.shaderValue),g.clipInfoID=this._clipInfoID}var m=this._mixRGBandAlpha(d,this._alpha*h);this._drawTriUseAbsMatrix?this._mesh.addData(a,n,l,o,m,null):(o?(ni.a=o.a,ni.b=o.b,ni.c=o.c,ni.d=o.d,ni.tx=o.tx+i,ni.ty=o.ty+s):(ni.a=1,ni.b=0,ni.c=0,ni.d=1,ni.tx=i,ni.ty=s),G.mul(ni,this._curMat,ni),this._mesh.addData(a,n,l,ni||this._curMat,m,null)),this._curSubmit._numEle+=l.length,u&&(this.globalCompositeOperation=c)}else this.sprite&&e.systemTimer.callLater(this,this._repaintSprite)}transform(t,e,r,i,s,a){Er.save(this),G.mul(G.TEMP.setTo(t,e,r,i,s,a),this._curMat,this._curMat),this._curMat._checkTransform()}rotate(t){Er.save(this),this._curMat.rotateEx(t)}scale(t,e){Er.save(this),this._curMat.scaleEx(t,e)}clipRect(t,e,r,i,s){if(vr.save(this),this._clipRect==li.MAXCLIPRECT?this._clipRect=new F(t,e,r,i):(this._clipRect.width=r,this._clipRect.height=i,this._clipRect.x=t,this._clipRect.y=e),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,s)si.copyTo(this._globalClipMatrix);else{var a=this._globalClipMatrix,n=a.tx,l=a.ty,o=n+a.a,h=l+a.d;if(this._clipRect.width>=Ut.MAX_CLIP_SIZE?(a.a=a.d=Ut.MAX_CLIP_SIZE,a.b=a.c=a.tx=a.ty=0):this._curMat._bTransform?(a.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,a.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,a.a=this._clipRect.width*this._curMat.a,a.b=this._clipRect.width*this._curMat.b,a.c=this._clipRect.height*this._curMat.c,a.d=this._clipRect.height*this._curMat.d):(a.tx=this._clipRect.x+this._curMat.tx,a.ty=this._clipRect.y+this._curMat.ty,a.a=this._clipRect.width,a.b=a.c=0,a.d=this._clipRect.height),a.a>0&&a.d>0){var u=a.tx+a.a,d=a.ty+a.d;u<=n||d<=l||a.tx>=o||a.ty>=h?(a.a=-.1,a.d=-.1):(a.tx<n&&(a.a-=n-a.tx,a.tx=n),u>o&&(a.a-=u-o),a.ty<l&&(a.d-=l-a.ty,a.ty=l),d>h&&(a.d-=d-h),a.a<=0&&(a.a=-.1),a.d<=0&&(a.d=-.1))}}}startRender(){for(let t of this._shaderValueNeedRelease)t.release(),t._needRelease=!1;this._shaderValueNeedRelease.length=0,this._render2D.renderStart(this._clear,this._clearColor),this.clear()}endRender(){this.flush(),this._render2DManager._renderEnd||this._render2DManager.render(oe.rendercontext2D),this._render2D.renderEnd(),this._curSubmit=Fr.RENDERBASE}drawLeftData(){this._render2DManager._renderEnd||this._render2DManager.render(oe.rendercontext2D),this._drawToRender2D(this._curSubmit)}flush(){this.drawLeftData(),this._clipID_Gen=0,this._path&&this._path.reset(),this._curSubmit=Fr.RENDERBASE,this._flushCnt++,this._flushCnt%60==0&&this.isMain&&ti.textRenderInst&&ti.textRenderInst.GC()}beginPath(t=!1){this._getPath().beginPath(t)}closePath(){this._path.closePath()}addPath(t,e,r,i,s){let a=t.length;for(let e=0;e<a-1;e+=2)t[e]+=i,t[e+1]+=s;e&&a>5&&(t[a-2]!=t[0]||t[a-1]!=t[1])&&t.push(t[0],t[1]),this._getPath().push(t,r)}fill(){var t=this._curMat,e=this._getPath(),r=this._curSubmit;r._key.submitType===Fr.KEY_VG&&r._key.blendShader===this._nBlendType&&!this.isStopMerge(r)&&this._curSubmit.material==this._material||(this._drawToRender2D(r),this._mesh=this._meshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));for(var i,s=this.mixRGBandAlpha(this.fillStyle.toInt()),a=0,n=0,l=e.paths.length;n<l;n++){var o=e.paths[n],h=o.path.length/2;if(!(h<3||3==h&&!o.convex)){var u,d,c,_,p=o.path.concat(),f=0;if(t._bTransform)for(f=0;f<h;f++)d=(u=f<<1)+1,c=p[u],_=p[d],p[u]=t.a*c+t.c*_+t.tx,p[d]=t.b*c+t.d*_+t.ty;else for(f=0;f<h;f++)d=(u=f<<1)+1,c=p[u],_=p[d],p[u]=c+t.tx,p[d]=_+t.ty;this._mesh.vertexNum+h>li._MAXVERTNUM&&(this._curSubmit._numEle+=a,a=0,this._mesh=new ii,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));var g=this._mesh.vertexNum;if(o.convex){var m=h-2;i=new Array(3*m);for(var y=0,T=0;T<m;T++)i[y++]=g,i[y++]=T+1+g,i[y++]=T+2+g}else if(i=Nr.earcut(p,null,2),g>0)for(var x=0;x<i.length;x++)i[x]+=g;this._mesh.addVertAndIBToMesh(p,s,i),a+=i.length}}this._curSubmit._numEle+=a}addVGSubmit(e){var r=Fr.create(this,e,Cr.create(t.RenderSpriteData.Primitive));return this.fillShaderValue(r.shaderValue),r._key.submitType=Fr.KEY_VG,this._copyClipInfo(r.shaderValue),r.clipInfoID=this._clipInfoID,r}stroke(){if(!(this.lineWidth<=0)){var t=this.mixRGBandAlpha(this.strokeStyle._color.numColor),e=this._getPath(),r=this._curSubmit;r._key.submitType===Fr.KEY_VG&&r._key.blendShader===this._nBlendType&&!this.isStopMerge(r)&&this._curSubmit.material==this._material||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));for(var i=0,s=0,a=e.paths.length;s<a;s++){var n=e.paths[s];if(!(n.path.length<=0)){var l=[],o=[],h=2*n.path.length;if(!(h<2)){this._mesh.vertexNum+h>li._MAXVERTNUM&&(this._curSubmit._numEle+=i,i=0,this._drawToRender2D(this._curSubmit),this._mesh=new ii,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue)),Lr.createLine2(n.path,l,this.lineWidth,this._mesh.vertexNum,o,n.loop);var u,d,c,_,p=o.length/2,f=this._curMat,g=0;if(f._bTransform)for(g=0;g<p;g++)d=(u=g<<1)+1,c=o[u],_=o[d],o[u]=f.a*c+f.c*_+f.tx,o[d]=f.b*c+f.d*_+f.ty;else for(g=0;g<p;g++)d=(u=g<<1)+1,c=o[u],_=o[d],o[u]=c+f.tx,o[d]=_+f.ty;this._mesh.addVertAndIBToMesh(o,t,l),i+=l.length}}}this._curSubmit._numEle+=i}}moveTo(t,e){var r=this._getPath();r.newPath(),r._lastOriX=t,r._lastOriY=e,r.addPoint(t,e)}lineTo(t,e){var r=this._getPath();Math.abs(t-r._lastOriX)<.001&&Math.abs(e-r._lastOriY)<.001||(r._lastOriX=t,r._lastOriY=e,r.addPoint(t,e))}arcTo(t,e,r,i,s){var a=0,n=0,l=0,o=this._path._lastOriX-t,h=this._path._lastOriY-e,u=Math.sqrt(o*o+h*h);if(!(u<=1e-6)){var d=o/u,c=h/u,_=r-t,p=i-e,f=_*_+p*p,g=Math.sqrt(f);if(!(g<=1e-6)){var m=_/g,y=p/g,T=d+m,x=c+y,v=Math.sqrt(T*T+x*x);if(!(v<=1e-6)){var S=T/v,E=x/v,w=Math.acos(S*d+E*c),D=Math.PI/2-w,b=(u=s*Math.tan(D))*d+t,R=u*c+e,C=Math.sqrt(u*u+s*s),A=t+S*C,I=e+E*C,M=0,B=0;if(d*y-c*m>=0){var L=2*D/li.SEGNUM;M=Math.sin(L),B=Math.cos(L)}else L=2*-D/li.SEGNUM,M=Math.sin(L),B=Math.cos(L);var P=this._path._lastOriX,N=this._path._lastOriY,O=b,F=R;(Math.abs(O-this._path._lastOriX)>.1||Math.abs(F-this._path._lastOriY)>.1)&&(n=O,l=F,P=O,N=F,this._path._lastOriX=n,this._path._lastOriY=l,this._path.addPoint(n,l));var U=b-A,k=R-I;for(a=0;a<li.SEGNUM;a++){var G=U*B+k*M,V=-U*M+k*B;n=G+A,l=V+I,(Math.abs(P-n)>.1||Math.abs(N-l)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=l,this._path.addPoint(n,l),P=n,N=l),U=G,k=V}}}}}arc(t,e,r,i,s,a,n=!1,l=!0,o=20){s>a&&([s,a]=[a,s]);var h=this.getMatScaleX(),u=this.getMatScaleY(),d=r*(h>u?h:u),c=2*Math.PI*d;let _=0|Math.max(c/5,o),p=2*Math.PI/_;var f=this._getPath();let g=t+Math.cos(s)*r,m=e+Math.sin(s)*i;g==this._path._lastOriX&&m==this._path._lastOriY||f.addPoint(g,m);let y=Math.ceil(s/p)*p;for(;a-y>=p;)g=t+Math.cos(y)*r,m=e+Math.sin(y)*i,f.addPoint(g,m),y+=p;g=t+Math.cos(a)*r,m=e+Math.sin(a)*i,g==this._path._lastOriX&&m==this._path._lastOriY||f.addPoint(g,m)}quadraticCurveTo(t,e,r,i){for(var s=cr.I.getBezierPoints([this._path._lastOriX,this._path._lastOriY,t,e,r,i],30,2),a=0,n=s.length/2;a<n;a++)this.lineTo(s[2*a],s[2*a+1]);this.lineTo(r,i)}mixRGBandAlpha(t){return this._mixRGBandAlpha(t,this._alpha)}_mixRGBandAlpha(t,e){if(e>=1)return t;var r=(4278190080&t)>>>24;return 0!=r?r*=e:r=255*e,16777215&t|r<<24}strokeRect(t,e,r,i,s){if(this.lineWidth>0){var a=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(t-n,e-n,r+this.lineWidth,this.lineWidth,a),this._fillRect(t-n,e-n+i,r+this.lineWidth,this.lineWidth,a),this._fillRect(t-n,e+n,this.lineWidth,i-this.lineWidth,a),this._fillRect(t-n+r,e+n,this.lineWidth,i-this.lineWidth,a)}}drawParticle(t,e,r){}_getPath(){return this._path||(this._path=new yr)}get canvas(){return this._canvas}_fillTexture_h(t,e,r,i,s,a,n,l,o){if(!(i<=0)){for(var h=a,u=Math.floor(l/i),d=l%i,c=0;c<u;c++)this._inner_drawTexture(t,e,h,n,i,s,this._curMat,r,1,!1,o),h+=i;if(d>0){var _=r[2]-r[0],p=r[0]+_*(d/i),f=ai;f[0]=r[0],f[1]=r[1],f[2]=p,f[3]=r[3],f[4]=p,f[5]=r[5],f[6]=r[6],f[7]=r[7],this._inner_drawTexture(t,e,h,n,d,s,this._curMat,f,1,!1,o)}}}_fillTexture_v(t,e,r,i,s,a,n,l,o){if(!(s<=0)){for(var h=n,u=Math.floor(l/s),d=l%s,c=0;c<u;c++)this._inner_drawTexture(t,e,a,h,i,s,this._curMat,r,1,!1,o),h+=s;if(d>0){var _=r[7]-r[1],p=r[1]+_*(d/s),f=ai;f[0]=r[0],f[1]=r[1],f[2]=r[2],f[3]=r[3],f[4]=r[4],f[5]=p,f[6]=r[6],f[7]=p,this._inner_drawTexture(t,e,a,h,i,d,this._curMat,f,1,!1,o)}}}drawTextureWithSizeGrid(t,e,r,i,s,a,n,l,o){if(t._getSource()){e+=n,r+=l;var h=t.uv,u=t.bitmap.width,d=t.bitmap.height,c=a[0],_=a[3],p=a[1],f=a[2],g=a[4];i==t.width&&(_=p=0),s==t.height&&(c=f=0);var m=c/d,y=_/u,T=p/u,x=f/d,v=t.bitmap.id,S=this._curMat,E=this._tempUV,w=1,D=1;_+p>i&&(w=i/(_+p)),c+f>s&&(D=s/(c+f)),_*=w,p*=w,c*=D,f*=D;var b=h[0],R=h[1],C=h[4],A=h[5],I=b,M=R,B=C,L=A;if(_&&c&&(B=b+y,L=R+m,E[0]=b,E[1]=R,E[2]=B,E[3]=R,E[4]=B,E[5]=L,E[6]=b,E[7]=L,this._inner_drawTexture(t,v,e,r,_,c,S,E,1,!1,o)),p&&c&&(I=C-T,M=R,B=C,L=R+m,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,this._inner_drawTexture(t,v,i-p+e,0+r,p,c,S,E,1,!1,o)),_&&f&&(I=b,M=A-x,B=b+y,L=A,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,this._inner_drawTexture(t,v,0+e,s-f+r,_,f,S,E,1,!1,o)),p&&f&&(I=C-T,M=A-x,B=C,L=A,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,this._inner_drawTexture(t,v,i-p+e,s-f+r,p,f,S,E,1,!1,o)),c&&(I=b+y,M=R,B=C-T,L=R+m,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g?this._fillTexture_h(t,v,E,t.width-_-p,c,_+e,r,i-_-p,o):this._inner_drawTexture(t,v,_+e,r,i-_-p,c,S,E,1,!1,o)),f&&(I=b+y,M=A-x,B=C-T,L=A,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g?this._fillTexture_h(t,v,E,t.width-_-p,f,_+e,s-f+r,i-_-p,o):this._inner_drawTexture(t,v,_+e,s-f+r,i-_-p,f,S,E,1,!1,o)),_&&(I=b,M=R+m,B=b+y,L=A-x,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g?this._fillTexture_v(t,v,E,_,t.height-c-f,e,c+r,s-c-f,o):this._inner_drawTexture(t,v,e,c+r,_,s-c-f,S,E,1,!1,o)),p&&(I=C-T,M=R+m,B=C,L=A-x,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g?this._fillTexture_v(t,v,E,p,t.height-c-f,i-p+e,c+r,s-c-f,o):this._inner_drawTexture(t,v,i-p+e,c+r,p,s-c-f,S,E,1,!1,o)),I=b+y,M=R+m,B=C-T,L=A-x,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g){var P=li.tmpUVRect;P[0]=I,P[1]=M,P[2]=B-I,P[3]=L-M,this._fillTexture(t,t.width-_-p,t.height-c-f,P,_+e,c+r,i-_-p,s-c-f,"repeat",0,0,o)}else this._inner_drawTexture(t,v,_+e,c+r,i-_-p,s-c-f,S,E,1,!1,o)}}}li._MAXVERTNUM=65535,li.MAXCLIPRECT=null,li.SEGNUM=32,li._contextcount=0,li._textRender=null,li.tmpUVRect=[0,0,0,0];class oi{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===oi.DEFAULT?new oi:this}}class hi{static __init__(){hi.map[ie.ALPHA|ie.TRANSFORM|ie.GRAPHICS]=hi.alpha_transform_drawLayaGL,hi.map[ie.ALPHA|ie.GRAPHICS]=hi.alpha_drawLayaGL,hi.map[ie.TRANSFORM|ie.GRAPHICS]=hi.transform_drawLayaGL,hi.map[ie.TRANSFORM|ie.CHILDS]=hi.transform_drawNodes,hi.map[ie.ALPHA|ie.TRANSFORM|ie.TEXTURE]=hi.alpha_transform_drawTexture,hi.map[ie.ALPHA|ie.TEXTURE]=hi.alpha_drawTexture,hi.map[ie.TRANSFORM|ie.TEXTURE]=hi.transform_drawTexture,hi.map[ie.GRAPHICS|ie.CHILDS]=hi.drawLayaGL_drawNodes}static transform_drawTexture(t,e,r,i){var s=t.texture;e.save(),e.transformByMatrix(t.transform,r,i);var a=t._isWidthSet?t._width:s.sourceWidth,n=t._isHeightSet?t._height:s.sourceHeight,l=a/s.sourceWidth,o=n/s.sourceHeight;if(a=s.width*l,n=s.height*o,a<=0||n<=0)return null;var h=-t.pivotX+s.offsetX*l,u=-t.pivotY+s.offsetY*o;t._getBit(kt.HIDE_BY_EDITOR)||e.drawTexture(s,h,u,a,n),e.restore()}static alpha_drawTexture(t,e,r,i){var s=t._style,a=s.alpha,n=t.texture;if(a>.01||t._needRepaint()){var l=e.globalAlpha;e.globalAlpha*=a;var o=t._isWidthSet?t._width:n.sourceWidth,h=t._isHeightSet?t._height:n.sourceHeight,u=o/n.sourceWidth,d=h/n.sourceHeight;if(o=n.width*u,h=n.height*d,o<=0||h<=0)return null;var c=r-s.pivotX+n.offsetX*u,_=i-s.pivotY+n.offsetY*d;t._getBit(kt.HIDE_BY_EDITOR)||e.drawTexture(n,c,_,o,h),e.globalAlpha=l}}static alpha_transform_drawTexture(t,e,r,i){var s=t._style,a=s.alpha,n=t.texture;if(a>.01||t._needRepaint()){var l=e.globalAlpha;e.globalAlpha*=a,e.save(),e.transformByMatrix(t.transform,r,i);var o=t._isWidthSet?t._width:n.sourceWidth,h=t._isHeightSet?t._height:n.sourceHeight,u=o/n.sourceWidth,d=h/n.sourceHeight;if(o=n.width*u,h=n.height*d,o<=0||h<=0)return null;var c=-s.pivotX+n.offsetX*u,_=-s.pivotY+n.offsetY*d;t._getBit(kt.HIDE_BY_EDITOR)||e.drawTexture(n,c,_,o,h),e.restore(),e.globalAlpha=l}}static alpha_transform_drawLayaGL(t,e,r,i){var s=t._style,a=s.alpha;if(a>.01||t._needRepaint()){var n=e.globalAlpha;e.globalAlpha*=a,e.save(),e.transformByMatrix(t.transform,r,i),t._getBit(kt.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,-s.pivotX,-s.pivotY),e.restore(),e.globalAlpha=n}}static alpha_drawLayaGL(t,e,r,i){var s=t._style,a=s.alpha;if(a>.01||t._needRepaint()){var n=e.globalAlpha;e.globalAlpha*=a,t._getBit(kt.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,r-s.pivotX,i-s.pivotY),e.globalAlpha=n}}static transform_drawLayaGL(t,e,r,i){var s=t._style;e.save(),e.transformByMatrix(t.transform,r,i),t._getBit(kt.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,-s.pivotX,-s.pivotY),e.restore()}static transform_drawNodes(t,e,r,i){var s=t._getBit(kt.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0),a=t._style;e.save(),e.transformByMatrix(t.transform,r,i),r=-a.pivotX,i=-a.pivotY;var n=t._children,l=n.length;let o,h,u,d,c,_,p;a.viewport&&(o=a.viewport,h=o.x,u=o.y,d=o.right,c=o.bottom);for(let t=0;t<l;++t){let s=n[t],a=s._visible||s._getBit(kt.DISABLE_VISIBILITY);o&&((_=s._x)>=d||_+s.width<=h||(p=s._y)>=c||p+s.height<=u)&&(a=!1),a&&s.render(e,r,i)}e.restore(),s&&e.drawCallOptimize(!1)}static drawLayaGL_drawNodes(t,e,r,i){var s=t._getBit(kt.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0);let a=e._drawingToTexture;var n=t._style;r-=n.pivotX,i-=n.pivotY,t._getBit(kt.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,r,i);var l=t._children,o=l.length;let h,u,d,c,_,p,f,g;n.viewport&&(h=n.viewport,u=h.x,d=h.y,c=h.right,_=h.bottom);for(let t=0;t<o;++t){let s=l[t];g=a?s._visible&&!s._getBit(kt.ESCAPE_DRAWING_TO_TEXTURE):s._visible||s._getBit(kt.DISABLE_VISIBILITY),h&&((p=s._x)>=c||p+s.width<=u||(f=s._y)>=_||f+s.height<=d)&&(g=!1),g&&s.render(e,r,i)}s&&e.drawCallOptimize(!1)}}hi.map=[];var ui=0;class di extends li{constructor(){super(...arguments),this.cache=null,this.mustTouchRes=[],this.randomTouchRes=[],this.genID=ui++}touchRes(t){t.isRandomTouch?this.randomTouchRes.push(t):this.mustTouchRes.push(t)}}class ci extends le{constructor(){super(null),this.renderResult=[]}clone(t){return null}_createMesh(){}setVertexDecl(t){this._tex_vert_decl!=t&&(this._tex_vert_decl=t,this._createMesh())}renderStart(){}draw(t,e,r,i,s,a){this.setVertexDecl(t.vertexDeclarition);let n=new _i(t,e,r,i,s,a),l=a.clipMatPos,o=a.clipMatDir,h=n.localClipMatrix;h.a=o.x,h.b=o.y,h.c=o.z,h.d=o.w,h.tx=l.x,h.ty=l.y,a.shaderData.addDefine(Rr.WORLDMAT),n.toNativeMesh(),this.renderResult.push(n)}drawMesh(t,e){throw new V}drawElement(t){throw new V}renderEnd(){}}class _i{constructor(t,e,r,i,s,a){this.localClipMatrix=new G,this.vertexDeclarition=t.vertexDeclarition,this.vbBuffer=new ArrayBuffer(r),this.ibBuffer=new ArrayBuffer(s),new Uint8Array(this.vbBuffer).set(new Uint8Array(t.vbBuffer,e,r)),new Uint8Array(this.ibBuffer).set(new Uint8Array(t.ibBuffer,i,s)),this.mtl=a,this.vboff=0,this.vblen=r,this.iboff=0,this.iblen=s}toNativeMesh(){let e=l.renderDeviceFactory,r=this.geo=e.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),i=r.bufferState=e.createBufferState(),s=e.createVertexBuffer(t.BufferUsage.Dynamic);s.vertexDeclaration=this.vertexDeclarition;let a=e.createIndexBuffer(t.BufferUsage.Dynamic);i.applyState([s],a),r.indexFormat=t.IndexFormat.UInt16,s.setDataLength(this.vblen),s.setData(this.vbBuffer,this.vboff,0,this.vblen),a._setIndexDataLength(this.iblen),a._setIndexData(new Uint16Array(this.ibBuffer,this.iboff,this.iblen/2),0),r.clearRenderParams(),r.setDrawElemenParams(this.iblen/2,0),this.renderElement=l.render2DRenderPassFactory.createRenderElement2D(),this.renderElement.geometry=r,this.renderElement.value2DShaderData=this.mtl.shaderData,this.renderElement.subShader=this.mtl._defaultShader.getSubShaderAt(0),this.renderElement.materialShaderData=null}destroyGPUResource(){this.renderElement&&this.renderElement.destroy();let t=this.geo;t&&(t.bufferState._vertexBuffers[0].destroy(),t.bufferState._bindedIndexBuffer.destroy(),t.bufferState.destroy(),t.bufferState,t.destroy(),this.geo=null)}}class pi{constructor(){this.page=null}reset(){this.page&&this.page.reset(),this.page=null}}function fi(t,e,r){let i=t.tx+t.a,s=t.ty+t.d,a=e.tx+e.a,n=e.ty+e.d,l=r.tx=Math.max(t.tx,e.tx),o=r.ty=Math.max(t.ty,e.ty);if(r.b=r.c=0,r.tx=l,r.ty=o,i<=e.tx||s<=e.ty||a<=t.tx||n<=t.ty)r.a=-.1,r.d=-.1;else{let t=Math.min(i,a),e=Math.min(s,n);r.a=t-l,r.d=e-o}return r}class gi{constructor(t,e,r){this.alpha=1,this.width=0,this.height=0,this.blend=0;let i=this.curMatrix=t._curMat.clone();i.tx+=i.a*e+i.c*r,i.ty+=i.b*e+i.d*r,this.alpha=t.globalAlpha,this.render2d=t.render2D,this.width=t.width,this.height=t.height,this.clipInfo=t._globalClipMatrix.clone(),this.blend=t._nBlendType}_copyClipInfo(t){let e=this.clipInfo;var r=t.clipMatDir;r.x=e.a,r.y=e.b,r.z=e.c,r.w=e.d,t.clipMatDir=r;var i=t.clipMatPos;i.x=e.tx,i.y=e.ty,t.clipMatPos=i}clipRect(t){let e=t.x,r=t.y,i=t.width,s=t.height;var a=this.clipInfo,n=a.tx,l=a.ty,o=n+a.a,h=l+a.d;if(i>=Ut.MAX_CLIP_SIZE)a.a=a.d=Ut.MAX_CLIP_SIZE,a.b=a.c=a.tx=a.ty=0;else{let t=this.curMatrix;t._bTransform?(a.tx=e*t.a+r*t.c+t.tx,a.ty=e*t.b+r*t.d+t.ty,a.a=i*t.a,a.b=i*t.b,a.c=s*t.c,a.d=s*t.d):(a.tx=e+t.tx,a.ty=r+t.ty,a.a=i,a.b=a.c=0,a.d=s)}if(a.a>0&&a.d>0){var u=a.tx+a.a,d=a.ty+a.d;u<=n||d<=l||a.tx>=o||a.ty>=h?(a.a=-.1,a.d=-.1):(a.tx<n&&(a.a-=n-a.tx,a.tx=n),u>o&&(a.a-=u-o),a.ty<l&&(a.d-=l-a.ty,a.ty=l),d>h&&(a.d-=d-h),a.a<=0&&(a.a=-.1),a.d<=0&&(a.d=-.1))}}setBlendMode(t){this.blend=pr.TOINT[t]}_applyBlend(t){let e=t.shaderData;switch(this.blend){case 1:case 3:case 5:e.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ONE),e.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE);break;case 2:e.setInt(dr.BLEND_SRC,xe.BLENDPARAM_DST_COLOR),e.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:e.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ZERO),e.setInt(dr.BLEND_DST,xe.BLENDPARAM_SRC_ALPHA);break;case 7:e.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ZERO),e.setInt(dr.BLEND_DST,xe.BLENDPARAM_ZERO);break;case 9:e.setInt(dr.BLEND_SRC,xe.BLENDPARAM_SRC_ALPHA),e.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:e.setInt(dr.BLEND_SRC,xe.BLENDPARAM_ONE),e.setInt(dr.BLEND_DST,xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}}}class mi{constructor(){this.sprite=null,this.meshes=null,this.defferTouchRes=null,this.defferTouchResRand=null,this.children=null}reset(){this.clearGPUObject()}clearGPUObject(){this.meshes&&this.meshes.forEach((t=>{t.destroyGPUResource()}))}render(t,e,r){let i=t.transform,s=e.curMatrix;if(r)s.copyTo(xi);else{let r=t._x,a=t._y;i?(i.copyTo(Si),Si.tx=r,Si.ty=a,G.mul(Si,s,xi)):(xi.a=s.a,xi.b=s.b,xi.c=s.c,xi.d=s.d,xi.tx=s.a*r+s.c*a+s.tx,xi.ty=s.b*r+s.d*a+s.ty),e.alpha*=t.alpha,t.blendMode&&e.setBlendMode(t.blendMode)}yi.setValue(e.width,e.height);let a=Ei,n=a.elements;n[0]=xi.a,n[1]=xi.b,n[4]=xi.c,n[5]=xi.d,n[12]=xi.tx,n[13]=xi.ty,this.meshes.forEach((t=>{let r=e.render2d,i=t.mtl;i.textureHost instanceof Xr&&i.textureHost.touchTexture(),i.size=yi;let s=t.localClipMatrix;s.a==Ut.MAX_CLIP_SIZE&&s.d==Ut.MAX_CLIP_SIZE?e.clipInfo.copyTo(wi):(G.mul(s,xi,wi),fi(e.clipInfo,wi,wi));let n=i.clipMatDir,l=i.clipMatPos;n.x=wi.a,n.y=wi.b,n.z=wi.c,n.w=wi.d,i.clipMatDir=n,l.x=wi.tx,l.y=wi.ty,i.clipMatPos=l,i.mmat=a,i.vertAlpha=e.alpha,e._applyBlend(i),r.drawElement(t.renderElement)})),this.defferTouchRes.forEach((t=>{t.touch()})),this.defferTouchResRand.forEach((t=>t.touch())),this.children&&this.children.forEach((t=>{let r=e.curMatrix.clone(),i=e.alpha,s=t.parent._cacheStyle.cacheInfo,a=s.mat;G.mul(a,r,e.curMatrix),e.alpha*=s.alpha;let n=e.blend;null!=s.blend&&e.setBlendMode(s.blend);let l=e.clipInfo.clone(),o=s.clipMatrix;G.mul(o,e.curMatrix,wi),fi(e.clipInfo,wi,e.clipInfo),t._cacheStyle.cacheInfo.page.render(t,e,!1),e.curMatrix=r,e.alpha=i,e.blend=n,e.clipInfo=l}))}}var yi=new Qe;class Ti{static curMatSubSpriteMat(t,e,r){if(t._renderType&ie.TRANSFORM)t.transform.copyTo(vi),vi.tx=t._x,vi.ty=t._y,vi.invert(),G.mul(vi,e,r);else{e.copyTo(r);let i=-t._x,s=-t._y;r.tx+=r.a*i+r.c*s,r.ty+=r.b*i+r.d*s}return r}static renderCacheAsNormal(t,r,i,a,n){let l=!1;var o=r._getCacheStyle().cacheInfo.page;if(!o||r._needRepaint()||e.stage.isGlobalRepaint()){if(r.alpha<=1e-6&&(r.alpha=.001),l=!0,t instanceof di){let e=t.cache;e.children?e.children.indexOf(r)<0&&e.children.push(r):e.children=[r];let i=r.parent,s=i._cacheStyle.cacheInfo;if(s.page=e,t.genID!=s.contextID){s.contextID=t.genID;let l=t._curMat.clone();0==a&&0==n||(l.tx+=a*l.a+n*l.c,l.ty+=a*l.b+n*l.d),s.mat=Ti.curMatSubSpriteMat(r,l,l),s.alpha=t.globalAlpha/r.alpha;let o=e.sprite;if(i.blendMode)s.blend=i.blendMode;else{let t=i;for(;t!=o;)if(t=t.parent,t.blendMode){s.blend=t.blendMode;break}}s.clipMatrix=t._globalClipMatrix.clone()}}(o=r._cacheStyle.cacheInfo.page=new mi).sprite=r,se.canvasNormal++;let e=new di;e.cache=o;let h=new ci;e.render2D=h,e.startRender(),i._fun(r,e,0,0),e.endRender(),o.meshes=h.renderResult,o.defferTouchRes=e.mustTouchRes,o.defferTouchResRand=e.randomTouchRes,r.once(s.REMOVED,(()=>{(o=r._cacheStyle.cacheInfo.page).reset()}))}if(!(t instanceof di)){let e=new gi(t,a,n);o.render(r,e,!0)}return l}}var xi=new G,vi=new G,Si=new G,Ei=new $e,wi=new G;class Di{static __init__(){hi.__init__();var t=new Di(69905,null);let e=Di.renders.length=2*ie.CHILDS;for(let r=0;r<e;r++)Di.renders[r]=t;Di.renders[0]=new Di(0,null)}static _initRenderFun(t,e,r,i){var s=t._renderType;(Di.renders[s]=Di._getTypeRender(s))._fun(t,e,r,i)}static _getTypeRender(t){if(hi.map[t]&&n.isPlaying)return new Di(t,null);for(var e=null,r=ie.CHILDS;r>0;)r&t&&(e=new Di(r,e)),r>>=1;return e}constructor(t,e){if(this._spriteRect_TextureSpace=new F,this._maskRect_TextureSpace=new F,hi.map[t]&&n.isPlaying)return this._fun=hi.map[t],void(this._next=Di.NORENDER);switch(this._next=e||Di.NORENDER,t){case 0:return void(this._fun=this._no);case ie.ALPHA:return void(this._fun=this._alpha);case ie.TRANSFORM:return void(this._fun=this._transform);case ie.BLEND:return void(this._fun=this._blend);case ie.CANVAS:return void(this._fun=this._canvas);case ie.MASK:return void(this._fun=this._mask);case ie.CLIP:return void(this._fun=this._clip);case ie.GRAPHICS:return void(this._fun=this._graphics);case ie.CHILDS:return void(this._fun=this._children);case ie.CUSTOM:return void(this._fun=this._custom);case ie.TEXTURE:return void(this._fun=this._texture);case ie.FILTERS:return void(this._fun=ee._filter);case ie.HITAREA:return void(this._fun=this._hitarea);case ie.RENDERNODE2D:this._fun=this._renderNode2D;break;case 69905:return void(this._fun=Di._initRenderFun)}}_renderNode2D(t,e,r,i){t._renderNode.addCMDCall&&t._renderNode.addCMDCall(e,r,i),e.drawLeftData(),e._render2DManager._renderEnd?(e._render2DManager._renderEnd=!1,e._render2DManager.addRenderObject(t._renderNode)):e._render2DManager.addRenderObject(t._renderNode),this._next!=Di.NORENDER&&this._next._fun(t,e,r,i)}_no(t,e,r,i){}_custom(t,e,r,i){t.customRender(e,r,i),this._next._fun(t,e,0,0)}_clip(t,e,r,i){let s=this._next;if(s==Di.NORENDER)return;if(t._getBit(kt.DISABLE_INNER_CLIPPING)&&!e._drawingToTexture)return void s._fun(t,e,r,i);let a=t._style.scrollRect,n=a.width,l=a.height;0===n&&(n=.001),0===l&&(l=.001),e.save(),e.clipRect(r,i,n,l),s._fun(t,e,r-a.x,i-a.y),e.restore()}_texture(t,e,r,i){if(!t._getBit(kt.HIDE_BY_EDITOR)){var s=t.texture;if(s._getSource()){var a=t._isWidthSet?t._width:s.sourceWidth,n=t._isHeightSet?t._height:s.sourceHeight,l=a/s.sourceWidth,o=n/s.sourceHeight;if(a=s.width*l,n=s.height*o,a>0&&n>0){let h=r-t.pivotX+s.offsetX*l,u=i-t.pivotY+s.offsetY*o;e._material=t.graphics.material,e.drawTexture(s,h,u,a,n,4294967295),e._material=null}}}this._next!=Di.NORENDER&&this._next._fun(t,e,r,i)}_graphics(t,e,r,i){if(!t._getBit(kt.HIDE_BY_EDITOR)){let s=t._style,a=t._graphics;a&&a._render(t,e,r-s.pivotX,i-s.pivotY)}this._next!=Di.NORENDER&&this._next._fun(t,e,r,i)}_hitarea(t,e,r,i){if(!e._drawingToTexture&&t.hitArea){var s=t._style,a=t.hitArea._hit,n=e.globalAlpha;e.globalAlpha*=.5,a&&a._render(t,e,r-s.pivotX,i-s.pivotY),(a=t.hitArea._unHit)&&a._render(t,e,r-s.pivotX,i-s.pivotY),e.globalAlpha=n}this._next!=Di.NORENDER&&this._next._fun(t,e,r,i)}_alpha(t,e,r,i){var s=t._style.alpha;if(s>.01||t._needRepaint()){var a=e.globalAlpha;e.globalAlpha*=s,this._next!=Di.NORENDER&&this._next._fun(t,e,r,i),e.globalAlpha=a}}_transform(t,e,r,i){var s=t.transform,a=this._next;s&&a!=Di.NORENDER?(e.save(),e.transform(s.a,s.b,s.c,s.d,s.tx+r,s.ty+i),a._fun(t,e,0,0),e.restore()):a!=Di.NORENDER&&a._fun(t,e,r,i)}_children(t,e,r,i){let s=t._style,a=t._children,n=a.length;r-=t.pivotX,i-=t.pivotY;let l,o,h,u,d,c,_,p=t._getBit(kt.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0),f=e._drawingToTexture;s.viewport&&(l=s.viewport,o=l.x,h=l.y,u=l.right,d=l.bottom);for(let s=0;s<n;++s){let n,p=a[s];n=f?p._visible&&!p._getBit(kt.ESCAPE_DRAWING_TO_TEXTURE):p._visible||p._getBit(kt.DISABLE_VISIBILITY),n&&(l&&((c=p._x)>=u||c+p.width<=o||(_=p._y)>=d||_+p.height<=h)?n=!1:t._cacheStyle.mask!=p||p._getBit(kt.DISABLE_VISIBILITY)&&!f||(n=!1)),n&&(p._getBit(kt.DISABLE_OUTER_CLIPPING)&&e.clipRect(0,0,1,1,!0),p.render(e,r,i))}p&&e.drawCallOptimize(!1)}_renderNextToCacheRT(r,i,s=0,a=0,n=0,l=0){var o=r._getCacheStyle();if(r._needRepaint()||!o.renderTexture||e.stage.isGlobalRepaint()){o.renderTexture&&o.renderTexture.destroy();let e=r._cacheStyle._calculateCacheRect(r,"bitmap",0,0),h=o.cacheRect;if(h.width<=0||h.height<=0)return o.renderTexture=null,!1;se.canvasBitmap++;let u=h.width*e.x+s+n,d=h.height*e.y+a+l,c=new pt(u,d,t.RenderTargetFormat.R8G8B8A8),_=new li;return _.copyState(i),_.size(u,d),_.clearBG(0,0,0,0),_.render2D=new oe(c),_.startRender(),h.x-=s,h.y-=a,this._next._fun(r,_,-h.x,-h.y),_.endRender(),_.render2D.setRenderTarget(i.render2D.out),_.destroy(),o.renderTexture=c,!0}return!1}_canvas(t,e,r,i){var s=t._cacheStyle,a=this._next;if(!e._drawingToTexture&&s.mask&&s.mask._getBit(kt.DISABLE_VISIBILITY))return void a._fun(t,e,r,i);if("bitmap"===t.cacheAs){e.drawLeftData(),this._renderNextToCacheRT(t,e);var n=s.cacheRect;e._material=t.graphics.material;let a=s.renderTexture;a&&e._drawRenderTexture(a,r+n.x,i+n.y,a.width,a.height,null,1,[0,1,1,1,1,0,0,0]),e._material=null}else{if(!Di.cacheNormalEnable)return void a._fun(t,e,r,i);e.drawLeftData(),Ti.renderCacheAsNormal(e,t,this._next,r,i)}}static RenderToRenderTexture(e,r,i,s,a=null,n=!0){let l=e._getCacheStyle()._calculateCacheRect(e,"bitmap",0,0);this._transBound(e._cacheStyle.cacheRect,e.transform);let o=e._cacheStyle.cacheRect,h=new li;h._drawingToTexture=!0,r&&h.copyState(r);let u=a;if(u)h.size(u.width,u.height),h.clearBG(pt._clearColor.r,pt._clearColor.g,pt._clearColor.b,pt._clearColor.a);else{let e=o.width*l.x+(n?0:o.x),r=o.height*l.y+(n?0:o.y);u=new pt(e,r,t.RenderTargetFormat.R8G8B8A8),h.size(e,r),h.clearBG(0,0,0,0)}return h.render2D=h.render2D.clone(u),h.startRender(),n?e.render(h,i-e.x-o.x,s-e.y-o.y):e.render(h,i-e.x,s-e.y),h.endRender(),h._drawingToTexture=!1,r&&h.render2D.setRenderTarget(r.render2D.out),h.destroy(),u}static RenderToCacheTexture(t,r,i,s,a=!0){var n=t._getCacheStyle();return!(!t._needRepaint()&&n.renderTexture&&!e.stage.isGlobalRepaint())&&(n.renderTexture&&n.renderTexture.destroy(),n.renderTexture=Di.RenderToRenderTexture(t,r,i,s,null,a),!0)}_blend(t,e,r,i){var s=t._style;e.save(),e.globalCompositeOperation=s.blendMode,this._next._fun(t,e,r,i),e.restore()}static _transBound(t,e){if(!e||!t)return;let r=e.a,i=e.b,s=e.c,a=e.d,n=t.x,l=t.y,o=n+t.width,h=l+t.height,u=n*r,d=o*r,c=l*s,_=h*s,p=n*i,f=o*i,g=l*a,m=h*a,y=Math.min(u+c,u+_,d+c,d+_),T=Math.max(u+c,u+_,d+c,d+_),x=Math.min(p+g,p+m,f+g,f+m),v=Math.max(p+g,p+m,f+g,f+m);t.setTo(y,x,T-y,v-x)}_mask(r,i,s,a){let n=r.mask;if(n._getBit(kt.DISABLE_VISIBILITY)&&!i._drawingToTexture)return void(this._next!=Di.NORENDER&&this._next._fun(r,i,s,a));let l=r._getCacheStyle();if(r._needRepaint()||!l.renderTexture||l.renderTexture.destroyed||e.stage.isGlobalRepaint()){l.renderTexture&&l.renderTexture.destroy(),r._cacheStyle._calculateCacheRect(r,"bitmap",0,0);let e=this._spriteRect_TextureSpace.copyFrom(l.cacheRect);if(e.width<=0||e.height<=0)return;e.x+=r.pivotX,e.y+=r.pivotY;let s=n._getCacheStyle();s._calculateCacheRect(n,"bitmap",0,0),Di._transBound(s.cacheRect,n.transform);let a=this._maskRect_TextureSpace.copyFrom(s.cacheRect);a.x+=n._x,a.y+=n._y;let o=Math.max(e.x,a.x),h=Math.max(e.y,a.y),u=Math.min(e.x+e.width,a.x+a.width)-o,d=Math.min(e.y+e.height,a.y+a.height)-h;if(u<=0||d<=0)return;Di.RenderToCacheTexture(n,i,0,0);let c=new pt(u,d,t.RenderTargetFormat.R8G8B8A8),_=new li;_.clearBG(0,0,0,0),_.size(u,d),_.render2D=new oe(c),_.startRender(),_._drawingToTexture=i._drawingToTexture,this._next._fun(r,_,r.pivotX-o,r.pivotY-h),_._drawingToTexture=!1;let p=s.renderTexture;_.globalCompositeOperation="mask",_._drawRenderTexture(p,a.x-o,a.y-h,a.width,a.height,null,1,[0,1,1,1,1,0,0,0]),_.endRender(),_.render2D.setRenderTarget(i.render2D.out),_.destroy(),l.renderTexture=c,l.cacheRect.x=o-r.pivotX,l.cacheRect.y=h-r.pivotY,l.cacheRect.width=c.width,l.cacheRect.height=c.height}let o=l.renderTexture,h=l.cacheRect;i._drawRenderTexture(o,s+h.x,a+h.y,o.width,o.height,null,1,[0,1,1,1,1,0,0,0])}}Di.cacheNormalEnable=!0,Di.renders=[],Di.NORENDER=new Di(0,null);class bi extends b{get source(){return this._source}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}_getSource(){return this._source}constructor(t=!1){super(),this._source=t?A.createElement("canvas"):this,this.lock=!0}clear(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}destroy(){super.destroy(),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}release(){}get context(){return this._ctx||(this._source==this?this._ctx=new li:this._ctx=this._source.getContext(n.isConch?"layagl":"2d"),this._ctx._canvas=this),this._ctx}_setContext(t){this._ctx=t}getContext(t,e=null){return this.context}getMemSize(){return 0}size(t,e){(this._width!=t||this._height!=e||this._source&&(this._source.width!=t||this._source.height!=e))&&(this._width=t,this._height=e,this._setCPUMemory(t*e*4),this._ctx&&this._ctx.size&&this._ctx.size(t,e),this._source&&(this._source.height=e,this._source.width=t),this._texture&&(this._texture.destroy(),this._texture=null))}getTexture(){if(!this._texture){var e=new ct(this.source.width,this.source.height,t.TextureFormat.R8G8B8A8,!0,!1,!1);e.setImageData(this.source,!1,!1),this._texture=new mt(e)}return this._texture}toBase64(t,e){return this._source?this._source.toDataURL(t,e):null}}class Ri{reset(){return this.bounds&&this.bounds.recover(),this.userBounds&&this.userBounds.recover(),this.bounds=null,this.userBounds=null,this.temBM=null,this}recover(){r.recover("BoundsStyle",this.reset())}static create(){return r.getItemByClass("BoundsStyle",Ri)}}class Ci{constructor(){this.renderTexOffx=0,this.renderTexOffy=0,this.cacheInfo=new pi,this.reset()}onInvisible(){}set renderTexture(t){this._renderTexture&&t!=this._renderTexture&&this._renderTexture.destroy(),this._renderTexture=t}get renderTexture(){return this._renderTexture}recover(){this!==Ci.EMPTY&&r.recover("SpriteCache",this.reset())}reset(){return this.userSetCache="none",this.staticCache=!1,this.mask=null,this.maskParent=null,this.cacheRect&&this.cacheRect.recover(),this.cacheRect=null,this.cacheInfo.reset(),this}static create(){return r.getItemByClass("SpriteCache",Ci)}_calculateCacheRect(t,e,r,i){var s,a=t._getCacheStyle();if(a.cacheRect||(a.cacheRect=F.create()),"bitmap"===e?((s=t.getSelfBounds()).width=s.width,s.height=s.height,s.x=s.x-t.pivotX,s.y=s.y-t.pivotY,s.x=Math.floor(s.x+r)-r,s.y=Math.floor(s.y+i)-i,s.width=Math.floor(s.width),s.height=Math.floor(s.height),a.cacheRect.copyFrom(s)):a.cacheRect.setTo(-t._style.pivotX,-t._style.pivotY,1,1),s=a.cacheRect,t._style.scrollRect){var n=t._style.scrollRect;s.x-=n.x,s.y-=n.y}return Ci._scaleInfo.setTo(1,1),Ci._scaleInfo}}Ci.EMPTY=new Ci,Ci._scaleInfo=new i,Ci.CANVAS_EXTEND_EDGE=16;class Ai{constructor(){this.reset()}reset(){return this.scaleX=this.scaleY=1,this.skewX=this.skewY=0,this.pivotX=this.pivotY=this.rotation=0,this.alpha=1,this.scrollRect&&this.scrollRect.recover(),this.scrollRect=null,this.viewport&&this.viewport.recover(),this.viewport=null,this.hitArea=null,this.dragging=null,this.blendMode=null,this}recover(){this!==Ai.EMPTY&&r.recover("SpriteStyle",this.reset())}static create(){return r.getItemByClass("SpriteStyle",Ai)}}Ai.EMPTY=new Ai;class Ii{static create(t){var e=r.getItemByClass("AlphaCmd",Ii);return e.alpha=t,e}recover(){r.recover("AlphaCmd",this)}run(t,e,r){t.alpha(this.alpha)}get cmdID(){return Ii.ID}}Ii.ID="Alpha";class Mi{constructor(){this.lineWidth=0}static create(t,e,i,s,a,n){var l=r.getItemByClass("DrawCircleCmd",Mi);return l.x=t,l.y=e,l.radius=i,l.fillColor=s,l.lineColor=a,l.lineWidth=n,l}recover(){this.fillColor=null,this.lineColor=null,r.recover("DrawCircleCmd",this)}run(t,e,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&t.sprite){let s=t.sprite.width,a=t.sprite.height;t._drawCircle(this.x*s+e,this.y*a+r,this.radius*Math.min(s,a)-i,this.fillColor,this.lineColor,this.lineWidth,0)}else t._drawCircle(this.x+e,this.y+r,this.radius-i,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return Mi.ID}getBoundPoints(t){return F._getBoundPointS(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius,this.percent?t:null)}}Mi.ID="DrawCircle",Ot.regClass("DrawCircleCmd",Mi);class Bi{static create(t,e,i,s,a){var n=r.getItemByClass("DrawCurvesCmd",Bi);return n.x=t,n.y=e,n.points=i,n.lineColor=s,n.lineWidth=a,n}recover(){this.points=null,this.lineColor=null,r.recover("DrawCurvesCmd",this)}run(t,e,r){this.points&&t.drawCurves(this.x+e,this.y+r,this.points,this.lineColor,this.lineWidth)}get cmdID(){return Bi.ID}getBoundPoints(){return cr.I.getBezierPoints(this.points)}}Bi.ID="DrawCurves",Ot.regClass("DrawCurvesCmd",Bi);class Li{constructor(){this.color=4294967295}static create(t,e,i,s,a,n){null==s&&(s=t.sourceWidth),null==a&&(a=t.sourceHeight);let l=s/t.sourceWidth,o=a/t.sourceHeight;s=t.width*l,a=t.height*o,e+=t.offsetX*l,i+=t.offsetY*o;var h=r.getItemByClass("DrawImageCmd",Li);return h.texture=t,t._addReference(),h.x=e,h.y=i,h.width=s,h.height=a,h.color=null!=n?gr.create(n).numColor:4294967295,h}recover(){this.texture&&this.texture._removeReference(),this.texture=null,r.recover("DrawImageCmd",this)}run(t,e,r){this.texture&&t.drawTexture(this.texture,this.x+e,this.y+r,this.width,this.height,this.color)}get cmdID(){return Li.ID}}Li.ID="DrawImage";class Pi{constructor(){this.lineWidth=0}static create(t,e,i,s,a,n){var l=r.getItemByClass("DrawLineCmd",Pi);return l.fromX=t,l.fromY=e,l.toX=i,l.toY=s,l.lineColor=a,l.lineWidth=n,l}recover(){r.recover("DrawLineCmd",this)}run(t,e,r){let i=this.lineWidth<1||this.lineWidth%2==0?0:.5;if(this.percent&&t.sprite){let s=t.sprite.width,a=t.sprite.height;t._drawLine(e,r,this.fromX*s+i,this.fromY*a+i,this.toX*s+i,this.toY*a+i,this.lineColor,this.lineWidth,0)}else t._drawLine(e,r,this.fromX+i,this.fromY+i,this.toX+i,this.toY+i,this.lineColor,this.lineWidth,0)}get cmdID(){return Pi.ID}getBoundPoints(t){let e;Ni.length=0,e=.5*this.lineWidth;let r=this.fromX,i=this.fromY,s=this.toX,a=this.toY;return this.percent&&(r*=t.width,i*=t.height,s*=t.width,a*=t.height),r==s?Ni.push(r+e,i,s+e,a,r-e,i,s-e,a):i==a?Ni.push(r,i+e,s,a+e,r,i-e,s,a-e):Ni.push(r,i,s,a),Ni}}Pi.ID="DrawLine";const Ni=[];Ot.regClass("DrawLineCmd",Pi);class Oi{constructor(){this.lineWidth=0}static create(t,e,i,s,a){var n=r.getItemByClass("DrawLinesCmd",Oi);return n.x=t,n.y=e,n.points=i,n.lineColor=s,n.lineWidth=a,n}recover(){this.points=null,this.lineColor=null,r.recover("DrawLinesCmd",this)}run(t,e,r){let i=this.lineWidth<1||this.lineWidth%2==0?0:.5;this.points&&t._drawLines(this.x+i+e,this.y+i+r,this.points,this.lineColor,this.lineWidth,0)}get cmdID(){return Oi.ID}}Oi.ID="DrawLines",Ot.regClass("DrawLinesCmd",Oi);class Fi{static create(t,e,i,s,a){var n=r.getItemByClass("DrawPathCmd",Fi);return n.x=t,n.y=e,n.paths=i,n.brush=s,n.pen=a,n}recover(){this.paths=null,this.brush=null,this.pen=null,r.recover("DrawPathCmd",this)}run(t,e,r){this.paths&&t._drawPath(this.x+e,this.y+r,this.paths,this.brush,this.pen)}get cmdID(){return Fi.ID}getBoundPoints(){let t=Ui;t.length=0;let e=this.paths,r=e.length;for(let i=0;i<r;i++){let r=e[i];r.length>1&&(t.push(r[1],r[2]),r.length>3&&t.push(r[3],r[4]))}return t}}Fi.ID="DrawPath";const Ui=[];Ot.regClass("DrawPathCmd",Fi);class ki{constructor(){this.radius=0,this.lineWidth=0}static create(t,e,i,s,a,n,l,o){var h=r.getItemByClass("DrawPieCmd",ki);return h.x=t,h.y=e,h.radius=i,h._startAngle=s,h._endAngle=a,h.fillColor=n,h.lineColor=l,h.lineWidth=o,h}recover(){this.fillColor=null,this.lineColor=null,r.recover("DrawPieCmd",this)}run(t,e,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;t._drawPie(this.x+i+e,this.y+i+r,this.radius-s,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return ki.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(t){this._startAngle=t*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(t){this._endAngle=t*Math.PI/180}getBoundPoints(){let t=Gi;Gi.length=0;let e=Math.PI/180,r=this.endAngle-this.startAngle,i=this.x,s=this.y,a=this.radius;if(r>=360||r<=-360)return t.push(i-a,s-a),t.push(i+a,s-a),t.push(i+a,s+a),t.push(i-a,s+a),t;t.push(i,s);var n=r%360;n<0&&(n+=360);var l=this.startAngle+n,o=this.startAngle*e,h=l*e;t.push(i+a*Math.cos(o),s+a*Math.sin(o)),t.push(i+a*Math.cos(h),s+a*Math.sin(h));for(var u=90*Math.ceil(this.startAngle/90),d=90*Math.floor(l/90),c=u;c<=d;c+=90){var _=c*e;t.push(i+a*Math.cos(_),s+a*Math.sin(_))}return t}}ki.ID="DrawPie";const Gi=[];Ot.regClass("DrawPieCmd",ki);class Vi{static create(t,e,i,s,a,n){var l=r.getItemByClass("DrawPolyCmd",Vi);return l.x=t,l.y=e,l.points=i,l.fillColor=s,l.lineColor=a,l.lineWidth=n,l}recover(){this.points=null,this.fillColor=null,this.lineColor=null,r.recover("DrawPolyCmd",this)}run(t,e,r){let i=this.points.length<=6,s=this.lineWidth>=1&&this.lineColor?this.lineWidth%2==0?0:.5:0;this.points&&t._drawPoly(this.x+s+e,this.y+s+r,this.points,this.fillColor,this.lineColor,this.lineWidth,i,0)}get cmdID(){return Vi.ID}}Vi.ID="DrawPoly",Ot.regClass("DrawPolyCmd",Vi);class Hi{constructor(){this.lineWidth=0}static create(t,e,i,s,a,n,l,o){var h=r.getItemByClass("DrawRectCmd",Hi);return h.x=t,h.y=e,h.width=i,h.height=s,h.fillColor=a,h.lineColor=n,h.lineWidth=l,h.percent=o,h}recover(){this.fillColor=null,this.lineColor=null,r.recover("DrawRectCmd",this)}run(t,e,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;if(this.percent&&t.sprite){let a=t.sprite.width,n=t.sprite.height;t.drawRect(this.x*a+i+e,this.y*n+i+r,this.width*a-s,this.height*n-s,this.fillColor,this.lineColor,this.lineWidth)}else t.drawRect(this.x+i+e,this.y+i+r,this.width-s,this.height-s,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return Hi.ID}getBoundPoints(t){return F._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?t:null)}}Hi.ID="DrawRect",Ot.regClass("DrawRectCmd",Hi);class zi{constructor(){this.color=4294967295,this.uv=null}static create(t,e,i,s,a,n,l,o,h,u){null==s&&(s=t.sourceWidth),null==a&&(a=t.sourceHeight);let d=s/t.sourceWidth,c=a/t.sourceHeight;s=t.width*d,a=t.height*c,e+=t.offsetX*d,i+=t.offsetY*c;var _=r.getItemByClass("DrawTextureCmd",zi);return _.texture=t,t._addReference(),_.x=e,_.y=i,_.width=s,_.height=a,_.matrix=n,_.alpha=l,_.blendMode=h,_.uv=u||null,_.color=null!=o?gr.create(o).numColor:4294967295,_}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,r.recover("DrawTextureCmd",this)}run(t,e,r){this.texture&&t.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,e,r,this.alpha,this.blendMode,this.uv,this.color)}get cmdID(){return zi.ID}}zi.ID="DrawTexture",Ot.regClass("DrawTextureCmd",zi);class Wi{constructor(){this.color=4294967295}static create(t,e,i,s,a,n,l,o){var h=r.getItemByClass("FillTextureCmd",Wi);return h.texture=t,t._addReference(),h.x=e,h.y=i,h.width=s,h.height=a,h.type=n,h.offset=l,h.color=null!=o?gr.create(o).numColor:4294967295,h}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.offset=null,r.recover("FillTextureCmd",this)}run(t,e,r){if(this.texture)if(this.percent&&t.sprite){let s=t.sprite.width,a=t.sprite.height;t.fillTexture(this.texture,this.x*s+e,this.y*a+r,this.width*s,this.height*a,this.type,this.offset||i.EMPTY,this.color)}else t.fillTexture(this.texture,this.x+e,this.y+r,this.width,this.height,this.type,this.offset||i.EMPTY,this.color)}get cmdID(){return Wi.ID}getBoundPoints(t){return this.width&&this.height?F._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?t:null):F._getBoundPointS(this.x,this.y,this.texture.width,this.texture.height)}}Wi.ID="FillTexture",Ot.regClass("FillTextureCmd",Wi);class Yi{static create(){return r.getItemByClass("RestoreCmd",Yi)}recover(){r.recover("RestoreCmd",this)}run(t){t.restore()}get cmdID(){return Yi.ID}}Yi.ID="Restore";class Xi{static create(t,e,i){var s=r.getItemByClass("RotateCmd",Xi);return s.angle=t,s.pivotX=e,s.pivotY=i,s}recover(){r.recover("RotateCmd",this)}run(t,e,r){t._rotate(this.angle,this.pivotX+e,this.pivotY+r)}get cmdID(){return Xi.ID}}Xi.ID="Rotate";class ji{static create(t,e,i,s){var a=r.getItemByClass("ScaleCmd",ji);return a.scaleX=t,a.scaleY=e,a.pivotX=i,a.pivotY=s,a}recover(){r.recover("ScaleCmd",this)}run(t,e,r){t._scale(this.scaleX,this.scaleY,this.pivotX+e,this.pivotY+r)}get cmdID(){return ji.ID}}ji.ID="Scale";class qi{static create(t,e,i){var s=r.getItemByClass("TransformCmd",qi);return s.matrix=t,s.pivotX=e,s.pivotY=i,s}recover(){this.matrix=null,r.recover("TransformCmd",this)}run(t,e,r){t._transform(this.matrix,this.pivotX+e,this.pivotY+r)}get cmdID(){return qi.ID}}qi.ID="Transform";class $i{static create(t,e){var i=r.getItemByClass("TranslateCmd",$i);return i.tx=t,i.ty=e,i}recover(){r.recover("TranslateCmd",this)}run(t){t.translate(this.tx,this.ty)}get cmdID(){return $i.ID}}$i.ID="Translate";class Ki{static create(t,e,i,s,a,n,l,o,h,u){var d=r.getItemByClass("DrawTrianglesCmd",Ki);return d.texture=t,t._addReference(),d.x=e,d.y=i,d.vertices=s,d.uvs=a,d.indices=n,d.matrix=l,d.alpha=o,d.color=null!=h?gr.create(h).numColor:4294967295,d.blendMode=u,d}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,r.recover("DrawTrianglesCmd",this)}run(t,e,r){t.drawTriangles(this.texture,this.x+e,this.y+r,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.blendMode,this.color)}get cmdID(){return Ki.ID}getBoundPoints(){let t=this.vertices;var e=t.length;if(e<2)return[];for(var r=t[0],i=t[1],s=r,a=i,n=2;n<e;){var l=t[n++],o=t[n++];r>l&&(r=l),i>o&&(i=o),s<l&&(s=l),a<o&&(a=o)}return[r,i,s,i,s,a,r,a]}}Ki.ID="DrawTriangles",Ot.regClass("DrawTrianglesCmd",Ki);class Qi{constructor(){this.color=4294967295}static create(t,e,i,s,a,n,l=!1,o=null){let h=r.getItemByClass("Draw9GridTextureCmd",Qi);return h.texture=t,t._addReference(),h.x=e,h.y=i,h.width=s,h.height=a,h.sizeGrid=n,h.percent=l,h.color=null!=o?gr.create(o).numColor:4294967295,h}recover(){this.texture&&this.texture._removeReference(),this.texture=null,r.recover("Draw9GridTextureCmd",this)}run(t,e,r){if(this.texture){let i=this.sizeGrid||this.texture._sizeGrid||Zi;if(this.percent&&t.sprite){let s=t.sprite.width,a=t.sprite.height;t.drawTextureWithSizeGrid(this.texture,this.x*s,this.y*a,this.width*s,this.height*a,i,e,r,this.color)}else t.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,i,e,r,this.color)}}get cmdID(){return Qi.ID}getBoundPoints(t){let e=this.x,r=this.y,i=this.width,s=this.height;return this.percent&&(e*=t.width,r*=t.height,i*=t.width,s*=t.height),[e,r,i,r,i,s,e,s]}}Qi.ID="Draw9GridTexture";const Zi=[0,0,0,0,0];Ot.regClass("Draw9GridTextureCmd",Qi);class Ji{static create(){return r.getItemByClass("SaveCmd",Ji)}recover(){r.recover("SaveCmd",this)}run(t){t.save()}get cmdID(){return Ji.ID}}Ji.ID="Save";class ts{constructor(){this.lineWidth=0}static create(t,e,i,s,a,n,l,o){var h=r.getItemByClass("DrawEllipseCmd",ts);return h.x=t,h.y=e,h.width=i,h.height=s,h.fillColor=a,h.lineColor=n,h.lineWidth=l,h.percent=o,h}recover(){this.fillColor=null,this.lineColor=null,r.recover("DrawEllipseCmd",this)}run(t,e,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&t.sprite){let s=t.sprite.width,a=t.sprite.height;t._drawEllipse(this.x*s+e,this.y*a+r,this.width*s-i,this.height*a-i,this.fillColor,this.lineColor,this.lineWidth)}else t._drawEllipse(this.x+e,this.y+r,this.width-i,this.height-i,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return ts.ID}getBoundPoints(t){return F._getBoundPointS(this.x-this.width,this.y-this.height,2*this.width,2*this.height,this.percent?t:null)}}ts.ID="DrawEllipse",Ot.regClass("DrawEllipseCmd",ts);class es{constructor(){this.lineWidth=0}static create(t,e,i,s,a,n,l,o,h,u,d,c){var _=r.getItemByClass("DrawRoundRectCmd",es);return _.x=t,_.y=e,_.width=i,_.height=s,_.lt=a,_.rt=n,_.lb=l,_.rb=o,_.fillColor=h,_.lineColor=u,_.lineWidth=d,_.percent=c,_}recover(){this.fillColor=null,this.lineColor=null,r.recover("DrawRoundRectCmd",this)}run(t,e,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;if(this.percent&&t.sprite){let a=t.sprite.width,n=t.sprite.height;t._drawRoundRect(this.x*a+i+e,this.y*n+i+r,this.width*a-s,this.height*n-s,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}else t._drawRoundRect(this.x+i+e,this.y+i+r,this.width-s,this.height-s,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return es.ID}getBoundPoints(t){return F._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?t:null)}}es.ID="DrawRoundRect",Ot.regClass("DrawRoundRectCmd",es);class rs{constructor(){this.x=0,this.y=0,this._strokeColor="#000000",this._loosyBound=null}get text(){return this._text}set text(t){this._text=t}get strokeColor(){return this._strokeColor}set strokeColor(t){this._strokeColor=t}get stroke(){return this._stroke}set stroke(t){this._stroke=t}get align(){return this._align}set align(t){this._align=t}static create(t,e,i,s,a,n,l,o){var h=r.getItemByClass("FillTextCmd",rs);switch(h._text=null,h._wordText=null,h.x=e,h.y=i,h.font=s,h.color=a,h._stroke=l,h._strokeColor=o,n){case"center":h._align=Ut.ENUM_TEXTALIGN_CENTER;break;case"right":h._align=Ut.ENUM_TEXTALIGN_RIGHT;break;default:h._align=Ut.ENUM_TEXTALIGN_DEFAULT}return t instanceof Qr?(h._wordText=t,t.cleanCache()):h._text=t,h}recover(){r.recover("FillTextCmd",this)}run(t,r,i){e.stage.isGlobalRepaint()&&this._wordText&&this._wordText.cleanCache(),null==this._text&&(this._text=""),null==this._fontObj&&(this.font=null),null==this._color&&(this._color="#ffffff"),t._fast_filltext(this._wordText||this._text,this.x+r,this.y+i,this._fontObj,this._color,this._strokeColor,this._stroke,this._align)}get cmdID(){return rs.ID}get font(){return this._font}set font(t){this._font=t,t||(t=f.defaultFontSize+"px "+f.defaultFont),this._fontObj=qr.parse(t),this._wordText&&this._wordText.cleanCache()}get color(){return this._color}set color(t){this._color=t,this._wordText&&this._wordText.cleanCache()}getBoundPoints(){if(!this._loosyBound){let t=e.Browser.context;t.save(),t.font=this.font;let r=t.measureText(this.text).width;t.restore();let i=this.x,s=this.y;switch(this._align){case Ut.ENUM_TEXTALIGN_CENTER:i-=r/2;break;case Ut.ENUM_TEXTALIGN_RIGHT:i-=r}this._fontObj||(this.font=null),i-=4,s-=this._fontObj._size,this._loosyBound=new F(i,s,r+8,2*this._fontObj._size)}return F._getBoundPointS(this._loosyBound.x,this._loosyBound.y,this._loosyBound.width,this._loosyBound.height,null)}}rs.ID="FillText",Ot.regClass("FillTextCmd",rs);const is=new G,ss=new G,as=[];class ns{constructor(){this._cacheBoundsType=!1}destroy(){this._graphics=null,this._cacheBoundsType=!1,this._temp&&(this._temp.length=0),this._rstBoundPoints&&(this._rstBoundPoints.length=0),this._bounds&&this._bounds.recover(),this._bounds=null,r.recover("GraphicsBounds",this)}static create(){return r.getItemByClass("GraphicsBounds",ns)}reset(){this._temp&&(this._temp.length=0)}getBounds(t=!1){return(!this._bounds||!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._bounds=F._getWrapRec(this.getBoundPoints(t),this._bounds)),this._cacheBoundsType=t,this._bounds}getBoundPoints(t=!1){return(!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(t)),this._cacheBoundsType=t,this._rstBoundPoints=P.copyArray(this._rstBoundPoints,this._temp)}_getCmdPoints(t=!1){let e=this._graphics.cmds,r=this._graphics._sp;this._affectBySize=!1;let i=this._temp||(this._temp=[]);if(i.length=0,0==e.length)return i;let s=as;s.length=0;let a=ss;a.identity();let n=is;for(let t=0,l=e.length;t<l;t++){let l=e[t];switch(l.percent&&(this._affectBySize=!0),l.cmdID){case Ii.ID:case Ji.ID:s.push(a),a=a.clone();break;case Yi.ID:a=s.pop();break;case ji.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.scale(l.scaleX,l.scaleY),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case Xi.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.rotate(l.angle),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case $i.ID:n.identity(),n.translate(l.tx,l.ty),this._switchMatrix(a,n);break;case qi.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.concat(l.matrix),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case Li.ID:case Wi.ID:ls(i,F._getBoundPointS(l.x,l.y,l.width,l.height),a);break;case zi.ID:a.copyTo(n),l.matrix&&n.concat(l.matrix),ls(i,F._getBoundPointS(l.x,l.y,l.width,l.height),n);break;case Hi.ID:case Mi.ID:case ts.ID:case es.ID:case Pi.ID:ls(i,l.getBoundPoints(r),a);break;case Bi.ID:ls(i,l.getBoundPoints(),a,l.x,l.y);break;case Oi.ID:case Vi.ID:ls(i,l.points,a,l.x,l.y);break;case Fi.ID:ls(i,l.getBoundPoints(),a,l.x,l.y);break;case ki.ID:case Ki.ID:ls(i,l.getBoundPoints(),a);break;case Qi.ID:ls(i,l.getBoundPoints(r),a);break;case rs.ID:ls(i,l.getBoundPoints(),a);break;default:ls(i,F._getBoundPointS(r.x,r.y,r.width,r.height,null),a)}}return i.length>200?i=P.copyArray(i,F._getWrapRec(i)._getBoundPoints()):i.length>8&&(i=re.scanPList(i)),i}_switchMatrix(t,e){e.concat(t),e.copyTo(t)}}function ls(t,e,r,i=0,s=0){let a=e.length;for(let n=0;n<a;n+=2)os(t,e[n]+i,e[n+1]+s,r)}function os(t,e,r,s){var a=i.TEMP;a.setTo(e||0,r||0),s.transformPoint(a),t.push(a.x,a.y)}class hs{static create(t,e,i,s){var a=r.getItemByClass("ClipRectCmd",hs);return a.x=t,a.y=e,a.width=i,a.height=s,a}recover(){r.recover("ClipRectCmd",this)}run(t,e,r){t.clipRect(this.x+e,this.y+r,this.width,this.height)}get cmdID(){return hs.ID}}hs.ID="ClipRect";class us{static create(t,e,i){var s=r.getItemByClass("DrawTexturesCmd",us);return s.texture=t,t._addReference(),s.pos=e,s.colors=i||[],s}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,r.recover("DrawTexturesCmd",this)}run(t,e,r){t.drawTextures(this.texture,this.pos,e,r,this.colors)}get cmdID(){return us.ID}}us.ID="DrawTextures";class ds{constructor(){}static regCacheByFunction(t,e){var r;ds.unRegCacheByFunction(t,e),r={tryDispose:t,getCacheList:e},ds._cacheList.push(r)}static unRegCacheByFunction(t,e){var r,i;for(i=ds._cacheList.length,r=0;r<i;r++)if(ds._cacheList[r].tryDispose==t&&ds._cacheList[r].getCacheList==e)return void ds._cacheList.splice(r,1)}static forceDispose(){var t,e=ds._cacheList.length;for(t=0;t<e;t++)ds._cacheList[t].tryDispose(!0)}static beginCheck(t=15e3){e.systemTimer.loop(t,null,ds._checkLoop)}static stopCheck(){e.systemTimer.clear(null,ds._checkLoop)}static _checkLoop(){var t=ds._cacheList;if(!(t.length<1)){var r,i,s=e.Browser.now();for(i=r=t.length;r>0&&(ds._index++,ds._index=ds._index%i,t[ds._index].tryDispose(!1),!(e.Browser.now()-s>ds.loopTimeLimit));)r--}}}ds.loopTimeLimit=2,ds._cacheList=[],ds._index=0;class cs{constructor(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],ds.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this))}static getInstance(){return cs.instance=cs.instance||new cs}getId(){return this._id++}addShape(t,e){this.shapeDic[t]=e,this.useDic[t]||(this.useDic[t]=!0)}addLine(t,e){this.shapeLineDic[t]=e,this.shapeLineDic[t]||(this.shapeLineDic[t]=!0)}getShape(t){this._checkKey&&null!=this.useDic[t]&&(this.useDic[t]=!0)}deleteShape(t){this.shapeDic[t]&&(this.shapeDic[t]=null,delete this.shapeDic[t]),this.shapeLineDic[t]&&(this.shapeLineDic[t]=null,delete this.shapeLineDic[t]),null!=this.useDic[t]&&delete this.useDic[t]}getCacheList(){var t,e=[];for(t in this.shapeDic)e.push(this.shapeDic[t]);for(t in this.shapeLineDic)e.push(this.shapeLineDic[t]);return e}startDispose(t){var e;for(e in this.useDic)this.useDic[e]=!1;this._checkKey=!0}endDispose(){if(this._checkKey){var t;for(t in this.useDic)this.useDic[t]||this.deleteShape(t);this._checkKey=!1}}}class _s{static create(t,e){var i=r.getItemByClass("DrawGeoCmd"+e.id,_s);return i.init(t,e),i}static creatGEO(e,r,i,s,a){let n=l.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),o=l.renderDeviceFactory.createBufferState();n.bufferState=o;let h=l.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic);h.vertexDeclaration=e;let u=l.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Dynamic);return o.applyState([h],u),n.indexFormat=t.IndexFormat.UInt16,h.setDataLength(i),h.setData(r.buffer,0,0,i),u._setIndexDataLength(a),u._setIndexData(new Uint16Array(s.buffer,0,a/2),0),n.clearRenderParams(),n.setDrawElemenParams(a/2,0),n}init(t,e){this.material=e,this.geo=t}recover(){r.recover("DrawGeoCmd"+this.material.id,this)}run(t,e,r){t.drawGeo(this.geo,this.material,e,r)}get cmdID(){return _s.ID}}_s.ID="DrawGeoCmd";class ps{static create(t,e){var i=r.getItemByClass("DrawGeosCmd",ps);return i.init(t,e),i}init(t,e){this.elements=e,this.geo=t}recover(){r.recover("DrawGeosCmd",this)}run(t,e,r){t.drawGeos(this.geo,this.elements,e,r)}get cmdID(){return ps.ID}}ps.ID="DrawGeoCmd";class fs{static add2DGlobalUniformData(t,e,r){l.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal").addShaderUniform(t,e,r)}static get globalShaderData(){return null}constructor(){this._sp=null,this._render=this._renderEmpty,this._cmds=[],this._vectorgraphArray=null,this._graphicBounds=null,this._createData()}_createData(){}_clearData(){}_destroyData(){}destroy(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp=null),this._material&&(this._material._removeReference(),this._material=null),this._destroyData()}clear(t=!0){if(t)for(let t=0,e=this._cmds.length;t<e;t++)this._cmds[t].recover();if(this._cmds.length=0,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~ie.GRAPHICS),this._repaint(),this._vectorgraphArray){for(let t=0,e=this._vectorgraphArray.length;t<e;t++)cs.getInstance().deleteShape(this._vectorgraphArray[t]);this._vectorgraphArray.length=0}}_clearBoundsCache(t){this._graphicBounds&&(t&&!this._graphicBounds._affectBySize||this._graphicBounds.reset())}_initGraphicBounds(){this._graphicBounds||(this._graphicBounds=ns.create(),this._graphicBounds._graphics=this)}_repaint(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}_isOnlyOne(){return 1===this._cmds.length}get cmds(){return this._cmds}set cmds(t){this._sp&&(this._sp._renderType|=ie.GRAPHICS),this._cmds=t;let e=t.length;this._render=0===e?this._renderEmpty:1===e?this._renderOne:this._renderAll,this._repaint()}addCmd(t){if(null!=t)return this._sp&&(this._sp._renderType|=ie.GRAPHICS),this._cmds.push(t),this._render=1===this._cmds.length?this._renderOne:this._renderAll,this._repaint(),t;console.warn("null cmd")}removeCmd(t){let e=this.cmds.indexOf(t);if(-1!=e){this._cmds.splice(e,1);let t=this._cmds.length;this._render=0===t?this._renderEmpty:1===t?this._renderOne:this._renderAll,this._repaint()}}getBounds(t=!1){return this._initGraphicBounds(),this._graphicBounds.getBounds(t)}getBoundPoints(t=!1){return this._initGraphicBounds(),this._graphicBounds.getBoundPoints(t)}get material(){return this._material}set material(t){this._material!=t&&(this._material&&this._material._removeReference(),this._material=t,null!=t&&t._addReference())}drawImage(t,e=0,r=0,i=null,s=null,a=null){return t&&t.bitmap?this.addCmd(Li.create(t,e,r,i,s,a)):null}drawTexture(t,e=0,r=0,i=null,s=null,a=null,n=1,l=null,o=null,h){return!t||n<.01?null:t.bitmap?this.addCmd(zi.create(t,e,r,i,s,a,n,l,o,h)):null}drawTextures(t,e,r){return t?this.addCmd(us.create(t,e,r)):null}drawGeo(t,e){return this.addCmd(_s.create(t,e))}drawGeos(t,e){return this.addCmd(ps.create(t,e))}drawTriangles(t,e,r,i,s,a,n=null,l=1,o=null,h=null){return this.addCmd(Ki.create(t,e,r,i,s,a,n,l,o,h))}fillTexture(t,e,r,s=0,a=0,n="repeat",l=null,o=null){return t&&t.bitmap?this.addCmd(Wi.create(t,e,r,s,a,n,l||i.EMPTY,o)):null}clipRect(t,e,r,i){return this.addCmd(hs.create(t,e,r,i))}fillText(t,e,r,i,s,a){return this.addCmd(rs.create(t,e,r,i,s,a,0,""))}fillBorderText(t,e,r,i,s,a,n,l){return this.addCmd(rs.create(t,e,r,i,s,a,n,l))}strokeText(t,e,r,i,s,a,n){return this.addCmd(rs.create(t,e,r,i,null,n,a,s))}alpha(t){return this.addCmd(Ii.create(t))}transform(t,e=0,r=0){return this.addCmd(qi.create(t,e,r))}rotate(t,e=0,r=0){return this.addCmd(Xi.create(t,e,r))}scale(t,e,r=0,i=0){return this.addCmd(ji.create(t,e,r,i))}translate(t,e){return this.addCmd($i.create(t,e))}save(){return this.addCmd(Ji.create())}restore(){return this.addCmd(Yi.create())}replaceTextColor(t){this._repaint();let e=this._cmds;for(let r=e.length-1;r>-1;r--){let i=e[r];switch(i.cmdID){case rs.ID:i.color=t;break;case Li.ID:i.color=null!=t?gr.create(t).numColor:4294967295}}}loadImage(t,r=0,i=0,s=null,a=null,n=null){let l=e.loader.getRes(t);l?(this.drawImage(l,r,i,s,a),n&&n.call(this._sp)):e.loader.load(t).then((t=>{this.drawImage(t,r,i,s,a),n&&n.call(this._sp)}))}_renderEmpty(t,e,r,i){}_renderAll(t,e,r,i){e.sprite=t,e._material=this._material;var s=this._cmds;for(let t=0,a=s.length;t<a;t++)s[t].run(e,r,i);e._material=null}_renderOne(t,e,r,i){e.sprite=t,e._material=this._material,this._cmds[0].run(e,r,i),e._material=null}drawLine(t,e,r,i,s,a=1){return this.addCmd(Pi.create(t,e,r,i,s,a))}drawLines(t,e,r,i,s=1){return!r||r.length<4?null:this.addCmd(Oi.create(t,e,r,i,s))}drawCurves(t,e,r,i,s=1){return this.addCmd(Bi.create(t,e,r,i,s))}drawRect(t,e,r,i,s,a=null,n=1,l){return this.addCmd(Hi.create(t,e,r,i,s,a,n,l))}drawRoundRect(t,e,r,i,s,a,n,l,o,h=null,u=1,d){return this.addCmd(es.create(t,e,r,i,s,a,n,l,o,h,u,d))}drawCircle(t,e,r,i,s=null,a=1){return this.addCmd(Mi.create(t,e,r,i,s,a))}drawEllipse(t,e,r,i,s,a,n,l){return this.addCmd(ts.create(t,e,r,i,s,a,n,l))}drawPie(t,e,r,i,s,a,n=null,l=1){return this.addCmd(ki.create(t,e,r,P.toRadian(i),P.toRadian(s),a,n,l))}drawPoly(t,e,r,i,s=null,a=1){return this.addCmd(Vi.create(t,e,r,i,s,a))}drawPath(t,e,r,i=null,s=null){return this.addCmd(Fi.create(t,e,r,i,s))}draw9Grid(t,e=0,r=0,i=0,s=0,a,n){this.addCmd(Qi.create(t,e,r,i,s,a,!1,n))}}const gs=[];class ms extends v{get url(){return this._url}set url(t){this._url=t}get hideFlags(){return this._hideFlags}set hideFlags(t){this._hideFlags=t}get is3D(){return this._is3D}get destroyed(){return this._destroyed}constructor(){super(),this._bits=0,this._hideFlags=0,this._children=gs,this._parent=null,this._destroyed=!1,this.name="",this._initialize()}_initialize(){this._extra={}}_setBit(t,e){t===kt.DISPLAY&&(this._getBit(t)!=e&&this._updateDisplayedInstage());e?this._bits|=t:this._bits&=~t}_getBit(t){return!!(this._bits&t)}_updateDisplayedInstage(){var t;t=this;for(var r=e.stage,i=!1;t;){if(t._getBit(kt.DISPLAY)){i=t._getBit(kt.DISPLAYED_INSTAGE);break}if(t===r||t._getBit(kt.DISPLAYED_INSTAGE)){i=!0;break}t=t._parent}this._setBit(kt.DISPLAYED_INSTAGE,i)}_setUpNoticeChain(){this._getBit(kt.DISPLAY)&&this._setBitUp(kt.DISPLAY)}_setBitUp(t){var e=this;for(e._setBit(t,!0),e=e._parent;e;){if(e._getBit(t))return;e._setBit(t,!0),e=e._parent}}onStartListeningToType(t){t!==s.DISPLAY&&t!==s.UNDISPLAY||this._getBit(kt.DISPLAY)||this._setBitUp(kt.DISPLAY)}bubbleEvent(t,e){let r=ys.length>0?ys.pop():[];r.length=0;let i=this;for(;i;)i.activeInHierarchy&&r.push(i),i=i.parent;if(e instanceof s){e._stopped=!1;for(let i of r)if(e.setTo(t,i,this),i.event(t,e),e._stopped)break}else for(let i of r)i.event(t,e);ys.push(r)}hasHideFlag(t){return!!(this._hideFlags&t)}destroy(t=!0){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent.removeChild(this),this._children&&(t?this.destroyChildren():this.removeChildren()),this.onDestroy(),this._children=null,this.offAll()}onDestroy(){}destroyChildren(){if(this._children)for(let t=0,e=this._children.length;t<e;t++)this._children[0]&&this._children[0].destroy(!0)}addChild(t){if(!t||this._destroyed||t===this)return t;if(t._zOrder&&this._setBit(kt.HAS_ZORDER,!0),t._parent===this){var e=this.getChildIndex(t);e!==this._children.length-1&&(this._children.splice(e,1),this._children.push(t),this._childChanged())}else t._parent&&t._parent.removeChild(t),this._children===gs&&(this._children=[]),this._children.push(t),t._setParent(this);return t}addChildren(...t){for(var e=0,r=t.length;e<r;)this.addChild(t[e++])}addChildAt(t,e){if(!t||this._destroyed||t===this)return t;if(t._zOrder&&this._setBit(kt.HAS_ZORDER,!0),e>=0&&e<=this._children.length){if(t._parent===this){var r=this.getChildIndex(t);this._children.splice(r,1),this._children.splice(e,0,t),this._childChanged()}else t._parent&&t._parent.removeChild(t),this._children===gs&&(this._children=[]),this._children.splice(e,0,t),t._setParent(this);return t}throw new H(e)}getChildIndex(t){return this._children.indexOf(t)}getChildByName(t){for(let e of this._children)if(e&&e.name===t)return e;return null}getChildAt(t){return this._children[t]||null}setChildIndex(t,e){var r=this._children;if(e<0||e>=r.length)throw new H(e);var i=this.getChildIndex(t);if(i<0)throw new Error("node must be a child of this object.");return r.splice(i,1),r.splice(e,0,t),this._childChanged(),t}_childChanged(t=null){}removeChild(t){if(!this._children)return t;var e=this._children.indexOf(t);return this.removeChildAt(e)}removeSelf(){return this._parent&&this._parent.removeChild(this),this}removeChildByName(t){var e=this.getChildByName(t);return e&&this.removeChild(e),e}removeChildAt(t){var e=this.getChildAt(t);return e&&(this._children.splice(t,1),e._setParent(null)),e}removeChildren(t=0,e=2147483647){if(this._children&&this._children.length>0){var r=this._children;if(0===t&&e>=r.length-1){var i=r;this._children=gs}else i=r.splice(t,e-t+1);for(var s=0,a=i.length;s<a;s++)i[s]._setParent(null)}return this}replaceChild(t,e){var r=this._children.indexOf(e);return r>-1?(this._children.splice(r,1,t),e._setParent(null),t._setParent(this),t):null}get numChildren(){return this._children?this._children.length:0}get parent(){return this._parent}isAncestorOf(t){let e=t.parent;for(;e;){if(e==this)return!0;e=e.parent}return!1}_setParent(t){if(this._parent!==t)if(t)this._parent=t,this._onAdded(),this.event(s.ADDED),this._getBit(kt.DISPLAY)&&(this._setUpNoticeChain(),t.displayedInStage&&this._displayChild(this,!0)),t._childChanged(this);else{this._onRemoved(),this.event(s.REMOVED);let e=this._parent;this._getBit(kt.DISPLAY)&&this._displayChild(this,!1),this._parent=t,e._childChanged(this)}}get displayedInStage(){return this._getBit(kt.DISPLAY)||this._setBitUp(kt.DISPLAY),this._getBit(kt.DISPLAYED_INSTAGE)}_setDisplay(t){this._getBit(kt.DISPLAYED_INSTAGE)!==t&&(this._setBit(kt.DISPLAYED_INSTAGE,t),t?this.event(s.DISPLAY):this.event(s.UNDISPLAY))}_displayChild(t,e){var r=t._children;if(r)for(var i=0,s=r.length;i<s;i++){var a=r[i];a&&(a._getBit(kt.DISPLAY)&&(a._children.length>0?this._displayChild(a,e):a._setDisplay(e)))}t._setDisplay(e)}contains(t){if(t===this)return!0;for(;t;){if(t._parent===this)return!0;t=t._parent}return!1}timerLoop(t,e,r,i=null,s=!0,a=!1){this.timer.loop(t,e,r,i,s,a)}timerOnce(t,e,r,i=null,s=!0){this.timer._create(!1,!1,t,e,r,i,s)}frameLoop(t,e,r,i=null,s=!0){this.timer._create(!0,!0,t,e,r,i,s)}frameOnce(t,e,r,i=null,s=!0){this.timer._create(!0,!1,t,e,r,i,s)}clearTimer(t,e){this.timer.clear(t,e)}callLater(t,e=null){this.timer.callLater(this,t,e)}runCallLater(t){this.timer.runCallLater(this,t)}get scene(){return this._scene}get active(){return!this._getBit(kt.NOT_READY)&&!this._getBit(kt.NOT_ACTIVE)}set active(t){if(t=!!t,!this._getBit(kt.NOT_ACTIVE)!==t){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");this._setBit(kt.NOT_ACTIVE,!t),this._parent&&this._parent.activeInHierarchy&&this._processActive(t,!0)}}get activeInHierarchy(){return this._getBit(kt.ACTIVE_INHIERARCHY)}_onActive(){se.spriteCount++}_onInActive(){se.spriteCount--}_onActiveInScene(){this.event(ms.EVENT_SET_ACTIVESCENE,this._scene)}_onInActiveInScene(){this.event(ms.EVENT_SET_IN_ACTIVESCENE,this._scene)}onAwake(){}onEnable(){}onDisable(){}_parse(t,e){}_setBelongScene(t){if(!this._scene||this.scene!=t){this._scene=t,this._onActiveInScene();for(let e=0,r=this._children.length;e<r;e++)this._children[e]._setBelongScene(t)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._setUnBelongScene()}}_processActive(t,e){this._activeChangeScripts||(this._activeChangeScripts=[]);let r=this._activeChangeScripts;t?this._activeHierarchy(r,e):this._inActiveHierarchy(r,e);for(let e=0,i=r.length;e<i;e++){let i=r[e];i.owner&&i._setActive(t)}r.length=0}_activeHierarchy(t,e){if(this._setBit(kt.ACTIVE_INHIERARCHY,!0),this._components)for(let e=0,r=this._components.length;e<r;e++){let r=this._components[e];r._isScript()?r._enabled&&t.push(r):r._setActive(!0)}this._onActive();for(let r=0,i=this._children.length;r<i;r++){let i=this._children[r];!i._getBit(kt.NOT_ACTIVE)&&!i._getBit(kt.NOT_READY)&&i._activeHierarchy(t,e)}this._getBit(kt.AWAKED)||(this._setBit(kt.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(t,e){if(this._onInActive(),this._components)for(let e=0,r=this._components.length;e<r;e++){let r=this._components[e];r._isScript()?r._enabled&&t.push(r):r._setActive(!1)}this._setBit(kt.ACTIVE_INHIERARCHY,!1);for(let r=0,i=this._children.length;r<i;r++){let i=this._children[r];i&&!i._getBit(kt.NOT_ACTIVE)&&i._inActiveHierarchy(t,e)}this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");{let t=this._parent.scene;t&&this._setBelongScene(t),this._parent.activeInHierarchy&&this.active&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");this._parent.activeInHierarchy&&this.active&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(t){var e;this._components||(this._components=[]),this._components.push(t),t._setOwner(this),this.activeInHierarchy&&t._setActive(!0),null===(e=this._componentsChanged)||void 0===e||e.call(this,t,0)}_destroyComponent(t){var e;if(!this._components)return;let r=this._components.indexOf(t);-1!=r&&(this._components.splice(r,1),t._destroy(),null===(e=this._componentsChanged)||void 0===e||e.call(this,t,1))}destroyAllComponent(){var t;if(this._components){for(let t=0,e=this._components.length;t<e;t++){let e=this._components[t];e&&!e.destroyed&&e._destroy()}this._components.length=0,null===(t=this._componentsChanged)||void 0===t||t.call(this,null,2)}}_cloneTo(t,e,r){if(this._components)for(let e=0,r=this._components.length;e<r;e++){var i=t.addComponent(this._components[e].constructor);this._components[e]._cloneTo(i)}}addComponentInstance(t){if(t.owner)throw new Error("the component is belong to other node.");return t._singleton&&this.getComponent(t.constructor)?console.warn("the component is singleton, can't add the second one.",t):this._addComponentInstance(t),t}addComponent(t){let e=r.createByClass(t);if(!e)throw new Error("missing "+t.toString());return e._singleton&&this.getComponent(t)?console.warn("the component is singleton, can't add the second one.",e):this._addComponentInstance(e),e}getComponent(t){if(this._components)for(let e=0,r=this._components.length;e<r;e++){let r=this._components[e];if(r instanceof t)return r}return null}get components(){return this._components||gs}getComponents(t){var e;if(this._components)for(let r=0,i=this._components.length;r<i;r++){let i=this._components[r];i instanceof t&&(e=e||[]).push(i)}return e}get timer(){return this._scene?this._scene.timer:e.timer}onAfterDeserialize(){}}ms.EVENT_SET_ACTIVESCENE="ActiveScene",ms.EVENT_SET_IN_ACTIVESCENE="InActiveScene";const ys=[],Ts=.5*Math.PI,xs=2*Math.PI;class vs{static linearNone(t,e,r,i){return r*t/i+e}static linearIn(t,e,r,i){return r*t/i+e}static linearInOut(t,e,r,i){return r*t/i+e}static linearOut(t,e,r,i){return r*t/i+e}static bounceIn(t,e,r,i){return r-vs.bounceOut(i-t,0,r,i)+e}static bounceInOut(t,e,r,i){return t<.5*i?.5*vs.bounceIn(2*t,0,r,i)+e:.5*vs.bounceOut(2*t-i,0,r,i)+.5*r+e}static bounceOut(t,e,r,i){return(t/=i)<1/2.75?r*(7.5625*t*t)+e:t<2/2.75?r*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?r*(7.5625*(t-=2.25/2.75)*t+.9375)+e:r*(7.5625*(t-=2.625/2.75)*t+.984375)+e}static backIn(t,e,r,i,s=1.70158){return r*(t/=i)*t*((s+1)*t-s)+e}static backInOut(t,e,r,i,s=1.70158){return(t/=.5*i)<1?.5*r*(t*t*((1+(s*=1.525))*t-s))+e:r/2*((t-=2)*t*((1+(s*=1.525))*t+s)+2)+e}static backOut(t,e,r,i,s=1.70158){return r*((t=t/i-1)*t*((s+1)*t+s)+1)+e}static elasticIn(t,e,r,i,s=0,a=0){var n;return 0==t?e:1==(t/=i)?e+r:(a||(a=.3*i),!s||r>0&&s<r||r<0&&s<-r?(s=r,n=a/4):n=a/xs*Math.asin(r/s),-s*Math.pow(2,10*(t-=1))*Math.sin((t*i-n)*xs/a)+e)}static elasticInOut(t,e,r,i,s=0,a=0){var n;return 0==t?e:2==(t/=.5*i)?e+r:(a||(a=i*(.3*1.5)),!s||r>0&&s<r||r<0&&s<-r?(s=r,n=a/4):n=a/xs*Math.asin(r/s),t<1?s*Math.pow(2,10*(t-=1))*Math.sin((t*i-n)*xs/a)*-.5+e:s*Math.pow(2,-10*(t-=1))*Math.sin((t*i-n)*xs/a)*.5+r+e)}static elasticOut(t,e,r,i,s=0,a=0){var n;return 0==t?e:1==(t/=i)?e+r:(a||(a=.3*i),!s||r>0&&s<r||r<0&&s<-r?(s=r,n=a/4):n=a/xs*Math.asin(r/s),s*Math.pow(2,-10*t)*Math.sin((t*i-n)*xs/a)+r+e)}static strongIn(t,e,r,i){return r*(t/=i)*t*t*t*t+e}static strongInOut(t,e,r,i){return(t/=.5*i)<1?.5*r*t*t*t*t*t+e:.5*r*((t-=2)*t*t*t*t+2)+e}static strongOut(t,e,r,i){return r*((t=t/i-1)*t*t*t*t+1)+e}static sineInOut(t,e,r,i){return.5*-r*(Math.cos(Math.PI*t/i)-1)+e}static sineIn(t,e,r,i){return-r*Math.cos(t/i*Ts)+r+e}static sineOut(t,e,r,i){return r*Math.sin(t/i*Ts)+e}static quintIn(t,e,r,i){return r*(t/=i)*t*t*t*t+e}static quintInOut(t,e,r,i){return(t/=.5*i)<1?.5*r*t*t*t*t*t+e:.5*r*((t-=2)*t*t*t*t+2)+e}static quintOut(t,e,r,i){return r*((t=t/i-1)*t*t*t*t+1)+e}static quartIn(t,e,r,i){return r*(t/=i)*t*t*t+e}static quartInOut(t,e,r,i){return(t/=.5*i)<1?.5*r*t*t*t*t+e:.5*-r*((t-=2)*t*t*t-2)+e}static quartOut(t,e,r,i){return-r*((t=t/i-1)*t*t*t-1)+e}static cubicIn(t,e,r,i){return r*(t/=i)*t*t+e}static cubicInOut(t,e,r,i){return(t/=.5*i)<1?.5*r*t*t*t+e:.5*r*((t-=2)*t*t+2)+e}static cubicOut(t,e,r,i){return r*((t=t/i-1)*t*t+1)+e}static quadIn(t,e,r,i){return r*(t/=i)*t+e}static quadInOut(t,e,r,i){return(t/=.5*i)<1?.5*r*t*t+e:.5*-r*(--t*(t-2)-1)+e}static quadOut(t,e,r,i){return-r*(t/=i)*(t-2)+e}static expoIn(t,e,r,i){return 0==t?e:r*Math.pow(2,10*(t/i-1))+e-.001*r}static expoInOut(t,e,r,i){return 0==t?e:t==i?e+r:(t/=.5*i)<1?.5*r*Math.pow(2,10*(t-1))+e:.5*r*(2-Math.pow(2,-10*--t))+e}static expoOut(t,e,r,i){return t==i?e+r:r*(1-Math.pow(2,-10*t/i))+e}static circIn(t,e,r,i){return-r*(Math.sqrt(1-(t/=i)*t)-1)+e}static circInOut(t,e,r,i){return(t/=.5*i)<1?.5*-r*(Math.sqrt(1-t*t)-1)+e:.5*r*(Math.sqrt(1-(t-=2)*t)+1)+e}static circOut(t,e,r,i){return r*Math.sqrt(1-(t=t/i-1)*t)+e}}class Ss{constructor(){this.gid=0,this.repeat=1,this._count=0}static to(t,e,i,s=null,a=null,n=0,l=!1,o=!0){return r.getItemByClass("tween",Ss)._create(t,e,i,s,a,n,l,!0,o,!0)}static from(t,e,i,s=null,a=null,n=0,l=!1,o=!0){return r.getItemByClass("tween",Ss)._create(t,e,i,s,a,n,l,!1,o,!0)}to(t,e,r,i=null,s=null,a=0,n=!1){return this._create(t,e,r,i,s,a,n,!0,!1,!0)}from(t,e,r,i=null,s=null,a=0,n=!1){return this._create(t,e,r,i,s,a,n,!1,!1,!0)}_create(t,r,i,s,a,n,l,o,h,u){if(!t)throw new Error("Tween:target is null");this._target=t,this._duration=i,this._ease=s||r.ease||Ss.easeNone,this._complete=a||r.complete,this._delay=n,this._props=[],this._usedTimer=0,this._startTimer=A.now(),this._usedPool=h,this._delayParam=null,this.update=r.update;var d=t.$_GID||(t.$_GID=P.getGID());return Ss.tweenMap[d]?(l&&Ss.clearTween(t),Ss.tweenMap[d].push(this)):Ss.tweenMap[d]=[this],u?n<=0?this.firstStart(t,r,o):(this._delayParam=[t,r,o],e.timer.once(n,this,this.firstStart,this._delayParam)):this._initProps(t,r,o),this}firstStart(t,e,r){this._delayParam=null,t.destroyed?this.clear():(this._initProps(t,e,r),this._beginLoop())}_initProps(t,e,r){for(var i in e)if("number"==typeof t[i]){var s=r?t[i]:e[i],a=r?e[i]:t[i];this._props.push([i,s,a-s]),r||(t[i]=s)}}_beginLoop(){e.timer.frameLoop(1,this,this._doEase)}_doEase(){this._updateEase(A.now())}_updateEase(t){var e=this._target;if(e){if(e.destroyed)return Ss.clearTween(e);var r=this._usedTimer=t-this._startTimer-this._delay;if(!(r<0)){if(r>=this._duration)return this.complete();for(var i=r>0?this._ease(r,0,1,this._duration):0,s=this._props,a=0,n=s.length;a<n;a++){var l=s[a];e[l[0]]=l[1]+i*l[2]}this.update&&this.update.run()}}}set progress(t){var e=t*this._duration;this._startTimer=A.now()-this._delay-e}complete(){if(this._target){e.timer.runTimer(this,this.firstStart);for(var t=this._target,r=this._props,i=this._complete,s=0,a=r.length;s<a;s++){var n=r[s];t[n[0]]=n[1]+n[2]}this.update&&this.update.run(),this._count++,0!=this.repeat&&this._count>=this.repeat?(this.clear(),i&&i.run()):this.restart()}}pause(){var t;e.timer.clear(this,this._beginLoop),e.timer.clear(this,this._doEase),e.timer.clear(this,this.firstStart),(t=A.now()-this._startTimer-this._delay)<0&&(this._usedTimer=t)}setStartTime(t){this._startTimer=t}static clearAll(t){if(t&&t.$_GID){var e=Ss.tweenMap[t.$_GID];if(e){for(var r=0,i=e.length;r<i;r++)e[r]._clear();e.length=0}}}static clear(t){t.clear()}static clearTween(t){Ss.clearAll(t)}clear(){this._target&&(this._remove(),this._clear())}_clear(){this.pause(),e.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._delayParam=null,this.repeat=1,this._usedPool&&(this.update=null,r.recover("tween",this))}recover(){this._usedPool=!0,this._clear()}_remove(){var t=Ss.tweenMap[this._target.$_GID];if(t)for(var e=0,r=t.length;e<r;e++)if(t[e]===this){t.splice(e,1);break}}restart(){if(this.pause(),this._usedTimer=0,this._startTimer=A.now(),this._delayParam)e.timer.once(this._delay,this,this.firstStart,this._delayParam);else{for(var t=this._props,r=0,i=t.length;r<i;r++){var s=t[r];this._target[s[0]]=s[1]}e.timer.once(this._delay,this,this._beginLoop)}}resume(){this._usedTimer>=this._duration||(this._startTimer=A.now()-this._usedTimer-this._delay,this._delayParam?this._usedTimer<0?e.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam):this.firstStart.apply(this,this._delayParam):this._beginLoop())}static easeNone(t,e,r,i){return r*t/i+e}}Ss.tweenMap=[];class Es{constructor(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}start(t,r,i,a,n,l,o=.92){this.clearTimer(),this.target=t,this.area=r,this.hasInertia=i,this.elasticDistance=r?a:0,this.elasticBackTime=n,this.data=l,this.ratio=o,this._parent=t.parent,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,e.stage.on(s.MOUSE_UP,this,this.onStageMouseUp),e.stage.on(s.MOUSE_OUT,this,this.onStageMouseUp),e.systemTimer.frameLoop(1,this,this.loop)}clearTimer(){e.systemTimer.clear(this,this.loop),e.systemTimer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)}stop(){this._dragging&&(e.stage.off(s.MOUSE_UP,this,this.onStageMouseUp),e.stage.off(s.MOUSE_OUT,this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())}loop(){var t=this._parent.getMousePoint(),r=t.x,i=t.y,a=r-this._lastX,n=i-this._lastY;if(this._clickOnly){if(!(Math.abs(a*e.stage._canvasTransform.getScaleX())>1||Math.abs(n*e.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event(s.DRAG_START,this.data)}else this._offsets.push(a,n);0===a&&0===n||(this._lastX=r,this._lastY=i,this.target.x+=a*this._elasticRateX,this.target.y+=n*this._elasticRateY,this.area&&this.checkArea(),this.target.event(s.DRAG_MOVE,this.data))}checkArea(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target._x<this.area.x)var t=this.area.x-this.target._x;else t=this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-t/this.elasticDistance),this.target._y<this.area.y)var e=this.area.y-this.target.y;else e=this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-e/this.elasticDistance)}}backToArea(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height)}onStageMouseUp(t){if(e.stage.off(s.MOUSE_UP,this,this.onStageMouseUp),e.stage.off(s.MOUSE_OUT,this,this.onStageMouseUp),e.systemTimer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var r=this._offsets.length,i=Math.min(r,6),a=this._offsets.length-i,n=r-1;n>a;n--)this._offsetY+=this._offsets[n--],this._offsetX+=this._offsets[n];this._offsetX=this._offsetX/i*2,this._offsetY=this._offsetY/i*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),e.systemTimer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()}checkElastic(){var t=NaN,e=NaN;if(this.target.x<this.area.x?t=this.area.x:this.target._x>this.area.x+this.area.width&&(t=this.area.x+this.area.width),this.target.y<this.area.y?e=this.area.y:this.target._y>this.area.y+this.area.height&&(e=this.area.y+this.area.height),isNaN(t)&&isNaN(e))this.clear();else{var r={};isNaN(t)||(r.x=t),isNaN(e)||(r.y=e),this._tween=Ss.to(this.target,r,this.elasticBackTime,vs.sineOut,St.create(this,this.clear),0,!1,!1)}}tweenMove(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event(s.DRAG_MOVE,this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(e.systemTimer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())}clear(){if(this.target){this.clearTimer();var t=this.target;this.target=null,this._parent=null,t.event(s.DRAG_END,this.data)}}}class ws{static getGlobalRecByPoints(t,e,r,s,a){var n,l;n=i.create().setTo(e,r),n=t.localToGlobal(n),l=i.create().setTo(s,a),l=t.localToGlobal(l);var o=F._getWrapRec([n.x,n.y,l.x,l.y]);return n.recover(),l.recover(),o}static getGlobalPosAndScale(t){return ws.getGlobalRecByPoints(t,0,0,1,1)}static getTransformRelativeToWindow(t,r,i){var s=e.stage,a=ws.getGlobalPosAndScale(t),n=s._canvasTransform.clone(),l=n.tx,o=n.ty;n.rotate(-Math.PI/180*s.canvasDegree),n.scale(s.clientScaleX,s.clientScaleY);var h,u,d,c,_=s.canvasDegree%180!=0;return _?(h=i+a.y,u=r+a.x,h*=n.d,u*=n.a,90==s.canvasDegree?(h=l-h,u+=o):(h+=l,u=o-u)):(h=r+a.x,u=i+a.y,h*=n.a,u*=n.d,h+=l,u+=o),u+=s._safariOffsetY,_?(d=n.d*a.height,c=n.a*a.width):(d=n.a*a.width,c=n.d*a.height),{x:h,y:u,scaleX:d,scaleY:c}}static fitDOMElementInArea(t,r,i,s,a,n){t._fitLayaAirInitialized||(t._fitLayaAirInitialized=!0,t.style.transformOrigin=t.style.webKittransformOrigin="left top",t.style.position="absolute");var l=ws.getTransformRelativeToWindow(r,i,s);t.style.transform=t.style.webkitTransform="scale("+l.scaleX+","+l.scaleY+") rotate("+e.stage.canvasDegree+"deg)",t.style.width=a+"px",t.style.height=n+"px",t.style.left=l.x+"px",t.style.top=l.y+"px"}static updateOrder(t){if(!t||t.length<2)return!1;for(var e,r,i,s=1,a=t.length;s<a;){for(i=t[e=s],r=t[e]._zOrder;--e>-1&&t[e]._zOrder>r;)t[e+1]=t[e];t[e+1]=i,s++}return!0}}class Ds extends ms{destroy(t=!0){super.destroy(t),this._style&&this._style.recover(),this._cacheStyle&&this._cacheStyle.recover(),this._boundStyle&&this._boundStyle.recover(),this._transform&&this._transform.recover(),this._style=null,this._cacheStyle=null,this._boundStyle=null,this._transform=null,this._texture&&this._texture._removeReference(),this._texture=null,this._graphics&&this._ownGraphics&&this._graphics.destroy(),this._graphics=null}constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._anchorX=0,this._anchorY=0,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._transform=null,this._tfChanged=!1,this._repaint=ie.REPAINT_NONE,this._texture=null,this._sizeFlag=0,this._style=Ai.EMPTY,this._cacheStyle=Ci.EMPTY,this._filterArr=null,this._boundStyle=null,this._graphics=null,this._renderNode=null,this._ownGraphics=!1,this.mouseThrough=!1,this.hitTestPrior=!1,this.autoSize=!1,this._globalDeltaFlages=0,this._cacheGlobal=!1,this._globalPosx=0,this._globalPosy=0,this._globalRotate=0,this._globalScalex=1,this._globalScaley=1}get scene(){return this._scene}updateZOrder(){ws.updateOrder(this._children)&&this.repaint()}_getBoundsStyle(){return this._boundStyle||(this._boundStyle=Ri.create()),this._boundStyle}_setCustomRender(){}set customRenderEnable(t){t&&(this._renderType|=ie.CUSTOM,this._setCustomRender())}get cacheAs(){return this._getCacheStyle().userSetCache}set cacheAs(t){t!==this._cacheStyle.userSetCache&&(this._getCacheStyle().userSetCache=t,this.mask&&"normal"===t||("bitmap"==t||"normal"==t?this._renderType|=ie.CANVAS:this._renderType&=~ie.CANVAS,this.repaint()))}get staticCache(){return this._getCacheStyle().staticCache}set staticCache(t){this._getCacheStyle().staticCache=t,t||this.reCache()}reCache(){this._repaint|=ie.REPAINT_CACHE}get renderNode2D(){return this._renderNode}set renderNode2D(t){t?(this._renderType|=ie.RENDERNODE2D,this._renderNode=t):this._renderType&=~ie.RENDERNODE2D}getRepaint(){return this._repaint}_setX(t){this._x=t}_setY(t){this._y=t}get x(){return this._x}set x(t){if(!this._destroyed&&this._x!==t){this._setX(t),this.cacheGlobal&&(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Position_X|Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Position_X|Ds.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(ie.REPAINT_CACHE);var e=this._getCacheStyle().maskParent;e&&e.repaint(ie.REPAINT_CACHE)}}get y(){return this._y}set y(t){if(!this._destroyed&&this._y!==t){this._setY(t),this.cacheGlobal&&(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Position_Y|Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Position_Y|Ds.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(ie.REPAINT_CACHE);var e=this._getCacheStyle().maskParent;e&&e.repaint(ie.REPAINT_CACHE)}}get width(){return this.get_width()}set width(t){this.set_width(t)}set_width(t){let e=this._sizeFlag;null==t?(t=0,this._sizeFlag&=-2):0==t?this._sizeFlag|=1:this._sizeFlag&=-2,this._width===t&&e==this._sizeFlag||(this._width=t,this._setWidth(t),this._setPivotX(this._anchorX*t),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_width(){return this.autoSize?this.texture?this.texture.width:this._graphics||0!==this._children.length?this.getSelfBounds().width:0:0!=this._width||1&this._sizeFlag||!this.texture?this._width:this.texture.width}get height(){return this.get_height()}set height(t){this.set_height(t)}set_height(t){let e=this._sizeFlag;null==t?(t=0,this._sizeFlag&=-3):0==t?this._sizeFlag|=2:this._sizeFlag&=-3,this._height===t&&e==this._sizeFlag||(this._height=t,this._setHeight(t),this._setPivotY(this._anchorY*t),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_height(){return this.autoSize?this.texture?this.texture.height:this._graphics||0!==this._children.length?this.getSelfBounds().height:0:0!=this._height||2&this._sizeFlag||!this.texture?this._height:this.texture.height}get _isWidthSet(){return 0!=this._width||!!(1&this._sizeFlag)}get _isHeightSet(){return 0!=this._height||!!(2&this._sizeFlag)}_setWidth(t){}_setHeight(t){}_shouldRefreshLayout(){}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}setSelfBounds(t){this._getBoundsStyle().userBounds=t}getBounds(){return this._getBoundsStyle().bounds=F._getWrapRec(this._boundPointsToParent())}getSelfBounds(){return this._boundStyle&&this._boundStyle.userBounds?this._boundStyle.userBounds:this._graphics||0!==this._children.length||this._texture?this._getBoundsStyle().bounds=F._getWrapRec(this._getBoundPointsM(!1)):F.TEMP.setTo(0,0,this.width,this.height)}_boundPointsToParent(t=!1){let e=0,r=0;this._style&&(e=this.pivotX,r=this.pivotY,t=t||0!==this._style.rotation,this._style.scrollRect&&(e+=this._style.scrollRect.x,r+=this._style.scrollRect.y));let s=this._getBoundPointsM(t);if(!s||s.length<1)return s;if(8!=s.length&&(s=t?re.scanPList(s):F._getWrapRec(s,F.TEMP)._getBoundPoints()),!this.transform)return P.transPointList(s,this._x-e,this._y-r),s;let a=i.TEMP,n=s.length;for(let t=0;t<n;t+=2)a.x=s[t],a.y=s[t+1],this.toParentPoint(a),s[t]=a.x,s[t+1]=a.y;return s}_getBoundPointsM(t=!1){if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();this._boundStyle||this._getBoundsStyle();let e,r=this._boundStyle.temBM;if(r||(r=this._boundStyle.temBM=[]),this._style.scrollRect){r.length=0;var i=F.TEMP;return i.copyFrom(this._style.scrollRect),r.push(...i._getBoundPoints()),r}this._graphics?e=this._graphics.getBoundPoints():(r.length=0,e=r),this._renderNode&&((i=F.TEMP).setTo(0,0,this.width,this.height),e.push(...i._getBoundPoints())),this._texture&&((i=F.TEMP).setTo(0,0,this.width||this._texture.width,this.height||this._texture.height),e.push(...i._getBoundPoints()));let s=this._children;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(!0===i._visible&&i._cacheStyle.maskParent!=this){let r=i._boundPointsToParent(t);r&&(e?e.push(...r):e=r)}}return e}getGraphicBounds(t=!1){return this._graphics?this._graphics.getBounds(t):F.TEMP.setTo(0,0,0,0)}_getCacheStyle(){return this._cacheStyle===Ci.EMPTY&&(this._cacheStyle=Ci.create()),this._cacheStyle}getStyle(){return this._style===Ai.EMPTY&&(this._style=Ai.create()),this._style}setStyle(t){this._style=t}get scaleX(){return this._style.scaleX}set scaleX(t){this.set_scaleX(t)}get scaleY(){return this._style.scaleY}set scaleY(t){this.set_scaleY(t)}set_scaleX(t){this.getStyle().scaleX!==t&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Scale_X|Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Scale_X|Ds.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleX(t),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleX(){return this._style.scaleX}set_scaleY(t){this.getStyle().scaleY!==t&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Scale_Y|Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Scale_Y|Ds.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleY(t),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleY(){return this._style.scaleY}_setScaleX(t){this._style.scaleX=t}_setScaleY(t){this._style.scaleY=t}get rotation(){return this._style.rotation}set rotation(t){this.getStyle().rotation!==t&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Rotation|Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Rotation|Ds.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setRotation(t),this._setTranformChange())}_setRotation(t){this.getStyle().rotation=t}get skewX(){return this._style.skewX}set skewX(t){this.getStyle().skewX!==t&&(this._setSkewX(t),this._setTranformChange())}_setSkewX(t){this._style.skewX=t}get skewY(){return this._style.skewY}set skewY(t){this.getStyle().skewY!==t&&(this._setSkewY(t),this._setTranformChange())}_setSkewY(t){this._style.skewY=t}_createTransform(){return G.create()}_adjustTransform(){this._tfChanged=!1;var t=this._style,e=t.scaleX,r=t.scaleY,i=t.skewX,s=t.skewY,a=t.rotation,n=this._transform||(this._transform=this._createTransform());if(a||1!==e||1!==r||0!==i||0!==s){n._bTransform=!0;var l=.0174532922222222*(a-i),o=.0174532922222222*(a+s),h=Math.cos(o),u=Math.sin(o),d=Math.sin(l),c=Math.cos(l);n.a=e*h,n.b=e*u,n.c=-r*d,n.d=r*c,n.tx=n.ty=0}else n.identity(),this._renderType&=~ie.TRANSFORM;return n}_setTransform(t){}get transform(){return this._tfChanged?this._adjustTransform():this._transform}set transform(t){this.set_transform(t)}get_transform(){return this._tfChanged?this._adjustTransform():this._transform}set_transform(t){this._tfChanged=!1;var e=this._transform||(this._transform=this._createTransform());t.copyTo(e),this._setTransform(e),t&&(this._x=e.tx,this._y=e.ty,e.tx=e.ty=0),t?this._renderType|=ie.TRANSFORM:this._renderType&=~ie.TRANSFORM,this.parentRepaint()}_getPivotX(){return this._style.pivotX}_setPivotX(t){this.getStyle().pivotX=t}_getPivotY(){return this._style.pivotY}_setPivotY(t){this.getStyle().pivotY=t}get pivotX(){return this._getPivotX()}set pivotX(t){if(this.getStyle().pivotX!=t){this._setPivotX(t);let e=this.width;0!=e&&(this._anchorX=t/e),this._shouldRefreshLayout(),this.repaint()}}get pivotY(){return this._getPivotY()}set pivotY(t){if(this.getStyle().pivotY!=t){this._setPivotY(t);let e=this.height;0!=e&&(this._anchorY=t/e),this._shouldRefreshLayout(),this.repaint()}}get anchorX(){return this.get_anchorX()}get_anchorX(){return this._anchorX}set anchorX(t){this.set_anchorX(t)}set_anchorX(t){isNaN(t)&&(t=null),this._anchorX!=t&&(this._anchorX=t,null!=t&&(this._setPivotX(t*this.width),this._shouldRefreshLayout(),this.repaint()))}get anchorY(){return this.get_anchorY()}get_anchorY(){return this._anchorY}set anchorY(t){this.set_anchorY(t)}set_anchorY(t){isNaN(t)&&(t=null),this._anchorY!=t&&(this._anchorY=t,null!=t&&(this._setPivotY(t*this.height),this._shouldRefreshLayout(),this.repaint()))}_setAlpha(t){this._style.alpha!==t&&(this.getStyle().alpha=t,1!==t?this._renderType|=ie.ALPHA:this._renderType&=~ie.ALPHA,this.parentRepaint())}_getAlpha(){return this._style.alpha}get alpha(){return this._getAlpha()}set alpha(t){t=t<0?0:t>1?1:t,this._setAlpha(t)}get visible(){return this.get_visible()}set visible(t){this.set_visible(t)}get_visible(){return this._visible}set_visible(t){this._visible!==t&&(this._visible=t,this.parentRepaint(ie.REPAINT_ALL))}get blendMode(){return this._style.blendMode}set blendMode(t){this.getStyle().blendMode!=t&&(this.getStyle().blendMode=t,t&&"source-over"!=t?this._renderType|=ie.BLEND:this._renderType&=~ie.BLEND,this.parentRepaint())}get graphics(){return this._graphics||(this.graphics=new fs,this._ownGraphics=!0),this._graphics}set graphics(t){this.setGraphics(t,!1)}setGraphics(t,e){this._graphics&&(this._graphics._sp=null,this._ownGraphics&&this._graphics.destroy()),this._ownGraphics=e,this._graphics=t,t?(this._renderType|=ie.GRAPHICS,t._sp=this):this._renderType&=~ie.GRAPHICS,this.repaint()}get material(){var t;return null===(t=this._graphics)||void 0===t?void 0:t.material}set material(t){null==this._graphics&&null==t||(this.graphics.material=t)}get scrollRect(){return this._style.scrollRect}set scrollRect(t){null==this.getStyle().scrollRect&&null==t||(this.getStyle().scrollRect=t,t?this._renderType|=ie.CLIP:this._renderType&=~ie.CLIP,this.repaint())}get viewport(){return this._style.viewport}set viewport(t){if("string"==typeof t){let e=t.split(",");e.length>3&&(t=new F(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])))}this.getStyle().viewport=t}pos(t,e,r=!1){if(this._x!==t||this._y!==e){if(this._destroyed)return this;if(r){this._setX(t),this._setY(e),this.parentRepaint(ie.REPAINT_CACHE);var i=this._cacheStyle.maskParent;if(i&&i.repaint(ie.REPAINT_CACHE),this.cacheGlobal){let t=Ds.Sprite_GlobalDeltaFlage_Position_X|Ds.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(t,!0),this._syncGlobalFlag(t,!0)}}else this.x=t,this.y=e}return this}pivot(t,e){return this.pivotX=t,this.pivotY=e,this}size(t,e){return this.width=t,this.height=e,this}scale(t,e,r){if(this._destroyed)return this;var i=this.getStyle();return i.scaleX==t&&i.scaleY==e||(r?(this._setScaleX(t),this._setScaleY(e),this._setTranformChange(),this._shouldRefreshLayout()):(this.scaleX=t,this.scaleY=e)),this}skew(t,e){return this.skewX=t,this.skewY=e,this}render(t,e,r){Di.renders[this._renderType]._fun(this,t,e+this._x,r+this._y),this._repaint=0}drawToCanvas(t,e,r,i){return Ds.drawToCanvas(this,t,e,r,i)}static drawToCanvas(t,e,r,i,s,a=!0){let n=Ds.drawToRenderTexture2D(t,e,r,i,s,null);for(var l=n.getData(0,0,e,r),o=new ImageData(e,r),h=4*e,u=o.data,d=r-1,c=d*h,_=0;d>=0;d--)u.set(l.subarray(_,_+h),c),c-=h,_+=h;var p=new bi(!0);return p.size(e,r),p.getContext("2d").putImageData(o,0,0),n.destroy(),p}drawToTexture(t,e,r,i,s=null,a=!0){return Ds.drawToTexture(this,t,e,r,i,s,a)}static drawToTexture(e,r,i,s,a,n=null,l=!0){let o=n||new pt(r,i,t.RenderTargetFormat.R8G8B8A8),h=new li;n?h.size(n.width,n.height):h.size(r,i),h.render2D=h.render2D.clone(o),h._drawingToTexture=!0;let u=Di.RenderToRenderTexture(e,h,s,a,o,l);if(h._drawingToTexture=!1,h.destroy(),!n){return new mt(u,mt.INV_UV)}return u}drawToRenderTexture2D(t,e,r,i,s=null,a=!0,n=!1){return Ds.drawToRenderTexture2D(this,t,e,r,i,s,a,n)}static drawToRenderTexture2D(e,r,i,s,a,n=null,l=!0,o=!1){let h=n||new pt(r,i,t.RenderTargetFormat.R8G8B8A8),u=new li;n?u.size(n.width,n.height):u.size(r,i),u.render2D=u.render2D.clone(h),u._drawingToTexture=!0,o&&(h._invertY=!0);let d=Di.RenderToRenderTexture(e,u,s,a,h,l);return u._drawingToTexture=!1,u.destroy(),d}customRender(t,e,r){this._repaint=ie.REPAINT_ALL}_applyFilters(){}get filters(){return this._filterArr}set filters(t){if(t&&0===t.length&&(t=null),this._filterArr)for(let t of this._filterArr)t&&t.off(ee.EVENT_CHANGE,this,this.repaint);if(this._filterArr=t?t.slice():null,t)for(let e of t)e&&e.on(ee.EVENT_CHANGE,this,this.repaint);t?this._renderType|=ie.FILTERS:this._renderType&=~ie.FILTERS,t&&t.length>0&&(this._getBit(kt.DISPLAY)||this._setBitUp(kt.DISPLAY)),this.repaint()}localToGlobal(t,r=!1,s=null){!0===r&&(t=new i(t.x,t.y));var a=this;for(s=s||e.stage;a&&!a._destroyed&&a!=s;)t=a.toParentPoint(t),a=a.parent;return t}globalToLocal(t,r=!1,s=null){r&&(t=new i(t.x,t.y));var a=this,n=[];for(s=s||e.stage;a&&!a._destroyed&&a!=s;)n.push(a),a=a.parent;for(var l=n.length-1;l>=0;)t=(a=n[l]).fromParentPoint(t),l--;return t}toParentPoint(t){if(!t)return t;t.x-=this.pivotX,t.y-=this.pivotY,this.transform&&this._transform.transformPoint(t),t.x+=this._x,t.y+=this._y;var e=this._style.scrollRect;return e&&(t.x-=e.x,t.y-=e.y),t}fromParentPoint(t){if(!t)return t;t.x-=this._x,t.y-=this._y;var e=this._style.scrollRect;return e&&(t.x+=e.x,t.y+=e.y),this.transform&&this._transform.invertTransformPoint(t),t.x+=this.pivotX,t.y+=this.pivotY,t}onStartListeningToType(t){super.onStartListeningToType(t),1!==this._mouseState&&s.isMouseEvent(t)&&(this.mouseEnabled=!0,this._setBit(kt.HAS_MOUSE,!0),this._parent&&this._onDisplay())}_onDisplay(t){if(1!==this._mouseState){var e=this;for(e=e.parent;e&&1!==e._mouseState&&!e._getBit(kt.HAS_MOUSE);)e.mouseEnabled=!0,e._setBit(kt.HAS_MOUSE,!0),e=e.parent}}_setParent(t){super._setParent(t),t&&this._getBit(kt.HAS_MOUSE)&&this._onDisplay()}loadImage(t,r=null){if(t){let i=e.loader.getRes(t);i?(this.texture=i,this.repaint(ie.REPAINT_ALL),r&&r.run()):(this._skinBaseUrl&&(t=O.formatURL(t,this._skinBaseUrl)),e.loader.load(t).then((t=>{this.texture=t,this.repaint(ie.REPAINT_ALL),r&&r.run()})))}else this.texture=null,this.repaint(ie.REPAINT_ALL),r&&r.run();return this}static fromImage(t){return(new Ds).loadImage(t)}repaint(t=ie.REPAINT_CACHE){this._repaint&t||(this._repaint|=t,this.parentRepaint(t)),this._getCacheStyle(),this._cacheStyle&&(this._cacheStyle.renderTexture=null),this._cacheStyle&&this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(t)}_needRepaint(){return!!(this._repaint&ie.REPAINT_CACHE)}_childChanged(t=null){super._childChanged(t),this._children.length?this._renderType|=ie.CHILDS:this._renderType&=~ie.CHILDS,t&&this._getBit(kt.HAS_ZORDER)&&e.systemTimer.callLater(this,this.updateZOrder),this.repaint(ie.REPAINT_ALL)}parentRepaint(t=ie.REPAINT_CACHE){var e=this._parent;!e||e._repaint&t||(e._repaint|=t,e.parentRepaint(t))}get stage(){return e.stage}get hitArea(){return this._style.hitArea}set hitArea(t){this.getStyle().hitArea=t}_setMask(t){}get mask(){return this._cacheStyle.mask}set mask(t){t==this||t&&this.mask==t&&t._cacheStyle.maskParent==this||(this.mask&&(this.mask._getCacheStyle().maskParent=null),this._getCacheStyle().mask=t,this._setMask(t),t?(t._getCacheStyle().maskParent=this,this._renderType|=ie.MASK):this._renderType&=~ie.MASK,this.repaint())}get mouseEnabled(){return this._mouseState>1}set mouseEnabled(t){this._mouseState=t?2:1}startDrag(t=null,e=!1,r=0,i=300,s=null,a=.92){this._style.dragging||(this.getStyle().dragging=new Es),this._style.dragging.start(this,t,e,r,i,s,a)}stopDrag(){this._style.dragging&&this._style.dragging.stop()}_setDisplay(t){this._getCacheStyle(),t||this._cacheStyle.onInvisible(),super._setDisplay(t)}hitTestPoint(t,e){var r=this.globalToLocal(i.TEMP.setTo(t,e));return t=r.x,e=r.y,(this._style.hitArea?this._style.hitArea:this._isWidthSet&&this._isHeightSet?F.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(t,e,this)}getMousePoint(){return this.globalToLocal(i.TEMP.setTo(e.stage.mouseX,e.stage.mouseY))}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get zOrder(){return this._zOrder}set zOrder(t){this._zOrder!=t&&(this._zOrder=t,this._parent&&(t&&this._parent._setBit(kt.HAS_ZORDER,!0),e.systemTimer.callLater(this._parent,this.updateZOrder)))}get texture(){return this._texture}_setTexture(t){}set texture(t){"string"==typeof t?this.loadImage(t):this._texture!=t&&(this._texture&&this._texture._removeReference(),this._texture=t,t&&t._addReference(),this._setTexture(t),this._setWidth(this.width),this._setHeight(this.height),t?this._renderType|=ie.TEXTURE:this._renderType&=~ie.TEXTURE,this.repaint())}_setTranformChange(){this._tfChanged=!0,this._renderType|=ie.TRANSFORM,this.parentRepaint(ie.REPAINT_CACHE)}set drawCallOptimize(t){this._setBit(kt.DRAWCALL_OPTIMIZE,t)}get drawCallOptimize(){return this._getBit(kt.DRAWCALL_OPTIMIZE)}onAfterDeserialize(){super.onAfterDeserialize(),n.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters))}get cacheGlobal(){return this._cacheGlobal}set cacheGlobal(t){if(this._cacheGlobal!=t)if(this._cacheGlobal=t,t){if(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Position_X,!0),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Position_Y,!0),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Scale_X,!0),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Scale_Y,!0),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Rotation,!0),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent==e.stage||!this._parent)return;this._parent.cacheGlobal=t}else this._children.forEach((e=>{e.cacheGlobal=t}))}getGlobalMatrix(){return null==this._globalMatrix&&(this._globalMatrix=G.create()),this._getGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix)&&(this._globalMatrix.identity(),this._globalMatrix.translate(-this.pivotX,-this.pivotY),this._globalMatrix.scale(this.globalScaleX,this.globalScaleY),this._globalMatrix.rotate(P.toRadian(this.globalRotation)),this._globalMatrix.translate(this.globalPosX,this.globalPosY),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!1)),this._globalMatrix}set globalPosX(t){this.setGlobalPos(t,this._globalPosy)}setGlobalPos(t,e){if(t!=this.globalPosX||e!=this.globalPosY)if(this._cacheGlobal){let r=this.parent.getGlobalMatrix().invertTransformPoint(i.TEMP.setTo(t,e));this._setX(r.x),this._setY(r.y),this._globalPosx=t,this._globalPosy=e;let s=Ds.Sprite_GlobalDeltaFlage_Position_X|Ds.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(s,!1),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(s|Ds.Sprite_GlobalDeltaFlage_Matrix,!0)}else{i.TEMP.setTo(t,e);let r=this.globalToLocal(i.TEMP,!1,null);r=this.toParentPoint(r),this.x=r.x,this.y=r.y}}get globalPosX(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix|Ds.Sprite_GlobalDeltaFlage_Position_X)){this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Position_X,!1);let t=this.parent.getGlobalMatrix(),e=this.toParentPoint(i.TEMP.setTo(this.pivotX,this.pivotY));e=t.transformPoint(e),this._globalPosx=e.x,this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosx}return this.localToGlobal(i.TEMP.setTo(0,0),!1,null).x}get globalPosY(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix|Ds.Sprite_GlobalDeltaFlage_Position_Y)){this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Position_Y,!1);let t=this.parent.getGlobalMatrix(),e=this.toParentPoint(i.TEMP.setTo(this.pivotX,this.pivotY));e=t.transformPoint(e),this._globalPosy=e.y,this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosy}return this.localToGlobal(i.TEMP.setTo(0,0),!1,null).y}set globalPosY(t){this.setGlobalPos(this._globalPosx,t)}get globalRotation(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Rotation)&&(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Rotation,!1),this._parent!=e.stage&&this._parent?this._globalRotate=this.rotation+this.parent.globalRotation:this._globalRotate=this.rotation),this._globalRotate;for(var t=0,r=this;r&&r!==e.stage;)t+=r.rotation,r=r.parent;return t}set globalRotation(t){t!=this.globalRotation&&(this._parent!=e.stage&&this._parent?(this._setRotation(t-this.parent.globalRotation),this._setTranformChange()):(this._setRotation(t),this._setTranformChange()),this._cacheGlobal&&(this._globalRotate=t,this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Rotation,!1),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0)))}get globalScaleX(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Scale_X)&&(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Scale_X,!1),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=e.stage&&this._parent?this._globalScalex=this.scaleX*this.parent.globalScaleX:this._globalScalex=this.scaleX,this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScalex;for(var t=1,r=this;r&&r!==e.stage;)t*=r.scaleX,r=r.parent;return t}get globalScaleY(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Scale_Y)&&(this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Scale_Y,!1),this._setGlobalCacheFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=e.stage&&this._parent?this._globalScaley=this.scaleY*this.parent.globalScaleY:this._globalScaley=this.scaleY,this._syncGlobalFlag(Ds.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScaley;for(var t=1,r=this;r&&r!==e.stage;)t*=r.scaleY,r=r.parent;return t}_getGlobalCacheFlag(t){return!!(this._globalDeltaFlages&t)}_getGlobalCacheLocalToGlobal(t,e){return this._cacheGlobal?this.getGlobalMatrix().transformPoint(i.TEMP.setTo(this.pivotX+t,this.pivotY+e)):this.localToGlobal(i.TEMP.setTo(t,e),!1,null)}_getGlobalCacheGlobalToLocal(t,e){if(this._cacheGlobal){let r=this.getGlobalMatrix().invertTransformPoint(i.TEMP.setTo(t,e));return r.x-=this.pivotX,r.y-=this.pivotY,r}return this.globalToLocal(i.TEMP.setTo(t,e),!1,null)}_setGlobalCacheFlag(t,e){e?this._globalDeltaFlages|=t:this._globalDeltaFlages&=~t,e&&this.event("GlobaChange",t)}get globalDeltaFlages(){return this._globalDeltaFlages}_syncGlobalFlag(t,e){this.cacheGlobal&&this._children.forEach((r=>{r._setGlobalCacheFlag(t,e),r._syncGlobalFlag(t,e)}))}}Ds.Sprite_GlobalDeltaFlage_Position_X=1,Ds.Sprite_GlobalDeltaFlage_Position_Y=2,Ds.Sprite_GlobalDeltaFlage_Rotation=4,Ds.Sprite_GlobalDeltaFlage_Scale_X=8,Ds.Sprite_GlobalDeltaFlage_Scale_Y=16,Ds.Sprite_GlobalDeltaFlage_Matrix=32;class bs extends b{static loadFont(t,r){e.loader.load(t,Bt.FONT).then((t=>{r&&r.runWith(t)}))}constructor(){super(!1),this.dict={},this.fontSize=12,this.autoScaleSize=!1,this.tint=!0,this.maxWidth=0,this.lineHeight=12,this.letterSpacing=0}parseFont(t,e){var r;if(null==t||null==e)return;this.texture=e,e._addReference();let i=t.getNode("info");this.fontSize=i.getAttrInt("size",12),this.autoScaleSize=i.getAttrBool("autoScaleSize"),this.lineHeight=i.getAttrInt("lineHeight",this.fontSize),0==this.lineHeight&&(this.lineHeight=this.fontSize);let s=i.getAttrString("padding","").split(",");this.padding=[parseInt(s[0]),parseInt(s[1]),parseInt(s[2]),parseInt(s[3])];let a=(null===(r=t.getNode("chars"))||void 0===r?void 0:r.elements("char"))||[],n=0,l=this.dict;for(let t=0,r=a.length;t<r;t++){let r=a[t],i=r.getAttrInt("id"),s=r.getAttrInt("xoffset")/1,o=r.getAttrInt("yoffset")/1,h=r.getAttrInt("xadvance")/1,u=r.getAttrInt("x"),d=r.getAttrInt("y"),c=r.getAttrInt("width"),_=r.getAttrInt("height"),p=mt.create(e,u,d,c,_,s,o);0==h&&(h=c),h+=this.letterSpacing,n=Math.max(n,h),l[i]={x:0,y:0,width:c,height:_,advance:h,texture:p}}this.maxWidth=n>0?n:this.fontSize,l[32]||(l[32]={x:0,y:0,advance:Math.floor(.5*this.fontSize)+this.letterSpacing})}_disposeResource(){var t;if(this.texture){for(let e in this.dict)null===(t=this.dict[e].texture)||void 0===t||t.destroy();this.texture._removeReference(),this.dict=null,this.texture=null,this.padding=null}}getTextWidth(t,e){let r=0;for(let i=0,s=t.length;i<s;i++){let s=this.dict[t.charCodeAt(i)];if(s){let t=this.autoScaleSize?e/this.fontSize:1;r+=Math.round(s.advance*t)}}return r}getMaxWidth(t){return null!=t&&this.autoScaleSize?Math.round(this.maxWidth*(t/this.fontSize)):this.maxWidth}getMaxHeight(t){return null!=t&&this.autoScaleSize?Math.round(this.lineHeight*(t/this.fontSize)):this.lineHeight}}class Rs{constructor(){this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.strikethrough=!1,this.strikethroughColor=null,this.align="left",this.valign="top",this.leading=2,this.stroke=0,this.strokeColor="#000000",this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.align="left",this.valign="top",this.alignItems="middle",this.leading=2,this.stroke=0,this.strokeColor="#000000"}}var Cs;t.HtmlElementType=void 0,(Cs=t.HtmlElementType||(t.HtmlElementType={}))[Cs.Text=0]="Text",Cs[Cs.Link=1]="Link",Cs[Cs.Image=2]="Image",Cs[Cs.Input=3]="Input",Cs[Cs.Select=4]="Select",Cs[Cs.Object=5]="Object",Cs[Cs.LinkEnd=6]="LinkEnd";class As{constructor(){this.style=new Rs}getAttr(t){return null==this._attrs?null:this._attrs[t]}setAttr(t,e){null==this._attrs&&(this._attrs={}),this._attrs[t]=e}getAttrString(t,e){return wt.getString(this._attrs,t,e)}getAttrInt(t,e){return wt.getInt(this._attrs,t,e)}getAttrFloat(t,e){return wt.getFloat(this._attrs,t,e)}getAttrBool(t,e){return wt.getBool(this._attrs,t,e)}fetchAttributes(){this._attrs=Object.assign({},bt.attributes)}reset(){this.name=null,this.text=null,this.obj&&(this.obj.release(),r.recoverByClass(this.obj),this.obj=null),this._attrs=null}static getFromPool(e){let r;return r=this.pool.length>0?this.pool.pop():new As,r.type=e,r.type==t.HtmlElementType.Text||r._attrs||(r._attrs={}),r}static returnToPool(t){if(Array.isArray(t)){for(let e of t)e.reset();this.pool.push(...t),t.length=0}else t.reset(),this.pool.push(t)}}As.pool=[];class Is{constructor(){this._v=0,this.obj=new Ds}get element(){return this._element}get width(){return this.obj.width}get height(){return this.obj.height}create(t,e){this._owner=t,this._element=e,this._owner.objContainer.addChild(this.obj);let r=this._element.getAttrString("src");r&&this.loadTexture(r)}loadTexture(t){let r=this._element.getAttrInt("width",-1),i=this._element.getAttrInt("height",-1);-1!=r&&(this.obj.width=r),-1!=i&&(this.obj.height=i);let s=Bt.getRes(t);if(s)this.obj.texture=s,-1==r&&(this.obj.width=s.sourceWidth),-1==i&&(this.obj.height=s.sourceHeight);else{let s=this._v;e.loader.load(t,{silent:!0}).then((t=>{if(this.obj.destroyed||s!=this._v)return;let e=this.obj.width,a=this.obj.height;this.obj.texture=t,-1==r&&(this.obj.width=t?t.sourceWidth:0),-1==i&&(this.obj.height=t?t.sourceHeight:0),!this._owner||e==this.obj.width&&a==this.obj.height||this._owner.refreshLayout()}))}}pos(t,e){this.obj.pos(t,e)}release(){this.obj.removeSelf(),this.obj.offAll(),this.obj.texture=null,this._owner=null,this._element=null,this._v++}destroy(){this.obj.destroy()}}class Ms{constructor(){this._shape=new Ds,this._shape.hitArea=this,this._shape.on(s.CLICK,(()=>{this._owner.bubbleEvent(s.LINK,this._element.getAttrString("href"))})),this._rects=[],this._rectCnt=0}get element(){return this._element}get width(){return 0}get height(){return 0}create(t,e){this._owner=t,this._element=e,this._owner.objContainer.addChild(this._shape)}resetArea(){this._rectCnt=0}addRect(t,e,r,i){let s=this._rects[this._rectCnt];s||(s=this._rects[this._rectCnt]=new F),this._rectCnt++,s.setTo(t,e,r,i)}contains(t,e){for(let r=0;r<this._rectCnt;r++)if(this._rects[r].contains(t,e))return!0;return!1}pos(t,e){}release(){this._shape.removeSelf(),this._owner=null,this._element=null}destroy(){this._shape.destroy()}}class Bs{constructor(){this.linkUnderline=Bs.defaultLinkUnderline,this.linkColor=Bs.defaultLinkColor}}Bs.defaultLinkUnderline=!0,Bs.defaultLinkColor=null,Ot.regClass("HtmlParseOptions",Bs);const Ls=new Array,Ps=new Array;class Ns{constructor(){this._styleStack=new Array,this._style=new Rs,this._options=new Bs}parse(e,r,i,s){null==s&&(s=this._options),this._elements=i,this._styleStackTop=0,Object.assign(this._style,r),this._style.colorChanged=!1;let a,n=0,l=s.ignoreWhiteSpace,o=!1;for(bt.begin(e,!0);bt.nextTag();)switch(0==n&&(a=bt.getText(l),a.length>0&&(o&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),o=!1,bt.tagName){case"b":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.bold=!0):this.popStyle();break;case"i":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.italic=!0):this.popStyle();break;case"u":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.underline=!0):this.popStyle();break;case"strike":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.strikethrough=!0):this.popStyle();break;case"font":if(bt.tagType==t.XMLTagType.Start){this.pushStyle(),this._style.fontSize=wt.getInt(bt.attributes,"size",this._style.fontSize);let t=bt.getAttribute("color");null!=t&&(this._style.color=t,this._style.colorChanged=!0)}else bt.tagType==t.XMLTagType.End&&this.popStyle();break;case"br":this.appendText("\n");break;case"img":if(bt.tagType==t.XMLTagType.Start||bt.tagType==t.XMLTagType.Void){let e=As.getFromPool(t.HtmlElementType.Image);e.fetchAttributes(),e.name=e.getAttrString("name"),e.style.align=this._style.align,e.style.underline=this._style.underline,e.style.underlineColor=this._style.underlineColor,this._elements.push(e)}break;case"a":if(bt.tagType==t.XMLTagType.Start){this.pushStyle(),this._style.underline=this._style.underline||s.linkUnderline,this._style.colorChanged||null==s.linkColor||(this._style.color=s.linkColor);let e=As.getFromPool(t.HtmlElementType.Link);e.fetchAttributes(),e.name=e.getAttrString("name"),e.style.align=this._style.align,this._elements.push(e)}else if(bt.tagType==t.XMLTagType.End){this.popStyle();let e=As.getFromPool(t.HtmlElementType.LinkEnd);this._elements.push(e)}break;case"input":{let e=As.getFromPool(t.HtmlElementType.Input);e.fetchAttributes(),e.name=e.getAttrString("name"),Object.assign(e.style,this._style),this._elements.push(e)}break;case"select":if(bt.tagType==t.XMLTagType.Start||bt.tagType==t.XMLTagType.Void){let e=As.getFromPool(t.HtmlElementType.Select);if(e.fetchAttributes(),bt.tagType==t.XMLTagType.Start){for(Ls.length=0,Ps.length=0;bt.nextTag()&&"select"!=bt.tagName;)"option"==bt.tagName&&(bt.tagType==t.XMLTagType.Start||bt.tagType==t.XMLTagType.Void?Ps.push(wt.getString(bt.attributes,"value","")):Ls.push(bt.getText()));e.setAttr("items",Ls.slice()),e.setAttr("values",Ps.slice())}e.name=e.getAttrString("name"),Object.assign(e.style,this._style),this._elements.push(e)}break;case"p":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.align=bt.getAttribute("align"),this.isNewLine()||this.appendText("\n")):bt.tagType==t.XMLTagType.End&&(this.appendText("\n"),o=!0,this.popStyle());break;case"ui":case"div":case"li":bt.tagType==t.XMLTagType.Start?this.isNewLine()||this.appendText("\n"):(this.appendText("\n"),o=!0);break;case"html":case"body":l=!0;break;case"head":case"style":case"script":case"form":bt.tagType==t.XMLTagType.Start?n++:bt.tagType==t.XMLTagType.End&&n--}0==n&&(a=bt.getText(l),a.length>0&&(o&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),this._elements=null}pushStyle(){let t;this._styleStack.length<=this._styleStackTop?(t=new Rs,this._styleStack.push(t)):t=this._styleStack[this._styleStackTop],Object.assign(t,this._style),this._styleStackTop++}popStyle(){if(this._styleStackTop>0){let t=this._styleStack[this._styleStackTop-1];Object.assign(this._style,t),this._styleStackTop--}}isNewLine(){if(this._elements.length>0){let e=this._elements[this._elements.length-1];return!(!e||e.type!=t.HtmlElementType.Text)&&e.text.endsWith("\n")}return!0}appendText(e){let r;this._elements.length>0&&(r=this._elements[this._elements.length-1],r.type==t.HtmlElementType.Text&&function(t,e){for(let r in t)if(!r.startsWith("_")&&t[r]!=e[r])return!1;return!0}(r.style,this._style))?r.text+=e:(r=As.getFromPool(t.HtmlElementType.Text),r.text=e,Object.assign(r.style,this._style),this._elements.push(r))}}Ns.defaultParser=new Ns,Ns.classMap={[t.HtmlElementType.Image]:Is,[t.HtmlElementType.Link]:Ms};class Os{constructor(){this._readPos=0,this.defaultImgWidth=0,this.defaultImgHeight=0,this._handlers={},this._handlers.url=this.onTag_URL,this._handlers.img=this.onTag_IMG,this._handlers.b=this.onTag_B,this._handlers.i=this.onTag_I,this._handlers.u=this.onTag_U,this._handlers.sup=this.onTag_Simple,this._handlers.sub=this.onTag_Simple,this._handlers.color=this.onTag_COLOR,this._handlers.font=this.onTag_FONT,this._handlers.size=this.onTag_SIZE}onTag_URL(t,e,r){return e?"</a>":null!=r?'<a href="'+r+'">':'<a href="'+this.getTagText()+'">'}onTag_IMG(t,e,r){if(e)return null;var i=this.getTagText(!0);return i?this.defaultImgWidth?'<img src="'+i+'" width="'+this.defaultImgWidth+'" height="'+this.defaultImgHeight+'"/>':'<img src="'+i+'"/>':null}onTag_B(t,e,r){return e?"</b>":"<b>"}onTag_I(t,e,r){return e?"</i>":"<i>"}onTag_U(t,e,r){return e?"</u>":"<u>"}onTag_Simple(t,e,r){return e?"</"+t+">":"<"+t+">"}onTag_COLOR(t,e,r){return e?"</font>":(this.lastColor=r,'<font color="'+r+'">')}onTag_FONT(t,e,r){return e?"</font>":'<font face="'+r+'">'}onTag_SIZE(t,e,r){return e?"</font>":(this.lastSize=r,'<font size="'+r+'">')}getTagText(t){for(var e,r=this._readPos,i="";-1!=(e=this._text.indexOf("[",r));){if(92!=this._text.charCodeAt(e-1)){i+=this._text.substring(r,e);break}i+=this._text.substring(r,e-1),i+="[",r=e+1}return-1==e?null:(t&&(this._readPos=e),i)}parse(t,e){this._text=t,this.lastColor=null,this.lastSize=null;for(var r,i,s,a,n,l,o,h=0,u="";-1!=(r=t.indexOf("[",h));)if(r>0&&92==t.charCodeAt(r-1))u+=t.substring(h,r-1),u+="[",h=r+1;else{if(u+=t.substring(h,r),h=r,-1==(r=t.indexOf("]",h)))break;s="/"==t.charAt(h+1),a=t.substring(s?h+2:h+1,r),this._readPos=r+1,n=null,l=null,-1!=(i=a.indexOf("="))&&(n=a.substring(i+1),a=a.substring(0,i)),a=a.toLowerCase(),null!=(o=this._handlers[a])?e||null!=(l=o.call(this,a,s,n))&&(u+=l):u+=t.substring(h,this._readPos),h=this._readPos}return h<t.length&&(u+=t.substring(h)),this._text=null,u}}Os.defaultParser=new Os;class Fs extends Ds{constructor(){super(),this._overflow=Fs.VISIBLE,this._singleCharRender=!1,this._prompt="",this._textWidth=0,this._textHeight=0,this._textStyle=new Rs,this._textStyle.fontSize=f.defaultFontSize,this._text="",this.font="",this._elements=[],this._lines=[],this._padding=[0,0,0,0],this._fontSizeScale=1}static registerBitmapFont(t,e){e._addReference(),Fs._bitmapFonts[t]=e}static unregisterBitmapFont(t,e=!0){let r=Fs._bitmapFonts[t];r&&(r._removeReference(),e&&r.destroy(),delete Fs._bitmapFonts[t])}destroy(t=!0){Gs(this._lines),As.returnToPool(this._elements),super.destroy(t)}_getBoundPointsM(t=!1){var e=F.TEMP;return e.setTo(0,0,this.width,this.height),e._getBoundPoints()}getGraphicBounds(t=!1){var e=F.TEMP;return e.setTo(0,0,this.width,this.height),e}get_width(){return this._isWidthSet?this._width:this.textWidth}_setWidth(t){super._setWidth(t),this._updatingLayout?this.drawBg():this.markChanged()}get_height(){return this._isHeightSet?this._height:this.textHeight}_setHeight(t){super._setHeight(t),this._updatingLayout?this.drawBg():this.markChanged()}get textWidth(){return this.typeset(),this._textWidth}get textHeight(){return this.typeset(),this._textHeight}get text(){return this._text}set text(t){null==t?t="":"string"!=typeof t&&(t=""+t),!this.ignoreLang&&Fs.langPacks&&(t=Fs.langPacks[t]||t),this._text!=t&&(this._text=t,this.markChanged(),this.event(s.CHANGE))}changeText(t){this.text=t}get font(){return this._textStyle.font}set font(t){if(this._textStyle.font=t,t||(t=f.defaultFont)||(t="Arial"),this._realFont=t,this._bitmapFont=Fs._bitmapFonts[t],this._bitmapFont)this._text&&this.markChanged();else if(t&&(P.getFileExtension(t)||t.startsWith("res://"))){let r=t,i=e.loader.getRes(t);!i||i.obsolute?e.loader.load(t).then((t=>{t&&this._realFont==r&&(t instanceof bs?this._bitmapFont=t:this._realFont=t.family,this._text&&this.markChanged())})):(i instanceof bs?this._bitmapFont=i:this._realFont=i.family,this._text&&this.markChanged())}else this._realFont=A.onIPhone&&f.fontFamilyMap[t]||t,this._text&&this.markChanged()}get fontSize(){return this._textStyle.fontSize}set fontSize(t){this._textStyle.fontSize!=t&&(this._textStyle.fontSize=t,this.markChanged())}get color(){return this._textStyle.color}set color(t){this.set_color(t)}set_color(t){this._textStyle.color!=t&&(this._textStyle.color=t,!this._isChanged&&this._graphics&&0==this._elements.length?this._graphics.replaceTextColor(this._textStyle.color):this.markChanged())}get bold(){return this._textStyle.bold}set bold(t){this._textStyle.bold!=t&&(this._textStyle.bold=t,this.markChanged())}get italic(){return this._textStyle.italic}set italic(t){this._textStyle.italic!=t&&(this._textStyle.italic=t,this.markChanged())}get align(){return this._textStyle.align}set align(t){this._textStyle.align!=t&&(this._textStyle.align=t,this.markChanged())}get valign(){return this._textStyle.valign}set valign(t){this._textStyle.valign!=t&&(this._textStyle.valign=t,this.markChanged())}get alignItems(){return this._textStyle.alignItems}set alignItems(t){this._textStyle.alignItems!=t&&(this._textStyle.alignItems=t,this.markChanged())}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap!=t&&(this._wordWrap=t,this.markChanged())}get leading(){return this._textStyle.leading}set leading(t){this._textStyle.leading!=t&&(this._textStyle.leading=t,this.markChanged())}get padding(){return this._padding}set padding(t){if("string"==typeof t){let e=t.split(",");this._padding.length=0;for(let t=0;t<4;t++){let r=parseFloat(e[t]);isNaN(r)&&(r=0),this._padding.push(r)}}else this._padding=t;this.markChanged()}get bgColor(){return this._bgColor}set bgColor(t){this._bgColor=t,this.drawBg()}get borderColor(){return this._borderColor}set borderColor(t){this._borderColor=t,this.drawBg()}get stroke(){return this._textStyle.stroke}set stroke(t){this._textStyle.stroke!=t&&(this._textStyle.stroke=t,this.markChanged())}get strokeColor(){return this._textStyle.strokeColor}set strokeColor(t){this._textStyle.strokeColor!=t&&(this._textStyle.strokeColor=t,this.markChanged())}get overflow(){return this._overflow}set overflow(t){this._overflow!=t&&(this._overflow=t,this.markChanged())}get underline(){return this._textStyle.underline}set underline(t){this._textStyle.underline!=t&&(this._textStyle.underline=t,this.markChanged())}get underlineColor(){return this._textStyle.underlineColor}set underlineColor(t){this._textStyle.underlineColor!=t&&(this._textStyle.underlineColor=t,this.markChanged())}get strikethrough(){return this._textStyle.strikethrough}set strikethrough(t){this._textStyle.strikethrough!=t&&(this._textStyle.strikethrough=t,this.markChanged())}get strikethroughColor(){return this._textStyle.strikethroughColor}set strikethroughColor(t){this._textStyle.strikethroughColor!=t&&(this._textStyle.strikethroughColor=t,this.markChanged())}get singleCharRender(){return this._singleCharRender}set singleCharRender(t){this._singleCharRender=t}get html(){return this._html}set html(t){this._html!=t&&(this._html=t,this.markChanged())}get ubb(){return this._ubb}set ubb(t){this._ubb!=t&&(this._ubb=t,this.markChanged())}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth!=t&&(this._maxWidth=t,this.markChanged())}get htmlParseOptions(){return this._htmlParseOptions}set htmlParseOptions(t){this._htmlParseOptions=t}parseTemplate(t){let e,r,i,s,a=0,n="";for(;-1!=(e=t.indexOf("{",a));)if(e>0&&92==t.charCodeAt(e-1))n+=t.substring(a,e-1),n+="{",a=e+1;else{if(n+=t.substring(a,e),a=e,e=t.indexOf("}",a),-1==e)break;e!=a+1?(i=t.substring(a+1,e),r=i.indexOf("="),-1!=r?(s=this._templateVars[i.substring(0,r)],n+=null==s?i.substring(r+1):s):(s=this._templateVars[i],null!=s&&(n+=s)),a=e+1):(n+=t.substring(a,a+2),a=e+1)}return a<t.length&&(n+=t.substring(a)),n}get templateVars(){return this._templateVars}set templateVars(t){(this._templateVars||t)&&(this._templateVars=!0===t?{}:!1===t?null:t,this.markChanged())}setVar(t,e){return this._templateVars||(this._templateVars={}),this._templateVars[t]=e,this.markChanged(),this}get scrollX(){return this._scrollPos?this._scrollPos.x:0}set scrollX(t){if(this.typeset(),!this._scrollPos)return;let e=this.maxScrollX;t=(t=t<0?0:t)>e?e:t,this._scrollPos.x=t,this.renderText()}get scrollY(){return this._scrollPos?this._scrollPos.y:0}set scrollY(t){if(this.typeset(),!this._scrollPos)return;let e=this.maxScrollY;t=(t=t<0?0:t)>e?e:t,this._scrollPos.y=t,this.renderText()}get maxScrollX(){let t=this.textWidth-this._width;return t<0?0:t}get maxScrollY(){let t=this.textHeight-this._height;return t<0?0:t}get lines(){return this.typeset(),this._lines}markChanged(){this._isChanged||(this._isChanged=!0,e.systemTimer.callLater(this,this._typeset))}typeset(){this._isChanged&&e.systemTimer.runCallLater(this,this._typeset)}refreshLayout(){e.systemTimer.callLater(this,this.doLayout)}get objContainer(){return this._objContainer||(this._objContainer=new Ds,this._objContainer.hideFlags|=Gt.HideAndDontSave,this.addChild(this._objContainer)),this._objContainer}_typeset(){if(this._isChanged=!1,this._hideText||this._destroyed)return;As.returnToPool(this._elements),this._objContainer&&this._objContainer.removeChildren();let e,r=this._text;if(!r&&this._prompt&&(r=this._prompt,e=!0),!r)return this.graphics.clear(!0),this.drawBg(),this._textWidth=this._textHeight=0,this._scrollPos=null,void(this._onPostLayout&&(this._updatingLayout=!0,this._onPostLayout(),this._updatingLayout=!1));let i,s=this._html;if(r=r.replace(Ys,"\n"),this._parseEscapeChars&&(r=r.replace(Xs,Ks)),!e&&this._templateVars&&(r=this.parseTemplate(r)),this._ubb&&(r=Os.defaultParser.parse(r),s=!0),!e&&this._asPassword&&(r=Fs._passwordChar.repeat(r.length)),e&&(i=this._textStyle.color,this._textStyle.color=this._promptColor),s)Ns.defaultParser.parse(r,this._textStyle,this._elements,this._htmlParseOptions);else{let e=As.getFromPool(t.HtmlElementType.Text);Object.assign(e.style,this._textStyle),e.text=r,this._elements.push(e)}e&&(this._textStyle.color=i),this.doLayout()}doLayout(){if(this._destroyed)return;this._updatingLayout=!0,this._fontSizeScale=1;let e,s=this._wordWrap||this._overflow==Fs.ELLIPSIS,a=this._padding;if(e=this._isWidthSet?this._width-a[3]-a[1]:Number.MAX_VALUE,this._maxWidth>0){let t=this._maxWidth-a[3]-a[1];(!s||t<e)&&(e=t),s=!0}let n,l,o,h,u,d,c,_,p=this._isHeightSet?this._height-a[0]-a[2]:Number.MAX_VALUE,f=this._bitmapFont,g="middle"==this._textStyle.alignItems?1:"bottom"==this._textStyle.alignItems?2:0,m=t=>{if(f)return f.getTextWidth(t,c);{let e=A.context.measureText(t);return e?e.width:100}},y=(t,e,r)=>{if(f)return f.getTextWidth(t,r);{let r=A.context.font;A.context.font=e;let i=A.context.measureText(t);return A.context.font=r,i?i.width:100}},T=(t,e)=>{if(c=Math.floor(e.fontSize*this._fontSizeScale),0==c&&(c=1),f)u=f.getMaxWidth(c),d=f.getMaxHeight(c);else{A.context.font=_=(e.italic?"italic ":"")+(e.bold?"bold ":"")+c+"px "+this._realFont;let t=A.context.measureText(Fs._testWord);t?(u=t.width,d=Math.ceil(t.height||c)):(u=100,d=c)}let r=t.split("\n");if(s)for(let t=0,i=r.length;t<i;t++){let s=r[t];s.length>0&&w(s,e),t!=i-1&&E()}else for(let t=0,i=r.length;t<i;t++){let s=r[t];s.length>0&&x(s,e,null),t!=i-1&&E()}},x=(t,e,r)=>{let i=Us.length>0?Us.pop():{};i.x=n,i.y=l,"string"==typeof t?(r||(r=m(t)),i.wt||(i.wt=new Qr),i.wt.setText(t),i.wt.width=r,i.wt.splitRender=this._singleCharRender,i.ctxFont=_,i.fontSize=c,i.width=r,i.height=d):(i.obj=t,i.width=t.width,i.height=t.height,t.width>0&&(i.x++,i.width+=2)),i.style=e,i.linkEnd=!1,i.next=null,i.prev=h,n+=Math.round(i.width),h?h.next=i:o.cmd=i,h=i},v=t=>{for(;t.linkEnd;)t=t.next;if(t)for(t.prev.next=null;t;){let e=t.next;t.x=n,t.y=l,t.next=null,t.prev=h,n+=Math.round(t.width),h?h.next=t:o.cmd=t,h=t,t=e}},S=(t,e)=>{if(Zs(t.wt.text.charCodeAt(e))&&e--,0==e)return!1;let r=t.wt.text.substring(e);t.wt.setText(t.wt.text.substring(0,e)),t.width=t.wt.width=y(t.wt.text,t.ctxFont,t.fontSize);let i=Us.length>0?Us.pop():{};return i.wt||(i.wt=new Qr),i.wt.setText(r),i.style=t.style,i.ctxFont=t.ctxFont,i.fontSize=t.fontSize,i.width=i.wt.width=y(r,t.ctxFont,t.fontSize),i.height=t.height,i.next=t.next,i.prev=t,t.next=i,!0},E=t=>{if(n=0,o){let t=0,e=0,r=o.cmd;for(;r;)r.height>t&&(t=r.height),e+=r.width,r=r.next;for(r=o.cmd;r;)r.y=1==g?Math.floor(.5*(t-r.height)):2==g?Math.floor(t-r.height):0,r=r.next;0==t&&(t=d),t++,o.height=t,o.width=Math.round(e),l+=o.height+Math.floor(this._textStyle.leading*this._fontSizeScale)}return t?null:(o=ks.length>0?ks.pop():{},o.x=0,o.y=l,this._lines.push(o),h=null,o)},w=(t,r)=>{let i=Math.max(0,e-n),s=m(t);if(s<=i)return void x(t,r,s);let a,l,o=0,d=0,c=0,_=Hs.test(t);f||_||(o=Math.floor(i/u),0!=o&&(d=m(t.substring(0,o))));let p=t.length;for(let u=o;u<p;u++){let f=t.charAt(u),g=f.charCodeAt(0);if(_&&Qs(g)&&u+1<p&&(f+=t.charAt(u+1)),s=m(f),d+=s,d<i||u===c&&0===n){f.length>1&&u++;continue}let y=t.substring(c,u);if(d-=s,g>=65&&g<=90||g>=97&&g<=122||g>=48&&g<=57||(a=Ws.includes(g))){let r=y.length>0?(l=zs.exec(y))?l.index:null:0;if(r>0)r>y.length-$s&&(u=c+r,y=t.substring(c,u),d=null,s=null);else if(null!=r&&null!=h){let t=h,r=y.length,o=!1;for(;t;){if(t.width>0){if(null!=t.obj)break;l=zs.exec(t.wt.text);let e=t.wt.text.length;if(null==l){E(),a&&0==r?S(t,e-1)?v(t.next):t.x>0&&v(t):null!=t.next&&v(t.next),o=!0;break}if(l.index>0){l.index>e-($s-r)&&(E(),S(t,l.index),v(t.next),o=!0);break}if(r+=e,r>=$s)break}t=t.prev}if(o&&(i=e-n,d+s<i)){d+=s;continue}}else if(a){let e=_&&u>=1&&Zs(t.charCodeAt(u-1))?2:1;(u-e>c||n>0)&&(u-=e,y=t.substring(c,u),d=null,s=null)}}y.length>0&&x(y,r,d),E(),c=u,i=e,d=null,o>1?u+=o-1:null!=s?(d=s,f.length>1&&u++):_&&Qs(t.charCodeAt(u))&&u++,null==d&&u<p-1&&(d=m(t.substring(c,u+1)))}x(t.substring(c,p),r)},D=()=>{let t=0,e=0;for(let e of this._lines)e.width>t&&(t=e.width);t>0&&(t+=a[1]+a[3]),this._textWidth=t;let r=this._lines[this._lines.length-1];r&&(e=r.y+r.height),e>0&&(e+=a[0]+a[2]),this._textHeight=e},b=()=>{n=l=u=d=0,o=null,h=null,Gs(this._lines),E();let i=this._elements;for(let a=0,l=i.length;a<l;a++){let l=i[a];if(l.type==t.HtmlElementType.Text)T(l.text,l.style);else if(l.type==t.HtmlElementType.LinkEnd)h&&(h.linkEnd=!0);else{let t=l.obj;if(!t){let e=Ns.classMap[l.type];e&&(t=r.createByClass(e),t.create(this,l),l.obj=t)}if(t){if(s){let r=e-n;t.width>0&&r<t.width+1&&n>0&&E()}x(t,l.style)}}}E(!0),D()};if(b(),this._overflow==Fs.SHRINK){if(this._lines.length>1&&this._textHeight>p){let t=0,r=this._textStyle.fontSize;this._fontSizeScale=Math.sqrt(p/this._textHeight);let i=Math.floor(this._fontSizeScale*this._textStyle.fontSize);for(;b(),this._textWidth>e||this._textHeight>p?r=i:t=i,r-t>1||r!=t&&i==r;)i=t+(r-t)/2,this._fontSizeScale=i/this._textStyle.fontSize}else if(this._textWidth>e&&(this._fontSizeScale=e/this._textWidth,b(),this._textWidth>e)){let t=Math.floor(this._textStyle.fontSize*this._fontSizeScale);t--,this._fontSizeScale=t/this._textStyle.fontSize,b()}}else if(this._overflow==Fs.ELLIPSIS&&(this._textWidth>e||this._textHeight>p||!this._wordWrap&&this._lines.length>1)){let t;!this._wordWrap&&this._lines.length>1?t=1:(t=this._lines.findIndex((t=>t.y+t.height>p)),0==t&&(t=1));let r=!1;-1!=t&&this._lines.length>t&&(Gs(this._lines.splice(t,this._lines.length-t),!0),r=!0),o=this._lines[this._lines.length-1];let i,s,a=o.cmd,n=!1;for(;a;){if(i=a.next,a.obj||(s=a),n)Vs(a,!0),Us.push(a);else if(!i&&r||a.x+a.width>e){if(a.obj)Vs(a,!0),a.wt=new Qr,a.wt.setText(qs),s?(a.ctxFont=s.ctxFont,a.fontSize=s.fontSize,a.height=s.height,a.style=s.style):(a.ctxFont=_,a.fontSize=c,a.height=d,a.style=this._textStyle),a.wt.splitRender=this._singleCharRender;else{let t=a.wt.text.length-2;t>0&&Zs(a.wt.text.charCodeAt(t))&&t--,a.wt.setText(a.wt.text.substring(0,Math.max(0,t))+qs)}a.width=a.wt.width=y(a.wt.text,a.ctxFont,a.fontSize),a.next=null,n=!0,E(!0)}a=i}(n||r)&&D()}this._onPostLayout&&this._onPostLayout();let R="center"==this._textStyle.align?1:"right"==this._textStyle.align?2:0;if(0!=R&&this._isWidthSet){let t=this._width-a[3]-a[1];for(let e of this._lines){let r=0;1==R?r=Math.floor(.5*(t-e.width)):2==R&&(r=t-e.width),r>0&&(e.x=r)}}if(this._isHeightSet&&this._textHeight<this._height){let t=0;if("middle"===this._textStyle.valign?t=Math.floor(.5*(this._height-this._textHeight)):"bottom"===this._textStyle.valign&&(t=this._height-this._textHeight),t>0)for(let e of this._lines)e.y+=t}if(this._overflow==Fs.SCROLL&&(this._isWidthSet&&this._textWidth>this._width||this._isHeightSet&&this._textHeight>this._height))if(this._scrollPos){let t=this.maxScrollX,e=this.maxScrollY;this._scrollPos.x>t&&(this._scrollPos.x=t),this._scrollPos.y>e&&(this._scrollPos.y=e)}else this._scrollPos=new i(0,0);else this._scrollPos=null;this._objContainer&&(this._objContainer.size(this._width,this._height),this._scrollPos||this._overflow==Fs.HIDDEN&&this._objContainer.numChildren>0?(this._objContainer.scrollRect||(this._objContainer.scrollRect=new F),this._objContainer.scrollRect.setTo(0,0,this._width,this._height)):this._objContainer.scrollRect=null),this._updatingLayout=!1,this.renderText()}renderText(){let e=this.graphics;e.clear(!0),this.drawBg();let r=this._padding,i=r[3],s=r[0],a=this._bitmapFont,n=this._scrollPos,l=this._isWidthSet?this._width:this._textWidth,o=this._isHeightSet?this._height:this._textHeight,h=o-r[2],u=this._overflow==Fs.HIDDEN||this._overflow==Fs.SCROLL;u&&(e.save(),e.clipRect(0,0,l,o),this.repaint()),l-=r[3]+r[1],o-=r[0]+r[2];let d,c,_=0,p=0,f=this._lines,g=f.length;for(let r=0;r<g;r++){let o=f[r];_=i+o.x,p=s+o.y,n&&(_-=n.x,p-=n.y);let g=u&&(p+o.height<=s||p>=h),m=o.cmd;for(;m;){if(m.linkEnd&&d&&(d.addRect(c,p,_+m.x+m.width-c,o.height),d=null),m.obj)m.obj.pos(_+m.x,p+m.y),m.obj.element.type==t.HtmlElementType.Link&&(d=m.obj,d.resetArea(),c=_+m.x);else if(!g)if(a){let t=0,r=m.wt.text,i=a.tint?m.style.color:"#FFFFFF",s=Math.floor((a.autoScaleSize?m.style.fontSize:a.fontSize)*this._fontSizeScale)/a.fontSize;for(let n=0,l=r.length;n<l;n++){let l=r.charCodeAt(n),o=a.dict[l];o&&(o.texture&&e.drawImage(o.texture,_+m.x+t+o.x*s,p+m.y+o.y*s,o.width*s,o.height*s,i),t+=Math.round(o.advance*s))}}else m.style.stroke?e.fillBorderText(m.wt,_+m.x,p+m.y,m.ctxFont,m.style.color,null,m.style.stroke,m.style.strokeColor):e.fillText(m.wt,_+m.x,p+m.y,m.ctxFont,m.style.color,null);if(!g&&m.width>0){if(m.style.underline){let t=Math.max(1,m.fontSize/16);e.drawLine(_+m.x,p+o.height-t,_+m.x+m.width,p+o.height-t,m.style.underlineColor||m.style.color,t)}if(m.style.strikethrough){let t=Math.max(1,m.fontSize/16),r=_+m.x,i=p+o.height/2-t|0,s=4;e.drawLine(r-s,i,r+m.width+s,i,m.style.strikethroughColor||m.style.color,t)}}m=m.next}d&&(d.addRect(c,p,l-c+i,o.height),c=i)}u&&e.restore()}drawBg(){let t=this._bgDrawCmd;if(this._bgColor||this._borderColor){t||(t=new Hi,t.x=t.y=0,t.width=t.height=1,t.percent=!0,this._bgDrawCmd=t),t.fillColor=this._bgColor,t.lineColor=this._borderColor,t.lineWidth=this._borderColor?1:0;let e=this.graphics.cmds,r=e.indexOf(t);0!=r&&(-1!=r&&e.splice(r,1),e.unshift(t),this.graphics.cmds=e)}else t&&this.graphics.removeCmd(t)}}Fs.VISIBLE="visible",Fs.SCROLL="scroll",Fs.HIDDEN="hidden",Fs.SHRINK="shrink",Fs.ELLIPSIS="ellipsis",Fs.RightToLeft=!1,Fs._testWord="游",Fs._passwordChar="●",Fs._bitmapFonts={};const Us=[],ks=[];function Gs(t,e){for(let r of t){let t=r.cmd;for(;t;)Vs(t,e),Us.push(t),t=t.next;r.cmd=null}ks.push(...t),t.length=0}function Vs(t,e){t.obj?(e&&(t.obj.element.obj=null,t.obj.release(),r.recoverByClass(t.obj)),t.obj=null):t.wt&&t.wt.cleanCache()}const Hs=/[\uD800-\uDBFF][\uDC00-\uDFFF]/,zs=/[a-zA-Z0-9\!-\+\/_]+$/,Ws=Array.from(".,，。、!！；;”’)）]】}》").map((t=>t.charCodeAt(0))),Ys=/\r\n/g,Xs=/\\(\w)/g,js={"\\n":"\n","\\t":"\t"},qs="…",$s=20;function Ks(t){return js[t]}function Qs(t){return t>=55296&&t<=56319}function Zs(t){return t>=56320&&t<=57343}var Js=!0;const ta=new i,ea=new F,ra=[],ia=[];var sa;class aa{constructor(){this._lastTouchId=0,this._touches=[],this._touchPool=[],this._mouseTouch=new la(this._touches),this._pressKeys=new Set,this._keyEvent=new s,this._keyEvent._touches=this._touches}static get inst(){return sa}static getTouchPos(t){var e;return null==t&&(t=sa._lastTouchId),(null===(e=sa.getTouch(t))||void 0===e?void 0:e.pos)||sa._mouseTouch.pos}static get touchTarget(){return sa._touchTarget}static get touches(){return sa._touches}static get touchCount(){return sa._touches.length}static cancelClick(t){null==t&&(t=sa._lastTouchId);let e=sa.getTouch(t);e&&(e.clickCancelled=!0)}static hasKeyDown(t){return sa._pressKeys.has(t)}static __init__(t,e){let r=sa=new aa;r._stage=t,e.oncontextmenu=()=>!1,e.addEventListener("mousedown",(t=>{A.onIE||t.cancelable&&t.preventDefault(),r.handleMouse(t,0)}),{passive:!1}),e.addEventListener("mouseup",(t=>{t.cancelable&&t.preventDefault(),r.handleMouse(t,1)}),{passive:!1}),e.addEventListener("mousemove",(t=>{t.cancelable&&t.preventDefault(),r.handleMouse(t,2)}),{passive:!1}),e.addEventListener("mouseout",(t=>{r.handleMouse(t,3)}),{passive:!1}),e.addEventListener("touchstart",(t=>{Js||aa.isTextInputting||t.cancelable&&t.preventDefault(),r.handleTouch(t,0)}),{passive:!1}),e.addEventListener("touchend",(t=>{Js||aa.isTextInputting||t.cancelable&&t.preventDefault(),Js=!1,r.handleTouch(t,1)}),{passive:!1}),e.addEventListener("touchmove",(t=>{t.cancelable&&t.preventDefault(),r.handleTouch(t,2)}),{passive:!1}),e.addEventListener("touchcancel",(t=>{t.cancelable&&t.preventDefault(),r.handleTouch(t,3)}),{passive:!1}),e.addEventListener("wheel",(t=>{r.handleMouse(t,4)}),{passive:!1}),e.addEventListener("pointerdown",(t=>{e.setPointerCapture(t.pointerId)})),e.addEventListener("pointerup",(t=>{e.releasePointerCapture(t.pointerId)}),!0);let i=A.document;i.addEventListener("keydown",(t=>{r.handleKeys(t)}),!0),i.addEventListener("keypress",(t=>{r.handleKeys(t)}),!0),i.addEventListener("keyup",(t=>{r.handleKeys(t)}),!0)}handleMouse(t,e){var r,i,a,n,l;this._eventType=e,this._nativeEvent=t,this._lastTouchId=0;let o=A.now();if(null!=this._lastTouchTime&&o-this._lastTouchTime<100)return;let h=this._mouseTouch;ta.setTo(t.pageX||t.clientX,t.pageY||t.clientY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(ta),aa.mouseX=ta.x,aa.mouseY=ta.y;let u=ta.x/this._stage.clientScaleX,d=ta.y/this._stage.clientScaleY;if(h.event.nativeEvent=t,3!=e&&aa.mouseEventsEnabled){h.target=this._touchTarget=this.getNodeUnderPoint(u,d);let t=Math.round(u),e=Math.round(d);if((t!=h.pos.x||e!=h.pos.y)&&(this._stage._mouseMoveTime=o,h.pos.setTo(t,e),h.move(),aa.mouseEventsEnabled)){h.target.bubbleEvent(s.MOUSE_MOVE,h.event);for(let t of h.downTargets)t.event(s.MOUSE_DRAG,h.event)}}else h.target=this._touchTarget=null;if(h.lastRollOver!=h.target&&this.handleRollOver(h),0==e)h.began||(h.begin(),this._touches[0]=h,h.event.button=t.button,h.downButton=t.button,aa.mouseEventsEnabled&&(this.handleFocus(),0==t.button?null===(r=h.target)||void 0===r||r.bubbleEvent(s.MOUSE_DOWN,h.event):null===(i=h.target)||void 0===i||i.bubbleEvent(s.RIGHT_MOUSE_DOWN,h.event)));else if(1==e){if(h.began&&t.button==h.downButton){if(h.end(),this._touches.length=0,h.event.button=t.button,aa.mouseEventsEnabled){if(0==t.button?null===(a=h.target)||void 0===a||a.bubbleEvent(s.MOUSE_UP,h.event):null===(n=h.target)||void 0===n||n.bubbleEvent(s.RIGHT_MOUSE_UP,h.event),h.moved)for(let t of h.downTargets)t.event(s.MOUSE_DRAG_END,h.event);let e=h.clickTest();e&&(0==t.button?(h.event.isDblClick=2==h.clickCount,e.bubbleEvent(s.CLICK,h.event),2==h.clickCount&&e.bubbleEvent(s.DOUBLE_CLICK,h.event),h.event.isDblClick=!1):(h.event.isDblClick=2==h.clickCount,e.bubbleEvent(s.RIGHT_CLICK,h.event),h.event.isDblClick=!1))}h.event.button=0}}else 4==e&&aa.mouseEventsEnabled&&(h.event.delta=.025*t.deltaY,null===(l=h.target)||void 0===l||l.bubbleEvent(s.MOUSE_WHEEL,h.event),h.event.delta=0)}handleTouch(t,e){var r,i;this._eventType=e,this._nativeEvent=t,this._lastTouchTime=A.now();let a=t.changedTouches;for(let n=0;n<a.length;++n){let l=a[n];if(!aa.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=l.identifier)continue;ta.setTo(l.pageX,l.pageY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(ta),aa.mouseX=ta.x,aa.mouseY=ta.y;let o=ta.x/this._stage.clientScaleX,h=ta.y/this._stage.clientScaleY,u=this.getTouch(l.identifier,0==e);if(u){if(u.event.nativeEvent=t,u.event.touchId=u.touchId,this._lastTouchId=u.touchId,3!=e&&aa.mouseEventsEnabled){u.target=this._touchTarget=this.getNodeUnderPoint(o,h),this._stage._mouseMoveTime=this._lastTouchTime;let t=Math.round(o),r=Math.round(h);if((Math.abs(t-u.pos.x)>1.5||Math.abs(r-u.pos.y)>1.5)&&(u.pos.setTo(t,r),2==e&&(u.move(),aa.mouseEventsEnabled))){u.target.bubbleEvent(s.MOUSE_MOVE,u.event);for(let t of u.downTargets)t.event(s.MOUSE_DRAG,u.event)}}else u.target=this._touchTarget=null;if(u.lastRollOver!=u.target&&this.handleRollOver(u),0==e)u.began||(u.begin(),aa.mouseEventsEnabled&&(this.handleFocus(),null===(r=u.target)||void 0===r||r.bubbleEvent(s.MOUSE_DOWN,u.event)));else if(1==e||3==e){if(u.began){if(u.end(),aa.mouseEventsEnabled){if(null===(i=u.target)||void 0===i||i.bubbleEvent(s.MOUSE_UP,u.event),u.moved)for(let t of u.downTargets)t.event(s.MOUSE_DRAG_END,u.event);if(3!=e){let t=u.clickTest();null!=t&&(u.event.isDblClick=2==u.clickCount,t.bubbleEvent(s.CLICK,u.event),2==u.clickCount&&t.bubbleEvent(s.DOUBLE_CLICK,u.event),u.event.isDblClick=!1)}}u.target=null,this.handleRollOver(u)}u.reset(),this._touches.splice(this._touches.indexOf(u),1),this._touchPool.push(u)}}}}getTouch(t,e){let r=this._touches.find((e=>e.touchId==t));return r||!e||(r=this._touchPool.length>0?this._touchPool.pop():new la(this._touches),r.touchId=t,this._touches.push(r)),r}handleFocus(){if(aa.isTextInputting&&this._stage.focus&&this._stage.focus.focus&&!this._stage.focus.contains(this._touchTarget)){let t=this._stage.focus._tf||this._stage.focus,e=this._touchTarget._tf||this._touchTarget;e.nativeInput&&e.multiline==t.multiline?t._focusOut():t.focus=!1}}handleKeys(t){let e=t.type,r=t.keyCode;if("keydown"===e?(0!=r&&this._pressKeys.add(r),this._pressKeys.add(t.key)):"keyup"===e&&(0!=r&&this._pressKeys.delete(r),this._pressKeys.delete(t.key)),this._keyEvent.nativeEvent=t,aa.keyEventsEnabled){let t=this._stage.focus&&null!=this._stage.focus.event&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,r=t;for(;r;)r.event(e,this._keyEvent.setTo(e,r,t)),r=r._parent}this._keyEvent.nativeEvent=null}getNodeUnderPoint(t,e){let r=this.getSpriteUnderPoint(this._stage,t,e);return r||(r=this.getSprite3DUnderPoint(t,e)),r||this._stage}getSpriteUnderPoint(t,e,r){let i=t._style.scrollRect;if(i&&!t._getBit(kt.DISABLE_INNER_CLIPPING)&&(ea.setTo(i.x,i.y,i.width,i.height),!ea.contains(e,r)))return null;let s=t._getBit(kt.EDITING_NODE);if(!s&&t.hitTestPrior&&!t.mouseThrough&&t!=this._stage&&!this.hitTest(t,e,r))return null;for(let i=t._children.length-1;i>-1;i--){let a=t._children[i],n=s||a._getBit(kt.EDITING_NODE);if(!a._destroyed&&(n?(!a.hasHideFlag(Gt.HideInHierarchy)||a.mouseThrough)&&!a._getBit(kt.HIDE_BY_EDITOR):a._mouseState>1)&&(a._visible||a._getBit(kt.DISABLE_VISIBILITY))){ta.setTo(e,r),a.fromParentPoint(ta);let t=this.getSpriteUnderPoint(a,ta.x,ta.y);if(t)return t}}if(s){if(!t._getBit(kt.LOCK_BY_EDITOR)&&!t.hasHideFlag(Gt.HideInHierarchy)&&this.hitTest(t,e,r,s))return t}else if(t!=this._stage&&(t.hitTestPrior&&!t.mouseThrough||this.hitTest(t,e,r)))return t;return null}getSprite3DUnderPoint(t,e){return null}hitTest(t,e,r,i){let s=!1;t.scrollRect&&(e-=t._style.scrollRect.x,r-=t._style.scrollRect.y);let a=t._style.hitArea,n=t.mouseThrough;return i&&(a=null,n=!1),a?a.contains(e,r,t):((t.width>0&&t.height>0||n||a)&&(s=n?t.getGraphicBounds().contains(e,r):(a||ea.setTo(0,0,t.width,t.height)).contains(e,r,t)),s)}handleRollOver(t){if(!aa.mouseEventsEnabled)return void(t.lastRollOver=t.target);ra.length=0,ia.length=0;let e=t.lastRollOver;for(;e;)ia.push(e),e=e._parent;for(t.lastRollOver=t.target,e=t.target;e;){let t=ia.indexOf(e);if(-1!=t){ia.splice(t,ia.length-t);break}ra.push(e),e=e._parent}let r=ia.length;if(r>0){for(let i=0;i<r;i++)e=ia[i],e._destroyed||e.event(s.MOUSE_OUT,t.event.setTo(s.MOUSE_OUT,e,e));ia.length=0}if(r=ra.length,r>0){for(let i=0;i<r;i++)e=ra[i],e.activeInHierarchy&&e.event(s.MOUSE_OVER,t.event.setTo(s.MOUSE_OVER,e,e));ra.length=0}}}aa.multiTouchEnabled=!0,aa.mouseEventsEnabled=!0,aa.keyEventsEnabled=!0,aa.clickTestThreshold=10,aa.mouseX=0,aa.mouseY=0,aa.isTextInputting=!1,aa.isiOSWKwebView=!1;const na={};class la{constructor(t){this.downPos=new i,this.downTargets=[],this.event=new s,this.event._touches=t,this.pos=this.event.touchPos,this.touchId=0,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let t=this.target;for(;t;)this.downTargets.push(t),t=t._parent}}move(){this.moved=!0,(Math.abs(this.pos.x-this.downPos.x)>aa.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>aa.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let t=performance.now(),e=na[this.touchId];e||(e={pos:new i,time:0,button:0},na[this.touchId]=e),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>aa.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>aa.clickTestThreshold?(this.clickCancelled=!0,e.time=0,this.clickCount=1):(t-e.time<350&&Math.abs(this.pos.x-e.pos.x)<aa.clickTestThreshold&&Math.abs(this.pos.y-e.pos.y)<aa.clickTestThreshold&&e.button==this.event.button?this.clickCount=2:this.clickCount=1,e.time=t,e.pos.copy(this.pos),e.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let t=this.downTargets[0];if(t.activeInHierarchy)return this.downTargets.length=0,t;for(t=this.target;t;){if(-1!=this.downTargets.indexOf(t)&&t.activeInHierarchy)break;t=t._parent}return this.downTargets.length=0,t}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1,this.downButton=0}}class oa extends R{static get defaultTexture(){return this._defaultTexture}static __init__(){l.renderEngine.getCapable(t.RenderCapable.Texture3D)&&(this._defaultTexture=new oa(1,1,1,t.TextureFormat.R8G8B8A8,!1,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255]),!1,!1))}constructor(e,r,i,s,a=!0,n,o=!1){super(e,r,s),this._dimension=t.TextureDimension.Texture2DArray,this._gammaSpace=o,this.depth=i;let h=l.textureContext;this._texture=h.createTexture3DInternal(this._dimension,e,r,i,s,a,o,!1)}setImageData(t,e,r){let i=this._texture;l.textureContext.setTexture3DImageData(i,t,this.depth,e,r)}setPixelsData(t,e,r){let i=this._texture;l.textureContext.setTexture3DPixelsData(i,t,this.depth,e,r)}setSubPixelsData(t,e,r,i,s,a,n,o,h,u,d){let c=this._texture;l.textureContext.setTexture3DSubPixelsData(c,n,o,h,t,e,r,i,s,a,u,d)}}var ha;t.TextureCubeFace=void 0,(ha=t.TextureCubeFace||(t.TextureCubeFace={}))[ha.PositiveX=0]="PositiveX",ha[ha.NegativeX=1]="NegativeX",ha[ha.PositiveY=2]="PositiveY",ha[ha.NegativeY=3]="NegativeY",ha[ha.PositiveZ=4]="PositiveZ",ha[ha.NegativeZ=5]="NegativeZ";const ua=new Uint8Array(4);class da extends R{static get blackTexture(){return da._blackTexture}static get grayTexture(){return da._grayTexture}static get whiteTexture(){return da._whiteTexture}static get errorTexture(){return da._errorTexture}static __init__(){var e=new da(1,t.TextureFormat.R8G8B8A8,!1),r=new da(1,t.TextureFormat.R8G8B8A8,!1),i=new da(1,t.TextureFormat.R8G8B8A8,!1),s=ua;s[0]=0,s[1]=0,s[2]=0,s[3]=255,e.setPixelsData([s,s,s,s,s,s],!1,!1),e.lock=!0,s[0]=128,s[1]=128,s[2]=128,s[3]=255,r.setPixelsData([s,s,s,s,s,s],!1,!1),r.lock=!0,s[0]=255,s[1]=255,s[2]=255,s[3]=255,i.setPixelsData([s,s,s,s,s,s],!1,!1),i.lock=!0,da._grayTexture=r,da._blackTexture=e,da._whiteTexture=i,da._errorTexture=i}constructor(e,r,i=!0,s=!1,a=!1){super(e,e,r),this._dimension=t.TextureDimension.Cube,this._texture=l.textureContext.createTextureInternal(this._dimension,e,e,r,i,s,a)}setImageData(t,e,r){let i=!1,s=t.findIndex((t=>null!=t));if(-1!=s){let e=t[s];t.every((t=>null!=t&&t.width==e.width&&t.height==e.height))||(i=!0)}else i=!0;let a=this._texture;if(i){let t=ua;l.textureContext.setCubePixelsData(a,[t,t,t,t,t,t],e,r)}else l.textureContext.setCubeImageData(a,t,e,r)}setPixelsData(t,e,r){let i=this._texture;l.textureContext.setCubePixelsData(i,t,e,r)}updateSubPixelsData(t,e,r,i,s,a,n,o,h){let u=this._texture;l.textureContext.setCubeSubPixelData(u,t,a,n,e,r,i,s,o,h)}setDDSData(t){let e=this._texture;l.textureContext.setCubeDDSData(e,t)}setKTXData(t){let e=this._texture;l.textureContext.setCubeKTXData(e,t)}get defaultTexture(){return da.grayTexture}}class ca{static customRequestAnimationFrame(t,e){ca._customRequestAnimationFrame=t,ca._loopFunction=e}static set customRenderEngine(t){ca._customEngine=t}static get customRenderEngine(){return ca._customEngine}static gc(){n.isConch&&window.gc({type:"major",execution:"async"})}constructor(t,r,i){this._first=!0,this._startTm=0,this._timeId=0,ca._Render=this,ca._mainCanvas=i;let s=ca._mainCanvas.source;s.id="layaCanvas",s.width=t,s.height=r,n.isConch&&(document.body.appendChild(s),ca._mainCanvas.getContext("2d")),this.initRender(ca._mainCanvas,t,r),f._enableWindowRAFFunction?window.requestAnimationFrame(h):requestAnimationFrame(h);let a=this;performance.now();let l=f.FPS,o=ca.ifps=1e3/l;function h(t){performance.now(),a._first&&(a._startTm=Math.floor(t/o)*o,a._first=!1),t-=a._startTm;let r=Math.floor(t/o);(r-ca.lastFrm>0||!f.fixedFrames)&&(ca.lastFrm=r,e.stage._loop()),ca._customRequestAnimationFrame&&ca._loopFunction?ca._customRequestAnimationFrame(ca._loopFunction):f._enableWindowRAFFunction?window.requestAnimationFrame(h):requestAnimationFrame(h)}e.stage.on("visibilitychange",this,this._onVisibilitychange),n.isConch&&ja.timer.frameOnce(2,null,ca.gc)}_onVisibilitychange(){e.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(this._enterFrame,1e3)}static vsyncTime(){return ca.lastFrm*ca.ifps}initRender(t,e,r){t.size(e,r),Rr.__init__(),li.__init__();var i=new li;return i.isMain=!0,ca._context=i,t._setContext(i),br.__init__(),pr._init_(),ct.__init__(),da.__init__(),oa.__init__(),Y.__init__(),!0}_enterFrame(t=null){e.stage._loop()}static get context(){return ca._context}static get canvas(){return ca._mainCanvas.source}}ca.lastFrm=0,ca.ifps=1e3/60;const _a={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};var pa,fa,ga,ma;class ya{static decodeObj(t,e,r){r?(pa=r.outErrors,fa=r.getNodeByRef,ga=r.getNodeData):(pa=null,fa=null,ga=null),ya.isDeserializing=!0;try{return ya._decodeObj(t,e)}finally{ya.isDeserializing=!1}}static _decodeObj(t,r){if(null==t)return null;if(Array.isArray(t)){let e=[];for(let r=0;r<t.length;r++){let i=t[r];if(null!=i)try{e[r]=ya._decodeObj(i)}catch(t){pa&&pa.push(t),e[r]=null}else e[r]=null}return e}if("object"==typeof t){if(null!=t._$uuid){let r=O.getResURLByUUID(t._$uuid);return e.loader.getRes(r,ya.getLoadTypeByEngineType(t._$type))}if(null!=t._$ref){let e=null==fa?void 0:fa(t._$ref);if(e&&t._$type){let r=Ot.getClass(t._$type);return r?e.getComponent(r):null}return e}let i=t._$type;if("any"===i)return t._$type?t.value:t;let s=_a[i];if(null!=s)return t._$type?new s(t.value):new s(t);if(!r){let t=Ot.getClass(i);if(!t)return null;r=new t}for(let e in t){if(e.startsWith("_$"))continue;let i=t[e];if(null==i||"object"!=typeof i||Array.isArray(i)||i._$type||i._$uuid||i._$ref)try{let t=ya._decodeObj(i);r[e]=t,null!=t&&null!=i&&i._$tmpl&&(r[i._$tmpl]=ga(t))}catch(t){pa&&pa.push(t)}else{let t=r[e];if(t)try{ya._decodeObj(i,t)}catch(t){pa&&pa.push(t)}}}return r.onAfterDeserialize&&r.onAfterDeserialize(),r}return t}static getLoadTypeByEngineType(t){switch(t){case"Texture2D":case"RenderTexture":return Bt.TEXTURE2D;case"TextureCube":return Bt.TEXTURECUBE;case"Prefab":return Bt.HIERARCHY;case"Material":return Bt.MATERIAL;case"Mesh":return Bt.MESH;default:return null}}static bakeOverrideData(t){let e=null;for(let r=t.length,i=r-1;i>=0;i--){let s=t[i];if(s&&s.length>0)for(let t of s){let s,a=t._$override||t._$parent;if(Array.isArray(a)?s=a[r-i-1]:i==r-1&&(s=a),null!=s){e||(e={});let a=e[s];a||(e[s]=a=[]),a.push(r-i,t)}}}return e}static applyOverrideData(t,e){return function t(r){if(e[r._$id])return!0;let i=r._$child;return!(!i||!i.find((e=>t(e))))}(t)&&(t=function t(e){let r=Object.assign({},e),i=r._$child;i&&(r._$child=i.map((e=>t(e))));let s=r._$comp;return s&&(r._$comp=s.map((t=>Object.assign({},t)))),r}(t),function t(r){let i=r._$child;if(i)for(let e of i)e._$id&&t(e);let s=e[r._$id];if(s)for(let t=0;t<s.length;t+=2){let e,a=s[t],n=s[t+1];if(e=n._$override){let t;if(Array.isArray(e))if(a==e.length-1){let s=e[a];i?t=i.find((t=>t._$override==s)):r._$child=i=[],t||(t={_$override:s},i.push(t))}else if(a<e.length-1){let s=e.slice(a);i?t=i.find((t=>{let e=t._$override;return Array.isArray(e)&&xa(e,s)})):r._$child=i=[],t||(t={_$override:s},i.push(t))}else t=r;else t=r;if(Ta(t,n),n._$comp){let e=t._$comp;e||(t._$comp=e=[]);for(let t of n._$comp){let r=t._$type||t._$override,i=e.find((t=>t._$override==r||t._$type==r||t._$id==r));i||(i={},t._$type?i._$type=r:i._$override=r,e.push(i)),Ta(i,t)}}}else if(e=n._$parent){let t;if(i||(r._$child=i=[]),a<e.length){t=a==e.length-1?e[a]:e.slice(a);let r=Object.assign({},n);r._$parent=t,i.push(r)}else{let t=Object.assign({},n);delete t._$parent,r._$prefab?i.push(t):(delete t._$index,n._$index<i.length?i.splice(n._$index,0,t):i.push(t))}}}}(t)),t}}function Ta(t,e){for(let r in e){if(r.startsWith("_$"))continue;let i=e[r];if(null==i||"object"!=typeof i||Array.isArray(i)||(i._$type||i._$uuid||i._$ref))t[r]=i;else{let e=t[r];null!=e&&"object"==typeof e?(t[r]=e=Object.assign({},e),Ta(e,i)):t[r]=i}}}function xa(t,e){if(t.length===e.length){for(var r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}return!1}ya.isDeserializing=!1;class va extends Fs{constructor(){super(),this._multiline=!1,this._editable=!0,this._maxChars=0,this._type="text",va.IOS_IFRAME=e.Browser.onIOS&&e.Browser.window.top!=e.Browser.window.self,this._width=100,this._height=20,this.multiline=!1,this.overflow=Fs.SCROLL,this._promptColor="#A9A9A9",this.on(s.MOUSE_DOWN,this,this._onMouseDown),this.on(s.UNDISPLAY,this,this._onUnDisplay)}static __init__(){if(va._createInputElement(),e.Browser.onMobile){var t=!1;(e.Browser.onMiniGame||e.Browser.onBDMiniGame||e.Browser.onQGMiniGame||e.Browser.onKGMiniGame||e.Browser.onVVMiniGame||e.Browser.onAlipayMiniGame||e.Browser.onQQMiniGame||e.Browser.onBLMiniGame||e.Browser.onTTMiniGame||e.Browser.onHWMiniGame||e.Browser.onTBMiniGame)&&(t=!0),ca.canvas.addEventListener(va.IOS_IFRAME?t?"touchend":"click":"touchend",va._popupInputMethod)}}static _popupInputMethod(t){aa.isTextInputting&&va.inputElement.focus()}static _createInputElement(){va._initInput(va.area=e.Browser.createElement("textarea")),va._initInput(va.input=e.Browser.createElement("input")),va.inputContainer=e.Browser.createElement("div"),va.inputContainer.style.position="absolute",va.inputContainer.style.zIndex="1E5",e.Browser.container.appendChild(va.inputContainer),va.inputContainer.setPos=function(t,e){va.inputContainer.style.left=t+"px",va.inputContainer.style.top=e+"px"}}static _initInput(t){var e=t.style;e.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",e.resize="none",e.backgroundColor="transparent",e.border="none",e.outline="none",e.zIndex="1",t.addEventListener("input",va._processInputting),t.addEventListener("mousemove",va._stopEvent,{passive:!1}),t.addEventListener("mousedown",va._stopEvent,{passive:!1}),t.addEventListener("touchmove",va._stopEvent,{passive:!1}),t.setFontFace=function(e){t.style.fontFamily=e},n.isConch&&!va.isAppUseNewInput||(t.setColor=function(e){t.style.color=e},t.setFontSize=function(e){t.style.fontSize=e+"px"})}static _processInputting(t){var e=va.inputElement.target;if(e){var r=va.inputElement.value;e._restrictPattern&&(r=r.replace(/\u2006|\x27/g,""),e._restrictPattern.test(r)&&(r=r.replace(e._restrictPattern,""),va.inputElement.value=r)),null==r&&(r=""),e._text=r,e.event(s.INPUT)}}static _stopEvent(t){"touchmove"==t.type&&t.preventDefault(),t.stopPropagation&&t.stopPropagation()}setSelection(t,e){this.focus=!0,va.inputElement.selectionStart=t,va.inputElement.selectionEnd=e}get multiline(){return this._multiline}set multiline(t){this._multiline=t,ya.isDeserializing||(this.valign=t?"top":"middle")}get nativeInput(){return this._multiline?va.area:va.input}_onUnDisplay(t=null){this.focus=!1}_onMouseDown(t){this.focus=!0}_syncInputTransform(){var t=this.nativeInput,r=ws.getTransformRelativeToWindow(this,this._padding[3],this._padding[0]),i=this._width-this._padding[1]-this._padding[3],s=this._height-this._padding[0]-this._padding[2];n.isConch&&!va.isAppUseNewInput?(t.setScale(r.scaleX,r.scaleY),t.setSize(i,s),t.setPos(r.x,r.y)):(va.inputContainer.style.transform=va.inputContainer.style.webkitTransform="scale("+r.scaleX+","+r.scaleY+") rotate("+e.stage.canvasDegree+"deg)",t.style.width=i+"px",t.style.height=s+"px",va.inputContainer.style.left=r.x+"px",va.inputContainer.style.top=r.y+"px")}select(){this.nativeInput.select()}get focus(){return this._focus}set focus(t){var r=this.nativeInput;this._focus!==t&&(t?(r.target?r.target._focusOut():this._setInputMethod(),(r=this.nativeInput).target=this,this._focusIn()):(r.target=null,this._focusOut(),e.Browser.document.body.scrollTop=0,r.blur(),n.isConch&&!va.isAppUseNewInput?r.setPos(-1e4,-1e4):va.inputContainer.contains(r)&&va.inputContainer.removeChild(r)))}_setInputMethod(){va.input.parentElement&&va.inputContainer.removeChild(va.input),va.area.parentElement&&va.inputContainer.removeChild(va.area),e.Browser.onAndroid&&(va.input=va.inputElement=e.Browser.createElement("input"),va._initInput(va.input)),va.inputElement=this._multiline?va.area:va.input,va.inputContainer.appendChild(va.inputElement),Fs.RightToLeft&&(va.inputElement.style.direction="rtl")}_focusIn(){aa.isTextInputting=!0;var t=this.nativeInput;va.input&&(va.input.type=this._type),this._focus=!0;var r=t.style;r.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),t.readOnly=!this._editable,n.isConch&&!va.isAppUseNewInput&&(t.setType(this._type),t.setForbidEdit(!this._editable)),t.maxLength=this._maxChars<=0?1e5:this._maxChars,t.value=this._text,t.placeholder=this._prompt,e.stage.off(s.KEY_DOWN,this,this._onKeyDown),e.stage.on(s.KEY_DOWN,this,this._onKeyDown),e.stage.focus=this,this.event(s.FOCUS),e.Browser.onPC&&t.focus(),n.isConch&&va.isAppUseNewInput||e.Browser.onMiniGame||e.Browser.onBDMiniGame||e.Browser.onQGMiniGame||e.Browser.onKGMiniGame||e.Browser.onVVMiniGame||e.Browser.onAlipayMiniGame||e.Browser.onQQMiniGame||e.Browser.onBLMiniGame||e.Browser.onTTMiniGame||e.Browser.onHWMiniGame||e.Browser.onTBMiniGame||(this.graphics.clear(!0),this.drawBg(),this._hideText=!0),t.setColor(this.color),t.setFontSize(this.fontSize),t.setFontFace(this._realFont),n.isConch&&!va.isAppUseNewInput&&t.setMultiAble&&t.setMultiAble(this._multiline),r.lineHeight=this.leading+this.fontSize+"px",r.fontStyle=this.italic?"italic":"normal",r.fontWeight=this.bold?"bold":"normal",r.textAlign=this.align,r.padding="0 0",this._syncInputTransform(),!n.isConch&&e.Browser.onPC&&e.systemTimer.frameLoop(1,this,this._syncInputTransform)}_setPromptColor(){va.promptStyleDOM=e.Browser.getElementById("promptStyle"),va.promptStyleDOM||(va.promptStyleDOM=e.Browser.createElement("style"),va.promptStyleDOM.setAttribute("id","promptStyle"),e.Browser.document.head.appendChild(va.promptStyleDOM)),va.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}_focusOut(){aa.isTextInputting&&(aa.isiOSWKwebView||(aa.isTextInputting=!1),this._focus=!1,this._hideText=!1,this.text=this.nativeInput.value,this.markChanged(),this.typeset(),e.stage.off(s.KEY_DOWN,this,this._onKeyDown),e.stage.focus=null,this.event(s.BLUR),this.event(s.CHANGE),n.isConch&&!va.isAppUseNewInput&&this.nativeInput.blur(),e.Browser.onPC&&e.systemTimer.clear(this,this._syncInputTransform))}_onKeyDown(t){13===t.keyCode&&(e.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(s.ENTER))}miniGameTxt(t){t+="",this._multiline||(t=t.replace(/\r?\n/g,"")),this.text=t}get text(){return this._focus?this.nativeInput.value:super.text}set text(t){null==t?t="":"string"!=typeof t&&(t=""+t),this._focus?(this.nativeInput.value=t,this.event(s.CHANGE)):(this._multiline||(t=t.replace(/\r?\n/g,"")),super.text=t)}set_color(t){this._focus&&this.nativeInput.setColor(t),super.set_color(t)}get bgColor(){return super.bgColor}set bgColor(t){super.bgColor=t,n.isConch&&!va.isAppUseNewInput&&this.nativeInput.setBgColor(t)}get restrict(){return this._restrict}set restrict(t){this._restrict=t,t?((t="[^"+t+"]").indexOf("^^")>-1&&(t=t.replace("^^","")),this._restrictPattern=new RegExp(t,"g")):this._restrictPattern=null}get editable(){return this._editable}set editable(t){this._editable=t,n.isConch&&!va.isAppUseNewInput&&va.input.setForbidEdit(!t)}get maxChars(){return this._maxChars}set maxChars(t){this._maxChars=t}get prompt(){return this._prompt}set prompt(t){var e;t=(null===(e=Fs.langPacks)||void 0===e?void 0:e[t])||t,this._prompt!=t&&(this._prompt=t,this.markChanged())}get promptColor(){return this._promptColor}set promptColor(t){this._promptColor!=t&&(this._promptColor=t,this.markChanged())}get type(){return this._type}set type(t){this._asPassword="password"===t,this._type=t,this.markChanged()}}va.TYPE_TEXT="text",va.TYPE_PASSWORD="password",va.TYPE_EMAIL="email",va.TYPE_URL="url",va.TYPE_NUMBER="number",va.TYPE_RANGE="range",va.TYPE_DATE="date",va.TYPE_MONTH="month",va.TYPE_WEEK="week",va.TYPE_TIME="time",va.TYPE_DATE_TIME="datetime",va.TYPE_DATE_TIME_LOCAL="datetime-local",va.TYPE_SEARCH="search",va.IOS_IFRAME=!1,va.isAppUseNewInput=!1;class Sa{constructor(t=!0){this.scale=1,this.currFrame=0,this._delta=0,this._map={},this._handlers=[],this._temp=[],this._count=0,t&&Sa.gSysTimer&&Sa.gSysTimer.frameLoop(1,this,this._update),this.currTimer=this._getNowData(),this._lastTimer=this._getNowData()}get delta(){return this._delta}_update(){if(this.scale<=0)return this._lastTimer=this._getNowData(),void(this._delta=0);var t=this.currFrame=this.currFrame+this.scale,e=this._getNowData(),r=e-this._lastTimer>3e4;this._delta=(e-this._lastTimer)*this.scale;var i=this.currTimer=this.currTimer+this._delta;this._lastTimer=e;var s=this._handlers;this._count=0;for(var a=0,n=s.length;a<n;a++){var l=s[a];if(null!==l.method){var o=l.userFrame?t:i;if(o>=l.exeTime)if(l.repeat)if(!l.jumpFrame||r)l.exeTime+=l.delay,l.run(!1),o>l.exeTime&&(l.exeTime+=Math.ceil((o-l.exeTime)/l.delay)*l.delay);else for(;o>=l.exeTime;)l.exeTime+=l.delay,l.run(!1);else l.run(!0)}else this._count++}(this._count>30||t%200==0)&&this._clearHandlers()}_clearHandlers(){for(var t=this._handlers,e=0,r=t.length;e<r;e++){var i=t[e];null!==i.method?this._temp.push(i):this._recoverHandler(i)}this._handlers=this._temp,t.length=0,this._temp=t}_recoverHandler(t){this._map[t.key]==t&&delete this._map[t.key],t.clear(),Sa._pool.push(t)}_getNowData(){return Date.now()}_create(t,e,r,i,s,a,n){if(!r)return s.apply(i,a),null;if(n){var l=this._getHandler(i,s);if(l)return l.repeat=e,l.userFrame=t,l.delay=r,l.caller=i,l.method=s,l.args=a,l.exeTime=r+(t?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),l}return(l=Sa._pool.length>0?Sa._pool.pop():new Ea).repeat=e,l.userFrame=t,l.delay=r,l.caller=i,l.method=s,l.args=a,l.exeTime=r+(t?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),this._indexHandler(l),this._handlers.push(l),l}_indexHandler(t){var e=t.caller,r=t.method,i=e?e.$_GID||(e.$_GID=P.getGID()):0,s=r.$_TID||(r.$_TID=Sa._mid++);t.key=i+"_"+s,this._map[t.key]=t}once(t,e,r,i=null,s=!0){this._create(!1,!1,t,e,r,i,s)}loop(t,e,r,i=null,s=!0,a=!1){var n=this._create(!1,!0,t,e,r,i,s);n&&(n.jumpFrame=a)}frameOnce(t,e,r,i=null,s=!0){this._create(!0,!1,t,e,r,i,s)}frameLoop(t,e,r,i=null,s=!0){this._create(!0,!0,t,e,r,i,s)}toString(){return" handlers:"+this._handlers.length+" pool:"+Sa._pool.length}clear(t,e){var r=this._getHandler(t,e);r&&r.clear()}clearAll(t){if(t)for(var e=0,r=this._handlers.length;e<r;e++){var i=this._handlers[e];i.caller===t&&i.clear()}}_getHandler(t,e){var r=(t?t.$_GID||(t.$_GID=P.getGID()):0)+"_"+(e.$_TID||(e.$_TID=Sa._mid++));return this._map[r]}callLater(t,e,r=null){wa.I.callLater(t,e,r)}runCallLater(t,e){wa.I.runCallLater(t,e)}clearCallLater(t,e){wa.I.clear(t,e)}runTimer(t,e){var r=this._getHandler(t,e);r&&null!=r.method&&(this._map[r.key]=null,r.run(!0))}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(var t=0,e=this._handlers.length;t<e;t++){this._handlers[t].clear()}this._handlers.length=0,this._map={},this._temp.length=0}}Sa.gSysTimer=null,Sa._pool=[],Sa._mid=1;class Ea{clear(){this.caller=null,this.method=null,this.args=null}run(t){var e=this.caller;if(e&&e.destroyed)return this.clear();var r=this.method,i=this.args;t&&this.clear(),null!=r&&(i?r.apply(e,i):r.call(e))}}class wa{constructor(){this._pool=[],this._map={},this._laters=[]}_update(){let t=this._laters,e=t.length;if(e>0){for(let r=0,i=e-1;r<=i;r++){let e=t[r];delete this._map[e.key],null!==e.method&&(e.run(),e.clear()),this._pool.push(e),r===i&&(i=t.length-1)}t.length=0}}_getHandler(t,e){var r=t?t.$_GID||(t.$_GID=P.getGID()):0,i=e.$_TID||(e.$_TID=Sa._mid++);return this._map[r+"."+i]}callLater(t,e,r=null){if(null==this._getHandler(t,e)){let a;a=this._pool.length?this._pool.pop():new Da,a.caller=t,a.method=e,a.args=r;var i=t?t.$_GID:0,s=e.$_TID;a.key=i+"."+s,this._map[a.key]=a,this._laters.push(a)}}runCallLater(t,e){var r=this._getHandler(t,e);r&&null!=r.method&&(delete this._map[r.key],r.run(),r.clear())}clear(t,e){var r=this._getHandler(t,e);return!!r&&(delete this._map[r.key],r.key="",r.clear(),!0)}clearAll(t){if(t)for(var e=0,r=this._laters.length;e<r;e++){var i=this._laters[e];i.caller===t&&(delete this._map[i.key],i.key="",i.clear())}}}wa.I=new wa;class Da{clear(){this.caller=null,this.method=null,this.args=null}run(){var t=this.caller;if(t&&t.destroyed)return this.clear();var e=this.method,r=this.args;null!=e&&(r?e.apply(t,r):e.call(t))}}class ba{static _nativeRender_enable(){}static enable(){return!0}static onStageResize(t,e){ne.width=t,ne.height=e,l.renderEngine.resizeOffScreen(t,e)}}ba.isNativeRender_enable=!1;class Ra{}Ra.changeWebGLSize=function(t,e){ba.onStageResize(t,e)};class Ca{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let t of this._toStarts)if(2==t._status){t._status=3;try{t.onStart()}catch(t){this.onError(t)}}this._toStarts.clear()}callUpdate(){for(let t of this._onUpdates)if(3==t._status)try{t.onUpdate()}catch(t){this.onError(t)}}callLateUpdate(){for(let t of this._onLateUpdates)if(3==t._status)try{t.onLateUpdate()}catch(t){this.onError(t)}}callPreRender(){for(let t of this._onPreRenders)if(3==t._status)try{t.onPreRender()}catch(t){this.onError(t)}}callPostRender(){for(let t of this._onPostRenders)if(3==t._status)try{t.onPostRender()}catch(t){this.onError(t)}}callDestroy(){for(let t of this._toDestroys)try{t._destroy(!0)}catch(t){this.onError(t)}this._toDestroys.clear()}add(t){1==t._status&&(t.onStart?(t._status=2,this._toStarts.add(t)):t._status=3),t.onUpdate&&this._onUpdates.add(t),t.onLateUpdate&&this._onLateUpdates.add(t),t.onPreRender&&this._onPreRenders.add(t),t.onPostRender&&this._onPostRenders.add(t)}remove(t){2==t._status&&(t._status=1),t.onUpdate&&this._onUpdates.delete(t),t.onLateUpdate&&this._onLateUpdates.delete(t),t.onPreRender&&this._onPreRenders.delete(t),t.onPostRender&&this._onPostRenders.delete(t)}destroy(){}onError(t){console.error(t)}}class Aa extends Ds{constructor(){super(),this.offset=new i,this._frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new G,this._mouseMoveTime=0,this._wgColor=new _t(0,0,0,0),this._scene3Ds=[],this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="gray",this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=0,this._previousOrientation=A.window.orientation,this._globalRepaintSet=!1,this._globalRepaintGet=!1,this.useRetinalCanvas=!1,this._needUpdateCanvasSize=!1,super.set_transform(this._createTransform()),this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._setBit(kt.DISPLAYED_INSTAGE,!0),this._setBit(kt.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._isVisibility=!0,this.useRetinalCanvas=!!n.isConch||f.useRetinalCanvas;var t=A.window;t.addEventListener("focus",(()=>{this._isFocused=!0,this.event(s.FOCUS),this.event(s.FOCUS_CHANGE)})),t.addEventListener("blur",(()=>{this._isFocused=!1,this.event(s.BLUR),this.event(s.FOCUS_CHANGE),this._isInputting()&&(va.inputElement.target.focus=!1)}));var e="visibilityState",r="visibilitychange",a=t.document;void 0!==a.hidden?(r="visibilitychange",e="visibilityState"):void 0!==a.mozHidden?(r="mozvisibilitychange",e="mozVisibilityState"):void 0!==a.msHidden?(r="msvisibilitychange",e="msVisibilityState"):void 0!==a.webkitHidden&&(r="webkitvisibilitychange",e="webkitVisibilityState"),t.document.addEventListener(r,(()=>{"hidden"==A.document[e]?(this._isVisibility=!1,this._isInputting()&&(va.inputElement.target.focus=!1)):this._isVisibility=!0,this.renderingEnabled=this._isVisibility,this.event(s.VISIBILITY_CHANGE)})),t.addEventListener("resize",(()=>{var t=A.window.orientation;null!=t&&t!=this._previousOrientation&&this._isInputting()&&(va.inputElement.target.focus=!1),this._previousOrientation=t,this._isInputting()||(A.onSafari&&(this._safariOffsetY=A.getSafariToolbarOffset()),this.screenAdaptationEnabled&&(this.event(s.WILL_RESIZE),this.updateCanvasSize(!0)))})),t.addEventListener("orientationchange",(t=>{this.screenAdaptationEnabled&&(this.event(s.WILL_RESIZE),this.updateCanvasSize(!0))})),this._componentDriver=new Ca}_isInputting(){return A.onMobile&&aa.isTextInputting}set_width(t){this.designWidth=t,super.set_width(t),this.updateCanvasSize(!0)}get_width(){return this.needUpdateCanvasSize(),super.get_width()}set_height(t){this.designHeight=t,super.set_height(t),this.updateCanvasSize(!0)}get_height(){return this.needUpdateCanvasSize(),super.get_height()}get transform(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||this._createTransform()}set transform(t){super.set_transform(t)}get isFocused(){return this._isFocused}get isVisibility(){return this._isVisibility}updateCanvasSize(t){t?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,e.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(A.clientWidth*A.pixelRatio,A.clientHeight*A.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(t,e){this._needUpdateCanvasSize=!1;var r=!1;if(this._screenMode!==Aa.SCREEN_NONE&&(r=(t/e<1?Aa.SCREEN_VERTICAL:Aa.SCREEN_HORIZONTAL)!==this._screenMode)){var i=e;e=t,t=i}this.canvasRotation=r;var a=ca._mainCanvas,n=this._canvasTransform.identity(),l=this._scaleMode,o=t/this.designWidth,h=e/this.designHeight,u=this.useRetinalCanvas?t:this.designWidth,d=this.useRetinalCanvas?e:this.designHeight,c=t,_=e,p=A.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,l){case Aa.SCALE_NOSCALE:o=h=1,c=this.designWidth,_=this.designHeight;break;case Aa.SCALE_SHOWALL:o=h=Math.min(o,h),u=c=Math.round(this.designWidth*o),d=_=Math.round(this.designHeight*h);break;case Aa.SCALE_NOBORDER:o=h=Math.max(o,h),c=Math.round(this.designWidth*o),_=Math.round(this.designHeight*h);break;case Aa.SCALE_FULL:o=h=p,u=t,d=e,this._width=t/p,this._height=e/p;break;case Aa.SCALE_FIXED_WIDTH:h=o,this._height=d=Math.round(e/o);break;case Aa.SCALE_FIXED_HEIGHT:o=h,this._width=u=Math.round(t/h);break;case Aa.SCALE_FIXED_AUTO:t/e<this.designWidth/this.designHeight?(h=o,this._height=d=Math.round(e/o)):(o=h,this._width=u=Math.round(t/h))}this.useRetinalCanvas&&(c=u=t,_=d=e),o*=this.scaleX,h*=this.scaleY,1===o&&1===h?this.transform.identity():(this.transform.a=this._formatData(o/(c/u)),this.transform.d=this._formatData(h/(_/d))),a.size(u,d),Ra.changeWebGLSize(u,d),n.scale(c/u/p,_/d/p),this._alignH===Aa.ALIGN_LEFT?this.offset.x=0:this._alignH===Aa.ALIGN_RIGHT?this.offset.x=t-c:this.offset.x=.5*(t-c)/p,this._alignV===Aa.ALIGN_TOP?this.offset.y=0:this._alignV===Aa.ALIGN_BOTTOM?this.offset.y=e-_:this.offset.y=.5*(e-_)/p,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),n.translate(this.offset.x,this.offset.y),this._safariOffsetY&&n.translate(0,this._safariOffsetY),this.canvasDegree=0,r&&(this._screenMode===Aa.SCREEN_HORIZONTAL?(n.rotate(Math.PI/2),n.translate(e/p,0),this.canvasDegree=90):(n.rotate(-Math.PI/2),n.translate(0,t/p),this.canvasDegree=-90)),n.a=this._formatData(n.a),n.d=this._formatData(n.d),n.tx=this._formatData(n.tx),n.ty=this._formatData(n.ty),super.set_transform(this.transform),Aa._setStageStyle(a,u,d,n),this._safariOffsetY&&n.translate(0,-this._safariOffsetY),this.visible=!0,this._repaint|=ie.REPAINT_CACHE,this.event(s.RESIZE)}static _setStageStyle(t,e,r,i){var s=t.source.style;s.transformOrigin=s.webkitTransformOrigin=s.msTransformOrigin=s.mozTransformOrigin=s.oTransformOrigin="0px 0px 0px",s.transform=s.webkitTransform=s.msTransform=s.mozTransform=s.oTransform="matrix("+i.toString()+")",s.width=e,s.height=r,i.translate(parseInt(s.left)||0,parseInt(s.top)||0)}setScreenSizeForScene(t,e,r){var i=!1;if(r!==Aa.SCREEN_NONE&&(i=(t/e<1?Aa.SCREEN_VERTICAL:Aa.SCREEN_HORIZONTAL)!==r)){var s=e;e=t,t=s}this.canvasRotation=i;var a=this._scaleMode,n=t/this.designWidth,l=e/this.designHeight,o=this.useRetinalCanvas?t:this.designWidth,h=this.useRetinalCanvas?e:this.designHeight,u=t,d=e;let c=this.designWidth,_=this.designHeight;switch(a){case Aa.SCALE_NOSCALE:n=l=1,u=this.designWidth,d=this.designHeight;break;case Aa.SCALE_SHOWALL:n=l=Math.min(n,l),o=u=Math.round(this.designWidth*n),h=d=Math.round(this.designHeight*l);break;case Aa.SCALE_NOBORDER:n=l=Math.max(n,l),u=Math.round(this.designWidth*n),d=Math.round(this.designHeight*l);break;case Aa.SCALE_FULL:n=l=1,c=o=t,_=h=e;break;case Aa.SCALE_FIXED_WIDTH:l=n,_=h=Math.round(e/n);break;case Aa.SCALE_FIXED_HEIGHT:n=l,c=o=Math.round(t/l);break;case Aa.SCALE_FIXED_AUTO:t/e<this.designWidth/this.designHeight?(l=n,_=h=Math.round(e/n)):(n=l,c=o=Math.round(t/l))}return this.useRetinalCanvas&&(u=o=t,d=h=e),{stageWidth:c,stageHeight:_,canvasWidth:o,canvasHeight:h,scaleX:n/(u/o),scaleY:l/(d/h)}}_formatData(t){return Math.abs(t)<1e-6?0:Math.abs(1-t)<.001?t>0?1:-1:t}get scaleMode(){return this._scaleMode}set scaleMode(t){this._scaleMode=t,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(t){this._alignH=t,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(t){this._alignV=t,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(t){if(this._bgColor=t,t){let e=gr.create(t).arrColor;this._wgColor.setValue(e[0],e[1],e[2],e[3])}else this._wgColor=null;Aa._setStyleBgColor(t)}static _setStyleBgColor(t){ca.canvas.style.background=t||"none"}get mouseX(){return Math.round(aa.mouseX/this.clientScaleX)}get mouseY(){return Math.round(aa.mouseY/this.clientScaleY)}getMousePoint(){return i.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleX():1}get clientScaleY(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleY():1}get screenMode(){return this._screenMode}set screenMode(t){this._screenMode=t}repaint(t=ie.REPAINT_CACHE){this._repaint|=t}parentRepaint(t=ie.REPAINT_CACHE){}_loop(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(ca._context,0,0),!0}getFrameTm(){return this._frameStartTime}getTimeFromFrameStart(){return A.now()-this._frameStartTime}get visible(){return super.visible}set visible(t){this.visible!==t&&(super.set_visible(t),Aa._setVisibleStyle(t))}static _setVisibleStyle(t){ca._mainCanvas.source.style.visibility=t?"visible":"hidden"}render(t,e,r){if(this._frameRate===Aa.FRAME_SLEEP){var i=A.now();if(i-this._frameStartTime<1e3)return;this._frameStartTime=i}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(wa.I._update(),se.loopCount++,Ur.loopCount=se.loopCount,this._runComponents(),this._updateTimers()));this._frameStartTime=A.now(),Ur.loopStTm=this._frameStartTime}this._renderCount++;var s=(this._frameRate===Aa.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2e3?Aa.FRAME_FAST:Aa.FRAME_SLOW:this._frameRate)!==Aa.FRAME_SLOW,a=this._renderCount%2==0;if(se.renderSlow=!s,s||a){if(wa.I._update(),se.loopCount++,Ur.loopCount=se.loopCount,this.renderingEnabled){for(let t=0,e=this._scene3Ds.length;t<e;t++)this._scene3Ds[t]._update();this._runComponents(),this._componentDriver.callPreRender(),t.render2D.renderStart(!f.preserveDrawingBuffer,this._wgColor);for(let t=0,e=this._scene3Ds.length;t<e;t++)this._scene3Ds[t].renderSubmit();this._render2d(t,e,r),this._componentDriver.callPostRender(),cs.instance&&cs.getInstance().endDispose()}else this._runComponents();this._updateTimers(),l.renderEngine.endFrame()}}_render2d(t,e,r){se.draw2D=0,t.startRender(),super.render(t,e,r),se.render(t,e,r),t.endRender()}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(){e.systemTimer._update(),e.physicsTimer._update(),e.timer._update()}set fullScreenEnabled(t){var e=A.document,r=ca.canvas;t?(r.addEventListener("mousedown",Ia),r.addEventListener("touchstart",Ia),e.addEventListener("fullscreenchange",Ma),e.addEventListener("mozfullscreenchange",Ma),e.addEventListener("webkitfullscreenchange",Ma),e.addEventListener("msfullscreenchange",Ma)):(r.removeEventListener("mousedown",Ia),r.removeEventListener("touchstart",Ia),e.removeEventListener("fullscreenchange",Ma),e.removeEventListener("mozfullscreenchange",Ma),e.removeEventListener("webkitfullscreenchange",Ma),e.removeEventListener("msfullscreenchange",Ma))}exitFullscreen(){var t=A.document;t.exitFullscreen?t.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitExitFullscreen&&t.webkitExitFullscreen()}get frameRate(){return this._frameRate}set frameRate(t){this._frameRate=t}isGlobalRepaint(){return this._globalRepaintGet}setGlobalRepaint(){this._globalRepaintSet=!0}}function Ia(){var t=A.document.documentElement;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen();var e=ca.canvas;e.removeEventListener("mousedown",Ia),e.removeEventListener("touchstart",Ia)}function Ma(){e.stage.event(s.FULL_SCREEN_CHANGE)}Aa.SCALE_NOSCALE="noscale",Aa.SCALE_SHOWALL="showall",Aa.SCALE_NOBORDER="noborder",Aa.SCALE_FULL="full",Aa.SCALE_FIXED_WIDTH="fixedwidth",Aa.SCALE_FIXED_HEIGHT="fixedheight",Aa.SCALE_FIXED_AUTO="fixedauto",Aa.ALIGN_LEFT="left",Aa.ALIGN_RIGHT="right",Aa.ALIGN_CENTER="center",Aa.ALIGN_TOP="top",Aa.ALIGN_MIDDLE="middle",Aa.ALIGN_BOTTOM="bottom",Aa.SCREEN_NONE="none",Aa.SCREEN_HORIZONTAL="horizontal",Aa.SCREEN_VERTICAL="vertical",Aa.FRAME_FAST="fast",Aa.FRAME_SLOW="slow",Aa.FRAME_MOUSE="mouse",Aa.FRAME_SLEEP="sleep";class Ba extends v{constructor(){super(...arguments),this.isStopped=!1}get volume(){return 1}set volume(t){}get position(){return 0}get duration(){return 0}play(){}stop(){this.completeHandler&&this.completeHandler.runWith(!1)}pause(){}resume(){}__runComplete(t){t&&t.runWith(!0)}}class La extends Ba{constructor(t){super(),this._audio=null,this._onEnd=this.__onEnd.bind(this),this._resumePlay=this.__resumePlay.bind(this),t.addEventListener("ended",this._onEnd),this._audio=t,this._src=t.src}__onEnd(t){if(1==this.loops)return this.completeHandler&&(e.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(s.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}__resumePlay(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,A.container.appendChild(this._audio),this._audio.play()}catch(t){this.event(s.ERROR)}}play(){this.isStopped=!1;try{this._audio.playbackRate=Fa.playbackRate,this._audio.currentTime=this.startTime}catch(t){return void this._audio.addEventListener("canplay",this._resumePlay)}if(Fa.addChannel(this),A.container.appendChild(this._audio),"play"in this._audio){let t=this._audio.play();t&&t.catch((t=>{}))}}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,Fa.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&n.isConch&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),e.Browser.onIE||this._audio!=Pa._musicAudio&&r.recover("audio:"+this.url,this._audio),A.removeElement(this._audio),this._audio=null,Fa.autoReleaseSound&&Fa.disposeSoundLater(this.url))}pause(){this.isStopped=!0,Fa.removeChannel(this),this._audio&&("pause"in this._audio&&this._audio.pause(),Fa.autoReleaseSound&&Fa.disposeSoundLater(this.url))}resume(){var t=this._audio;t&&(this.isStopped=!1,0==t.readyState&&(t.src=this._src,t.addEventListener("canplay",this._resumePlay),t.load()),Fa.addChannel(this),"play"in t&&t.play())}get volume(){return this._audio?this._audio.volume:1}set volume(t){this._audio&&(this._audio.volume=t)}}class Pa extends v{constructor(){super(...arguments),this.loaded=!1}dispose(){var t=Pa._audioCache[this.url];r.clearBySign("audio:"+this.url),t&&(n.isConch||(t.src=""),delete Pa._audioCache[this.url])}static _initMusicAudio(){Pa._musicAudio||(Pa._musicAudio||(Pa._musicAudio=A.createElement("audio")),n.isConch||A.document.addEventListener("mousedown",Pa._makeMusicOK))}static _makeMusicOK(){A.document.removeEventListener("mousedown",Pa._makeMusicOK),Pa._musicAudio.src?Pa._musicAudio.play():(Pa._musicAudio.src="",Pa._musicAudio.load())}load(t){var e;if(this.url=t,t==Fa._bgMusic?(Pa._initMusicAudio(),(e=Pa._musicAudio).originalUrl!=t&&(delete Pa._audioCache[e.originalUrl],e=null)):e=Pa._audioCache[t],e&&e.readyState>=2)this.event(s.COMPLETE);else{e||(t==Fa._bgMusic?(Pa._initMusicAudio(),e=Pa._musicAudio):e=A.createElement("audio"),Pa._audioCache[t]=e,N.inst.resolveURL(t,(t=>{e.src=O.postFormatURL(O.formatURL(t))}))),e.originalUrl=t,e.addEventListener("canplaythrough",i),e.addEventListener("error",a);var r=this;this.audio=e,e.load?e.load():a()}function i(){n(),r.loaded=!0,r.event(s.COMPLETE)}function a(){e.load=null,n(),r.event(s.ERROR)}function n(){e.removeEventListener("canplaythrough",i),e.removeEventListener("error",a)}}play(t=0,e=0){if(!this.url)return null;var i,s;if(this.url==Fa._bgMusic?""!=(i=Pa._musicAudio).src&&i.originalUrl!=this.url&&(delete Pa._audioCache[i.originalUrl],Pa._audioCache[this.url]=i):i=Pa._audioCache[this.url],!i)return null;s=r.getItem("audio:"+this.url),n.isConch?s||(s=A.createElement("audio"),N.inst.resolveURL(this.url,(t=>{s.src=O.postFormatURL(O.formatURL(t))}))):this.url==Fa._bgMusic?(Pa._initMusicAudio(),s=Pa._musicAudio,N.inst.resolveURL(this.url,(t=>{s.src=O.postFormatURL(O.formatURL(t))}))):s=s||i.cloneNode(!0),s.originalUrl=this.url;var a=new La(s);return a.url=this.url,a.loops=e,a.startTime=t,a.play(),Fa.addChannel(a),a}get duration(){var t;return(t=Pa._audioCache[this.url])?t.duration:0}}Pa._audioCache={};class Na extends Ba{constructor(){super(),this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this.context=Oa.ctx,this._onPlayEnd=this.__onPlayEnd.bind(this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}play(){if(Fa.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return this.stop();var t=this.context,e=this.gain,r=t.createBufferSource();this.bufferSource=r,r.buffer=this.audioBuffer,r.connect(e),e&&e.disconnect(),e.connect(t.destination),r.onended=this._onPlayEnd,this._startTime=A.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,Na.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(r.loop=!0),r.playbackRate.setTargetAtTime?r.playbackRate.setTargetAtTime(Fa.playbackRate,this.context.currentTime,Na.SetTargetDelay):r.playbackRate.value=Fa.playbackRate,r.start(0,this.startTime),this._currentTime=0}}__onPlayEnd(){if(1==this.loops)return this.completeHandler&&(e.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(s.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}get position(){return this.bufferSource?(A.now()-this._startTime)/1e3+this.startTime:0}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}_clearBufferSource(){if(this.bufferSource){var t=this.bufferSource;t.stop?t.stop(0):t.noteOff(0),t.disconnect(0),t.onended=null,Na._tryCleanFailed||this._tryClearBuffer(t),this.bufferSource=null}}_tryClearBuffer(t){try{t.buffer=null}catch(t){Na._tryCleanFailed=!0}}stop(){super.stop(),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,Fa.removeChannel(this),this.completeHandler=null,Fa.autoReleaseSound&&Fa.disposeSoundLater(this.url)}pause(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,Fa.removeChannel(this),Fa.autoReleaseSound&&Fa.disposeSoundLater(this.url)}resume(){this.startTime=this._pauseTime,this.play()}get volume(){return this._volume}set volume(t){this._volume=t,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(t,this.context.currentTime,Na.SetTargetDelay):this.gain.gain.value=t)}}Na._tryCleanFailed=!1,Na.SetTargetDelay=.001;class Oa extends v{constructor(){super(...arguments),this.loaded=!1,this._disposed=!1}static _playEmptySound(){if(null!=Oa.ctx){var t=Oa.ctx.createBufferSource();t.buffer=Oa._miniBuffer,t.connect(Oa.ctx.destination),t.start(0,0,0)}}static _unlock(){Oa._unlocked||(Oa._playEmptySound(),"running"==Oa.ctx.state&&(window.document.removeEventListener("mousedown",Oa._unlock,!0),window.document.removeEventListener("touchend",Oa._unlock,!0),window.document.removeEventListener("touchstart",Oa._unlock,!0),Oa._unlocked=!0))}static initWebAudio(){Oa.ctx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),"running"!=Oa.ctx.state&&(Oa._unlock(),window.document.addEventListener("mousedown",Oa._unlock,!0),window.document.addEventListener("touchend",Oa._unlock,!0),window.document.addEventListener("touchstart",Oa._unlock,!0))}load(t){this.url=t,this.audioBuffer=e.loader.getRes(t),this.audioBuffer?this._loaded(this.audioBuffer):e.loader.load(t,Bt.SOUND).then((t=>this._loaded(t)))}_loaded(t){this._disposed||(this.audioBuffer=t,this.loaded=!0,this.event(s.COMPLETE))}__playAfterLoaded(){if(this.__toPlays){var t,e,r,i;for(e=(r=this.__toPlays).length,t=0;t<e;t++)(i=r[t])[2]&&!i[2].isStopped&&this.play(i[0],i[1],i[2]);this.__toPlays.length=0}}play(t=0,e=0,r=null){return r=r||new Na,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([t,e,r]),this.once(s.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),r.url=this.url,r.loops=e,r.audioBuffer=this.audioBuffer,r.startTime=t,r.play(),Fa.addChannel(r),r}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}dispose(){this._disposed=!0,this.audioBuffer&&(e.loader.clearRes(this.url,this.audioBuffer),this.audioBuffer=null),this.__toPlays=[]}}Oa._miniBuffer=Oa.ctx?Oa.ctx.createBuffer(1,1,22050):void 0,Oa._unlocked=!1;class Fa{static __init__(){var t=e.Browser.window,r=!!(t.AudioContext||t.webkitAudioContext||t.mozAudioContext);return r&&Oa.initWebAudio(),Fa._soundClass=r?Oa:Pa,A.onTBMiniGame||Pa._initMusicAudio(),Fa._musicClass=Pa,r}static addChannel(t){Fa._channels.indexOf(t)>=0||Fa._channels.push(t)}static removeChannel(t){for(let e=Fa._channels.length-1;e>=0;e--)Fa._channels[e]==t&&Fa._channels.splice(e,1)}static disposeSoundLater(t){Fa._lastSoundUsedTimeDic[t]=e.Browser.now(),Fa._isCheckingDispose||(Fa._isCheckingDispose=!0,e.timer.loop(5e3,null,Fa._checkDisposeSound))}static _checkDisposeSound(){let t=e.Browser.now(),r=!1;for(let e in Fa._lastSoundUsedTimeDic)t-Fa._lastSoundUsedTimeDic[e]>3e4?(delete Fa._lastSoundUsedTimeDic[e],Fa.disposeSoundIfNotUsed(e)):r=!0;r||(Fa._isCheckingDispose=!1,e.timer.clear(null,Fa._checkDisposeSound))}static disposeSoundIfNotUsed(t){for(let e=Fa._channels.length-1;e>=0;e--)if(Fa._channels[e].url==t)return;Fa.destroySound(t)}static get autoStopMusic(){return Fa._autoStopMusic}static set autoStopMusic(t){e.stage.off(s.BLUR,null,Fa._stageOnBlur),e.stage.off(s.FOCUS,null,Fa._stageOnFocus),e.stage.off(s.VISIBILITY_CHANGE,null,Fa._visibilityChange),Fa._autoStopMusic=t,t&&(e.stage.on(s.BLUR,null,Fa._stageOnBlur),e.stage.on(s.FOCUS,null,Fa._stageOnFocus),e.stage.on(s.VISIBILITY_CHANGE,null,Fa._visibilityChange))}static _visibilityChange(){e.stage.isVisibility?Fa._stageOnFocus():Fa._stageOnBlur()}static _stageOnBlur(){Fa._isActive=!1,Fa._musicChannel&&(Fa._musicChannel.isStopped||(Fa._blurPaused=!0,Fa._musicChannel.pause())),Fa.stopAllSound(),e.stage.once(s.MOUSE_DOWN,null,Fa._stageOnFocus)}static _recoverWebAudio(){Oa.ctx&&"running"!=Oa.ctx.state&&Oa.ctx.resume&&Oa.ctx.resume()}static _stageOnFocus(){Fa._isActive=!0,Fa._recoverWebAudio(),e.stage.off(s.MOUSE_DOWN,null,Fa._stageOnFocus),Fa._blurPaused&&Fa._musicChannel&&Fa._musicChannel.isStopped&&(Fa._blurPaused=!1,Fa._musicChannel.resume())}static get muted(){return Fa._muted}static set muted(t){t!=Fa._muted&&(t&&Fa.stopAllSound(),Fa.musicMuted=t,Fa._muted=t)}static get soundMuted(){return Fa._soundMuted}static set soundMuted(t){Fa._soundMuted=t}static get musicMuted(){return Fa._musicMuted}static set musicMuted(t){t!=Fa._musicMuted&&(t?(Fa._bgMusic&&Fa._musicChannel&&!Fa._musicChannel.isStopped?n.isConch?Fa._musicChannel._audio&&(Fa._musicChannel._audio.muted=!0):Fa._musicChannel.pause():Fa._musicChannel=null,Fa._musicMuted=t):(Fa._musicMuted=t,Fa._bgMusic&&Fa._musicChannel&&(n.isConch?Fa._musicChannel._audio&&(Fa._musicChannel._audio.muted=!1):Fa._musicChannel.resume())))}static get useAudioMusic(){return Fa._useAudioMusic}static set useAudioMusic(t){Fa._useAudioMusic=t,Fa._musicClass=t?Pa:null}static playSound(t,e=1,r=null,i=null,s=0){if(!Fa._isActive||!t)return null;if(Fa._muted)return null;if(Fa._recoverWebAudio(),t==Fa._bgMusic){if(Fa._musicMuted)return null}else if(Fa._soundMuted)return null;let a;A._isMiniGame||(a=Fa._soundCache[t]),i||(i=Fa._soundClass),a||(a=new i,a.load(t),A._isMiniGame||(Fa._soundCache[t]=a));let n=a.play(s,e);return n?(n.url=t,n.volume=t==Fa._bgMusic?Fa.musicVolume:Fa.soundVolume,n.completeHandler=r,n):null}static destroySound(t){let e=Fa._soundCache[t];e&&(delete Fa._soundCache[t],e.dispose())}static playMusic(t,e=0,r=null,i=0){return Fa._bgMusic=t,Fa._musicChannel&&Fa._musicChannel.stop(),Fa._musicChannel=Fa.playSound(t,e,r,Fa._musicClass,i)}static stopSound(t){for(let e=Fa._channels.length-1;e>=0;e--){let r=Fa._channels[e];r.url==t&&r.stop()}}static stopAll(){var t;for(Fa._bgMusic=null,t=Fa._channels.length-1;t>=0;t--)Fa._channels[t].stop()}static stopAllSound(){for(let t=Fa._channels.length-1;t>=0;t--){let e=Fa._channels[t];e.url!=Fa._bgMusic&&e.stop()}}static stopMusic(){Fa._musicChannel&&Fa._musicChannel.stop(),Fa._bgMusic=null}static setSoundVolume(t,e=null){if(e)Fa._setVolume(e,t);else{Fa.soundVolume=t;for(let e=Fa._channels.length-1;e>=0;e--){let r=Fa._channels[e];r.url!=Fa._bgMusic&&(r.volume=t)}}}static setMusicVolume(t){Fa.musicVolume=t,Fa._setVolume(Fa._bgMusic,t)}static _setVolume(t,e){for(let r=Fa._channels.length-1;r>=0;r--){let i=Fa._channels[r];i.url==t&&(i.volume=e)}}}Fa.musicVolume=1,Fa.soundVolume=1,Fa.playbackRate=1,Fa._useAudioMusic=!0,Fa._muted=!1,Fa._soundMuted=!1,Fa._musicMuted=!1,Fa._bgMusic=null,Fa._musicChannel=null,Fa._channels=[],Fa._blurPaused=!1,Fa._isActive=!0,Fa._lastSoundUsedTimeDic={},Fa._isCheckingDispose=!1,Fa._soundCache={},Fa.autoReleaseSound=!0;class Ua{static __init__(){return Ua._baseClass||(Ua._baseClass=ka,ka.init()),Ua.items=Ua._baseClass.items,Ua.support=Ua._baseClass.support,Ua.support}static setItem(t,e){Ua._baseClass.setItem(t,e)}static getItem(t){return Ua._baseClass.getItem(t)}static setJSON(t,e){Ua._baseClass.setJSON(t,e)}static getJSON(t){return Ua._baseClass.getJSON(t)}static removeItem(t){Ua._baseClass.removeItem(t)}static clear(){Ua._baseClass.clear()}}Ua.support=!1;class ka{static init(){try{ka.support=!0,ka.items=window.localStorage,ka.setItem("laya","1"),ka.removeItem("laya")}catch(t){ka.support=!1}ka.support||console.log("LocalStorage is not supprot or browser is private mode.")}static setItem(t,e){try{ka.support&&ka.items.setItem(t,e)}catch(t){console.warn("set localStorage failed",t)}}static getItem(t){return ka.support?ka.items.getItem(t):null}static setJSON(t,e){try{ka.support&&ka.items.setItem(t,JSON.stringify(e))}catch(t){console.warn("set localStorage failed",t)}}static getJSON(t){try{return JSON.parse(ka.support?ka.items.getItem(t):null)}catch(e){return ka.items.getItem(t)}}static removeItem(t){ka.support&&ka.items.removeItem(t)}static clear(){ka.support&&ka.items.clear()}}ka.support=!1;class Ga extends Cr{constructor(){super(t.RenderSpriteData.Primitive),Ga.prototype.initialize.call(this)}initialize(){this._defaultShader=dr.find("Sprite2DPrimitive")}reinit(){super.initialize(),this.initialize()}}class Va extends Cr{constructor(){super(t.RenderSpriteData.Texture2D),Va.prototype.initialize.call(this)}initialize(){this._blurInfo=new Qe,this._u_blurInfo1=new u,this._u_blurInfo2=new u,this._u_TexRange=new u,this._colorMat=new $e,this._colorAlpha=new u,this._strength_sig2_2sig2_gauss1=new u,this._defaultShader=dr.find("Sprite2DTexture"),this.blurInfo=this._blurInfo,this.u_blurInfo1=this._u_blurInfo1,this.u_blurInfo2=this._u_blurInfo2,this.u_TexRange=this._u_TexRange,this.colorMat=this._colorMat,this.colorAlpha=this._colorAlpha,this.strength_sig2_2sig2_gauss1=this._strength_sig2_2sig2_gauss1}reinit(){super.initialize(),this.initialize()}get blurInfo(){return this.shaderData.getVector2(Rr.UNIFORM_BLURINFO)}set blurInfo(t){this.shaderData.setVector2(Rr.UNIFORM_BLURINFO,t)}get u_blurInfo1(){return this.shaderData.getVector(Rr.UNIFORM_BLURINFO1)}set u_blurInfo1(t){this.shaderData.setVector(Rr.UNIFORM_BLURINFO1,t)}get u_blurInfo2(){return this.shaderData.getVector(Rr.UNIFORM_BLURINFO2)}set u_blurInfo2(t){this.shaderData.setVector(Rr.UNIFORM_BLURINFO2,t)}get u_TexRange(){return this.shaderData.getVector(Rr.UNIFORM_TEXRANGE)}set u_TexRange(t){this.shaderData.setVector(Rr.UNIFORM_TEXRANGE,t)}get colorMat(){return this.shaderData.getMatrix4x4(Rr.UNIFORM_COLORMAT)}set colorMat(t){this.shaderData.setMatrix4x4(Rr.UNIFORM_COLORMAT,t)}get colorAlpha(){return this.shaderData.getVector(Rr.UNIFORM_COLORALPHA)}set colorAlpha(t){this.shaderData.setVector(Rr.UNIFORM_COLORALPHA,t)}get strength_sig2_2sig2_gauss1(){return this.shaderData.getVector(Rr.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1)}set strength_sig2_2sig2_gauss1(t){this.shaderData.setVector(Rr.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,t)}}class Ha{static set cursor(t){Ha._style.cursor=t}static get cursor(){return Ha._style.cursor}static __init__(){Ha._style=A.document.body.style}static hide(){"none"!=Ha.cursor&&(Ha._preCursor=Ha.cursor,Ha.cursor="none")}static show(){"none"==Ha.cursor&&(Ha._preCursor?Ha.cursor=Ha._preCursor:Ha.cursor="auto")}}class za{static __init__(){za.I=new za,za.supportWeakMap||e.systemTimer.loop(za.delInterval,null,za.clearCache)}static clearCache(){for(var t=0,e=za._maps.length;t<e;t++){za._maps[t]._obj={}}}constructor(){this._obj={},za._maps.push(this)}set(t,e){null!=t&&(za.supportWeakMap||("string"==typeof t||"number"==typeof t?this._obj[t]=e:(t.$_GID||(t.$_GID=P.getGID()),this._obj[t.$_GID]=e)))}get(t){return null==t?null:za.supportWeakMap?void 0:"string"==typeof t||"number"==typeof t?this._obj[t]:this._obj[t.$_GID]}del(t){null!=t&&(za.supportWeakMap||("string"==typeof t||"number"==typeof t?delete this._obj[t]:delete this._obj[this._obj.$_GID]))}has(t){return null!=t&&(!za.supportWeakMap&&("string"==typeof t||"number"==typeof t?null!=this._obj[t]:null!=this._obj[this._obj.$_GID]))}}za.supportWeakMap=!1,za.delInterval=6e5,za._maps=[];class Wa{constructor(t,e,r){this._mapArray=[],this._blockName=t,this._singgle=r,this._glPointerID=e}add(t){-1==this._mapArray.indexOf(t)&&this._mapArray.push(t)}splitBuffer(t){let e=this._mapArray.indexOf(t);-1!=e&&this._mapArray.splice(e,1)}}class Ya{static create(t,e,r,i=!1){Ya._Map.get(t)||Ya._Map.set(t,new Wa(t,l.renderEngine.getUBOPointer(t),i));let s=Ya._Map.get(t);if(s._singgle&&s._mapArray.length>0)return null;{let a=l.renderOBJCreate.createUniformBufferObject(s._glPointerID,t,e,r,i);return s._singgle&&s.add(a),a}}static getBuffer(t,e){let r=Ya._Map.get(t);return r?r._mapArray[e]:null}constructor(e,r,i,s,a){this._isSingle=!1,this.bufferType=t.BufferTargetType.UNIFORM_BUFFER,this.bufferUsage=i,this._glPointer=e,this.byteLength=s,this._name=r,this._isSingle=a,this._glBuffer=l.renderEngine.createBuffer(t.BufferTargetType.UNIFORM_BUFFER,i),this.bind(),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}_bindUniformBufferBase(){this._glBuffer.bindBufferBase(this._glPointer)}_bindBufferRange(t,e){this.bind(),this._glBuffer.bindBufferRange(this._glPointer,t,e)}_reset(t){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null),this.byteLength=t,this._glBuffer=l.renderEngine.createBuffer(this.bufferType,this.bufferUsage),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}bind(){return this._glBuffer.bindBuffer()}setData(t,e=0,r=Number.MAX_SAFE_INTEGER){if(!(r<0))if(this.bind(),!(0==e&&r==this.byteLength)){var i=new Uint8Array(t.buffer,e,r);this._glBuffer.setData(i,e)}else this._glBuffer.setDataEx(t,e,t.length)}setDataByUniformBufferData(t){this._updateDataInfo==t?(this.setData(t._buffer,4*t._updateFlag.x,4*(t._updateFlag.y-t._updateFlag.x)),t._resetUpdateFlag()):(this.setData(t._buffer,0,this.byteLength),t._resetUpdateFlag(),this._updateDataInfo=t)}setDataByByUniformBufferDataOffset(t,e){let r=t.getbyteLength(),i=t._realByte;t._resetUpdateFlag(),this.bind(),this._glBuffer.setDataEx(t._buffer,e*r,i/4)}destroy(){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null)}}Ya.UBONAME_SCENE="SceneUniformBlock",Ya.UBONAME_CAMERA="CameraUniformBlock",Ya.UBONAME_SPRITE3D="SpriteUniformBlock",Ya.UBONAME_SHADOW="ShadowUniformBlock",Ya._Map=new Map,t.MaterialRenderMode=void 0,(ma=t.MaterialRenderMode||(t.MaterialRenderMode={}))[ma.RENDERMODE_OPAQUE=0]="RENDERMODE_OPAQUE",ma[ma.RENDERMODE_CUTOUT=1]="RENDERMODE_CUTOUT",ma[ma.RENDERMODE_TRANSPARENT=2]="RENDERMODE_TRANSPARENT",ma[ma.RENDERMODE_ADDTIVE=3]="RENDERMODE_ADDTIVE",ma[ma.RENDERMODE_ALPHABLENDED=4]="RENDERMODE_ALPHABLENDED",ma[ma.RENDERMODE_CUSTOME=5]="RENDERMODE_CUSTOME";class Xa extends b{static load(t,r){e.loader.load(t,r,null,Bt.MATERIAL)}static __initDefine__(){Xa.SHADERDEFINE_ALPHATEST=dr.getDefineByName("ALPHATEST"),Xa.SHADERDEFINE_MAINTEXTURE=dr.getDefineByName("MAINTEXTURE"),Xa.SHADERDEFINE_ADDTIVEFOG=dr.getDefineByName("ADDTIVEFOG"),Xa.ALPHATESTVALUE=dr.propertyNameToID("u_AlphaTestValue"),dr.CULL=dr.propertyNameToID("s_Cull"),dr.BLEND=dr.propertyNameToID("s_Blend"),dr.BLEND_SRC=dr.propertyNameToID("s_BlendSrc"),dr.BLEND_DST=dr.propertyNameToID("s_BlendDst"),dr.BLEND_SRC_RGB=dr.propertyNameToID("s_BlendSrcRGB"),dr.BLEND_DST_RGB=dr.propertyNameToID("s_BlendDstRGB"),dr.BLEND_SRC_ALPHA=dr.propertyNameToID("s_BlendSrcAlpha"),dr.BLEND_DST_ALPHA=dr.propertyNameToID("s_BlendDstAlpha"),dr.BLEND_EQUATION=dr.propertyNameToID("s_BlendEquation"),dr.BLEND_EQUATION_RGB=dr.propertyNameToID("s_BlendEquationRGB"),dr.BLEND_EQUATION_ALPHA=dr.propertyNameToID("s_BlendEquationAlpha"),dr.DEPTH_TEST=dr.propertyNameToID("s_DepthTest"),dr.DEPTH_WRITE=dr.propertyNameToID("s_DepthWrite"),dr.STENCIL_Ref=dr.propertyNameToID("s_StencilRef"),dr.STENCIL_TEST=dr.propertyNameToID("s_StencilTest"),dr.STENCIL_WRITE=dr.propertyNameToID("s_StencilWrite"),dr.STENCIL_Op=dr.propertyNameToID("s_StencilOp")}get renderQueue(){return this._renderQueue}set renderQueue(t){this._renderQueue=t,this._notifyOwnerElements()}_setOwnerElement(t){this.ownerElements.add(t),t.materialShaderData=this.shaderData,t.materialRenderQueue=this.renderQueue,t.subShader=this._shader.getSubShaderAt(0),t.materialId=this.id}_removeOwnerElement(t){this.ownerElements.delete(t)}_notifyOwnerElements(){this.ownerElements.forEach((t=>{this._setOwnerElement(t)}))}get shaderData(){return this._shaderValues}get alphaTestValue(){return this._shaderValues.getNumber(Xa.ALPHATESTVALUE)}set alphaTestValue(t){this._shaderValues.setNumber(Xa.ALPHATESTVALUE,t)}get alphaTest(){return this.shaderData.hasDefine(Xa.SHADERDEFINE_ALPHATEST)}set alphaTest(t){t?this._shaderValues.addDefine(Xa.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(Xa.SHADERDEFINE_ALPHATEST)}addDefine(t){this._shaderValues.addDefine(t)}removeDefine(t){this._shaderValues.removeDefine(t)}setDefine(t,e){e?this._shaderValues.addDefine(t):this._shaderValues.removeDefine(t)}hasDefine(t){return this._shaderValues.hasDefine(t)}get depthWrite(){return this._shaderValues.getBool(dr.DEPTH_WRITE)}set depthWrite(t){this._shaderValues.setBool(dr.DEPTH_WRITE,t)}get cull(){return this._shaderValues.getInt(dr.CULL)}set cull(t){this._shaderValues.setInt(dr.CULL,t)}get blend(){return this._shaderValues.getInt(dr.BLEND)}set blend(t){this._shaderValues.setInt(dr.BLEND,t)}get blendSrc(){return this._shaderValues.getInt(dr.BLEND_SRC)}set blendSrc(t){this._shaderValues.setInt(dr.BLEND_SRC,t)}get blendDst(){return this._shaderValues.getInt(dr.BLEND_DST)}set blendDst(t){this._shaderValues.setInt(dr.BLEND_DST,t)}get blendSrcAlpha(){return this._shaderValues.getInt(dr.BLEND_SRC_ALPHA)}set blendSrcAlpha(t){this._shaderValues.setInt(dr.BLEND_SRC_ALPHA,t)}get blendSrcRGB(){return this._shaderValues.getInt(dr.BLEND_SRC_RGB)}set blendSrcRGB(t){this._shaderValues.setInt(dr.BLEND_SRC_RGB,t)}get blendDstRGB(){return this._shaderValues.getInt(dr.BLEND_DST_RGB)}set blendDstRGB(t){this._shaderValues.setInt(dr.BLEND_DST_RGB,t)}get blendDstAlpha(){return this._shaderValues.getInt(dr.BLEND_DST_ALPHA)}set blendDstAlpha(t){this._shaderValues.setInt(dr.BLEND_DST_ALPHA,t)}get blendEquation(){return this._shaderValues.getInt(dr.BLEND_EQUATION)}set blendEquation(t){this._shaderValues.setInt(dr.BLEND_EQUATION,t)}get blendEquationRGB(){return this._shaderValues.getInt(dr.BLEND_EQUATION_RGB)}set blendEquationRGB(t){this._shaderValues.setInt(dr.BLEND_EQUATION_RGB,t)}get blendEquationAlpha(){return this._shaderValues.getInt(dr.BLEND_EQUATION_ALPHA)}set blendEquationAlpha(t){this._shaderValues.setInt(dr.BLEND_EQUATION_ALPHA,t)}get depthTest(){return this._shaderValues.getInt(dr.DEPTH_TEST)}set depthTest(t){this._shaderValues.setInt(dr.DEPTH_TEST,t)}get stencilTest(){return this._shaderValues.getInt(dr.STENCIL_TEST)}set stencilTest(t){this._shaderValues.setInt(dr.STENCIL_TEST,t)}get stencilWrite(){return this._shaderValues.getBool(dr.STENCIL_WRITE)}set stencilWrite(t){this._shaderValues.setBool(dr.STENCIL_WRITE,t)}get stencilRef(){return this._shaderValues.getInt(dr.STENCIL_Ref)}set stencilRef(t){this._shaderValues.setInt(dr.STENCIL_Ref,t)}get stencilOp(){return this._shaderValues.getVector3(dr.STENCIL_Op)}set stencilOp(t){this._shaderValues.setVector3(dr.STENCIL_Op,t)}get MaterialProperty(){let t={};var e=this._shaderValues.getData();for(let r in e)t[l.renderEngine.propertyIDToName(parseInt(r))]=e[r];return t}get MaterialDefine(){let t=new Array,e=this._shaderValues.getDefineData();return dr._getNamesByDefineData(e,t),t}get materialRenderMode(){return this._matRenderNode}set materialRenderMode(e){switch(this._matRenderNode=e,e){case t.MaterialRenderMode.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Xa.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.blend=xe.BLEND_DISABLE,this.depthTest=xe.DEPTHTEST_LESS;break;case t.MaterialRenderMode.RENDERMODE_CUTOUT:this.renderQueue=Xa.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.blend=xe.BLEND_DISABLE,this.depthTest=xe.DEPTHTEST_LESS;break;case t.MaterialRenderMode.RENDERMODE_TRANSPARENT:this.renderQueue=Xa.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=xe.BLEND_ENABLE_ALL,this.blendSrc=xe.BLENDPARAM_SRC_ALPHA,this.blendDst=xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=xe.DEPTHTEST_LESS;break;case t.MaterialRenderMode.RENDERMODE_ADDTIVE:this.renderQueue=Xa.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=xe.BLEND_ENABLE_ALL,this.blendSrc=xe.BLENDPARAM_SRC_ALPHA,this.blendDst=xe.BLENDPARAM_ONE,this.depthTest=xe.DEPTHTEST_LESS,this._shaderValues.addDefine(Xa.SHADERDEFINE_ADDTIVEFOG);break;case t.MaterialRenderMode.RENDERMODE_ALPHABLENDED:this.renderQueue=Xa.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=xe.BLEND_ENABLE_ALL,this.blendSrc=xe.BLENDPARAM_SRC_ALPHA,this.blendDst=xe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=xe.DEPTHTEST_LESS,this._shaderValues.removeDefine(Xa.SHADERDEFINE_ADDTIVEFOG);break;case t.MaterialRenderMode.RENDERMODE_CUSTOME:break;default:console.warn(`Material : renderMode value error - (${e}).`)}}constructor(){super(),this.ownerElements=new Set,this._shaderValues=l.renderDeviceFactory.createShaderData(this),this.renderQueue=Xa.RENDERQUEUE_OPAQUE,this._matRenderNode=0,this.alphaTest=!1,this.cull=xe.CULL_BACK,this.blend=xe.BLEND_DISABLE,this.blendSrc=xe.BLENDPARAM_ONE,this.blendDst=xe.BLENDPARAM_ZERO,this.blendSrcRGB=xe.BLENDPARAM_ONE,this.blendDstRGB=xe.BLENDPARAM_ZERO,this.blendSrcAlpha=xe.BLENDPARAM_ONE,this.blendDstAlpha=xe.BLENDPARAM_ZERO,this.blendEquation=xe.BLENDEQUATION_ADD,this.blendEquationRGB=xe.BLENDEQUATION_ADD,this.blendEquationAlpha=xe.BLENDEQUATION_ADD,this.depthTest=xe.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=xe.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new d(xe.STENCILOP_KEEP,xe.STENCILOP_KEEP,xe.STENCILOP_REPLACE),this.destroyedImmediately=f.destroyResourceImmediatelyDefault}_bindShaderInfo(e){let r=e.getSubShaderAt(0)._uniformBufferDataMap;if(r)for(let e of r.keys()){let i=r.get(e).clone(),s=Ya.create(e,t.BufferUsage.Dynamic,i.getbyteLength(),!1);this._shaderValues.setUniformBuffer(dr.propertyNameToID(e),s),this._shaderValues._addCheckUBO(e,s,i)}}_releaseUBOData(){this._shaderValues._releaseUBOData()}_disposeResource(){this._releaseUBOData(),this._shaderValues.destroy(),this._shaderValues=null,this.ownerElements.clear()}get shader(){return this._shader}effectiveProperty(){return this._shader.getSubShaderAt(0)._uniformTypeMap}setShaderName(t){this._shader=dr.find(t),this._shader||(console.warn(`Material: unknown shader name '${t}'`),this._shader=dr.find("BLINNPHONG")),_._uniformBlock&&(this._releaseUBOData(),this._bindShaderInfo(this._shader));let e=this._shader.getSubShaderAt(0),r=e._uniformDefaultValue,i=e._uniformTypeMap;this.applyUniformDefaultValue(i,r),this._notifyOwnerElements()}applyUniformDefaultValue(t,e){t.forEach(((t,r)=>{if(e&&null!=e[r]){let i=e[r];this.setShaderData(r,t,i)}else{let e=er(t);e&&this.setShaderData(r,t,e)}}))}getBoolByIndex(t){return this.shaderData.getBool(t)}setBoolByIndex(t,e){this.shaderData.setBool(t,e)}getBool(t){let e=dr.propertyNameToID(t);return this.getBoolByIndex(e)}setBool(t,e){let r=dr.propertyNameToID(t);this.setBoolByIndex(r,e)}getFloatByIndex(t){return this.shaderData.getNumber(t)}setFloatByIndex(t,e){this.shaderData.setNumber(t,e)}getFloat(t){let e=dr.propertyNameToID(t);return this.getFloatByIndex(e)}setFloat(t,e){let r=dr.propertyNameToID(t);this.setFloatByIndex(r,e)}getIntByIndex(t){return this.shaderData.getInt(t)}setIntByIndex(t,e){this.shaderData.setInt(t,e)}getInt(t){let e=dr.propertyNameToID(t);return this.getIntByIndex(e)}setInt(t,e){let r=dr.propertyNameToID(t);this.setIntByIndex(r,e)}getVector2ByIndex(t){return this.shaderData.getVector2(t)}setVector2ByIndex(t,e){this.shaderData.setVector2(t,e)}getVector2(t){let e=dr.propertyNameToID(t);return this.getVector2ByIndex(e)}setVector2(t,e){let r=dr.propertyNameToID(t);this.setVector2ByIndex(r,e)}getVector3ByIndex(t){return this.shaderData.getVector3(t)}setVector3ByIndex(t,e){this.shaderData.setVector3(t,e)}getVector3(t){let e=dr.propertyNameToID(t);return this.getVector3ByIndex(e)}setVector3(t,e){let r=dr.propertyNameToID(t);this.setVector3ByIndex(r,e)}setVector4ByIndex(t,e){this.shaderData.setVector(t,e)}getVector4ByIndex(t){return this.shaderData.getVector(t)}setVector4(t,e){let r=dr.propertyNameToID(t);this.setVector4ByIndex(r,e)}getVector4(t){let e=dr.propertyNameToID(t);return this.getVector4ByIndex(e)}getColorByIndex(t){return this.shaderData.getColor(t)}setColorByIndex(t,e){this.shaderData.setColor(t,e)}getColor(t){let e=dr.propertyNameToID(t);return this.shaderData.getColor(e)}setColor(t,e){let r=dr.propertyNameToID(t);this.setColorByIndex(r,e)}getMatrix4x4ByIndex(t){return this.shaderData.getMatrix4x4(t)}setMatrix4x4ByIndex(t,e){this.shaderData.setMatrix4x4(t,e)}getMatrix4x4(t){let e=dr.propertyNameToID(t);return this.getMatrix4x4ByIndex(e)}setMatrix4x4(t,e){let r=dr.propertyNameToID(t);this.setMatrix4x4ByIndex(r,e)}getMatrix3x3ByIndex(t){return this.shaderData.getMatrix3x3(t)}setMatrix3x3ByIndex(t,e){this.shaderData.setMatrix3x3(t,e)}getMatrix3x3(t){let e=dr.propertyNameToID(t);return this.getMatrix3x3ByIndex(e)}setMatrix3x3(t,e){let r=dr.propertyNameToID(t);this.setMatrix3x3ByIndex(r,e)}setTextureByIndex(t,e){this.shaderData.setTexture(t,e),e&&!e._texture&&e.once(s.READY,this,this.reSetTexture,[t,e])}reSetTexture(t,e){this.setTextureByIndex(t,e)}getTextureByIndex(t){return this.shaderData.getTexture(t)}setTexture(t,e){let r=dr.propertyNameToID(t);this.setTextureByIndex(r,e)}getTexture(t){let e=dr.propertyNameToID(t);return this.getTextureByIndex(e)}getBufferByIndex(t){return this.shaderData.getBuffer(t)}setBufferByIndex(t,e){this.shaderData.setBuffer(t,e)}getBuffer(t){let e=dr.propertyNameToID(t);return this.getBufferByIndex(e)}setBuffer(t,e){let r=dr.propertyNameToID(t);this.setBufferByIndex(r,e)}setShaderDataByIndex(t,e,r){this.shaderData.setShaderData(t,e,r)}setShaderData(t,e,r){let i=dr.propertyNameToID(t);this.setShaderDataByIndex(i,e,r)}getShaderData(t,e){let r=dr.propertyNameToID(t);return this.getShaderDataByIndex(r,e)}getShaderDataByIndex(t,e){return this._shaderValues.getShaderData(t,e)}cloneTo(t){t.name=this.name,t.renderQueue=this.renderQueue,t.setShaderName(this._shader._name),this._shaderValues.cloneTo(t._shaderValues)}clone(){var t=new Xa;return this.cloneTo(t),t}get _defineDatas(){return this._shaderValues.getDefineData()}oldparseEndEvent(){}}Xa.RENDERQUEUE_OPAQUE=2e3,Xa.RENDERQUEUE_ALPHATEST=2450,Xa.RENDERQUEUE_TRANSPARENT=3e3;class ja{static init(...r){if(ja._inited)return Promise.resolve();if(ja._inited=!0,se.renderPassStatArray.length=t.RenderPassStatisticsInfo.RenderPassStatisticCount,!ba.enable())throw new Error("Must support webGL!");let i;i="number"==typeof r[0]?{designWidth:r[0],designHeight:r[1]}:r[0],A.__init__(),O.__init__();let s=window.Laya3D;s&&(Ra.changeWebGLSize=s._changeWebGLSize,ca.is3DMode=!0);let a=A.mainCanvas=new bi(!0);ja._setStyleInfo(a),A.onKGMiniGame||A.onAlipayMiniGame||A.onTBMiniGame||A.container.appendChild(a.source),A.canvas=new bi(!0),A.context=A.canvas.getContext("2d"),A.supportWebAudio=Fa.__init__(),A.supportLocalStorage=Ua.__init__(),t.systemTimer=new Sa(!1),t.physicsTimer=new Sa(!1),t.timer=new Sa(!1),t.loader=new Bt,ja.systemTimer=Sa.gSysTimer=t.systemTimer,ja.timer=t.timer,ja.physicsTimer=t.physicsTimer,ja.loader=t.loader,e.systemTimer=t.systemTimer,e.physicsTimer=t.physicsTimer,e.timer=t.timer,e.loader=t.loader,za.__init__(),Ha.__init__(),ds.beginCheck();let o=[];n.beforeInit&&o.push((()=>n.beforeInit(i))),ja._beforeInitCallbacks.forEach((t=>o.push((()=>t(i))))),o.push((()=>l.renderOBJCreate.createEngine(null,A.mainCanvas))),o.push((()=>ja.initRender2D(i))),s&&o.push((()=>s.__init__())),o.push((()=>Promise.all(ja._initCallbacks.map((t=>t()))))),o.push((()=>{let t=Promise.resolve();for(let e of ja._afterInitCallbacks)t=t.then(e);return t})),n.afterInit&&o.push((()=>n.afterInit()));let h=Promise.resolve();for(let t of o)h=h.then(t);return h}static _setStyleInfo(t){let e=t.source.style;e.position="absolute",e.top=e.left="0px",e.background="#000000"}static initRender2D(r){t.stage=window.stage=e.stage=ja.stage=new Aa,$t.__init__(),or.__init__(),dr.init(),te.__int__(),ii.__init__(),ri.__init__(),ja.render=ja.createRender(),t.render=ja.render,t.stage.size(r.designWidth,r.designHeight),r.scaleMode&&(t.stage.scaleMode=r.scaleMode),r.screenMode&&(t.stage.screenMode=r.screenMode),r.alignV&&(t.stage.alignV=r.alignV),r.alignH&&(t.stage.alignH=r.alignH),f.isAlpha?t.stage.bgColor="#00000000":r.backgroundColor&&(t.stage.bgColor=r.backgroundColor),n.isConch&&window.conch.setGlobalRepaint&&window.conch.setGlobalRepaint(t.stage.setGlobalRepaint.bind(t.stage)),_r.__init__(),Di.__init__(),Xa.__initDefine__(),mr._Defaultinit(),aa.__init__(t.stage,ca.canvas),window.conch&&"conchUseWXAdapter"in A.window&&(va.isAppUseNewInput=!0),va.__init__(),Fa.autoStopMusic=!0,Cr._initone(t.RenderSpriteData.Texture2D,Va),Cr._initone(t.RenderSpriteData.Primitive,Ga)}static createRender(){return new ca(0,0,A.mainCanvas)}static alertGlobalError(t){var e=0;A.window.onerror=t?function(t,r,i,s,a){e++<5&&a&&this.alert("出错啦，请把此信息截图给研发商\n"+t+"\n"+a.stack)}:null}static _runScript(t){return A.window[ja._evcode](t)}static enableDebugPanel(t="libs/laya.debugtool.js"){if(window.Laya.DebugPanel)window.Laya.DebugPanel.enable();else{var e=A.createElement("script");e.onload=function(){window.Laya.DebugPanel.enable()},e.src=t,A.document.body.appendChild(e)}}static addInitCallback(t){ja._initCallbacks.push(t)}static addBeforeInitCallback(t){ja._beforeInitCallbacks.push(t)}static addAfterInitCallback(t){ja._afterInitCallbacks.push(t)}}ja.stage=null,ja.systemTimer=null,ja.physicsTimer=null,ja.timer=null,ja.loader=null,ja._inited=!1,ja._initCallbacks=[],ja._beforeInitCallbacks=[],ja._afterInitCallbacks=[],ja._evcode="eval",ja.isNativeRender_enable=!1,e.Laya=ja,e.Loader=Bt,e.Context=li,e.Browser=A;var qa=ja.init;t.stage=void 0,t.systemTimer=void 0,t.physicsTimer=void 0,t.timer=void 0,t.loader=void 0,t.render=void 0;var $a=ja.alertGlobalError,Ka=ja.enableDebugPanel,Qa=ja.addInitCallback,Za=ja.addBeforeInitCallback,Ja=ja.addAfterInitCallback;class tn{get hideFlags(){return this._hideFlags}set hideFlags(t){this._hideFlags=t}constructor(){var t;this._hideFlags=0,this._status=0,this._enabled=!0,this._id=P.getGID(),this._singleton=null===(t=Object.getPrototypeOf(this)._$singleton)||void 0===t||t,this._initialize()}_initialize(){this._extra={}}hasHideFlag(t){return!!(this._hideFlags&t)}get id(){return this._id}get enabled(){return this._enabled}set enabled(t){this._enabled!=t&&(this._enabled=t,this.owner&&this._setActive(t&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(t){if(0!=this._status)throw new Error("reuse a destroyed component");this.owner=t,this._isScript()&&t._setBit(kt.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(t,e=null){}_parseInteractive(t=null,e=null){}_cloneTo(t){}_setActive(t){var r;t?(0==this._status&&(this._status=1,(n.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,(n.isPlaying||this.runInEditor)&&(this._driver=(null===(r=this.owner._is3D&&this.owner._scene)||void 0===r?void 0:r._componentDriver)||e.stage._componentDriver,this._driver.add(this),n.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()))):this._enableState&&(this._enableState=!1,(n.isPlaying||this.runInEditor)&&(this._driver&&this._driver.remove(this),e.stage.offAllCaller(this),this._onDisable()))}setupScript(){}destroy(){4!=this._status&&(this.owner?this.owner._destroyComponent(this):this.destroyed||this._destroy(!0))}_destroy(t){t?(n.isPlaying||this.runInEditor)&&(this._onDestroy(),this.onDestroy(),this.onReset&&(this.onReset(),this._resetComp(),r.recoverByClass(this))):(this._setActive(!1),this._status=4,(n.isPlaying||this.runInEditor)&&(this._driver||e.stage._componentDriver)._toDestroys.add(this),this._driver=null)}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}class en extends Ds{constructor(){super(),this.wrapMode=0,this._interval=f.animationInterval,this._isReverse=!1,this._frameRateChanged=!1,this._setBitUp(kt.DISPLAY)}play(t=0,e=!0,r=""){this._isPlaying=!0,this._actionName=r,this.index="string"==typeof t?this._getFrameByLabel(t):t,this.loop=e,this._isReverse=this.wrapMode===en.WRAP_REVERSE,0==this.index&&this._isReverse&&(this.index=this.count-1),this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)}get interval(){return this._interval}set interval(t){this._interval!=t&&(this._frameRateChanged=!0,this._interval=t,this._isPlaying&&t>0&&this.timerLoop(t,this,this._frameLoop,null,!0,!0))}_getFrameByLabel(t){for(var e=0;e<this._count;e++){var r=this._labels[e];if(r&&r.indexOf(t)>-1)return e}return 0}_frameLoop(){if(this._controlNode&&!this._controlNode._destroyed){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event(s.COMPLETE);this.wrapMode==en.WRAP_PINGPONG?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event(s.COMPLETE)}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event(s.COMPLETE);this.wrapMode==en.WRAP_PINGPONG?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event(s.COMPLETE)}this.index=this._index}else this.clearTimer(this,this._frameLoop)}_setControlNode(t){this._controlNode&&(this._controlNode.off(s.DISPLAY,this,this._resumePlay),this._controlNode.off(s.UNDISPLAY,this,this._resumePlay)),this._controlNode=t,t&&t!=this&&(t.on(s.DISPLAY,this,this._resumePlay),t.on(s.UNDISPLAY,this,this._resumePlay))}_setDisplay(t){super._setDisplay(t),this._resumePlay()}_resumePlay(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))}stop(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)}get isPlaying(){return this._isPlaying}addLabel(t,e){this._labels||(this._labels={}),this._labels[e]||(this._labels[e]=[]),this._labels[e].push(t)}removeLabel(t){if(t){if(this._labels)for(var e in this._labels)this._removeLabelFromList(this._labels[e],t)}else this._labels=null}_removeLabelFromList(t,e){if(t)for(var r=t.length-1;r>=0;r--)t[r]==e&&t.splice(r,1)}gotoAndStop(t){this.index="string"==typeof t?this._getFrameByLabel(t):t,this.stop()}get index(){return this._index}set index(t){if(this._index=t,this._displayToIndex(t),this._labels&&this._labels[t])for(var e=this._labels[t],r=0,i=e.length;r<i;r++)this.event(s.LABEL,e[r])}_displayToIndex(t){}get count(){return this._count}clear(){return this.stop(),this._labels=null,this}}en.WRAP_POSITIVE=0,en.WRAP_REVERSE=1,en.WRAP_PINGPONG=2;class rn{static subtractVector3(t,e,r){r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2]}static lerp(t,e,r){return t*(1-r)+e*r}static scaleVector3(t,e,r){r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e}static lerpVector3(t,e,r,i){var s=t[0],a=t[1],n=t[2];i[0]=s+r*(e[0]-s),i[1]=a+r*(e[1]-a),i[2]=n+r*(e[2]-n)}static lerpVector4(t,e,r,i){var s=t[0],a=t[1],n=t[2],l=t[3];i[0]=s+r*(e[0]-s),i[1]=a+r*(e[1]-a),i[2]=n+r*(e[2]-n),i[3]=l+r*(e[3]-l)}static slerpQuaternionArray(t,e,r,i,s,a,n){var l,o,h,u,d,c=t[e+0],_=t[e+1],p=t[e+2],f=t[e+3],g=r[i+0],m=r[i+1],y=r[i+2],T=r[i+3];return(o=c*g+_*m+p*y+f*T)<0&&(o=-o,g=-g,m=-m,y=-y,T=-T),1-o>1e-6?(l=Math.acos(o),h=Math.sin(l),u=Math.sin((1-s)*l)/h,d=Math.sin(s*l)/h):(u=1-s,d=s),a[n+0]=u*c+d*g,a[n+1]=u*_+d*m,a[n+2]=u*p+d*y,a[n+3]=u*f+d*T,a}static getRotation(t,e,r,i){return Math.atan2(i-e,r-t)/Math.PI*180}static sortBigFirst(t,e){return t==e?0:e>t?1:-1}static sortSmallFirst(t,e){return t==e?0:e>t?-1:1}static sortNumBigFirst(t,e){return parseFloat(e)-parseFloat(t)}static sortNumSmallFirst(t,e){return parseFloat(t)-parseFloat(e)}static sortByKey(t,e=!1,r=!0){var i;return i=e?r?rn.sortNumBigFirst:rn.sortBigFirst:r?rn.sortNumSmallFirst:rn.sortSmallFirst,function(e,r){return i(e[t],r[t])}}}class sn extends en{static _sortIndexFun(t,e){return t.index-e.index}constructor(){super(),void 0===sn._sortIndexFun&&(sn._sortIndexFun=rn.sortByKey("index",!1,!0))}_setUp(t,e){this._targetDic=t,this._animationData=e,this.interval=1e3/e.frameRate,e.parsed?(this._count=e.count,this._labels=e.labels,this._usedFrames=e.animationNewFrames):(this._usedFrames=[],this._calculateDatas(),e.parsed=!0,e.labels=this._labels,e.count=this._count,e.animationNewFrames=this._usedFrames)}clear(){return super.clear(),this._targetDic=null,this._animationData=null,this}_displayToIndex(t){if(this._animationData){t<0&&(t=0),t>this._count&&(t=this._count);var e,r=this._animationData.nodes,i=r.length;for(e=0;e<i;e++)this._displayNodeToFrame(r[e],t)}}_displayNodeToFrame(t,e,r=null){r||(r=this._targetDic);var i=r[t.target];if(i){var s,a,n,l,o=t.frames,h=t.keys,u=h.length;for(l=0;l<u;l++)n=(a=o[s=h[l]]).length>e?a[e]:a[a.length-1],i[s]=n;var d,c=t.funkeys;if(0!=(u=c.length))for(l=0;l<u;l++)void 0!==(d=o[s=c[l]])[e]&&i[s]&&i[s].apply(i,d[e])}}_calculateDatas(){if(this._animationData){var t,e,r=this._animationData.nodes,i=r.length;for(this._count=0,t=0;t<i;t++)e=r[t],this._calculateKeyFrames(e);this._count+=1}}_calculateKeyFrames(t){var e,r,i=t.keyframes,s=t.target;for(e in t.frames||(t.frames={}),t.keys?t.keys.length=0:t.keys=[],t.funkeys?t.funkeys.length=0:t.funkeys=[],t.initValues||(t.initValues={}),i){var a=-1!=e.indexOf("()");if(r=i[e],a&&(e=e.substr(0,e.length-2)),t.frames[e]||(t.frames[e]=[]),a){t.funkeys.push(e);for(var n=t.frames[e],l=0;l<r.length;l++){var o=r[l];n[o.index]=o.value,o.index>this._count&&(this._count=o.index)}}else this._targetDic&&this._targetDic[s]&&(t.initValues[e]=this._targetDic[s][e]),r.sort(sn._sortIndexFun),t.keys.push(e),this._calculateNodePropFrames(r,t.frames[e],e,s)}}resetNodes(){if(this._targetDic&&this._animationData){var t,e,r,i=this._animationData.nodes,s=i.length;for(t=0;t<s;t++)if(r=(e=i[t]).initValues){var a,n=this._targetDic[e.target];if(n)for(a in r)n[a]=r[a]}}}_calculateNodePropFrames(t,e,r,i){var s,a=t.length-1;for(e.length=t[a].index+1,s=0;s<a;s++)this._dealKeyFrame(t[s]),this._calculateFrameValues(t[s],t[s+1],e);0==a&&(e[0]=t[0].value,this._usedFrames&&(this._usedFrames[t[0].index]=!0)),this._dealKeyFrame(t[s])}_dealKeyFrame(t){t.label&&""!=t.label&&this.addLabel(t.label,t.index)}_calculateFrameValues(t,e,r){var i,s,a=t.index,n=e.index,l=t.value,o=e.value-t.value,h=n-a,u=this._usedFrames;if(n>this._count&&(this._count=n),t.tween)for(null==(s=vs[t.tweenMethod])&&(s=vs.linearNone),i=a;i<n;i++)r[i]=s(i-a,l,o,h),u&&(u[i]=!0);else for(i=a;i<n;i++)r[i]=l;u&&(u[t.index]=!0,u[e.index]=!0),r[e.index]=e.value}}class an extends sn{constructor(){super(...arguments),this._nodeIDAniDic={}}_parseNodeList(t){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[t.compId]=t.props,t.compId&&this._nodeList.push(t.compId);var e=t.child;if(e){var r,i=e.length;for(r=0;r<i;r++)this._parseNodeList(e[r])}}_calGraphicData(t){var e;if(this._setUp(null,t),this._createGraphicData(),this._nodeIDAniDic)for(e in this._nodeIDAniDic)this._nodeIDAniDic[e]=null}_createGraphicData(){var t,e,r=[],i=this.count,s=this._usedFrames;for(s||(s=[]),t=0;t<i;t++)!s[t]&&e||(e=this._createFrameGraphic(t)),r.push(e);this._gList=r}_createFrameGraphic(t){var e=new fs;return an._rootMatrix||(an._rootMatrix=new G),this._updateNodeGraphic(this._rootNode,t,an._rootMatrix,e),e}_updateNodeGraphic(t,e,r,i,s=1){var a,n,l;(a=this._nodeGDic[t.compId]=this._getNodeGraphicData(t.compId,e,this._nodeGDic[t.compId])).resultTransform||(a.resultTransform=new G),n=a.resultTransform,G.mul(a.transform,r,n);var o=a.alpha*s;if(!(o<.01)){a.skin&&(l=this._getTextureByUrl(a.skin))&&(n._checkTransform()?(i.drawTexture(l,0,0,a.width,a.height,n,o),a.resultTransform=null):i.drawTexture(l,n.tx,n.ty,a.width,a.height,null,o));var h,u,d=t.child;if(d)for(u=d.length,h=0;h<u;h++)this._updateNodeGraphic(d[h],e,n,i,o)}}_updateNoChilds(t,e){if(t.skin){var r=this._getTextureByUrl(t.skin);if(r){var i=t.transform;i._checkTransform(),!i._bTransform?e.drawTexture(r,i.tx,i.ty,t.width,t.height,null,t.alpha):e.drawTexture(r,0,0,t.width,t.height,i.clone(),t.alpha)}}}_updateNodeGraphic2(t,e,r){var i;if(i=this._nodeGDic[t.compId]=this._getNodeGraphicData(t.compId,e,this._nodeGDic[t.compId]),t.child){var s,a,n,l=i.transform;l._checkTransform(),a=(s=!l._bTransform)&&(0!=l.tx||0!=l.ty),(n=l._bTransform||1!=i.alpha)&&r.save(),1!=i.alpha&&r.alpha(i.alpha),s?a&&r.translate(l.tx,l.ty):r.transform(l.clone());var o,h,u,d=t.child;if(i.skin&&(o=this._getTextureByUrl(i.skin))&&r.drawImage(o,0,0,i.width,i.height),d)for(u=d.length,h=0;h<u;h++)this._updateNodeGraphic2(d[h],e,r);n?r.restore():s?a&&r.translate(-l.tx,-l.ty):r.transform(l.clone().invert())}else this._updateNoChilds(i,r)}_calculateKeyFrames(t){super._calculateKeyFrames(t),this._nodeIDAniDic[t.target]=t}getNodeDataByID(t){return this._nodeIDAniDic[t]}_getParams(t,e,r,i){var s=an._temParam;s.length=e.length;var a,n=e.length;for(a=0;a<n;a++)s[a]=this._getObjVar(t,e[a][0],r,e[a][1],i);return s}_getObjVar(t,e,r,i,s){if(e in t){var a=t[e];return r>=a.length&&(r=a.length-1),t[e][r]}return e in s?s[e]:i}_getNodeGraphicData(t,e,r){r||(r=new nn),r.transform?r.transform.identity():r.transform=new G;var i=this.getNodeDataByID(t);if(!i)return r;var s,a,n,l=i.frames,o=this._getParams(l,an._drawTextureCmd,e,this._nodeDefaultProps[t]),h=o[0],u=o[5],d=o[6],c=o[13],_=o[14],p=o[7],f=o[8],g=o[9],m=o[11],y=o[12];s=o[3],a=o[4],0!=s&&0!=a||(h=null),-1==s&&(s=0),-1==a&&(a=0),r.skin=h,r.width=s,r.height=a,h&&((n=this._getTextureByUrl(h))?(s||(s=n.sourceWidth),a||(a=n.sourceHeight)):console.warn("lost skin:",h,",you may load pics first")),r.alpha=o[10];var T=r.transform;0!=c&&(u=c*s),0!=_&&(d=_*a),0==u&&0==d||T.translate(-u,-d);var x=null;if(g||1!==p||1!==f||m||y){(x=an._tempMt).identity(),x._bTransform=!0;var v=.0174532922222222*(g-m),S=.0174532922222222*(g+y),E=Math.cos(S),w=Math.sin(S),D=Math.sin(v),b=Math.cos(v);x.a=p*E,x.b=p*w,x.c=-f*D,x.d=f*b,x.tx=x.ty=0}return x&&(T=G.mul(T,x,T)),T.translate(o[1],o[2]),r}_getTextureByUrl(t){return Bt.getRes(t)}setAniData(t,e=null){if(t.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t);var r,i,s={},a=[],n=t.animations,l=n.length;for(r=0;r<l;r++)if(i=n[r],this._labels=null,(!e||e==i.name)&&i){try{this._calGraphicData(i)}catch(t){console.warn("parse animation fail:"+i.name+",empty animation created"),this._gList=[]}var o={};o.interval=1e3/i.frameRate,o.frames=this._gList,o.labels=this._labels,o.name=i.name,a.push(o),s[i.name]=o}this.animationList=a,this.animationDic=s}an._temParam.length=0}parseByData(t){var e,r;e=t.nodeRoot,r=t.aniO,delete t.nodeRoot,delete t.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e),this._labels=null;try{this._calGraphicData(r)}catch(t){console.warn("parse animation fail:"+r.name+",empty animation created"),this._gList=[]}var i=t;return i.interval=1e3/r.frameRate,i.frames=this._gList,i.labels=this._labels,i.name=r.name,i}setUpAniData(t){if(t.animations){var e,r,i={},s=[],a=t.animations,n=a.length;for(e=0;e<n;e++)if(r=a[e]){var l={};l.name=r.name,l.aniO=r,l.nodeRoot=t,s.push(l),i[r.name]=l}this.animationList=s,this.animationDic=i}}_clear(){this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic=null}static parseAnimationByData(t){var e;return an._I||(an._I=new an),e=an._I.parseByData(t),an._I._clear(),e}static parseAnimationData(t){var e;return an._I||(an._I=new an),an._I.setUpAniData(t),(e={}).animationList=an._I.animationList,e.animationDic=an._I.animationDic,an._I._clear(),e}}an._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]],an._temParam=[],an._tempMt=new G;class nn{constructor(){this.alpha=1}}class ln extends en{constructor(){super(),this._autoPlay=!1,this._setControlNode(this)}destroy(t=!0){if(this.stop(),super.destroy(t),this._atlasCatch)for(let t of this._atlasCatch)t._removeReference(),0==t.referenceCount&&t.destroy();this._atlasCatch=null,this._frames=null,this._labels=null}play(t=0,e=!0,r=""){r&&this._setFramesFromCache(r,!0),super.play(t,e,r)}_setFramesFromCache(t,e=!1){if(this._url&&(t=this._url+"#"+t),t&&ln.framesMap[t]){var r=ln.framesMap[t];return r instanceof Array?(this._frames=ln.framesMap[t],this._count=this._frames.length):(r.nodeRoot&&(ln.framesMap[t]=an.parseAnimationByData(r),r=ln.framesMap[t]),this._frames=r.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=r.interval),this._labels=this._copyLabels(r.labels)),!0}return e&&console.log("ani not found:",t),!1}_copyLabels(t){if(!t)return null;var e,r;for(r in e={},t)e[r]=P.copyArray([],t[r]);return e}_frameLoop(){this._visible&&this._style.alpha>.01&&this._frames&&super._frameLoop()}_displayToIndex(t){this._frames&&(this.graphics=this._frames[t])}get frames(){return this._frames}set frames(t){this._frames=t,t&&(this._count=t.length,this._actionName&&this._setFramesFromCache(this._actionName,!0),this.index=this._index)}get source(){return this._source}set source(t){this._source=t,t?t.indexOf(".ani")>-1?this.loadAnimation(t):t.startsWith("res://")||t.indexOf(".json")>-1||t.indexOf("als")>-1||t.indexOf("atlas")>-1?this.loadAtlas(t):this.loadImages(t.split(",")):this.clear()}set autoPlay(t){this._autoPlay=t,t?this.play():this.stop()}get autoPlay(){return this._autoPlay}clear(){return super.clear(),this.stop(),this.graphics=null,this._frames=null,this._labels=null,this}loadImages(t,e=""){return this._url="",this._setFramesFromCache(e)||(this.frames=ln.framesMap[e]?ln.framesMap[e]:ln.createFrames(t,e)),!this._isPlaying&&this._autoPlay&&this.play(),this}loadAtlas(t,r=null,i=""){if(this._url="",!this._setFramesFromCache(i)){let s=(e,s)=>{null==this._atlasCatch&&(this._atlasCatch=[]),0>this._atlasCatch.indexOf(s)&&(this._atlasCatch.push(s),s._addReference()),t===e&&(this.frames=ln.framesMap[i]?ln.framesMap[i]:ln.createFrames(t,i),!this._isPlaying&&this._autoPlay&&this.play(),r&&r.run())},a=Bt.getAtlas(t);a?s(t,a):e.loader.load(t,St.create(null,s,[t]),null,Bt.ATLAS)}return this}loadAnimation(t,r=null,i=null){this._url=t;return this._actionName||(this._actionName=""),this._setFramesFromCache(this._actionName)?(this._setFramesFromCache(this._actionName,!0),this.index=0,r&&r.run()):!i||Bt.getAtlas(i)?this._loadAnimationData(t,r,i):e.loader.load(i,St.create(this,this._loadAnimationData,[t,r,i]),null,Bt.ATLAS),this}_loadAnimationData(t,r=null,i=null){!i||Bt.getAtlas(i)?e.loader.fetch(t,"json").then((e=>{if(this._url!==t)return;if(!e)return void(ln.framesMap[t+"#"]&&(this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay(),r&&r.run()));let i;if(ln.framesMap[t+"#"])this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay();else{let r=an.parseAnimationData(e);if(!r)return;let s,a=r.animationList,n=a.length;for(let e=0;e<n;e++)i=a[e],ln.framesMap[t+"#"+i.name]=i,s||(s=i);s&&(ln.framesMap[t+"#"]=s,this._setFramesFromCache(this._actionName,!0),this.index=0),this._resumePlay()}r&&r.run()})):console.warn("atlas load fail:"+i)}static createFrames(t,e){var r;if("string"==typeof t){var i=Bt.getAtlas(t);if(i&&i.frames.length){let t=i.frames;r=[];for(var s=0,a=t.length;s<a;s++){var n=new fs;n.drawImage(t[s],0,0),r.push(n)}}}else if(t instanceof Array)for(r=[],s=0,a=t.length;s<a;s++)(n=new fs).loadImage(t[s],0,0),r.push(n);return e&&(ln.framesMap[e]=r),r}static clearCache(t){var e,r=ln.framesMap,i=t+"#";for(e in r)e!==t&&0!==e.indexOf(i)||delete ln.framesMap[e]}onAfterDeserialize(){super.onAfterDeserialize(),this.images&&(this._source||this.loadImages(this.images),delete this.images)}}ln.framesMap={};class on extends sn{constructor(){super(...arguments),this._initData={}}get target(){return this._target}set target(t){this._target&&this._target.off(on.EFFECT_BEGIN,this,this._onOtherBegin),this._target=t,this._target&&this._target.on(on.EFFECT_BEGIN,this,this._onOtherBegin),this._addEvent()}_onOtherBegin(t){t!==this&&this.stop()}set playEvent(t){this._playEvent=t,t&&this._addEvent()}_addEvent(){this._target&&this._playEvent&&(this._setControlNode(this._target),this._target.on(this._playEvent,this,this._onPlayAction))}_onPlayAction(){this.play(0,!1)}play(t=0,e=!0,r=""){this._target&&(this._target.event(on.EFFECT_BEGIN,[this]),this._recordInitData(),super.play(t,e,r))}_recordInitData(){var t,e,r;if(this._aniKeys)for(e=this._aniKeys.length,t=0;t<e;t++)r=this._aniKeys[t],this._initData[r]=this._target[r]}set effectClass(t){if(this._effectClass=Ot.getClass(t),this._effectClass){var e=this._effectClass.uiView;if(e){var r=e.animations;if(r&&r[0]){var i=r[0];this._setUp({},i),i.nodes&&i.nodes[0]&&(this._aniKeys=i.nodes[0].keys)}}}}set effectData(t){if(t){var e=t.animations;if(e&&e[0]){var r=e[0];this._setUp({},r),r.nodes&&r.nodes[0]&&(this._aniKeys=r.nodes[0].keys)}}}_displayToIndex(t){if(this._animationData){t<0&&(t=0),t>this._count&&(t=this._count);var e,r=this._animationData.nodes,i=r.length;for(i=i>1?1:i,e=0;e<i;e++)this._displayNodeToFrame(r[e],t)}}_displayNodeToFrame(t,e,r=null){if(this._target){var i,s,a,n,l,o,h,u,d,c=this._target,_=t.frames,p=t.keys,f=p.length,g=t.secondFrames;for(n=0;n<f;n++)s=_[i=p[n]],-1==(l=g[i])?a=this._initData[i]:e<l?(u=(h=t.keyframes[i])[0]).tween?(null==(o=vs[u.tweenMethod])&&(o=vs.linearNone),d=h[1],a=o(e,this._initData[i],d.value-this._initData[i],d.index)):a=this._initData[i]:a=s.length>e?s[e]:s[s.length-1],c[i]=a}}_calculateKeyFrames(t){super._calculateKeyFrames(t);var e,r,i=t.keyframes;t.target;var s={};for(e in t.secondFrames=s,i)(r=i[e]).length<=1?s[e]=-1:s[e]=r[1].index}}on.EFFECT_BEGIN="effectbegin";class hn extends tn{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=Gt.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(s.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(s.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(s.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(s.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var t=this.resetLayoutX(),e=this.resetLayoutY();(t||e)&&this.owner.event(s.RESIZE)}resetLayoutX(){var t=this.owner;if(!t)return!1;var e=t.parent;if(e)if(null!=this._centerX)t.x=Math.round(.5*(e.width-t.displayWidth)+this._centerX+t.pivotX*t.scaleX);else if(null!=this._left){if(t.x=Math.round(this._left+t.pivotX*t.scaleX),null!=this._right){if(!e._width)return!1;var r=(e._width-this._left-this._right)/(t.scaleX||.01);if(r!=t._width)return t.width=r,!0}}else null!=this._right&&(t.x=Math.round(e.width-t.displayWidth-this._right+t.pivotX*t.scaleX));return!1}resetLayoutY(){var t=this.owner;if(!t)return!1;var e=t.parent;if(e)if(null!=this._centerY)t.y=Math.round(.5*(e.height-t.displayHeight)+this._centerY+t.pivotY*t.scaleY);else if(null!=this._top){if(t.y=Math.round(this._top+t.pivotY*t.scaleY),null!=this._bottom){if(!e._height)return!1;var r=(e._height-this._top-this._bottom)/(t.scaleY||.01);if(r!=t._height)return t.height=r,!0}}else null!=this._bottom&&(t.y=Math.round(e.height-t.displayHeight-this._bottom+t.pivotY*t.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(t){isNaN(t)&&(t=null),this._top!=t&&(this._top=t,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(t){isNaN(t)&&(t=null),this._bottom!=t&&(this._bottom=t,this.resetLayoutY())}get left(){return this._left}set left(t){isNaN(t)&&(t=null),this._left!=t&&(this._left=t,this.resetLayoutX())}get right(){return this._right}set right(t){isNaN(t)&&(t=null),this._right!=t&&(this._right=t,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(t){isNaN(t)&&(t=null),this._centerX!=t&&(this._centerX=t,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(t){isNaN(t)&&(t=null),this._centerY!=t&&(this._centerY=t,this.resetLayoutY())}}hn.EMPTY=null,hn.EMPTY=new hn;class un extends b{constructor(t){super(),this.version=t,this._traceDeps=!0}create(t,e){return this.json?pn.legacySceneOrPrefab.createByData(null,this.json):null}}var dn=un;class cn extends un{constructor(t,e,r){super(r),this.api=t,this.data=e}create(t,e){let r=this.api.parse(this.data,t,e);return Array.isArray(r)?(1==r.length&&(r[0].url=this.url),r[0]):(r.url=this.url,r)}}class _n{static parse(t,e,r){let i=null==r;r=r||[];let s,a,n,l,o,h,u,d={},c=[],_=[],p=[];function f(t,e){for(let r of t._$child)if(r._$child){let t=g(r,e);f(r,r._$prefab?t:e),c.push(r),_.push(t)}else{let t=g(r,e);c.push(r),_.push(t)}}function g(t,e,i){let s,a;if(a=t._$override){if(e&&n)if(Array.isArray(a)){s=e;for(let t=0,e=a.length;t<e;t++){let e=n.get(s);if(s=null==e?void 0:e[a[t]],!s)break}}else{let r=n.get(e);r&&(s=r[t._$override])}}else{if(a=t._$prefab){let e=Bt.getRes(O.getResURLByUUID(a),Bt.HIERARCHY);if(e){n||(n=new Map);let i=[],a=t._$id;if(o)for(let t=0,e=o.length;t<e;t++){let r=o[t];r&&r.length>0?i[t]=r.filter((r=>{let i=r._$override||r._$parent;return Array.isArray(i)&&i.length>e-t&&i[e-t-1]==a})):i[t]=r}i.push(t._$child),s=e.create({inPrefab:!0,prefabNodeDict:n,overrideData:i},r)}}else if(a=t._$type){let e=Ot.getClass(i||a);if(e)try{s=new e,null==i||s instanceof ms||(r.push(new Error(`runtime class invalid - '${i}', must derive from Node`)),s=null)}catch(t){r.push(t)}else r.push(new Error(`missing node type '${i||a}' (in ${t.name||"noname"})`))}s&&(d[t._$id]=s)}return s}function m(t,e,r=0){if(!e)return t;let i=null==n?void 0:n.get(t);if(!i)return null;if(Array.isArray(e)){let t;for(let s=r,a=e.length;s<a;s++){if(!i)return null;if(t=i[e[s]],!t)break;i=n.get(t)}return t}return i[e]}if(e&&(a=e.inPrefab,a&&(n=e.prefabNodeDict),l=e.skinBaseUrl,o=e.overrideData),t._$type||t._$prefab){u=t._$runtime,u&&u.startsWith("res://")&&(u=u.substring(6));let e=g(t,null,u);e&&(t._$child&&f(t,t._$prefab?e:null),c.push(t),_.push(e),e instanceof fn&&(s=e))}else t._$child&&f(t,null);let y=c.length,T=0,x=[];for(let t=0;t<y;t++){let e=c[t],r=_[t],i=e._$child;if(i){let t=i.length;if(r)if(e._$prefab)for(let e=0;e<t;e++){let i=T-t+e,s=p[i];if(s&&!s.parent){let t=x[i],e=m(r,t._$parent);if(e){let r=t._$index;null!=r&&r<e.numChildren?e.addChildAt(s,r):e.addChild(s)}else r.addChildAt(s,0)}}else for(let e=0;e<t;e++){let i=p[T-t+e];i&&(r===s&&i._is3D?s._scene3D=i:r.addChild(i))}T-=t}p[T]=r,x[T]=e,T++}p.length=T,p=p.filter((t=>null!=t));let v=p[0],S=[];for(let t=0;t<y;t++){let e=c[t]._$comp;if(!e)continue;let i=_[t];if(i)for(let t of e){let e,s=t._$override;if(t._$override){let t=Ot.getClass(s);e=t?i.getComponent(t):i.components.find((t=>t._extra.storeId==s))}else{let s=Ot.getClass(t._$type);if(s){if(t._$id||(e=i.getComponent(s)),!e)try{e=i.addComponent(s),e._extra.storeId=t._$id}catch(t){r.push(t)}}else r.push(new Error(`missing component type '${t._$type}' (in ${i.name||"noname"})`))}e&&S.push(t,e)}}const E={outErrors:r,getNodeByRef:function(t){if(Array.isArray(t)){let e=d[t[0]];return e&&t.length>1?m(e,t,1):e}return d[t]},getNodeData:function(t){t.visible=!1;let e=_.indexOf(t),r=c[e];return o?(void 0===h&&(h=ya.bakeOverrideData(o)),h?ya.applyOverrideData(r,h):r):r}};for(let t=0;t<y;t++){let e=c[t],i=_[t];if(i&&(null!=l&&i instanceof Ds&&(i._skinBaseUrl=l),ya.decodeObj(e,i,E),u&&e._$var&&i.name))try{v[i.name]=i}catch(t){r.push(t)}}y=S.length;for(let t=0;t<y;t+=2)ya.decodeObj(S[t],S[t+1],E);return a&&n&&v&&n.set(v,d),i&&r.length>0&&r.forEach((t=>console.error(t))),p}static collectResourceLinks(t,e){let r,i={},s=[];function a(t,r){if(!t)return"";let a=i[t];if(void 0===a){let n;n=P.isUUID(t)?"res://"+t:O.join(e,t),s.push({url:n,type:r}),i[t]=a=[n,r]}else-1==a.indexOf(r,1)&&(a.push(r),s.push({url:a[0],type:r}));return a[0]}function l(t){if(null==t._$uuid){if(null!=t._$prefab)t._$prefab=a(t._$prefab,Bt.HIERARCHY);else if(null!=(r=t._$type))if(r.endsWith(".bp"))a(r,null);else if(n.isPreview&&P.isUUID(r)){let t=Ot.getClass(r);(null==t||t._$loadable)&&a("res://"+r,null)}o(t)}else t._$uuid=a(t._$uuid,ya.getLoadTypeByEngineType(t._$type))}function o(t){for(let e in t){let r=t[e];if(null!=r)if(Array.isArray(r))for(let t of r)null!=t&&"object"==typeof t&&l(t);else"object"==typeof r&&l(r)}}if(o(t),t._$preloads)for(let e of t._$preloads)s.push(e);return s}}class pn{load(t){let e=t.url;return("gltf"==t.ext||"fbx"==t.ext||"glb"==t.ext||"obj"==t.ext)&&(e=N.inst.getSubAssetURL(e,t.uuid,"0","lh")),t.loader.fetch(e,"json",t.progress.createCallback(.2),t.options).then((e=>e?null!=e._$ver?this._load(pn.v3,t,e,3):"ls"==t.ext||"lh"==t.ext?this._load(pn.v2,t,e,2):"scene"==t.ext||"prefab"==t.ext?this._load(pn.legacySceneOrPrefab,t,e,2):null:null))}_load(t,e,r,i){let s=O.getPath(e.url),a=t.collectResourceLinks(r,s),n=Object.assign({},e.options);return n.initiator=e,delete n.cache,delete n.ignoreCache,e.loader.load(a,n,e.progress.createCallback()).then((e=>{let s=new cn(t,r,i);return s.addDeps(e),s}))}}pn.v3=_n,pn.v2=null,Bt.registerLoader(["lh","ls","scene","prefab"],pn,Bt.HIERARCHY);class fn extends Ds{constructor(t=!0){super(),this.autoDestroyAtClosed=!1,this._viewCreated=!1,this._timer=e.timer,this._widget=hn.EMPTY,this._scene=this,t&&this.createChildren(),this._shaderData=l.renderDeviceFactory.createShaderData(null)}createChildren(){}static setUIMap(t){let r=e.loader.getRes(t);if(!r)throw"请提前加载uimap的json，再使用该接口设置！";for(let t in r)e.Loader.loadedMap[t+".scene"]=r[t]}loadScene(t){fn.unDestroyedScenes.add(this);let r=t.indexOf(".")>-1?t:t+".scene",i=e.loader.getRes(r);i?this._viewCreated||(i.create({root:this}),this._viewCreated=!0,fn.unDestroyedScenes.add(this)):(this._setBit(kt.NOT_READY,!0),e.loader.load(r,null,(t=>{fn._loadPage&&fn._loadPage.event("progress",t)})).then((e=>{if(!e)throw"Can not find scene:"+t;this._viewCreated?this._setBit(kt.NOT_READY,!1):(this.url=r,fn.hideLoadingPage(),e.create({root:this}),this._viewCreated=!0,fn.unDestroyedScenes.add(this))})))}createView(t){t&&!this._viewCreated&&(this._viewCreated=!0,pn.legacySceneOrPrefab.createByData(this,t))}getNodeByID(t){return this._idMap?this._idMap[t]:null}open(t=!0,r=null){t&&fn.closeAll(),fn.root.addChild(this),this._scene3D&&e.stage.addChildAt(this._scene3D,0),this.onOpened(r)}onOpened(t){}close(t=null){this.onClosed(t),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(t=null){}destroy(t=!0){super.destroy(t),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,fn.unDestroyedScenes.delete(this)}get_width(){if(this._isWidthSet)return this._width;for(var t=0,e=this.numChildren-1;e>-1;e--){var r=this.getChildAt(e);r._visible&&(t=Math.max(r._x+r.width*r.scaleX,t))}return t}get_height(){if(this._isHeightSet)return this._height;for(var t=0,e=this.numChildren-1;e>-1;e--){var r=this.getChildAt(e);r._visible&&(t=Math.max(r._y+r.height*r.scaleY,t))}return t}get timer(){return this._timer}set timer(t){this._timer=t}get scene3D(){return this._scene3D}get sceneShaderData(){return this._shaderData}get top(){return this._widget.top}set top(t){t!=this._widget.top&&(this._getWidget().top=t)}get bottom(){return this._widget.bottom}set bottom(t){t!=this._widget.bottom&&(this._getWidget().bottom=t)}get left(){return this._widget.left}set left(t){t!=this._widget.left&&(this._getWidget().left=t)}get right(){return this._widget.right}set right(t){t!=this._widget.right&&(this._getWidget().right=t)}get centerX(){return this._widget.centerX}set centerX(t){t!=this._widget.centerX&&(this._getWidget().centerX=t)}get centerY(){return this._widget.centerY}set centerY(t){t!=this._widget.centerY&&(this._getWidget().centerY=t)}render(t,e,r){oe.rendercontext2D.sceneData=this._shaderData,super.render(t,e,r),oe.rendercontext2D.sceneData=null}_shouldRefreshLayout(){super._shouldRefreshLayout(),this.callLater(this._sizeChanged)}_sizeChanged(){this.event(s.RESIZE),this._widget!==hn.EMPTY&&this._widget.resetLayout()}freshLayout(){this._widget!=hn.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===hn.EMPTY&&(this._widget=this.addComponent(hn)),this._widget}static get root(){let t=fn._root;return t||(t=fn._root=e.stage.addChild(new Ds),t.name="root",t.mouseThrough=!0,e.stage.on("resize",null,(()=>{t.size(e.stage.width,e.stage.height),t.event(s.RESIZE)})),t.size(e.stage.width,e.stage.height),t.event(s.RESIZE)),t}static load(t,r=null,i=null){return e.loader.load(t,null,(t=>{fn._loadPage&&fn._loadPage.event("progress",t),i&&i.runWith(t)})).then((e=>{if(!e)throw"Can not find scene:"+t;let i,s=[],a=e.create(null,s);if(s.length>0&&console.warn(`Error loading ${t}: \n${s.join("\n")}`),a instanceof fn)i=a;else{if(!a._is3D)throw"Not a scene:"+t;i=new fn,i.left=i.right=i.top=i.bottom=0,i._scene3D=a}return i._viewCreated=!0,i._scene3D&&(i._scene3D._scene2D=i),fn.unDestroyedScenes.add(i),fn.hideLoadingPage(),r&&r.runWith(i),i}))}static open(t,e=!0,r=null,i=null,s=null){if(r instanceof St){var a=i;i=r,r=a}return fn.showLoadingPage(),fn.load(t,St.create(null,this._onSceneLoaded,[e,i,r]),s)}static _onSceneLoaded(t,e,r,i){i.open(t,r),e&&e.runWith(i)}static close(t,e){let r=!1;for(let i of fn.unDestroyedScenes)if(i&&i.parent&&i.url===t&&(null==e||i.name==e)){i.close(),r=!0;break}return r}static closeAll(){let t=fn.root;for(let r=0,i=t.numChildren;r<i;r++){var e=t.getChildAt(0);e instanceof fn?e.close():e.removeSelf()}}static destroy(t,e){let r=!1;for(let i of fn.unDestroyedScenes)if(i.url===t&&(null==e||i.name==e)&&!i._destroyed){i.destroy(),r=!0;break}return r}static gc(){b.destroyUnusedResources()}static setLoadingPage(t){fn._loadPage=t}static showLoadingPage(t=null,r=500){fn._loadPage&&(e.systemTimer.clear(null,fn._showLoading),e.systemTimer.clear(null,fn._hideLoading),e.systemTimer.once(r,null,fn._showLoading,[t],!1))}static _showLoading(t){e.stage.addChild(fn._loadPage),fn._loadPage instanceof fn&&fn._loadPage.onOpened(t)}static _hideLoading(){fn._loadPage instanceof fn?fn._loadPage.close():fn._loadPage.removeSelf()}static hideLoadingPage(t=500){fn._loadPage&&(e.systemTimer.clear(null,fn._showLoading),e.systemTimer.clear(null,fn._hideLoading),e.systemTimer.once(t,null,fn._hideLoading))}}fn.unDestroyedScenes=new Set;var gn={};class mn extends ee{constructor(t=4){super(),this.shaderData=new Va,this._shaderV1=new u,this.strength=t}get strength(){return this._strength}set strength(t){this._strength=Math.max(Math.abs(t),2);var e=this._strength/3,r=e*e;let i=this._shaderV1=new u(this.strength,r,2*r,1/(2*Math.PI*r)),s=0,a=Math.floor(10*this.strength);if(null!=gn[a])s=gn[a];else{for(let t=-4;t<=4;++t)for(let e=-4;e<=4;++e)s+=i.w*Math.exp(-(e*e+t*t)/i.z);gn[a]=s}i.w/=s,this.onChange()}render(e,r,i){let s=50;this.left=-50,this.top=-50;let a=r+100,n=i+100;this.width=a,this.height=n,this.texture&&!this.texture.destroyed&&this.texture.width==a&&this.texture.height==n||(this.texture&&this.texture.destroy(),this.texture=new pt(a,n,t.RenderTargetFormat.R8G8B8A8));let l=this._render2D.clone(this.texture);l.renderStart(!0,new _t(0,0,0,0));let o=this._rectMeshVB,h=this._rectMesh.vertexDeclarition.vertexStride/4;o[0]=50,o[1]=s,o[h]=50+r,o[h+1]=s,o[2*h]=50+r,o[2*h+1]=s+i,o[3*h]=s,o[3*h+1]=s+i;let u=this.shaderData;u.shaderData.addDefine(Rr.FILTERBLUR),u.size=new Qe(a,n),u.textureHost=e,u.blurInfo=new Qe(a,n),u.strength_sig2_2sig2_gauss1=this._shaderV1,l.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,u,null),l.renderEnd()}}const yn=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],Tn=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],xn=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class vn extends ee{constructor(t=null){super(),t||(t=this._copyMatrix(xn)),this._mat=new Float32Array(16),this._alpha=new Float32Array(4),this.setByMatrix(t)}render(e,r,i){let s=r,a=i;this.width=s,this.height=a,this.texture&&!this.texture.destroyed&&this.texture.width==s&&this.texture.height==a||(this.texture&&this.texture.destroy(),this.texture=new pt(s,a,t.RenderTargetFormat.R8G8B8A8));let n=this._render2D.clone(this.texture);n.renderStart(!0,new _t(0,0,0,0));let l=this._rectMeshVB,o=this._rectMesh.vertexDeclarition.vertexStride/4;l[0]=0,l[1]=0,l[o]=r,l[o+1]=0,l[2*o]=r,l[2*o+1]=i,l[3*o]=0,l[3*o+1]=i;let h=new Va;h.setFilter(this),$e.TEMPMatrix0.cloneByArray(this._mat),h.shaderData.setMatrix4x4(Rr.UNIFORM_COLORMAT,$e.TEMPMatrix0),u.tempVec4.setValue(this._alpha[0],this._alpha[1],this._alpha[2],this._alpha[3]),h.shaderData.setVector(Rr.UNIFORM_COLORALPHA,u.tempVec4),h.size=new Qe(s,a),h.textureHost=e,n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,h,null),n.renderEnd()}gray(){return this.setByMatrix(Tn)}color(t=0,e=0,r=0,i=1){return this.setByMatrix([t,0,0,0,1,0,e,0,0,1,0,0,r,0,1,0,0,0,i,0])}setColor(t){var e=gr.create(t).arrColor,r=[0,0,0,0,256*e[0],0,0,0,0,256*e[1],0,0,0,0,256*e[2],0,0,0,1,0];return this.setByMatrix(r)}setByMatrix(t){this._matrix!=t&&this._copyMatrix(t);for(var e=0,r=0,i=0;i<20;i++)i%5!=4?this._mat[e++]=t[i]:this._alpha[r++]=t[i];return this.onChange(),this}get type(){return ee.COLOR}get typeDefine(){return Rr.FILTERCOLOR}adjustColor(t,e,r,i){return this.adjustHue(i),this.adjustContrast(e),this.adjustBrightness(t),this.adjustSaturation(r),this}adjustBrightness(t){return 0==(t=this._clampValue(t,100))||isNaN(t)?this:this._multiplyMatrix([1,0,0,0,t,0,1,0,0,t,0,0,1,0,t,0,0,0,1,0,0,0,0,0,1])}adjustContrast(t){if(0==(t=this._clampValue(t,100))||isNaN(t))return this;var e,r=(e=t<0?127+t/100*127:127*(e=0==(e=t%1)?yn[t]:yn[t|0]*(1-e)+yn[1+(t|0)]*e)+127)/127,i=.5*(127-e);return this._multiplyMatrix([r,0,0,0,i,0,r,0,0,i,0,0,r,0,i,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(t){if(0==(t=this._clampValue(t,100))||isNaN(t))return this;var e=1+(t>0?3*t/100:t/100),r=1-e,i=.3086*r,s=.6094*r,a=.082*r;return this._multiplyMatrix([i+e,s,a,0,0,i,s+e,a,0,0,i,s,a+e,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(t){if(0==(t=this._clampValue(t,180)/180*Math.PI)||isNaN(t))return this;var e=Math.cos(t),r=Math.sin(t),i=.213,s=.715,a=.072;return this._multiplyMatrix([i+e*(1-i)+r*-i,s+e*-s+r*-s,a+e*-a+r*(1-a),0,0,i+e*-i+.143*r,s+e*(1-s)+.14*r,a+e*-a+-.283*r,0,0,i+e*-i+-.787*r,s+e*-s+r*s,a+e*(1-a)+r*a,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(this._copyMatrix(xn))}_multiplyMatrix(t){var e=[];this._matrix=this._fixMatrix(this._matrix);for(var r=0;r<5;r++){for(var i=0;i<5;i++)e[i]=this._matrix[i+5*r];for(i=0;i<5;i++){for(var s=0,a=0;a<5;a++)s+=t[i+5*a]*e[a];this._matrix[i+5*r]=s}}return this.setByMatrix(this._matrix)}_clampValue(t,e){return Math.min(e,Math.max(-e,t))}_fixMatrix(t=null){return null==t?xn:(t.length<25?t=t.slice(0,t.length).concat(xn.slice(t.length,25)):t.length>25&&(t=t.slice(0,25)),t)}_copyMatrix(t){this._matrix||(this._matrix=[]);for(var e=0;e<25;e++)this._matrix[e]=t[e];return this._matrix}onAfterDeserialize(){let t=gr.create(this._color||"#FFFFFF").arrColor;this.color(t[0],t[1],t[2],t[3]),this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}class Sn extends ee{constructor(t,e=4,r=6,i=6){super(),this._sv_blurInfo1=new Array(4),this._sv_blurInfo2=[0,0,1,0],this._flipY=!1,this._color=new gr(t||"#000"),this.blur=Math.min(e,20),this.offX=r,this.offY=i,this._sv_blurInfo1[1]=this.blur,this.shaderDataBlur=new Va,this.shaderDataBlur.u_blurInfo1=new u,this.shaderDataBlur.u_blurInfo2=new u,this.shaderDataBlur.color=new u,this.shaderDataBlur.size=new Qe,this.shaderDataBlur.blurInfo=new Qe,this.shaderDataCopy=new Va,this.shaderDataCopy.size=new Qe,this.shaderDataCopy1=new Va}_fillQuad(t,e,r,i,s=!1){let a;a=s?[0,1,1,0]:[0,0,1,1];let n=this._rectMeshVB,l=this._rectMesh.vertexDeclarition.vertexStride/4;n[0]=t,n[1]=e,n[2]=a[0],n[3]=a[1],n[l]=t+r,n[l+1]=e,n[l+2]=a[2],n[l+3]=a[1],n[2*l]=t+r,n[2*l+1]=e+i,n[2*l+2]=a[2],n[2*l+3]=a[3],n[3*l]=e,n[3*l+1]=e+i,n[3*l+2]=a[0],n[3*l+3]=a[3]}useFlipY(t){super.useFlipY(t),this._flipY=t}render(e,r,i){this.left=-50,this.top=-50;let s=r+100,a=i+100;this.width=s,this.height=a,this.textureExtend&&!this.textureExtend.destroyed&&this.textureExtend.width==s&&this.textureExtend.height==a||(this.textureExtend&&this.textureExtend.destroy(),this.textureExtend=new pt(s,a,t.RenderTargetFormat.R8G8B8A8));let n=this._render2D.clone(this.textureExtend);n.renderStart(!0,new _t(0,0,0,0)),this.shaderDataCopy1.size=new Qe(s,a),this.shaderDataCopy1.textureHost=e,this._fillQuad(50,50,e.width,e.height,this._flipY),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,this.shaderDataCopy1,null),n.renderEnd(),this.texture&&!this.texture.destroyed&&this.texture.width==s&&this.texture.height==a||(this.texture&&this.texture.destroy(),this.texture=new pt(s,a,t.RenderTargetFormat.R8G8B8A8)),n=n.clone(this.texture),n.renderStart(!0,new _t(0,0,0,0)),this._fillQuad(0,0,s,a,!0);let l=this.shaderDataBlur;l.shaderData.addDefine(Rr.FILTERGLOW);let o=l.size;o.setValue(s,a),l.size=o,l.textureHost=this.textureExtend;let h=l.blurInfo;h.setValue(s,a),l.blurInfo=h;let u=l.u_blurInfo1;u.setValue(this._sv_blurInfo1[0],this._sv_blurInfo1[1],this._sv_blurInfo1[2],this._sv_blurInfo1[3]),l.u_blurInfo1=u;let d=l.u_blurInfo2;d.setValue(e.width,e.height,this._sv_blurInfo2[2],this._sv_blurInfo2[3]),l.u_blurInfo2=d;let c=this.getColor(),_=l.color;_.setValue(c[0],c[1],c[2],c[3]),l.color=_,n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,l,null);let p=this.shaderDataCopy;o=p.size,o.setValue(s,a),p.size=o,p.textureHost=e,this._fillQuad(50,50,e.width,e.height,this._flipY),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,p,null),n.renderEnd()}get typeDefine(){return Rr.FILTERGLOW}get offY(){return this._sv_blurInfo1[3]}set offY(t){this._sv_blurInfo1[3]=t,this.onChange()}get offX(){return this._sv_blurInfo1[2]}set offX(t){this._sv_blurInfo1[2]=t,this.onChange()}get color(){return this._color.strColor}set color(t){this._color=new gr(t),this.onChange()}getColor(){return this._color.arrColor}get blur(){return this._sv_blurInfo1[1]}set blur(t){this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=t,this.onChange()}}class En extends Ds{constructor(){super(),this._loop=1,this.on(s.ADDED,this,this._onParentChange),this.on(s.REMOVED,this,this._onParentChange)}get source(){return this._source}set source(t){this._source=t,t?this._autoPlay&&(!this._channel||this._channel.isStopped)&&n.isPlaying&&this.play():this.stop()}get isMusic(){return this._isMusic}set isMusic(t){this._isMusic=t}get loop(){return this._loop}set loop(t){this._loop=t}get autoPlay(){return this._autoPlay}set autoPlay(t){this._autoPlay=t,t&&this._source&&(!this._channel||this._channel.isStopped)&&n.isPlaying&&this.play()}_onParentChange(){this.target=this.parent}play(t,e){this._source&&((null==t||isNaN(t))&&(t=this._loop),this.stop(),this._isMusic?this._channel=Fa.playMusic(this._source,t,e):this._channel=Fa.playSound(this._source,t,e))}stop(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}_setPlayAction(t,e,r,i=!0){this[r]&&t&&(i?t.on(e,this,this[r]):t.off(e,this,this[r]))}_setPlayActions(t,e,r,i=!0){if(!t)return;if(!e)return;let s=e.split(","),a=s.length;for(let e=0;e<a;e++)this._setPlayAction(t,s[e],r,i)}set playEvent(t){this._playEvents=t,t&&this._tar&&this._setPlayActions(this._tar,t,"play")}set target(t){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=t,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(t){this._stopEvents=t,t&&this._tar&&this._setPlayActions(this._tar,t,"stop")}}class wn extends R{set updateFrame(t){this._frameDelty=1/t*1e3,this._updateFrame=t}get updateFrame(){return this._updateFrame}set useFrame(t){this._useFrame=t}get useFrame(){return this._useFrame}constructor(){let r=e.Browser.createElement("video");super(r.videoWidth,r.videoHeight,t.RenderTargetFormat.R8G8B8),this._requestVideoFrame=!1,this._lastTimer=0,this._frameRender=!0,this._isLoaded=!1,this._needUpdate=!1,this.immediatelyPlay=!1,this.element=r,this.useFrame=!1,this.updateFrame=30,this._listeningEvents={},this._dimension=t.TextureDimension.Tex2D;var i=this.element.style;if(i.position="absolute",i.top="0px",i.left="0px",r.setAttribute("crossorigin","anonymous"),e.Browser.onMobile&&(r["x5-playsInline"]=!0,r["x5-playsinline"]=!0,r.x5PlaysInline=!0,r.playsInline=!0,r["webkit-playsInline"]=!0,r["webkit-playsinline"]=!0,r.webkitPlaysInline=!0,r.playsinline=!0,r.style.playsInline=!0,r.crossOrigin="anonymous",r.setAttribute("playsinline","true"),r.setAttribute("x5-playsinline","true"),r.setAttribute("webkit-playsinline","true"),r.autoplay=!0),r.addEventListener("loadedmetadata",(()=>{this.loadedmetadata()})),"requestVideoFrameCallback"in HTMLVideoElement.prototype){const s=this;function a(){s._needUpdate=!0,r.requestVideoFrameCallback(a)}r.requestVideoFrameCallback(a),this._requestVideoFrame=!0}else this._needUpdate=!0}isNeedUpdate(){if(this.useFrame){let t=A.now();return t-this._lastTimer>this._frameDelty&&(this._lastTimer=t,!0)}return!this._requestVideoFrame||this._needUpdate}loadedmetadata(){this._isLoaded||(this._width=this.element.videoWidth,this._height=this.element.videoHeight,A.onLayaRuntime?this._texture=l.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,t.TextureFormat.R8G8B8A8,!1,!1,!1):this._texture=l.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,t.TextureFormat.R8G8B8,!1,!1,!1),this.wrapModeU=t.WrapMode.Clamp,this.wrapModeV=t.WrapMode.Clamp,this.filterMode=t.FilterMode.Bilinear,l.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this.immediatelyPlay&&this.play(),this._isLoaded=!0,this.event(s.READY,this))}get gammaCorrection(){return 2.2}get source(){return this._source}set source(t){this._source=t,t&&N.inst.resolveURL(t,(t=>{for(;this.element.childElementCount;)this.element.firstChild.remove();t.startsWith("blob:")?this.element.src=t:this.appendSource(t)}))}appendSource(t){var r=e.Browser.createElement("source");r.src=O.postFormatURL(O.formatURL(t));let i=P.getFileExtension(t);r.type="m3u8"==i?"application/vnd.apple.mpegurl":"video/"+i,this.element.appendChild(r)}render(){0!=this.element.readyState&&(this.isNeedUpdate()||A.onLayaRuntime)&&(l.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1,this.event(wn.videoEvent_update))}get frameRender(){return this._frameRender}set frameRender(t){this._frameRender&&!t&&e.timer.clear(this,this.render),!this._frameRender&&t&&e.timer.frameLoop(1,this,this.render),this._frameRender=t}play(){this._texture?(this.element.play().catch((()=>{this.event("NotAllowedError")})),this._frameRender&&e.timer.frameLoop(1,this,this.render)):this.immediatelyPlay=!0}_getSource(){return this._texture?this._texture.resource:null}get defaultTexture(){return ct.whiteTexture}pause(){this.element.pause(),this._frameRender&&e.timer.clear(this,this.render)}load(){this.element.load()}canPlayType(t){return t="m3u8"==t?"application/vnd.apple.mpegurl":"video/"+t,this.element.canPlayType(t)}get buffered(){return this.element.buffered}get currentSrc(){return this.element.currentSrc}get currentTime(){return this.element.currentTime}set currentTime(t){this.element&&(this.element.currentTime=t,this.render())}get volume(){return this.element.volume}set volume(t){this.element&&(this.element.volume=t)}get readyState(){return this.element.readyState}get videoWidth(){return this.element.videoWidth}get videoHeight(){return this.element.videoHeight}get duration(){return this.element.duration}get ended(){return this.element.ended}get error(){return this.element.error}get loop(){return this.element.loop}set loop(t){this.element&&(this.element.loop=t)}get playbackRate(){return this.element.playbackRate}set playbackRate(t){this.element&&(this.element.playbackRate=t)}get muted(){return this.element.muted}set muted(t){this.element&&(this.element.muted=t)}get paused(){return this.element.paused}get preload(){return this.element.preload}set preload(t){this.element&&(this.element.preload=t)}get seekable(){return this.element.seekable}get seeking(){return this.element.seeking}onStartListeningToType(t){if(Dn.has(t)){let e=this._listeningEvents[t];e||(e=this._listeningEvents[t]=()=>{this.event(t)}),this.element.addEventListener(t,e)}}destroy(){if(this.element)if(n.isConch)this.element._destroy();else for(this.element.pause(),this.element.src="";this.element.childElementCount;)this.element.firstChild.remove();e.timer.clear(this,this.render),super.destroy()}}wn.videoEvent_update="videoUpdate";const Dn=new Set(["abort","canplay","canplaythrough","durationchange","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting","ended"]);class bn extends Ds{constructor(){if(super(),this.texture=this._internalTex=new mt,n.isPlaying&&e.Browser.onMobile){let t=()=>{e.Browser.document.removeEventListener("touchend",t),this._videoTexture&&(A.onIOS?this._videoTexture.load():(this._videoTexture.play(),this._videoTexture.pause()))};e.Browser.document.addEventListener("touchend",t)}}get videoTexture(){return this._videoTexture}set videoTexture(t){this._videoTexture&&(this._videoTexture._removeReference(),this._videoTexture.off(s.READY,this,this.onVideoMetaLoaded),this._videoTexture.off(wn.videoEvent_update,this,this._repaintCachAs)),this._videoTexture=t,t?(this._videoTexture._addReference(),this._videoTexture.on(s.READY,this,this.onVideoMetaLoaded),this._videoTexture._isLoaded&&this._internalTex.setTo(this._videoTexture)):this._internalTex.setTo(null),this._checkCachAs()}get source(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.source}set source(t){t?(this._videoTexture||(this.videoTexture=new wn),this._videoTexture.source=t):this._videoTexture&&(this._videoTexture.source=t),this._checkCachAs()}_checkCachAs(){null!=this.videoTexture&&this.videoTexture.on(wn.videoEvent_update,this,this._repaintCachAs)}_repaintCachAs(){("none"!=this.cacheAs||this._getCacheStyle().mask)&&this.repaint()}load(t){this.source=t}play(){this._videoTexture&&this._videoTexture.play()}pause(){this._videoTexture&&this._videoTexture.pause()}reload(){this._videoTexture&&this._videoTexture.load()}canPlayType(t){return this._videoTexture||(this.videoTexture=new wn),this._videoTexture.canPlayType(t)}onVideoMetaLoaded(){this._internalTex.setTo(this._videoTexture)}get buffered(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.buffered}get currentSrc(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.currentSrc}get currentTime(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.currentTime}set currentTime(t){this._videoTexture&&(this._videoTexture.currentTime=t)}get volume(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.volume}set volume(t){this._videoTexture&&(this._videoTexture.volume=t)}get readyState(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.readyState}get videoWidth(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.videoWidth}get videoHeight(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.videoHeight}get duration(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.duration}get ended(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.ended}get error(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.error}get loop(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.loop}set loop(t){this._videoTexture&&(this._videoTexture.loop=t)}get playbackRate(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.playbackRate}set playbackRate(t){this._videoTexture&&(this._videoTexture.playbackRate=t)}get muted(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.muted}set muted(t){this._videoTexture&&(this._videoTexture.muted=t)}get paused(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.paused}get preload(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.preload}set preload(t){this._videoTexture&&(this._videoTexture.preload=t)}get seekable(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.seekable}get seeking(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.seeking}_setX(t){if(super._setX(t),this._videoTexture&&n.isConch){var e=ws.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.left=e.x}}_setY(t){if(super._setY(t),this._videoTexture&&n.isConch){var e=ws.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.top=e.y}}set_width(t){if(super.set_width(t),this._videoTexture)if(n.isConch){var r=ws.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.width=t*r.scaleX}else this._videoTexture.element.width=this.width/e.Browser.pixelRatio}set_height(t){if(super.set_height(t),this._videoTexture)if(n.isConch){var r=ws.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.height=t*r.scaleY}else this._videoTexture.element.height=this.height/e.Browser.pixelRatio}destroy(t=!0){this.videoTexture=null,super.destroy(t)}}class Rn{get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null,this._frontPlay=!0}_resetPlayState(t,e){this._finish=!1,this._startPlayTime=t,this._elapsedTime=t,this._lastIsFront=!0,this._parentPlayTime=null,this._playNum=0,this._playAllTime=0;var r=this._elapsedTime/e%1;this._normalizedPlayTime=r<0?r+1:r,this._frontPlay=!0}_cloneTo(t){t._finish=this._finish,t._startPlayTime=this._startPlayTime,t._elapsedTime=this._elapsedTime,t._playNum=this._playNum,t._parentPlayTime=this._parentPlayTime,t._normalizedPlayTime=this._normalizedPlayTime,t._lastIsFront=this._lastIsFront,t._frontPlay=this._frontPlay,t._playAllTime=this._playAllTime}}class Cn{constructor(t){this._referenceCount=0,this._playStateInfo=new Rn,this._crossPlayStateInfo=new Rn,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=Cn.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=t}get states(){return this._states}set states(t){if(this._states!==t){for(let t=this.states.length-1;t>=0;t--)this.removeState(this.states[t]);for(let e=t.length-1;e>=0;e--)this.addState(t[e])}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}set defaultStateName(t){if(this._defaultState=this.getStateByName(t),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=t;else for(var e=this._states.length-1;e>=0;e--)if(this._states[e].name==t){this._defaultState=this._states[e];break}}get defaultState(){return this._defaultState}set defaultState(t){this._defaultState=t}_removeClip(t,e,r){t.splice(e,1)}_getReferenceCount(){return this._referenceCount}_addReference(t){for(var e=0,r=this._states.length;e<r;e++)this._states[e]._addReference(t);this._referenceCount+=t}_removeReference(t=1){for(var e=0,r=this._states.length;e<r;e++)this._states[e]._removeReference(t);this._referenceCount-=t}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(t){for(let e=this._states.length-1;e>=0;e--)if(this._states[e].name==t)return this._states[e];return null}addState(t){var e=t.name;if(this.getStateByName(e))throw new Error("AnimatorControllerLayer:this stat's name has exist.");this._states.push(t),e==this._defaultStateNameCatch&&(this._defaultState=t,this._defaultStateNameCatch=null)}removeState(t){for(var e=this._states,r=-1,i=0,s=e.length;i<s;i++)if(e[i]===t){r=i;break}-1!=r&&this._removeClip(e,r,t)}clone(){var t=new Cn(this.name);return this.cloneTo(t),t}cloneTo(t){t.name=this.name}destroy(){this._removeReference();for(var t=0,e=this._states.length;t<e;t++)this._states[t].destroy();this._states.length=0}}var An,In,Mn,Bn,Ln,Pn,Nn;Cn.BLENDINGMODE_OVERRIDE=0,Cn.BLENDINGMODE_ADDTIVE=1,t.AniParmType=void 0,(An=t.AniParmType||(t.AniParmType={}))[An.Float=0]="Float",An[An.Bool=1]="Bool",An[An.Trigger=2]="Trigger",t.AniStateConditionType=void 0,(In=t.AniStateConditionType||(t.AniStateConditionType={}))[In.Number=0]="Number",In[In.Bool=1]="Bool",In[In.Trigger=2]="Trigger",t.AniStateConditionNumberCompressType=void 0,(Mn=t.AniStateConditionNumberCompressType||(t.AniStateConditionNumberCompressType={}))[Mn.Less=0]="Less",Mn[Mn.Greater=1]="Greater";class On{static parse(t){let e=t,r=e.controllerLayers;null==r&&(r=[]);let i=[];for(let t=r.length-1;t>=0;t--){let s=r[t],a=s.states;a||(a=[],s.states=a),s.defaultStateName=null;let n=this.checkStates(a,i,e);n?s.defaultStateName=n.enterName:r.splice(t,1)}return{ret:e,clipsID:i}}static checkStates(t,e,r){let i=null,s=null;for(let a=t.length-1;a>=0;a--){let n=t[a];n.states?null==this.checkStates(n.states,e,r)?t.splice(a,1):(null==i&&(i=[]),i.push(n)):"-1"==n.id?s=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?t.splice(a,1):(0>e.indexOf(n.clip._$uuid)&&e.push(n.clip._$uuid),this.checkNext(n,t,r),null==i&&(i=[]),i.push(n)))}let a=null;if(i&&s){let t=this.checkDefault(s,i);null!=t&&(a={states:i,enterName:t})}return a}static checkNext(t,e,r){let i=t.soloTransitions;if(i)for(let t=i.length-1;t>=0;t--){let s=i[t],a=this.getStateByID(e,s.id);!a||null==a.clip&&"-3"!=a.id&&null==a.states?i.splice(t,1):(s.name=a.name,s.conditions=this.checkConditions(s.conditions,r))}}static checkConditions(e,r){if(!e||0==e.length||null==r.animatorParams||0==r.animatorParams.length)return[];let i=r.animatorParams;for(let r=e.length-1;r>=0;r--){let s=e[r],a=null;for(let t=i.length-1;t>=0;t--)if(i[t].id==s.id){a=i[t];break}if(null==a)e.splice(r,1);else if(s.name=a.name,a.type==t.AniParmType.Float){let t=Number(s.checkValue);isNaN(t)&&(s.checkValue=0),t=Number(s.type),isNaN(t)&&(s.type=0)}}return e}static checkDefault(t,e){let r=t.soloTransitions,i=null;r&&0<r.length&&(i=r[0].id);let s=null;if(null!=i&&(s=this.getStateByID(e,i)),null!=s&&(null!=s.clip||null!=s.states))return s.name;for(let t=e.length-1;t>=0;t--)if(e[t].clip)return e[t].name;return null}static getStateByID(t,e){if(t)for(let r=t.length-1;r>=0;r--)if(t[r].id==e)return t[r];return null}}t.AnimatorUpdateMode=void 0,(Bn=t.AnimatorUpdateMode||(t.AnimatorUpdateMode={}))[Bn.Normal=0]="Normal",Bn[Bn.LowFrame=1]="LowFrame",Bn[Bn.UnScaleTime=2]="UnScaleTime";class Fn extends tn{constructor(){super(),this._speed=1,this._updateMode=t.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._controllerLayers=[],this._parameters={}}get controller(){return this._controller}set controller(t){this._controller&&this._controller._removeReference(),this._controller=t,t&&(t._addReference(),t.updateTo(this))}get parameters(){return this._parameters}set parameters(t){this._parameters=t}get speed(){return this._speed}set speed(t){this._speed=t}get isPlaying(){return this._isPlaying}_updateStateFinish(t,e){e._finish&&t._eventExit()}_setClipDatasToNode(t,e,r,i=null){for(var s=t._realtimeDatas,a=t._clip._nodes,n=0,l=a.count;n<l;n++)if(null!=s[n]){var o=a.getNodeByIndex(n),h=this.getOwner(o);h&&this._applyFloat(h,e,r,s[n])}}_applyFloat(t,e,r,i){var s=t.pro;s&&s.ower&&(s.ower[s.key]=e&&"number"==typeof i?s.defVal+r*i:"number"==typeof i?r*i:i)}getOwner(t){var e;if(this._ownerMap&&(e=this._ownerMap.get(t)))return e;for(var r=this.owner,i=0,s=t.ownerPathCount;i<s;i++){var a=t.getOwnerPathByIndex(i);if(""!=a&&!(r=r.getChildByName(a)))break}if(e={ower:r},r){var n=r,l=t.propertyCount;if(1==l){var o=t.getPropertyByIndex(0);e.pro={ower:r,key:o,defVal:r[o]}}else for(var h=0;h<l;h++){o=t.getPropertyByIndex(h);if(h==l-1||null==n){e.pro={ower:n,key:o,defVal:n?n[o]:null};break}if("_gcmds"===o&&null==n[o]&&n.graphics&&(n=n.graphics,o="cmds"),null==n[o]&&r==n){n=null;var u=Ot.getClass(o);u&&(n=r.getComponent(u))}else n=n[o]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(t,e),e}_updateClipDatas(t,e,r){var i=t._clip,s=i._duration,a=t.clipStart*s+r._normalizedPlayTime*r._duration,n=t._currentFrameIndices;i._evaluateClipDatasRealTime(a,n,e,!0,t._realtimeDatas)}_updatePlayer(t,e,r,i,s){let a=!1;var n=t._clip._duration*(t.clipEnd-t.clipStart),l=e._elapsedTime;let o=e._playAllTime;e._playAllTime+=Math.abs(r),r=l+r,e._lastElapsedTime=l,e._elapsedTime=r;var h=r/n;let u=1;t.yoyo&&(u=2);let d=e._playAllTime/(n*u);Math.floor(o/(n*u))<Math.floor(d)&&(a=!0);var c=h%1;let _=c<0?c+1:c;if(e._normalizedPlayTime=_,e._duration=n,1!=u&&(_=(c=(h=e._playAllTime/(n*u))%1)<0?c+1:c,t.yoyo&&(.5>_?e._frontPlay||(0>t.speed?(e._elapsedTime=t.clipEnd*o,e._normalizedPlayTime=t.clipEnd):(e._elapsedTime=t.clipStart*o,e._normalizedPlayTime=t.clipStart),e._frontPlay=!0):e._frontPlay&&(e._frontPlay=!1,0>t.speed?(e._elapsedTime=t.clipStart*o,e._normalizedPlayTime=t.clipStart):(e._elapsedTime=t.clipEnd*o,e._normalizedPlayTime=t.clipEnd)))),t._eventStateUpdate(_),!this._applyTransition(s,t._eventtransition(_,this.parameters,a))&&a){let r=e._playAllTime/(n*u);if(0<i&&i<=r)return e._finish=!0,void(0>t.speed?t.yoyo?(e._elapsedTime=t.clipEnd*o,e._normalizedPlayTime=t.clipEnd):(e._elapsedTime=t.clipStart*o,e._normalizedPlayTime=t.clipStart):t.yoyo?(e._elapsedTime=t.clipStart*o,e._normalizedPlayTime=t.clipStart):(e._elapsedTime=t.clipEnd*o,e._normalizedPlayTime=t.clipEnd));t._eventLoop()}}_updateEventScript(t,e){let r=t._clip,i=r._animationEvents;if(!i||0==i.length)return;let s=r._duration,a=e._normalizedPlayTime*s,n=e._frontPlay;0>e._currentState.speed&&(n=!n);let l=e._parentPlayTime,o=e._parentPlayTime;null==o&&(o=n?s*e.animatorState.clipStart:s*e.animatorState.clipEnd),n?a<o&&(this._eventScript(i,o,a,!0),o=s*e.animatorState.clipStart):a>o&&(this._eventScript(i,o,a,!1),o=s*e.animatorState.clipEnd),this._eventScript(i,o,a,n),l==e._parentPlayTime&&(e._parentPlayTime=a)}_eventScript(t,e,r,i){let s=this.owner.components;if(i)for(let i=0,a=t.length;i<a;i++){let a=t[i];if(a.time>e&&a.time<=r)for(let t=0,e=s.length;t<e;t++){let e=s[t];if(e._isScript()){let t=e[a.eventName];t&&t.apply(e,a.params)}}else if(a.time>r)break}else for(let i=t.length-1;i>=0;i--){let a=t[i];if(a.time<e&&a.time>=r)for(let t=0,e=s.length;t<e;t++){let e=s[t];if(e._isScript()){let t=e[a.eventName];t&&t.apply(e,a.params)}}else if(a.time<r)break}}_applyTransition(t,e){return!!e&&this.crossFade(e.destState.name,t,e.transstartoffset,e.transduration)}_applyUpdateMode(e){let r;switch(this._updateMode){case t.AnimatorUpdateMode.Normal:r=e;break;case t.AnimatorUpdateMode.LowFrame:r=se.loopCount%this._lowUpdateDelty==0?e*this._lowUpdateDelty:0;break;case t.AnimatorUpdateMode.UnScaleTime:r=0}return r}gotoAndStopByFrame(t,e,r){var i=this._controllerLayers[e];if(i){var s=i.getStateByName(t);if(!s||!s._clip)return;let a=r/(s._clip._duration*s._clip._frameRate);1<a&&(a=1),this.gotoAndStop(t,e,a)}}getControllerLayer(t=0){return this._controllerLayers[t]}gotoAndStop(t,e,r){var i=this._controllerLayers[e];if(i){var s=i.getStateByName(t);if(!s||!s._clip)return;var a=i._playStateInfo,n=a._currentState,l=s._clip._duration,o=s._clip._duration*(s.clipEnd-s.clipStart);a._resetPlayState(l*r,o),a._normalizedPlayTime=r,i._playType=0,n!==s&&(a._currentState=s),s._eventStart(this,e);let h=i.blendingMode!=Cn.BLENDINGMODE_OVERRIDE;this._updateClipDatas(s,h,a),this._setClipDatasToNode(s,h,i.defaultWeight,i),this.stop()}}play(t,e=0,r=Number.NEGATIVE_INFINITY){if(this._checkEnterIndex){let t=this._checkEnterIndex.indexOf(e);0<=t&&this._checkEnterIndex.splice(t,1)}this._isPlaying=!0;var i=this._controllerLayers[e];if(i){var s=i.defaultState;if(!t&&!s)throw new Error("Animator:must have default clip value,please set clip property.");var a=i._playStateInfo,n=a._currentState,l=t?i.getStateByName(t):s;if(!l._clip)return;var o=l._clip._duration,h=l._clip._duration*(l.clipEnd-l.clipStart);n!==l?(r!==Number.NEGATIVE_INFINITY?a._resetPlayState(o*r,h):a._resetPlayState(0,h),i._playType=0,a._currentState=l):r!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(o*r,h),i._playType=0),l._eventStart(this,e)}}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){if(this._checkEnterIndex)for(let e=this._checkEnterIndex.length-1;e>=0;e--){let r=this._checkEnterIndex[e];if(this._controllerLayers[r]._enterTransition.check(0,this.parameters,!0)){var t=this.getDefaultState(r);this.play(null,r,t.cycleOffset)}}var e=this.owner.timer._delta/1e3;if(e=this._applyUpdateMode(e),0!=this.speed&&0!=e)for(var r=0,i=this._controllerLayers.length;r<i;r++){var s=this._controllerLayers[r];if(s.enable){var a=s._playStateInfo,n=s.blendingMode!=Cn.BLENDINGMODE_OVERRIDE;if(0===s._playType){var l=a._currentState,o=this._speed*l.speed,h=a._finish,u=l.loop;-1>=u&&(u=l._clip.islooping?0:1);let t=1;a._frontPlay||(t=-1),h||this._updatePlayer(l,a,e*o*t,u,r),l=(a=s._playStateInfo)._currentState,this._updateClipDatas(l,n,a),h||(this._setClipDatasToNode(l,n,s.defaultWeight,s),this._updateEventScript(l,a)),h||this._updateStateFinish(l,a)}}}}}addControllerLayer(t){this._controllerLayers.push(t)}crossFade(t,e=0,r=Number.NEGATIVE_INFINITY,i){var s=this._controllerLayers[e];if(s){if(s.getStateByName(t))return this.play(t,e,r),!0;console.warn("Invalid layerIndex "+e+".")}return!1}onAfterDeserialize(){let t=this.controllerLayers;if(t&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let e of t)this.addControllerLayer(e)}}onEnable(){if(this._checkEnterIndex?this._checkEnterIndex.length=0:this._checkEnterIndex=[],this._isPlaying)for(var t=0,e=this._controllerLayers.length;t<e;t++)if(this._controllerLayers[t].playOnWake){var r=this.getDefaultState(t);if(r){let e=this._controllerLayers[t]._enterTransition;e?(this._isPlaying=!0,e.check(0,this.parameters,!0)?this.play(null,t,r.cycleOffset):this._checkEnterIndex.push(t)):this.play(null,t,r.cycleOffset)}}}getDefaultState(t=0){return this._controllerLayers[t].defaultState}setParamsTrigger(e){this._parameters[e]={name:e,type:t.AniParmType.Trigger,value:!0}}setParamsNumber(e,r){this._parameters[e]={name:e,type:t.AniParmType.Float,value:r}}setParamsBool(e,r){this._parameters[e]={name:e,type:t.AniParmType.Float,value:r}}getParamsvalue(t){let e=this._parameters[t];return e?e.value:null}onDestroy(){this._controller&&(this._controller._removeReference(),this._controller=null);for(var t=0,e=this._controllerLayers.length;t<e;t++)this._controllerLayers[t].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class Un extends v{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.cycleOffset=0,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(t){if(this._clip!=t){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),t){var e=t._nodes.count;this._currentFrameIndices=new Int16Array(e),this._resetFrameIndices(),this._referenceCount>0&&t._addReference(this._referenceCount),this._realtimeDatas.length=e}this._clip=t}}_eventStateUpdate(t){if(this.event(Un.EVENT_OnStateUpdate,t),this._scripts)for(var e=0,r=this._scripts.length;e<r;e++)this._scripts[e].onStateUpdate(t)}_eventStart(t,e){if(this.event(Un.EVENT_OnStateEnter),this._scripts)for(var r=0,i=this._scripts.length;r<i;r++)this._scripts[r].setPlayScriptInfo(t,e,this),this._scripts[r].onStateEnter()}_eventExit(){if(this.event(Un.EVENT_OnStateExit),this._scripts)for(let t=0,e=this._scripts.length;t<e;t++)this._scripts[t].onStateExit()}_eventLoop(){if(this.event(Un.EVENT_OnStateLoop),this._scripts)for(let t=0,e=this._scripts.length;t<e;t++)this._scripts[t].onStateLoop&&this._scripts[t].onStateLoop()}_eventtransition(t,e,r){let i=this.soloTransitions.length;if(i>0){for(var s=0;s<i;s++)if(this.soloTransitions[s].check(t,e,r))return this.soloTransitions[s];return null}let a=this.transitions.length;for(s=0;s<a;s++)if(this.transitions[s].check(t,e,r))return this.transitions[s];return null}_resetFrameIndices(){for(var t=0,e=this._currentFrameIndices.length;t<e;t++)this._currentFrameIndices[t]=-1}_getReferenceCount(){return this._referenceCount}_addReference(t){this._clip&&this._clip._addReference(t),this._referenceCount+=t}_removeReference(t){this._clip&&this._clip._removeReference(t),this._referenceCount-=t}_clearReference(){this._removeReference(-this._referenceCount)}addScript(t){var e=new t;return this._scripts=this._scripts||[],this._scripts.push(e),e}getScript(t){if(this._scripts)for(var e=0,r=this._scripts.length;e<r;e++){var i=this._scripts[e];if(i instanceof t)return i}return null}getScripts(t){var e=null;if(this._scripts)for(var r=0,i=this._scripts.length;r<i;r++){var s=this._scripts[r];s instanceof t&&(e=e||[]).push(s)}return e}clone(){var t=new Un;return this.cloneTo(t),t}cloneTo(t){t.name=this.name,t.speed=this.speed,t.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}Un.EVENT_OnStateEnter="OnStartEnter",Un.EVENT_OnStateUpdate="OnStateUpdate",Un.EVENT_OnStateExit="OnStateExit",Un.EVENT_OnStateLoop="OnStateLoop";class kn{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(t){this._ownerPath.length=t}_setOwnerPathByIndex(t,e){this._ownerPath[t]=e}_setPropertyCount(t){this._propertys.length=t}_setPropertyByIndex(t,e){this._propertys[t]=e}_setKeyframeCount(t){this._keyFrames.length=t}_joinOwnerPath(t){return this._ownerPath.join(t)}_joinProperty(t){return this._propertys.join(t)}getKeyframeByIndex(t){return this._keyFrames[t]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(t){return this._ownerPath[t]}getPropertyByIndex(t){return this._propertys[t]}}class Gn{clone(){var t=new Gn;return this.cloneTo(t),t}cloneTo(t){t.time=this.time}}Gn.defaultWeight=.33333;class Vn{constructor(){}}class Hn{static READ_DATA(){this._DATA.offset=this._reader.getUint32(),this._DATA.size=this._reader.getUint32()}static READ_BLOCK(){for(var t=this._BLOCK.count=this._reader.getUint16(),e=this._BLOCK.blockStarts=[],r=this._BLOCK.blockLengths=[],i=0;i<t;i++)e.push(this._reader.getUint32()),r.push(this._reader.getUint32())}static READ_STRINGS(){var t=this._reader.getUint32(),e=this._reader.getUint16(),r=this._reader.pos;this._reader.pos=t+this._DATA.offset;for(var i=0;i<e;i++)this._strings[i]=this._reader.readUTFString();this._reader.pos=r}static parse(t,e,r){this._clip=t,this._reader=e,this._version=r,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var i=0,s=this._BLOCK.count;i<s;i++){var a=e.getUint16(),n=this._strings[a],l=this["READ_"+n];if(!l)throw new Error("model file err,no this function:"+a+" "+n);l.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(t,e){return Math.round(t*e)}static READ_ANIMATIONS2D(){var t,e,r,i=this._reader,s=this._clip,a=[],n=i.getUint16();for(a.length=n,t=0;t<n;t++)a[t]=i.getFloat32();s._duration=a[i.getInt16()],s.islooping=!!i.getByte(),s._frameRate=i.getInt16();var l=i.getInt16(),o=s._nodes;o.count=l;var h=s._nodesMap={},u=s._nodesDic={};for(t=0;t<l;t++){r=new kn,o.setNodeByIndex(t,r),r._indexInList=t;var d=i.getUint16();for(r._setOwnerPathCount(d),e=0;e<d;e++)r._setOwnerPathByIndex(e,this._strings[i.getUint16()]);var c=r._joinOwnerPath("/"),_=h[c];_||(h[c]=_=[]),_.push(r);var p=i.getUint16();for(r._setPropertyCount(p),e=0;e<p;e++)r._setPropertyByIndex(e,this._strings[i.getUint16()]);var f=c+"."+r._joinProperty(".");u[f]=r,r.fullPath=f,r.nodePath=c;var g=i.getUint16();for(e=0;e<g;e++){var m=new Gn;m.time=a[i.getUint16()],m.data={f:this.timeToFrame(m.time,s._frameRate),val:0},1==i.getByte()&&(m.data.tweenType=this._strings[i.getUint16()]),1==i.getByte()&&(m.data.tweenInfo={},m.data.tweenInfo.inTangent=a[i.getUint16()],m.data.tweenInfo.outTangent=a[i.getUint16()],1==i.getByte()&&(m.data.tweenInfo.inWeight=a[i.getUint16()]),1==i.getByte()&&(m.data.tweenInfo.outWeight=a[i.getUint16()]));var y=i.getByte();if(0==y?m.data.val=a[i.getUint16()]:1==y?m.data.val=this._strings[i.getUint16()]:2==y&&(m.data.val=!!i.getByte()),1==i.getByte())try{m.data.extend=JSON.parse(this._strings[i.getUint16()])}catch(t){}r._keyFrames.push(m)}}var T=i.getUint16();for(t=0;t<T;t++){var x=new Vn;x.time=a[i.getUint16()],x.eventName=this._strings[i.getUint16()];var v=[],S=i.getUint16();for(S>0&&(x.params=v=[]),e=0;e<S;e++){switch(i.getByte()){case 0:v.push(!!i.getByte());break;case 1:v.push(i.getInt32());break;case 2:v.push(a[i.getUint16()]);break;case 3:v.push(this._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}s.addEvent(x)}}}Hn._strings=[],Hn._DATA={offset:0,size:0},Hn._BLOCK={count:0};class zn{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(t){this._nodes.length=t}getNodeByIndex(t){return this._nodes[t]}setNodeByIndex(t,e){this._nodes[t]=e}}class Wn extends b{static _parse(t){var e=new Wn,r=new W(t),i=r.readUTFString();if("LAYAANIMATION2D:01"!==i)throw"unknown animationClip version.";return Hn.parse(e,r,i),e}constructor(){super(),this._nodes=new zn,this._animationEvents=[]}duration(){return this._duration}_evaluateClipDatasRealTime(t,e,r,i,s){for(var a=this._nodes,n=0,l=a.count;n<l;n++){var o,h=a.getNodeByIndex(n)._keyFrames,u=h.length;if(0!=u){var d=e[n];if(i)for(-1!=d&&t<h[d].time&&(d=-1,e[n]=d),o=d+1;o<u&&!(h[o].time>t);)d++,o++,e[n]=d;else for((o=d+1)!=u&&t>h[o].time&&(d=u-1,e[n]=d),o=d+1;d>-1&&!(h[d].time<t);)d--,o--,e[n]=d;var c=o==u;if(-1!=d){var _=h[d];if(c)s[n]=_.data.val;else{var p,f=h[o],g=f.time-_.time;p=0!==g?(t-_.time)/g:0,s[n]=this._getTweenVal(_,f,p,g)}}else s[n]=h[0].data.val;r&&"number"==typeof h[0].data.val&&(s[n]=s[n]-h[0].data.val)}}}_getTweenVal(t,e,r,i){var s=t.data,a=e.data;if("number"!=typeof s.val||"number"!=typeof a.val)return s.val;var n=Wn.tween[s.tweenType],l=s.val,o=a.val;if(null!=n)return n(r,l,o-l,1);var h=0,u=0,d=NaN,c=NaN;return null!=s.tweenInfo&&(h=s.tweenInfo.outTangent,d=s.tweenInfo.outWeight),null!=a.tweenInfo&&(u=a.tweenInfo.inTangent,c=a.tweenInfo.inWeight),(isNaN(d)||0>=d)&&(d=Gn.defaultWeight),(isNaN(c)||0>=c)&&(c=Gn.defaultWeight),isNaN(h)&&(h=0),isNaN(u)&&(u=0),Math.abs(h)==Number.MAX_VALUE&&(h=0>h?-1/0:1/0),Math.abs(u)==Number.MAX_VALUE&&(u=0>u?-1/0:1/0),!s.tweenInfo&&!a.tweenInfo||Gn.defaultWeight==c&&Gn.defaultWeight==d?Wn.tween.hermiteInterpolate(h,u,l,o,r,i):this.hermiteCurveSplineWeight(l,t.time,d,h,o,e.time,c,u,r)}_binarySearchEventIndex(t){for(var e,r=0,i=this._animationEvents.length-1;r<=i;){e=r+i>>1;var s=this._animationEvents[e].time;if(s==t)return e;s>t?i=e-1:r=e+1}return r}hermiteCurveSplineWeight(t,e,r,i,s,a,n,l,o){let h=222e-18,u=o,d=t,c=r,_=n,p=a-e,f=s-d;f=Math.max(Math.abs(f),h)*(f<0?-1:1);let g=i,m=l;if(!Number.isFinite(g)||!Number.isFinite(m))return t;g=g*p/f,m=m*p/f;let y=1-_,T=.5,x=0;if(Math.abs(c-.33333334)<1e-4&&Math.abs(_-.33333334)<1e-4)T=u,x=1-T;else for(;;){x=1-T;let t=3*x*x*T*c+3*x*T*T*y+T*T*T-u;if(Math.abs(t)<=2.5*h)break;let e=3*x*x*c+6*x*T*(y-c)+3*T*T*(1-y),r=6*x*(y-2*c)+6*T*(1-2*y+c);T-=(6*t*e*e-3*t*t*r)/(6*e*e*e-6*t*e*r+t*t*(18*c-18*y+6))}return(3*x*x*T*c*g+3*x*T*T*(1-_*m)+T*T*T)*f+d}addEvent(t){var e=this._binarySearchEventIndex(t.time);this._animationEvents.splice(e,0,t)}}Wn.tween={Linear:function(t,e,r,i){return r*t/i+e},Quad_EaseIn:function(t,e,r,i){return r*(t/=i)*t+e},Quad_EaseOut:function(t,e,r,i){return-r*(t/=i)*(t-2)+e},Quad_EaseInOut:function(t,e,r,i){return(t/=i/2)<1?r/2*t*t+e:-r/2*(--t*(t-2)-1)+e},Cubic_EaseIn:function(t,e,r,i){return r*(t/=i)*t*t+e},Cubic_EaseOut:function(t,e,r,i){return r*((t=t/i-1)*t*t+1)+e},Cubic_EaseInOut:function(t,e,r,i){return(t/=i/2)<1?r/2*t*t*t+e:r/2*((t-=2)*t*t+2)+e},Quart_EaseIn:function(t,e,r,i){return r*(t/=i)*t*t*t+e},Quart_EaseOut:function(t,e,r,i){return-r*((t=t/i-1)*t*t*t-1)+e},Quart_EaseInOut:function(t,e,r,i){return(t/=i/2)<1?r/2*t*t*t*t+e:-r/2*((t-=2)*t*t*t-2)+e},Quint_EaseIn:function(t,e,r,i){return r*(t/=i)*t*t*t*t+e},Quint_EaseOut:function(t,e,r,i){return r*((t=t/i-1)*t*t*t*t+1)+e},Quint_EaseInOut:function(t,e,r,i){return(t/=i/2)<1?r/2*t*t*t*t*t+e:r/2*((t-=2)*t*t*t*t+2)+e},Sine_EaseIn:function(t,e,r,i){return-r*Math.cos(t/i*(Math.PI/2))+r+e},Sine_EaseOut:function(t,e,r,i){return r*Math.sin(t/i*(Math.PI/2))+e},Sine_EaseInOut:function(t,e,r,i){return-r/2*(Math.cos(Math.PI*t/i)-1)+e},Expo_EaseIn:function(t,e,r,i){return 0==t?e:r*Math.pow(2,10*(t/i-1))+e},Expo_EaseOut:function(t,e,r,i){return t==i?e+r:r*(1-Math.pow(2,-10*t/i))+e},Expo_EaseInOut:function(t,e,r,i){return 0==t?e:t==i?e+r:(t/=i/2)<1?r/2*Math.pow(2,10*(t-1))+e:r/2*(2-Math.pow(2,-10*--t))+e},Circ_EaseIn:function(t,e,r,i){return-r*(Math.sqrt(1-(t/=i)*t)-1)+e},Circ_EaseOut:function(t,e,r,i){return r*Math.sqrt(1-(t=t/i-1)*t)+e},Circ_EaseInOut:function(t,e,r,i){return(t/=i/2)<1?-r/2*(Math.sqrt(1-t*t)-1)+e:r/2*(Math.sqrt(1-(t-=2)*t)+1)+e},Elastic_EaseIn:function(t,e,r,i,s,a){if(0==t)return e;if(1==(t/=i))return e+r;if(a||(a=.3*i),!s||s<Math.abs(r)){s=r;var n=a/4}else n=a/(2*Math.PI)*Math.asin(r/s);return-s*Math.pow(2,10*(t-=1))*Math.sin((t*i-n)*(2*Math.PI)/a)+e},Elastic_EaseOut:function(t,e,r,i,s,a){if(0==t)return e;if(1==(t/=i))return e+r;if(a||(a=.3*i),!s||s<Math.abs(r)){s=r;var n=a/4}else n=a/(2*Math.PI)*Math.asin(r/s);return s*Math.pow(2,-10*t)*Math.sin((t*i-n)*(2*Math.PI)/a)+r+e},Elastic_EaseInOut:function(t,e,r,i,s,a){if(0==t)return e;if(2==(t/=i/2))return e+r;if(a||(a=i*(.3*1.5)),!s||s<Math.abs(r)){s=r;var n=a/4}else n=a/(2*Math.PI)*Math.asin(r/s);return t<1?s*Math.pow(2,10*(t-=1))*Math.sin((t*i-n)*(2*Math.PI)/a)*-.5+e:s*Math.pow(2,-10*(t-=1))*Math.sin((t*i-n)*(2*Math.PI)/a)*.5+r+e},Back_EaseIn:function(t,e,r,i,s=void 0){return null==s&&(s=1.70158),r*(t/=i)*t*((s+1)*t-s)+e},Back_EaseOut:function(t,e,r,i,s=void 0){return null==s&&(s=1.70158),r*((t=t/i-1)*t*((s+1)*t+s)+1)+e},Back_EaseInOut:function(t,e,r,i,s=void 0){return null==s&&(s=1.70158),(t/=i/2)<1?r/2*(t*t*((1+(s*=1.525))*t-s))+e:r/2*((t-=2)*t*((1+(s*=1.525))*t+s)+2)+e},Bounce_EaseIn:function(t,e,r,i){return r-Wn.tween.Bounce_EaseOut(i-t,0,r,i)+e},Bounce_EaseOut:function(t,e,r,i){return(t/=i)<1/2.75?r*(7.5625*t*t)+e:t<2/2.75?r*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?r*(7.5625*(t-=2.25/2.75)*t+.9375)+e:r*(7.5625*(t-=2.625/2.75)*t+.984375)+e},Bounce_EaseInOut:function(t,e,r,i){return t<i/2?.5*Wn.tween.Bounce_EaseIn(2*t,0,r,i)+e:.5*Wn.tween.Bounce_EaseOut(2*t-i,0,r,i)+.5*r+e},hermiteInterpolate:function(t,e,r,i,s,a){if(Math.abs(t)==1/0||Math.abs(e)==1/0)return r;var n=s*s,l=n*s;return(2*l-3*n+1)*r+(l-2*n+s)*t*a+(l-n)*e*a+(-2*l+3*n)*i}};class Yn{}t.AniConditionType=void 0,(Ln=t.AniConditionType||(t.AniConditionType={}))[Ln.Greater=0]="Greater",Ln[Ln.Less=1]="Less",Ln[Ln.Equals=2]="Equals",Ln[Ln.NotEqual=3]="NotEqual";class Xn{}class jn{static conditionNameToID(t){if(null!=jn._conditionNameMap[t])return jn._conditionNameMap[t];var e=this._propertyNameCounter++;return this._conditionNameMap[t]=e,this._conditionNameMap[e]=t,e}static conditionIDToName(t){return this._conditionNameMap[t]}constructor(t=null){t&&(this._id=jn.conditionNameToID(t),this._name=t)}get id(){return this._id}get name(){return this._name}set name(t){this._id=jn.conditionNameToID(t),this._name=t}get type(){return this._type}checkState(t){return!1}}jn._conditionNameMap={},jn._propertyNameCounter=0;class qn extends jn{constructor(e){super(e),this._numberValue=0,this._numberCompareFlag=t.AniStateConditionNumberCompressType.Greater,this._type=t.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(t){this._numberValue=t}get compareFlag(){return this._numberCompareFlag}set compareFlag(t){this._numberCompareFlag=t}checkState(e){return t.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?e>this._numberValue:e<this._numberValue}}class $n extends jn{constructor(e){super(e),this._compareFlag=!0,this._type=t.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(t){this._compareFlag=t}checkState(t){return this._compareFlag==t}}class Kn extends jn{constructor(e){super(e),this._type=t.AniStateConditionType.Trigger}checkState(t){return t}}class Qn{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(t){-1==this.conditions.indexOf(t)&&this.conditions.push(t)}removeCondition(t){let e=this.conditions.indexOf(t);-1!=e&&this.conditions.splice(e,0)}check(e,r,i){if(this.mute)return!1;if(this.exitByTime&&e<this.exitTime&&!i)return!1;if(null==this.conditions||0==this.conditions.length)return!0;if(this.isAndOperEnabled){let e;for(var s=0;s<this.conditions.length;s++){let i=this.conditions[s];if(!i.checkState(r[i.name].value))return!1;i.type==t.AniStateConditionType.Trigger&&e.push(i.name)}return!0}for(s=0;s<this.conditions.length;s++){let e=this.conditions[s];if(e.checkState(r[e.name].value))return e.type==t.AniStateConditionType.Trigger&&(r[e.name].value=!1),!0}return!1}}class Zn extends b{constructor(t){super();let e=On.parse(t);this.data=e.ret,this.clipsID=e.clipsID}getLayers(){let t=this.data.controllerLayers,e=[];for(let r=t.length-1;r>=0;r--){let i=t[r],s=new Cn(i.name);e.unshift(s);for(let t in i)if("name"!=t&&"states"!=t&&null!=i[t])try{s[t]=i[t]}catch(t){console.error(t)}this.getState(i.states,s,this.data)}return e}createState(t,e,r){if(!t)return null;let i={},s=null;for(let a=t.length-1;a>=0;a--){let n=t[a],l=n.states;if(l){let t=this.createState(l,e,r);t&&(e[n.id]=t.states[t.id]);continue}if(0>Number(n.id)){if("-1"==n.id){let t=n.soloTransitions;t&&0<t.length&&(s=t[0].id)}continue}let o=new Un;e[n.id]=o,i[n.id]=o;for(let t in n)try{if("scripts"==t){let e=n[t];if(e&&Array.isArray(e))for(let t=e.length-1;t>=0;t--){let r=e[t];r&&0==r.indexOf("res://")&&(r=r.substring(6));let i=Ot.getClass(r);i&&o.addScript(i)}continue}if("soloTransitions"==t)continue;null!=n[t]&&(o[t]=n[t])}catch(t){}r.addState(o)}return{id:s,states:i}}getState(t,e,r){if(t){let i={};this.createState(t,i,e),this.setTransitions(t,i,e,r)}}setExitTransition(t,e,r,i,s){for(let a in t){let n=r[a];if(n){let l=n.transitions,o=n.soloTransitions,h=t[a];for(let t=e.length-1;t>=0;t--){let n=e[t];if("-3"!=n.id)for(let t=h.length-1;t>=0;t--){let e=h[t],s=new Qn;s.destState=r[n.id],n.conditions&&this.addConditions(n.conditions,s,i),e.conditions&&this.addConditions(e.conditions,s,i);for(let t in n)"solo"!=t&&"id"!=t&&"conditions"!=t&&(s[t]=n[t]);n.solo?o.unshift(s):l.unshift(s)}else null==s[a]&&(s[a]=[]),s[a].push(n)}}}}_getAnimatorTransition2D(t,e,r){let i=new Qn;e[t.id]&&(i.destState=e[t.id]),t.conditions&&this.addConditions(t.conditions,i,r);for(let e in t)"solo"!=e&&"id"!=e&&"conditions"!=e&&(i[e]=t[e]);return i}setTransitions(t,e,r,i,s){if(!t)return null;let a={};for(let s=t.length-1;s>=0;s--){let n=t[s];if(n.states){let t=this.setTransitions(n.states,e,r,i,n);if(t){let r=n.soloTransitions;r&&this.setExitTransition(t,r,e,i,a)}}}for(let n=t.length-1;n>=0;n--){let l=t[n];if(l.states)continue;if("-1"==l.id){if(l.soloTransitions&&0<l.soloTransitions.length){null==s?(r.defaultState=e[l.soloTransitions[0].id],r._enterTransition=this._getAnimatorTransition2D(l.soloTransitions[0],e,i)):e[s.id]=e[l.soloTransitions[0].id];continue}}else{if("-2"==l.id){let t=l.soloTransitions;if(t)for(let r=t.length-1;r>=0;r--){let s=t[r];if(e[s.id])for(let t in e){let r=e[t],a=this._getAnimatorTransition2D(s,e,i);s.solo?r.soloTransitions.unshift(a):r.transitions.unshift(a)}}continue}if("-3"==l.id)continue}let o=l.soloTransitions;if(o&&e[l.id]){let t=e[l.id].transitions,r=e[l.id].soloTransitions;for(let s=o.length-1;s>=0;s--){let n=o[s];if("-3"==n.id){null==a[l.id]&&(a[l.id]=[]),a[l.id].push(n);continue}let h=this._getAnimatorTransition2D(n,e,i);n.solo?r.unshift(h):t.unshift(h)}}}return a}addConditions(e,r,i){let s=i.animatorParams;if(null!=s&&0!=s.length)for(let i=0,a=e.length;i<a;i++){let a,n=e[i],l=null;for(let t=s.length-1;t>=0;t--)if(s[t].id==n.id){l=s[t];break}if(null==l)return;if(l.type==t.AniParmType.Bool){let t=new $n(l.name);t.compareFlag=Boolean(n.checkValue),a=t}else if(l.type==t.AniParmType.Float){let t=new qn(l.name);t.numberValue=Number(n.checkValue),t.compareFlag=n.type,a=t}else if(l.type==t.AniParmType.Trigger){a=new Kn(l.name)}r.addCondition(a)}}updateTo(t){let e=t._controllerLayers;for(let t=0,r=e.length;t<r;t++)e[t].destroy();e.length=0;let r=this.getLayers();for(let e=0,i=r.length;e<i;e++)t.addControllerLayer(r[e]);let i=this.data.animatorParams;if(i){let e={};for(let t=i.length-1;t>=0;t--){let r=i[t],s=new Yn;s.name=r.name,s.type=r.type,s.value=r.val,e[r.name]=s}t.parameters=e}}}class Jn extends tn{_isScript(){return!0}setupScript(){let t,r=this.owner;this.onTriggerEnter!=Jn.prototype.onTriggerEnter&&r.on(s.TRIGGER_ENTER,this,this.onTriggerEnter),this.onTriggerStay!=Jn.prototype.onTriggerStay&&r.on(s.TRIGGER_STAY,this,this.onTriggerStay),this.onTriggerExit!=Jn.prototype.onTriggerExit&&r.on(s.TRIGGER_EXIT,this,this.onTriggerExit),this.onCollisionEnter!=Jn.prototype.onCollisionEnter&&r.on(s.COLLISION_ENTER,this,this.onCollisionEnter),this.onCollisionStay!=Jn.prototype.onCollisionStay&&r.on(s.COLLISION_STAY,this,this.onCollisionStay),this.onCollisionExit!=Jn.prototype.onCollisionExit&&r.on(s.COLLISION_EXIT,this,this.onCollisionExit),(t=this.onJointBreak)&&r.on(s.JOINT_BREAK,this,t),(t=this.onMouseDown)&&r.on(s.MOUSE_DOWN,this,t),(t=this.onMouseUp)&&r.on(s.MOUSE_UP,this,t),(t=this.onRightMouseDown)&&r.on(s.RIGHT_MOUSE_DOWN,this,t),(t=this.onRightMouseUp)&&r.on(s.RIGHT_MOUSE_UP,this,t),(t=this.onMouseMove)&&r.on(s.MOUSE_MOVE,this,t),(t=this.onMouseDrag)&&r.on(s.MOUSE_DRAG,this,t),(t=this.onMouseDragEnd)&&r.on(s.MOUSE_DRAG_END,this,t),(t=this.onMouseOver)&&r.on(s.MOUSE_OVER,this,t),(t=this.onMouseOut)&&r.on(s.MOUSE_OUT,this,t),(t=this.onMouseClick)&&r.on(s.CLICK,this,t),(t=this.onMouseDoubleClick)&&r.on(s.DOUBLE_CLICK,this,t),(t=this.onMouseRightClick)&&r.on(s.RIGHT_CLICK,this,t),(t=this.onKeyDown)&&e.stage.on(s.KEY_DOWN,this,t),(t=this.onKeyPress)&&e.stage.on(s.KEY_PRESS,this,t),(t=this.onKeyUp)&&e.stage.on(s.KEY_UP,this,t),r.event(s._Add_Script)}}t.TextResourceFormat=void 0,(Pn=t.TextResourceFormat||(t.TextResourceFormat={}))[Pn.Buffer=0]="Buffer",Pn[Pn.Plain=1]="Plain",Pn[Pn.JSON=2]="JSON",Pn[Pn.XML=3]="XML";class tl extends b{constructor(t,e){super(),this.data=t,this.format=e}}Bt.registerLoader(["txt","csv"],class{load(e){return e.loader.fetch(e.url,"text",e.progress.createCallback(),e.options).then((e=>e?new tl(e,t.TextResourceFormat.Plain):null))}},Bt.TEXT),Bt.registerLoader(["bin","bytes","fui"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?new tl(e,t.TextResourceFormat.Buffer):null))}},Bt.BUFFER),Bt.registerLoader(["json"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((e=>e?new tl(e,t.TextResourceFormat.JSON):null))}},Bt.JSON),Bt.registerLoader(["xml"],class{load(e){return e.loader.fetch(e.url,"xml",e.progress.createCallback(),e.options).then((e=>e?new tl(e,t.TextResourceFormat.XML):null))}},Bt.XML);Bt.registerLoader(["atlas"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(.2),t.options).then((e=>{if(!e)return null;let r=[];if(e.meta&&e.meta.image){let i="",s=t.url.lastIndexOf("/");-1!=s&&(i=t.url.substring(0,s+1));let a="";s=t.url.lastIndexOf("?"),-1!=s&&(a=t.url.substring(s));let n=e.meta.image.split(",");for(let e of n)r.push(t.loader.load(i+e+a,null,t.progress.createCallback()))}else r.push(t.loader.load(P.replaceFileExtension(t.url,"png"),null,t.progress.createCallback()));return Promise.all(r).then((r=>{r=r.filter((t=>null!=t));let i=t.options.baseUrl||"",s=e.frames,a=e.meta&&null!=e.meta.prefix?e.meta.prefix:t.url.substring(0,t.url.lastIndexOf("."))+"/",n=[],l=1;e.meta&&e.meta.scale&&1!=e.meta.scale&&(l=parseFloat(e.meta.scale));for(let t of r)t.scaleRate=l;for(let e in s){let l=s[e],o=r[l.frame.idx?l.frame.idx:0];if(!o)continue;let h=i+a+(l.filename||e),u=mt.create(o,l.frame.x,l.frame.y,l.frame.w,l.frame.h,l.spriteSourceSize.x,l.spriteSourceSize.y,l.sourceSize.w,l.sourceSize.h);u._sizeGrid=l.sizeGrid,u._stateNum=l.stateNum,t.loader.cacheRes(h,u),u.url=h,n.push(u)}return new xt(a,r,n)}))}))}},Bt.ATLAS);class el{static _parseHDRTexture(t,e=null,r=null){let i=el.getHDRInfo(t),s=new ct(i.width,i.height,i.format,!1,!1,!1);return s.setHDRData(i),e&&(null!=e.wrapModeU&&(s.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(s.wrapModeV=e.wrapModeV),null!=e.filterMode&&(s.filterMode=e.filterMode),null!=e.anisoLevel&&(s.anisoLevel=e.anisoLevel)),s}static getHDRInfo(e){let r=new Uint8Array(e),i=0;const s=()=>{let t=el.getLineString(r,i);return i+=t.length+1,t};if("#?RADIANCE"!=s())throw"HDR image: identifier wrong.";let a=new Map,n="";do{if(n=s(),"#"!=n[0]){let t=n.split("=");a.set(t[0],t[1])}}while(""!=n);if("32-bit_rle_rgbe"!=a.get("FORMAT"))throw"HDR image: unsupported format.";let l=s().split(" "),o="-Y"==l[0],h="-X"==l[2],u=parseInt(l[1]),d=parseInt(l[3]);return new el(e,i,h,o,d,u,t.TextureFormat.R32G32B32A32)}static getLineString(t,e){let r=t.length,i=e,s="",a="";for(;i<r&&"\n"!=a;)s=`${s}${a}`,a=String.fromCharCode(t[i]),i++;return s}constructor(t,e,r,i,s,a,n){this.source=t,this.byteOffset=e,this.decreaseX=r,this.decreaseY=i,this.width=s,this.height=a,this.format=n}get_32_bit_rle_rgbe(){let t=this.width,e=this.height;this.decreaseX,this.decreaseY;let r=new Uint8Array(this.source,this.byteOffset),i=0,s=new ArrayBuffer(4*t),a=new Uint8Array(s),n=new ArrayBuffer(t*e*4*3),l=new Float32Array(n);for(let s=e;s>0;s--){r[i++],r[i++];let n=r[i++]<<8|r[i++];if(n!=t)throw"HDR info: scanlineLength wrong.";let o=0;for(let t=0;t<4;t++){let e=(t+1)*n;for(;o<e;){let t=r[i++],s=r[i++];if(t>128){let r=t-128;if(r>e-o)throw"HDR info: ??";for(;r-- >0;)a[o++]=s}else{let n=t;if(0==n||n>e-o)throw"HDR info: ??";if(a[o++]=s,--n>0)for(let t=0;t<n;t++)a[o++]=r[i++]}}}for(let t=0;t<n;t++){let r=a[t],i=a[t+n],o=a[t+2*n],h=a[t+3*n],u=(e-s)*n*3+3*t;const d=(t,e)=>e>1023?t*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?t*Math.pow(2,-1074)*Math.pow(2,e+1074):t*Math.pow(2,e);if(h>0){let t=d(1,h-136);l[u]=r*t,l[u+1]=i*t,l[u+2]=o*t}else l[u]=0,l[u+1]=0,l[u+2]=0}}return l}readScanLine(){let e=this.width,r=this.height,i=this.decreaseX,s=this.decreaseY,a=3;this.format==t.TextureFormat.R32G32B32A32&&(a=4);let n=new Float32Array(e*r*a),l=new Uint8Array(4*e),o=new Uint8Array(this.source,this.byteOffset),h=o.length,u=0;const d=()=>{if(u>=h)throw"HDR info: data wrong.";return o[u++]},c=()=>{throw"HDR info: data wrong."};for(let t=r-1;t>=0;t--){this.readcolors(l,d,c);for(let o=0;o<e;o++){let h=4*o,u=l[h],d=l[h+1],c=l[h+2],_=l[h+3],p=t,f=o;s&&(p=r-1-t),i&&(f=e-1-o);let g=p*e*a+f*a;if(0==_)n[g]=0,n[g+1]=0,n[g+2]=0,4==a&&(n[g+3]=1);else{let t=rl(1,_-136);n[g]=(u+.5)*t,n[g+1]=(d+.5)*t,n[g+2]=(c+.5)*t,4==a&&(n[g+3]=1)}}}return n}readcolors(t,e,r){const i=(e,r,i)=>{t[4*e+r]=i};let s=this.width,a=e(),n=e(),l=e(),o=e();if(s<8||s>32767)this.olddreadcolors(t,e,a,n,l,o);else if(2!=a||2!=n||128&l)this.olddreadcolors(t,e,a,n,l,o);else{(l<<8|o)!=s&&r();for(let t=0;t<4;t++)for(let a=0;a<s;){let n=e();if(n>128){n&=127;let l=e();for(a+n>s&&r();n--;)i(a++,t,l)}else for(a+n>s&&r();n--;){i(a++,t,e())}}}}olddreadcolors(t,e,r,i,s,a){let n=0,l=this.width;t[0]=r,t[1]=i,t[2]=s,t[3]=a;for(let r=1;r<l;r++){let i=e(),s=e(),a=e(),l=e(),o=4*r;if(t[o]=i,t[o+1]=s,t[o+2]=a,t[o+3]=l,1==i&&1==s&&1==a){let e=o-4;for(let r=l<<n;r>0;r--)t[o]=t[e],t[o+1]=t[e+1],t[o+2]=t[e+2],t[o+3]=t[e+3];n+=8}else n=0}}color_color(t,e){let r=0;0==e.w?t.x=t.y=t.z=0:(r=rl(1,e.w-136),t.x=e.x*r,t.y=e.y*r,t.z=e.z*r)}}function rl(t,e){return t*Math.pow(2,e)}el.HDRTEXTURE="HDRTEXTURE";class il{constructor(){Nn||(Nn={"WhiteTexture.png":ct.whiteTexture,"BlackTexture.png":ct.blackTexture,"GrayTexture.png":ct.grayTexture,"NormalTexture.png":ct.normalTexture})}load(t){if(-1!=t.url.indexOf("internal/")){let e=Nn[P.getBaseName(t.url)];if(e)return Promise.resolve(e)}let e;return t.url.startsWith("data:")||(e=N.inst.metaMap[t.url],e||!n.isPreview)?this.load2(t,e):N.inst.getMeta(t.url,t.uuid).then((e=>this.load2(t,e)))}load2(e,r){var i,s,a;let n,o,h=e.ext,u=e.url;if(r){let t=A.platform,l=(null===(i=r.platforms)||void 0===i?void 0:i[t])||0,d=(null===(s=r.files)||void 0===s?void 0:s[l])||{};d.file&&(u=N.inst.getSubAssetURL(u,e.uuid,d.file,d.ext),h=d.ext),n=[0,0,null!==(a=d.format)&&void 0!==a?a:1,r.mipmap,r.readWrite,r.sRGB],o={wrapModeU:r.wrapMode,wrapModeV:r.wrapMode,filterMode:r.filterMode,anisoLevel:r.anisoLevel,premultiplyAlpha:!!r.pma,hdrEncodeFormat:r.hdrEncodeFormat}}else n=e.options.constructParams,o=e.options.propertyParams;let d=-1!=hl.indexOf(h)?h:null;if(null!=d)return e.loader.fetch(u,"arraybuffer",e.progress.createCallback(),e.options).then((i=>{if(!i)return null;let s;switch(d){case"dds":let e=lt.getDDSTextureInfo(i);if(e.isCube){let t=Ot.getClass("TextureCube");if(!t)return null;{let r=!!n&&!!n[5],i=new t(e.width,e.format,e.mipmapCount>1,r);i.setDDSData(e),s=i}}else s=ct._parseDDS(i,o,n);break;case"ktx":let r=dt.getKTXTextureInfo(i);if(r.dimension==t.TextureDimension.Cube){let t=Ot.getClass("TextureCube");if(!t)return null;{let e=new t(r.width,r.format,r.mipmapCount>1,r.sRGB);e.setKTXData(r),s=e}}else r.dimension==t.TextureDimension.Tex2D&&(s=ct._parseKTX(i,o,n));break;case"pvr":s=ct._parsePVR(i,o,n);break;case"hdr":s=el._parseHDRTexture(i,o,n);break;case"lanit.ls":s=ct._SimpleAnimatorTextureParse(i,o,n)}let a=e.obsoluteInst;return a&&Object.getPrototypeOf(a)==Object.getPrototypeOf(s)&&(s=this.move(a,s)),o&&o.hdrEncodeFormat&&(s.hdrEncodeFormat=o.hdrEncodeFormat),r&&(s._sizeGrid=r.sizeGrid,s._stateNum=r.stateNum),s}));{let t=e.options,i=o&&o.premultiplyAlpha?"premultiply":"none";return t.useWorkerLoader&&"none"===i&&(t=Object.assign({workerLoaderOptions:{premultiplyAlpha:i}},t)),e.loader.fetch(u,"image",e.progress.createCallback(),t).then((e=>l.textureContext.needBitmap?e instanceof ImageBitmap?e:createImageBitmap(e,t.workerLoaderOptions||{premultiplyAlpha:i}):e)).then((t=>{if(!t)return null;let i=ct._parseImage(t,o,n),s=e.obsoluteInst;return s&&Object.getPrototypeOf(s)==Object.getPrototypeOf(i)&&(i=this.move(s,i)),r&&(i._sizeGrid=r.sizeGrid,i._stateNum=r.stateNum),i}))}}move(t,e){return t._texture=e._texture,t._format=e.format,t.width=e.width,t.height=e.height,t.obsolute=!1,delete b._idResourcesMap[e.id],t}}class sl{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then((e=>{if(!e)return null;let r=t.obsoluteInst;return r?r.recreate(e.width,e.height,e.colorFormat,e.depthFormat,e.generateMipmap,e.multiSamples,e.generateDepthTexture,e.sRGB):r=new C(e.width,e.height,e.colorFormat,e.depthFormat,e.generateMipmap,e.multiSamples,e.generateDepthTexture,e.sRGB),null!=e.anisoLevel&&(r.anisoLevel=e.anisoLevel),null!=e.filterMode&&(r.filterMode=e.filterMode),null!=e.wrapModeU&&(r.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(r.wrapModeV=e.wrapModeV),r}))}}class al{load(t){let e=t.obsoluteInst||new wn;return e.source=t.url,Promise.resolve(e)}}const nl={premultiplyAlpha:!0},ll=[null,null,t.TextureFormat.R8G8B8A8,!1,!1,!0];class ol{wrapTex2D(t,e){if(!e)return null;let r=t.obsoluteInst;return r?(r.setTo(e),r.obsolute=!1,r._sizeGrid=e._sizeGrid,r._stateNum=e._stateNum,r.event("reload"),r._clipCache&&r._clipCache.forEach((t=>{t.event("reload"),t._sizeGrid=r._sizeGrid,t._stateNum=r._stateNum}))):(r=new mt(e),r._sizeGrid=e._sizeGrid,r._stateNum=e._stateNum),r}load(t){let e=t.loader.getRes(t.url,Bt.TEXTURE2D);if(!e||e.obsolute){let e={url:t.url,type:Bt.TEXTURE2D};return t.options.propertyParams?null==t.options.propertyParams.premultiplyAlpha&&(e.propertyParams=Object.assign({},nl,t.options.propertyParams)):e.propertyParams=nl,t.options.constructParams?null==t.options.constructParams[5]&&(e.constructParams=Object.assign([],ll,t.options.constructParams)):e.constructParams=ll,t.loader.load(e,t.options,t.progress.createCallback()).then((e=>this.wrapTex2D(t,e)))}return Promise.resolve(this.wrapTex2D(t,e))}}const hl=["ktx","pvr","dds","hdr","exr","lanit.ls"],ul=["mp4","webm"];Bt.registerLoader(["tga","tif","tiff","png","jpg","jpeg","webp","rendertexture",...ul,...hl],ol,Bt.IMAGE,!0),Bt.registerLoader([],il,Bt.TEXTURE2D,!0),Bt.registerLoader(["rendertexture"],sl,Bt.TEXTURE2D,!0),Bt.registerLoader(ul,al,Bt.TEXTURE2D);Bt.registerLoader(["mc"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?Wn._parse(t):null))}});Bt.registerLoader(["mcc"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(.2),t.options).then((e=>{let r=new Zn(e);if(r.data&&r.data.controllerLayers){let e=r.data.controllerLayers,i=[];for(let r=e.length-1;r>=0;r--){let s=e[r].states;this.loadStates(s,i,t)}return Promise.all(i).then((t=>(r.addDeps(t),r)))}return r}))}loadStates(t,e,r){let i=O.getPath(r.url);for(let s=t.length-1;s>=0;s--){if(t[s].clip&&t[s].clip._$uuid){let a=O.getResURLByUUID(t[s].clip._$uuid);a.startsWith("res://")||(a=O.join(i,a)),e.push(r.loader.load(a).then((e=>(t[s].clip=e,e))))}t[s].states&&this.loadStates(t[s].states,e,r)}}});class dl{load(t){return Promise.resolve(null)}}Bt.registerLoader(["lighting"],dl);Bt.registerLoader(["fnt"],class{load(t){let e=P.replaceFileExtension(t.url,"png");return Promise.all([t.loader.fetch(t.url,"xml",t.progress.createCallback(.2),t.options),t.loader.load(e,t.options,t.progress.createCallback(.8))]).then((([t,e])=>{if(!t||!e)return null;let r=new bs;return r.parseFont(t,e),r}))}},Bt.FONT);const cl="LayaTTFFont";Bt.registerLoader(["ttf","woff","woff2","otf"],class{load(t){let r=P.replaceFileExtension(P.getBaseName(t.url),"");if(n.isConch)return t.loader.fetch(t.url,"arraybuffer").then((t=>(t&&window.conch.registerFont(r,t),{family:r})));if(window.FontFace){let e=new window.FontFace(r,"url('"+O.postFormatURL(O.formatURL(t.url))+"')");return document.fonts.add(e),e.load().then((()=>e))}{let i="40px "+r,s=A.measureText(cl,i).width,a=A.createElement("style");return a.type="text/css",document.body.appendChild(a),a.textContent="@font-face { font-family:'"+r+"'; src:url('"+O.postFormatURL(O.formatURL(t.url))+"');}",new Promise((t=>{let a=()=>{A.measureText(cl,i).width!=s&&n()},n=()=>{e.systemTimer.clear(this,a),e.systemTimer.clear(this,n),t({family:r})};e.systemTimer.once(1e4,this,n),e.systemTimer.loop(20,this,a)}))}}},Bt.TTF);class _l{static parse(t){let e=t.props;switch(t.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":case"LAYAMATERIAL:03":let e=_l.parseLegacy(t);return e.oldparseEndEvent(),e;case"LAYAMATERIAL:04":break;default:throw new Error(`unkonwn material version: ${t.version}`)}let r,i=new Xa;i.setShaderName(e.type);for(let t in e)switch(t){case"type":case"name":break;case"defines":let a=e[t];for(let t=0,e=a.length;t<e;t++){let e=dr.getDefineByName(a[t]);i._shaderValues.addDefine(e)}break;case"textures":let n=e[t];for(let t=0,e=n.length;t<e;t++){let e=n[t],r=e.path;r&&i._shaderValues.setTexture(dr.propertyNameToID(e.name),Bt.getBaseTexture(r))}break;case"renderQueue":r=e[t];break;case"alphaTest":i.alphaTest=e[t];break;case"materialRenderMode":i.materialRenderMode=e[t];break;default:let l=e[t],o=dr.propertyNameToID(t);switch(o){case dr.CULL:i.cull=l;break;case dr.BLEND:i.blend=l;break;case dr.BLEND_SRC:i.blendSrc=l;break;case dr.BLEND_DST:i.blendDst=l;break;case dr.BLEND_DST_ALPHA:i.blendDstAlpha=l;break;case dr.BLEND_SRC_ALPHA:i.blendSrcAlpha=l;break;case dr.BLEND_SRC_RGB:i.blendSrcRGB=l;break;case dr.BLEND_SRC_RGB:i.blendDstRGB=l;break;case dr.DEPTH_TEST:i.depthTest=l;break;case dr.DEPTH_WRITE:i.depthWrite=!!e[t];break;case dr.STENCIL_TEST:i.stencilTest=l;break;case dr.STENCIL_Op:i.stencilOp=l;break;case dr.STENCIL_Ref:i.stencilRef=l;break;case dr.STENCIL_WRITE:i.stencilWrite=l;break;default:if(l.length){var s=l;switch(s.length){case 2:i._shaderValues.setVector2(o,new Qe(s[0],s[1]));break;case 3:i._shaderValues.setVector3(o,new d(s[0],s[1],s[2]));break;case 4:i._shaderValues.getColor(o)?i._shaderValues.setColor(o,new _t(s[0],s[1],s[2],s[3])):i._shaderValues.setVector(o,new u(s[0],s[1],s[2],s[3]));break;case 9:let t=new Oe;t.elements=new Float32Array(s),i._shaderValues.setMatrix3x3(o,t);break;case 16:let e=new $e;e.elements=new Float32Array(s),i._shaderValues.setMatrix4x4(o,e);break;default:i._shaderValues.setBuffer(o,s)}}else"boolean"==typeof l?i._shaderValues.setBool(o,e[t]):i._shaderValues.setNumber(o,e[t])}}return null!=r&&(i.renderQueue=r),i}static collectLinks(t,e){var r;let i=[],s=null===(r=t.props)||void 0===r?void 0:r.textures;if(s)for(let t=0,r=s.length;t<r;t++){let r=s[t],a=r.path;a&&(r.path=O.join(e,a),i.push({url:r.path,type:Bt.TEXTURE2D,constructParams:r.constructParams,propertyParams:r.propertyParams}))}return i}static parseLegacy(t){let e,r=t,i=r.props,s=i.type,a=Ot.getClass(s);switch(!a&&s&&s.startsWith("Laya.")&&(a=Ot.getClass(s.substring(5))),a?e=new a:(e=new Xa,e.setShaderName(s)),r.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(let t in i)switch(t){case"type":break;case"vectors":let r=i[t];for(let t=0,i=r.length;t<i;t++){let i=r[t],s=i.value;switch(s.length){case 2:e[i.name]=new Qe(s[0],s[1]);break;case 3:e[i.name]instanceof _t?e[i.name]=new _t(s[0],s[1],s[2],1):e[i.name]=new d(s[0],s[1],s[2]);break;case 4:e[i.name]instanceof _t?e[i.name]=new _t(s[0],s[1],s[2],s[3]):e[i.name]=new u(s[0],s[1],s[2],s[3]);break;default:throw new Error("unknown material color length: "+s.length)}}break;case"colors":let s=i[t];for(let t=0,r=s.length;t<r;t++){let r=s[t],i=r.value;e[r.name]=new _t(i[0],i[1],i[2],i[3])}break;case"textures":let a=i[t];for(let t=0,r=a.length;t<r;t++){let r=a[t],i=r.path;i&&(e[r.name]=Bt.getBaseTexture(i))}break;case"defines":let n=i[t];for(let t=0,r=n.length;t<r;t++){let r=dr.getDefineByName(n[t]);e._shaderValues.addDefine(r)}break;case"renderStates":let l=i[t][0];e.blend=l.blend,e.cull=this._getRenderStateParams(l.cull),e.depthTest=this._getRenderStateParams(l.depthTest),e.depthWrite=l.depthWrite,e.blendSrc=this._getRenderStateParams(l.srcBlend),e.blendDst=this._getRenderStateParams(l.dstBlend);break;case"cull":e.cull=this._getRenderStateParams(i[t]);break;case"blend":e.blend=this._getRenderStateParams(i[t]);break;case"depthWrite":e.depthWrite=!!i[t];break;case"srcBlend":case"blendSrc":e.blendSrc=this._getRenderStateParams(i[t]);break;case"dstBlend":case"blendDst":e.blendDst=this._getRenderStateParams(i[t]);break;case"depthTest":e.depthTest=this._getRenderStateParams(i[t]);break;default:e[t]=i[t]}break;case"LAYAMATERIAL:03":for(let t in i)switch(t){case"type":case"name":break;case"defines":let r=i[t];for(let t=0,i=r.length;t<i;t++){let i=dr.getDefineByName(r[t]);e._shaderValues.addDefine(i)}break;case"textures":let s=i[t];for(let t=0,r=s.length;t<r;t++){let r=s[t],i=r.path;i&&e._shaderValues.setTexture(dr.propertyNameToID(r.name),Bt.getBaseTexture(i))}break;case"renderQueue":e.renderQueue=i[t];break;default:let a=i[t],l=dr.propertyNameToID(t);switch(l){case dr.CULL:e.cull=this._getRenderStateParams(a);break;case dr.BLEND:e.blend=this._getRenderStateParams(a);break;case dr.BLEND_SRC:e.blendSrc=this._getRenderStateParams(a);break;case dr.BLEND_DST:e.blendDst=this._getRenderStateParams(a);break;case dr.DEPTH_TEST:e.depthTest=this._getRenderStateParams(a);break;case dr.DEPTH_WRITE:e.depthWrite=!!i[t];break;default:if(a.length){var n=a;switch(n.length){case 2:e._shaderValues.setVector2(l,new Qe(n[0],n[1]));break;case 3:e._shaderValues.setVector3(l,new d(n[0],n[1],n[2]));break;case 4:e._shaderValues.getColor(l)?e._shaderValues.setColor(l,new _t(n[0],n[1],n[2],n[3])):e._shaderValues.setVector(l,new u(n[0],n[1],n[2],n[3]));break;default:throw new Error("unknown material color length: "+n.length)}}else"boolean"==typeof a?e._shaderValues.setBool(l,i[t]):e._shaderValues.setNumber(l,i[t])}}break;default:throw new Error("unknown material version: "+r.version)}return e}static _getRenderStateParams(e){switch(e){case 768:return t.BlendFactor.SourceColor;case 769:return t.BlendFactor.OneMinusSourceColor;case 774:return t.BlendFactor.DestinationColor;case 775:return t.BlendFactor.OneMinusDestinationColor;case 770:return t.BlendFactor.SourceAlpha;case 771:return t.BlendFactor.OneMinusSourceAlpha;case 772:return t.BlendFactor.DestinationAlpha;case 773:return t.BlendFactor.OneMinusDestinationAlpha;case 776:return t.BlendFactor.SourceAlphaSaturate;case 32774:return t.BlendEquationSeparate.ADD;case 32778:return t.BlendEquationSeparate.SUBTRACT;case 32779:return t.BlendEquationSeparate.REVERSE_SUBTRACT;case 512:return t.CompareFunction.Never;case 513:return t.CompareFunction.Less;case 514:return t.CompareFunction.Equal;case 515:return t.CompareFunction.LessEqual;case 516:return t.CompareFunction.Greater;case 517:return t.CompareFunction.NotEqual;case 518:return t.CompareFunction.GreaterEqual;case 519:return t.CompareFunction.Always;default:return e}}}class pl{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(.3),t.options).then((e=>{if(!e)return null;let r=O.getPath(t.url),i=_l.collectLinks(e,r);if("LAYAMATERIAL:04"===e.version){let s=e.props.type;if(!dr.find(s)){let a=N.inst.shaderName_to_URL(s);if(!a)return N.inst.shaderName_to_URL_async(s).then((a=>(a?i.push(a):e.props.shaderPath?i.push(O.join(r,e.props.shaderPath)):Bt.warn(`unknown shaderName: ${s}`),this.load2(t,e,i))));i.push(a)}}return this.load2(t,e,i)}))}load2(t,e,r){if(0==r.length){let r=_l.parse(e),i=t.obsoluteInst;return i&&(r=this.move(i,r)),Promise.resolve(r)}let i=Object.assign({},t.options);return i.initiator=t,delete i.cache,delete i.ignoreCache,t.loader.load(r,i,t.progress.createCallback()).then((()=>{let r=_l.parse(e),i=t.obsoluteInst;return t.obsoluteInst&&(r=this.move(i,r)),r}))}move(t,e){return t._shaderValues.reset(),t.setShaderName(e._shader.name),e._shaderValues.cloneTo(t._shaderValues),t.materialRenderMode=e.materialRenderMode,t.renderQueue=e.renderQueue,t.obsolute=!1,e.destroy(),t}}Bt.registerLoader(["lmat"],pl,Bt.MATERIAL,!0);class fl{static parse(t){return this.parseStart(t)}static findIndex(t,e,r,i){var s=t.indexOf(r,e+1);return 0>s&&(s=i),{str:t.substring(e+1,s),i:s}}static finCurrObj(){if(this.type=1,null==this.cobj)return null;if(0==this.currArr.length)return this.cobj.k&&(this.ret[this.cobj.k]=this.cobj.val),null;var t=this.currArr.pop();if(this.cobj.k)if(Array.isArray(t.val)){if(null!=this.cobj.k){var e={};e[this.cobj.k]=this.cobj.val,t.val.push(e)}}else t.val[this.cobj.k]=this.cobj.val;else Array.isArray(this.cobj.val)&&(Array.isArray(t.val)?t.val.push(this.cobj.val):t.val=this.cobj.val);return t}static formatVal(t){if(null==t)return null;var e=Number(t);return isNaN(e)?"false"!=t.toLowerCase()&&("true"==t.toLowerCase()||("null"==t?null:t)):e}static finCurrStr(){null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&(null!=this.cobj&&(Array.isArray(this.cobj.val)?this.cobj.val.push(this.formatVal(this.currStr)):(this.cobj.val=this.formatVal(this.currStr),this.cobj=this.finCurrObj())),this.currStr=""))}static parseStart(t){this.len=t.length;var e=0;for(this.ret={},this.currStr=null,this.currArr=[],this.cobj=null,this.type=0;e<this.len;){var r=t.charAt(e);if("/"==r){if(e+1<this.len){e+=1;var i=t.charAt(e),s=null;if("/"==i?s="\n":"*"==i&&(s="*/"),null!=s){this.finCurrStr();var a=t.indexOf(s,e);0>a?(console.log("没有找到注释结尾，应该是一直注释到最后了"),e=this.len):e=a+s.length-1}}}else if("}"==r)null!=this.cobj&&(this.finCurrStr(),null!=this.cobj&&(this.cobj=this.finCurrObj())),this.currStr="",this.type=1;else if("{"==r)this.currStr="",this.type=1;else if("'"==r||'"'==r||"‘"==r||"“"==r){"‘"==r?r="’":"“"==r&&(r="”");var n=this.findIndex(t,e,r,this.len);2==this.type&&null!=this.cobj&&Array.isArray(this.cobj.val)?(null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),this.cobj.val.push(n.str),this.currStr=""):null!=this.currStr&&(this.currStr+=n.str),e=n.i}else if(";"==r||","==r||"\n"==r)this.finCurrStr();else if("]"==r)null!=this.currStr&&null!=this.cobj&&Array.isArray(this.cobj.val)&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),null!=this.cobj&&(this.cobj=this.finCurrObj(),this.cobj=this.finCurrObj()),this.currStr="";else if("["==r)2!=this.type?console.warn("没有key值，忽略掉一个数组"):(null!=this.cobj&&this.currArr.push(this.cobj),this.cobj={val:[]});else if(":"==r){if(null!=this.currStr&&1==this.type){if(this.type=2,null!=this.cobj&&this.currArr.push(this.cobj),null!=this.cobj&&Array.isArray(this.cobj.val)){var l=this.cobj;this.cobj={val:{}},l.val.push(this.cobj.val),this.currArr.push(this.cobj)}this.cobj={k:this.currStr.trim(),val:{}},this.currStr=""}}else null!=this.currStr&&(this.currStr+=r);e++}return this.ret}}const gl=["GLSL Start","GLSL End"],ml=["#defineGLSL","#endGLSL"],yl=["Shader3D Start","Shader3D End"],Tl={Color:t.ShaderDataType.Color,Int:t.ShaderDataType.Int,Bool:t.ShaderDataType.Bool,Float:t.ShaderDataType.Float,Vector2:t.ShaderDataType.Vector2,Vector3:t.ShaderDataType.Vector3,Vector4:t.ShaderDataType.Vector4,Matrix4x4:t.ShaderDataType.Matrix4x4,Matrix3x3:t.ShaderDataType.Matrix3x3,Texture2D:t.ShaderDataType.Texture2D,TextureCube:t.ShaderDataType.TextureCube,Texture2DArray:t.ShaderDataType.Texture2DArray,Texture3D:t.ShaderDataType.Texture3D};class xl{static parse(t,e){let r=xl.getShaderBlock(t),i=xl.getCGBlock(t);return xl.bindCG(r,i),dr.parse(r,e)}static compileToTree(t,e,r){if(r==t.length)return[e];let i=t[r],s=e.split(i);if(1==s.length)return s;let a=[];for(let e=0,n=s.length;e<n;e++)a=a.concat(xl.compileToTree(t,s[e],r+1)),e!=n-1&&a.push(i);return a}static getMapKey(t){let e=t.indexOf("\n");return t=(t=(t=t.slice(0,e).replace("\r","")).slice(0,e).replace(" ","")).trim()}static getShaderBlock(t){let e=null;try{let r=t.indexOf(yl[0]);if(-1==r)throw new Error(`no '${yl[0]}' tag`);let i=t.indexOf(yl[1]);if(-1==i)throw new Error(`no '${yl[1]}' tag`);let s=t.substring(r+yl[0].length,i);e=fl.parse(s)}catch(e){console.error("Shader parse error: "+e+"\n"+t.substring(0,100)+"...")}return e}static getCGBlock(t){let e={};try{let r=t.indexOf(gl[0]);if(-1==r)throw new Error(`no '${yl[0]}' tag`);let i=t.indexOf(gl[1]);if(-1==i)throw new Error(`no '${yl[1]}' tag`);let s=t.substring(r,i),a=xl.compileToTree(ml,s,0);for(let t=0,r=a.length;t<r;t++){if(a[t]==ml[0]){t+=1;let r=a[t];e[xl.getMapKey(r)]=r.slice(r.indexOf("\n"),r.length-1)}}}catch(e){console.error("Shader parse error: "+e+"\n"+t.substring(0,100)+"...")}return e}static bindCG(t,e){let r=t.shaderPass;r&&r.forEach((t=>{t.VS&&(t.VS=e[t.VS]),t.FS&&(t.FS=e[t.FS])}));let i=t.attributeMap;if(i){let e=0;for(let r in i)if(i[r]instanceof Array){let e=i[r],s=xl.getShaderDataType(e[0]);if(null==s){console.warn(`${t.name}: unkown attribute type '${e[0]}'`);continue}i[r]=[e[1],s]}else{let s=xl.getShaderDataType(i[r]);if(null==s){console.warn(`${t.name}: unkown attribute type '${i[r]}'`);continue}i[r]=[e,s],e++}}let s=t.uniformMap;if(s){let e={};t.defaultValue=e;let r={};t.uniformMap=r;for(let i in s){let a=s[i];if(!1===a.serializable)continue;let n=xl.getShaderDataType(a.type);if(null!=n)if(null!=a.default&&(e[i]=xl.getDefaultData(n,a.default)),a.block){let t=r[a.block];t||(r[a.block]=t={}),t[i]=n}else r[i]=n;else console.warn(`${t.name}: unkown uniform type '${a.type}'`)}}}static getShaderDataType(t){return Tl[t]}static getDefaultData(e,r){switch(e){case t.ShaderDataType.Int:case t.ShaderDataType.Float:case t.ShaderDataType.Bool:return r;case t.ShaderDataType.Vector2:return new Qe(r[0],r[1]);case t.ShaderDataType.Vector3:return new d(r[0],r[1],r[2]);case t.ShaderDataType.Vector4:return new u(r[0],r[1],r[2],r[3]);case t.ShaderDataType.Color:return new _t(r[0],r[1],r[2],r[3]);case t.ShaderDataType.Matrix4x4:let e=new $e;return e.cloneByArray(r),e;case t.ShaderDataType.Matrix3x3:let i=new Oe;return i.cloneByArray(r),i;case t.ShaderDataType.Texture2D:let s=null;return"white"==r?s=ct.whiteTexture:"black"==r?s=ct.blackTexture:"gray"==r?s=ct.grayTexture:"normal"==r&&(s=ct.normalTexture),s;case t.ShaderDataType.TextureCube:let a=da.grayTexture;return"white"==r?a=da.whiteTexture:"black"==r?a=da.blackTexture:"gray"==r&&(a=da.grayTexture),a}}}Bt.registerLoader(["shader","bps"],class{load(t){let e=t.url;return"bps"===t.ext&&(e=N.inst.getSubAssetURL(e,t.uuid,"0","shader")),t.loader.fetch(e,"text",t.progress.createCallback(),t.options).then((e=>{if(!e)return null;let r=xl.getShaderBlock(e),i=xl.getCGBlock(e);if(xl.bindCG(r,i),!r.name||!r.uniformMap)return null;let s=O.getPath(t.url),a=r.shaderPass;return Promise.all(a.map((t=>Me.compileAsync(t.VS,t.FS,s)))).then((e=>{var i;if(-1!=e.findIndex((t=>null==t)))return Bt.warn("some pass null "+t.url),null;let s=dr.add(r.name,r.enableInstancing,r.supportReflectionProbe);s._surportVolumetricGI=r.surportVolumetricGI;let n=new hr(r.attributeMap?r.attributeMap:hr.DefaultAttributeMap,r.uniformMap,r.defaultValue);s.addSubShader(n);for(let t in a){let r=n._addShaderPass(e[t],a[t].pipeline);r.statefirst=null!==(i=a[t].statefirst)&&void 0!==i&&i,Me.getRenderState(a[t].renderState,r.renderState)}return s}))}))}});Bt.registerLoader(["mp3","wav","ogg"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?Oa.ctx.decodeAudioData(t):null))}},Bt.SOUND);let vl=Ot.regClass;vl("Record",Object),vl("Node",ms),vl("Sprite",Ds),vl("Widget",hn),vl("Text",Fs),vl("Input",va),vl("AnimationBase",en),vl("Animation",ln),vl("FrameAnimation",sn),vl("EffectAnimation",on),vl("SoundNode",En),vl("VideoNode",bn),vl("Scene",fn),vl("Stage",Aa),vl("Component",tn),vl("Script",Jn),vl("BitmapFont",bs),vl("BlurFilter",mn),vl("ColorFilter",vn),vl("GlowFilter",Sn),vl("Point",i),vl("Rectangle",F),vl("Texture",mt),vl("Texture2D",ct),vl("Prefab",un),vl("Animator2D",Fn),vl("AnimatorControllerLayer2D",Cn),vl("AnimatorState2D",Un),vl("AnimationClip2D",Wn),vl("AnimatorController2D",Zn),vl("Animation2DParm",Yn),vl("Animation2DCondition",Xn),vl("Vector2",Qe),vl("Vector3",d),vl("Vector4",u),vl("Quaternion",He),vl("Color",_t),vl("Matrix",G),vl("Matrix3x3",Oe),vl("Matrix4x4",$e);class Sl{static create(t,e,r){}constructor(t){this.blendType=0}}Sl._blend_All_pool={},Sl._blend_seperate_pool={};class El{static getHash(t,e,r){return t+(e<<3)+(r<<7)}static getBlendComponent(t,e,r){let i=El.getHash(t,e,r);return El._pool[i]||(El._pool[i]=new El(t,e,r,i)),El._pool[i]}constructor(t,e,r,i){this._hashIndex=0,this._hashIndex=i,this._blendOperationGLData=t,this._sourceBlendFactor=e,this._destinationFactor=r}}El._pool={};class wl{get bufferUsage(){return this._bufferUsage}constructor(t,e){this._byteLength=0,this._bufferType=t,this._bufferUsage=e}destroy(){}}class Dl{static getVertexLayoutByPool(t){let e=Dl._pool;for(var r in e){let i=e[r];if(i.deepthEqaul(t))return i}return new Dl(t)}constructor(t){this.VAElements=new Array,this.attributeByteSize=new Array,this.instanceMode=new Array;for(let e=0;e<t.length;e++){let r=[],i=t[e].vertexDeclaration.vertexStride,s=t[e].vertexDeclaration._VAElements;for(let t=0;t<s.length;t++)r.push({format:s[t].format,stride:s[t].stride,shaderLocation:s[t].shaderLocation});this.attributeByteSize.push(i),this.VAElements.push(r),this.instanceMode.push(t[e].instanceBuffer)}this.id=Dl.IPoint,Dl._pool[Dl.IPoint++]=this}deepthEqaul(t){if(t.length!=this.VAElements.length)return!1;for(var e=0;e<t.length;e++){let s=t[e]._vertexDeclaration._VAElements,a=this.VAElements[e];if(s.length!=a.length)return!1;for(var r=0,i=s.length;r<i;r++){let t=s[r],e=a[r];if(t.format!=e.format||t.stride!=e.stride||t.shaderLocation!=e.shaderLocation)return!1}}return!0}}Dl.IPoint=0,Dl._pool={};class bl{}bl.NUMBER_0=48,bl.NUMBER_1=49,bl.NUMBER_2=50,bl.NUMBER_3=51,bl.NUMBER_4=52,bl.NUMBER_5=53,bl.NUMBER_6=54,bl.NUMBER_7=55,bl.NUMBER_8=56,bl.NUMBER_9=57,bl.A=65,bl.B=66,bl.C=67,bl.D=68,bl.E=69,bl.F=70,bl.G=71,bl.H=72,bl.I=73,bl.J=74,bl.K=75,bl.L=76,bl.M=77,bl.N=78,bl.O=79,bl.P=80,bl.Q=81,bl.R=82,bl.S=83,bl.T=84,bl.U=85,bl.V=86,bl.W=87,bl.X=88,bl.Y=89,bl.Z=90,bl.F1=112,bl.F2=113,bl.F3=114,bl.F4=115,bl.F5=116,bl.F6=117,bl.F7=118,bl.F8=119,bl.F9=120,bl.F10=121,bl.F11=122,bl.F12=123,bl.F13=124,bl.F14=125,bl.F15=126,bl.NUMPAD=21,bl.NUMPAD_0=96,bl.NUMPAD_1=97,bl.NUMPAD_2=98,bl.NUMPAD_3=99,bl.NUMPAD_4=100,bl.NUMPAD_5=101,bl.NUMPAD_6=102,bl.NUMPAD_7=103,bl.NUMPAD_8=104,bl.NUMPAD_9=105,bl.NUMPAD_ADD=107,bl.NUMPAD_DECIMAL=110,bl.NUMPAD_DIVIDE=111,bl.NUMPAD_ENTER=108,bl.NUMPAD_MULTIPLY=106,bl.NUMPAD_SUBTRACT=109,bl.SEMICOLON=186,bl.EQUAL=187,bl.COMMA=188,bl.MINUS=189,bl.PERIOD=190,bl.SLASH=191,bl.BACKQUOTE=192,bl.LEFTBRACKET=219,bl.BACKSLASH=220,bl.RIGHTBRACKET=221,bl.QUOTE=222,bl.ALTERNATE=18,bl.BACKSPACE=8,bl.CAPS_LOCK=20,bl.COMMAND=15,bl.CONTROL=17,bl.DELETE=46,bl.ENTER=13,bl.ESCAPE=27,bl.PAGE_UP=33,bl.PAGE_DOWN=34,bl.END=35,bl.HOME=36,bl.LEFT=37,bl.UP=38,bl.RIGHT=39,bl.DOWN=40,bl.SHIFT=16,bl.SPACE=32,bl.TAB=9,bl.INSERT=45;class Rl{}Rl.STANDARD=0,Rl.LEFT=1,Rl.RIGHT=2,Rl.NUM_PAD=3;class Cl extends tn{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=St.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat=this.repeat}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class Al{static getMCDName(t){return Al._typeToNameDic[t]}static showRenderTypeInfo(t,e=!1){if(e||!Al.showedDic[t]){if(Al.showedDic[t]=!0,!Al._rendertypeToStrDic[t]){var r,i=[];for(r=1;r<=t;)r&t&&i.push(Al.getMCDName(r&t)),r<<=1;Al._rendertypeToStrDic[t]=i.join(",")}console.log("cmd:",Al._rendertypeToStrDic[t])}}static __init__(){Al._typeToNameDic[ie.ALPHA]="ALPHA",Al._typeToNameDic[ie.TRANSFORM]="TRANSFORM",Al._typeToNameDic[ie.TEXTURE]="TEXTURE",Al._typeToNameDic[ie.GRAPHICS]="GRAPHICS",Al._typeToNameDic[ie.CHILDS]="CHILDS",Al._typeToNameDic[ie.TRANSFORM|ie.ALPHA]="TRANSFORM|ALPHA",Al._typeToNameDic[ie.CANVAS]="CANVAS",Al._typeToNameDic[ie.BLEND]="BLEND",Al._typeToNameDic[ie.FILTERS]="FILTERS",Al._typeToNameDic[ie.MASK]="MASK",Al._typeToNameDic[ie.CLIP]="CLIP"}constructor(){}render(t,e,r){Al._addType(this._renderType),Al.showRenderTypeInfo(this._renderType),Di.renders[this._renderType]._fun(this,t,e+this._x,r+this._y),this._repaint=0}_stageRender(t,r,i){Al._countStart(),Al._PreStageRender.call(e.stage,t,r,i),Al._countEnd()}static _countStart(){var t;for(t in Al._countDic)Al._countDic[t]=0}static _countEnd(){Al._i++,Al._i>60&&(Al.showCountInfo(),Al._i=0)}static _addType(t){Al._countDic[t]?Al._countDic[t]+=1:Al._countDic[t]=1}static showCountInfo(){var t;for(t in console.log("==================="),Al._countDic)console.log("count:"+Al._countDic[t]),Al.showRenderTypeInfo(t,!0)}static enableQuickTest(){Al.__init__(),Ds.prototype.render=Al.prototype.render,Al._PreStageRender=Aa.prototype.render,Aa.prototype.render=Al.prototype._stageRender}}var Il,Ml,Bl,Ll,Pl,Nl;Al.showedDic={},Al._rendertypeToStrDic={},Al._typeToNameDic={},Al._countDic={},Al._i=0,t.RenderClearFlag=void 0,(Il=t.RenderClearFlag||(t.RenderClearFlag={}))[Il.Nothing=0]="Nothing",Il[Il.Color=1]="Color",Il[Il.Depth=2]="Depth",Il[Il.Stencil=4]="Stencil",t.RenderDrawMode=void 0,(Ml=t.RenderDrawMode||(t.RenderDrawMode={}))[Ml.TRIANGLES=0]="TRIANGLES",Ml[Ml.POINTS=1]="POINTS",Ml[Ml.LINES=2]="LINES",t.RenderIndexMode=void 0,(Bl=t.RenderIndexMode||(t.RenderIndexMode={}))[Bl.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",Bl[Bl.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",Bl[Bl.UNSIGNED_INT=2]="UNSIGNED_INT",t.RenderStateType=void 0,(Ll=t.RenderStateType||(t.RenderStateType={}))[Ll.DepthTest=0]="DepthTest",Ll[Ll.DepthMask=1]="DepthMask",Ll[Ll.DepthFunc=2]="DepthFunc",Ll[Ll.StencilTest=3]="StencilTest",Ll[Ll.StencilMask=4]="StencilMask",Ll[Ll.StencilFunc=5]="StencilFunc",Ll[Ll.StencilOp=6]="StencilOp",Ll[Ll.BlendType=7]="BlendType",Ll[Ll.BlendEquation=8]="BlendEquation",Ll[Ll.BlendEquationSeparate=9]="BlendEquationSeparate",Ll[Ll.BlendFunc=10]="BlendFunc",Ll[Ll.BlendFuncSeperate=11]="BlendFuncSeperate",Ll[Ll.CullFace=12]="CullFace",Ll[Ll.FrontFace=13]="FrontFace",t.TextureCompareMode=void 0,(Pl=t.TextureCompareMode||(t.TextureCompareMode={}))[Pl.None=0]="None",Pl[Pl.LEQUAL=1]="LEQUAL",Pl[Pl.GEQUAL=2]="GEQUAL",Pl[Pl.LESS=3]="LESS",Pl[Pl.GREATER=4]="GREATER",Pl[Pl.EQUAL=5]="EQUAL",Pl[Pl.NOTEQUAL=6]="NOTEQUAL",Pl[Pl.ALWAYS=7]="ALWAYS",Pl[Pl.NEVER=8]="NEVER",t.TextureDecodeFormat=void 0,(Nl=t.TextureDecodeFormat||(t.TextureDecodeFormat={}))[Nl.Normal=0]="Normal",Nl[Nl.RGBM=1]="RGBM";class Ol{static glslAttributeString(t){let e="";for(const r in t){let i=Fl(t[r][1]);""!=i&&(e=`${e}attribute ${i} ${r};\n`)}return e}static glslUniformString(t,e){if(e){let e="",r="";for(const i in t)if("object"==typeof t[i]){let r=t[i];e+=`uniform ${i} {\n`;for(const t in r){let i=Fl(r[t]);""!=i&&(e+=`${i} ${t};\n`)}e+="};\n"}else{let e=Fl(t[i]);""!=e&&(r+=`uniform ${e} ${i};\n`)}return e+r}{let e="";for(const r in t)if("object"==typeof t[r]){let i=t[r];for(const t in i){let r=Fl(i[t]);""!=r&&(e+=`uniform ${r} ${t};\n`)}}else{let i=Fl(t[r]);""!=i&&(e+=`uniform ${i} ${r};\n`)}return e}}static GLShaderLanguageProcess3D(e,r,i,s,a){var n,o,h=_.lightClusterCount,u={},d="";let c=_._uniformBlock,p=Ol.glslAttributeString(r),f=Ol.glslUniformString(i,c);l.renderEngine.getParams(t.RenderParams.SHADER_CAPAILITY_LEVEL)>30?(e.push("GRAPHICS_API_GLES3"),n=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n    precision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n    precision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${p}\n${f}\n`,o=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n\tprecision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n\tprecision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n${f}`):(n=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${p}\n${f}`,o=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#ifdef GL_OES_standard_derivatives\n\t#extension GL_OES_standard_derivatives : enable \n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define texture3DLodEXT texture3D\n    #define textureCubeLodEXT textureCube\n#endif\n${f}`),d+="#define MAX_LIGHT_COUNT "+_.maxLightCount+"\n",d+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+_._maxAreaLightCountPerClusterAverage+"\n",d+="#define CLUSTER_X_COUNT "+h.x+"\n",d+="#define CLUSTER_Y_COUNT "+h.y+"\n",d+="#define CLUSTER_Z_COUNT "+h.z+"\n",d+="#define MORPH_MAX_COUNT "+_.maxMorphTargetCount+"\n",d+="#define SHADER_CAPAILITY_LEVEL "+l.renderEngine.getParams(t.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";for(var g=0,m=e.length;g<m;g++){var y=e[g];d+="#define "+y+"\n",u[y]=!0}var T=s.toscript(u,[]),x="";0==T[0].indexOf("#version")&&(x=T[0]+"\n",T.shift());var v=a.toscript(u,[]),S="";return 0==v[0].indexOf("#version")&&(S=v[0]+"\n",v.shift()),{vs:x+n+d+T.join("\n"),fs:S+o+d+v.join("\n")}}}function Fl(e){switch(e){case t.ShaderDataType.Int:return"int";case t.ShaderDataType.Bool:return"bool";case t.ShaderDataType.Float:return"float";case t.ShaderDataType.Vector2:return"vec2";case t.ShaderDataType.Vector3:return"vec3";case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:return"vec4";case t.ShaderDataType.Matrix4x4:return"mat4";case t.ShaderDataType.Matrix3x3:return"mat3";case t.ShaderDataType.Texture2D:return"sampler2D";case t.ShaderDataType.TextureCube:return"samplerCube";case t.ShaderDataType.Texture2DArray:return l.renderEngine.getCapable(t.RenderCapable.Texture3D)?"sampler2DArray":"";case t.ShaderDataType.Texture3D:return l.renderEngine.getCapable(t.RenderCapable.Texture3D)?"sampler3D":"";default:return""}}class Ul{constructor(){this.onID=Ul.pointID++,this.textureID=-1}}Ul.pointID=0;class kl{constructor(t,e,r,i){this.minDepth=0,this.maxDepth=1,this.x=null!=t?t:0,this.y=null!=e?e:0,this.width=null!=r?r:0,this.height=null!=i?i:0}project(t,e,r){d.transformV3ToV4(t,e,r);var i=r.x,s=r.y,a=r.z,n=r.w;1!==n&&(i/=n,s/=n,a/=n),r.x=.5*(i+1)*this.width+this.x,r.y=.5*(1-s)*this.height+this.y,r.z=a*(this.maxDepth-this.minDepth)+this.minDepth}unprojectFromMat(t,e,r){var i=e.elements;r.x=(t.x-this.x)/this.width*2-1,r.y=-((t.y-this.y)/this.height*2-1),r.z=(t.z-this.minDepth)/(this.maxDepth-this.minDepth);var s=r.x*i[3]+r.y*i[7]+r.z*i[11]+i[15];d.transformV3ToV3(r,e,r),1!==s&&(r.x=r.x/s,r.y=r.y/s,r.z=r.z/s)}unprojectFromWVP(t,e,r,i,s){$e.multiply(e,r,Gl),i&&$e.multiply(Gl,i,Gl),Gl.invert(Gl),this.unprojectFromMat(t,Gl,s)}set(t,e,r,i){this.x=t,this.y=e,this.width=r,this.height=i}cloneTo(t){t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t.minDepth=this.minDepth,t.maxDepth=this.maxDepth}}kl._tempViewport=new kl(0,0,0,0);const Gl=new $e;var Vl,Hl;t.BaseRender2DType=void 0,(Vl=t.BaseRender2DType||(t.BaseRender2DType={}))[Vl.baseRenderNode=0]="baseRenderNode",Vl[Vl.spine=1]="spine",Vl[Vl.particle=2]="particle",Vl[Vl.spineSimple=3]="spineSimple",t.Render2DOrderMode=void 0,(Hl=t.Render2DOrderMode||(t.Render2DOrderMode={}))[Hl.elementIndex=0]="elementIndex",Hl[Hl.ysort=1]="ysort";class zl extends tn{_getcommonUniformMap(){return["sprite2D"]}_getRect(){return null}_transformChange(){}get sharedMaterial(){return this._materials[0]}set sharedMaterial(t){var e=this._materials[0];e!==t&&(this._materials[0]=t,this._changeMaterialReference(e,t),this._renderElements[0]&&this._setRenderElement2DMaterial(this._renderElements[0],t))}_setRenderElement2DMaterial(t,e){t.subShader=e._shader.getSubShaderAt(0),t.materialShaderData=e._shaderValues}_changeMaterialReference(t,e){t&&t._removeReference(),e&&e._addReference()}constructor(){super(),this._renderType=t.BaseRender2DType.baseRenderNode,this._renderUpdateMask=0,this._layer=0,this._renderid=zl._uniqueIDCounter++,this._spriteShaderData=l.renderDeviceFactory.createShaderData(null),this._renderType=t.BaseRender2DType.baseRenderNode,this._ordingMode=t.Render2DOrderMode.elementIndex,this._layer=1}_onEnable(){super._onEnable(),this.owner&&(this.owner.renderNode2D=this)}_onDisable(){this.owner&&(this.owner.renderNode2D=null)}_onDestroy(){for(var t=0,e=this._materials.length;t<e;t++){let e=this._materials[t];e&&!e.destroyed&&e._removeReference()}this._spriteShaderData.destroy(),this.owner=null}clear(){this._renderElements.length=0}}zl._uniqueIDCounter=0;class Wl{static getVertexDeclaration(t,e=!0){let r=[];for(let l=0,o=t.length;l<o;l++){let o=t[l],h=Wl._vertexDeclarationMap[o+(e?"_0":"_1")];if(!h){var i=o.split(","),s=0,a=[];for(let t=0,r=i.length;t<r;t++){var n;switch(i[l]){case"POSITION":n=new Zt(s,$t.Vector3,or.MESH_POSITION0),s+=8;break;case"COLOR":n=new Zt(s,$t.Vector4,or.MESH_COLOR0),s+=16;break;case"UV":n=new Zt(s,$t.Vector2,or.MESH_TEXTURECOORDINATE0),s+=8;break;case"BLENDWEIGHT":n=new Zt(s,$t.Vector4,or.MESH_BLENDWEIGHT0),s+=16;break;case"BLENDINDICES":e?(n=new Zt(s,$t.Vector4,or.MESH_BLENDINDICES0),s+=16):(n=new Zt(s,$t.Byte4,or.MESH_BLENDINDICES0),s+=4);break;default:throw"VertexMesh: unknown vertex flag."}a.push(n)}h=new Qt(s,a),Wl._vertexDeclarationMap[o+(e?"_0":"_1")]=h,r.push(h)}}return r}}Wl._vertexDeclarationMap={};class Yl extends R{static get defaultTexture(){return this._defaultTexture}static __init__(){l.renderEngine.getCapable(t.RenderCapable.Texture3D)&&(this._defaultTexture=new Yl(1,1,1,t.TextureFormat.R8G8B8A8,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255])))}constructor(e,r,i,s,a=!0,n=!1){super(e,r,s),this._dimension=t.TextureDimension.Tex3D,this.depth=i,this._gammaSpace=n;let o=l.textureContext;this._texture=o.createTexture3DInternal(this._dimension,e,r,i,s,a,n,!1)}setPixelsData(t){let e=this._texture;l.textureContext.setTexture3DPixelsData(e,t,this.depth,!1,!1)}setSubPixelsData(t,e,r,i,s,a,n,o,h){let u=this._texture;l.textureContext.setTexture3DSubPixelsData(u,n,o,h,t,e,r,i,s,a,!1,!1)}}class Xl{static getRT(e,r){return r|=0,(e|=0)>=1e4&&console.error("getRT error! w too big"),new pt(e,r,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None)}static releaseRT(t){t.destroy()}}Xl.dict={};class jl{static begin(t){}static end(t){}}class ql{}function $l(t){jl.begin(t)}function Kl(t){jl.end(t)}function Ql(){}window.PerformanceDefine=ql,window.PERF_BEGIN=$l,window.PERF_BEGIN=Kl,window.PERF_FRAMECLEAR=Ql;class Zl{static init(){if(!Zl.lookup){Zl.lookup=new Uint8Array(256);for(var t=0;t<Zl.chars.length;t++)Zl.lookup[Zl.chars.charCodeAt(t)]=t}}static isBase64String(t){return Zl.reg.test(t)}static encode(t){var e,r=new Uint8Array(t),i=r.length,s="";for(e=0;e<i;e+=3)s+=Zl.chars[r[e]>>2],s+=Zl.chars[(3&r[e])<<4|r[e+1]>>4],s+=Zl.chars[(15&r[e+1])<<2|r[e+2]>>6],s+=Zl.chars[63&r[e+2]];return i%3==2?s=s.substring(0,s.length-1)+"=":i%3==1&&(s=s.substring(0,s.length-2)+"=="),s}static decode(t){Zl.init();var e,r,i,s,a,n=.75*t.length,l=t.length,o=0;"="===t[t.length-1]&&(n--,"="===t[t.length-2]&&n--);var h=new ArrayBuffer(n),u=new Uint8Array(h);for(e=0;e<l;e+=4)r=Zl.lookup[t.charCodeAt(e)],i=Zl.lookup[t.charCodeAt(e+1)],s=Zl.lookup[t.charCodeAt(e+2)],a=Zl.lookup[t.charCodeAt(e+3)],o+1>n||(u[o++]=r<<2|i>>4,o+1>n||(u[o++]=(15&i)<<4|s>>2,o+1>n||(u[o++]=(3&s)<<6|63&a)));return h}}Zl.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Zl.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,Zl.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,Zl.lookup=null,ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(t,e){var r=new Uint8Array(this,t,e-t),i=new Uint8Array(r.length);return i.set(r),i.buffer}),Float32Array.prototype.slice||(Float32Array.prototype.slice=function(){for(var t=this.length,e=new Float32Array(this.length),r=0;r<t;r++)e[r]=this[r];return e}),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=function(...t){var e,r,i;if(0===t.length)for(e=this.length,r=new Uint16Array(e),i=0;i<e;i++)r[i]=this[i];else if(2===t.length){var s=t[0],a=t[1];if(a>s)for(e=a-s,r=new Uint16Array(e),i=s;i<a;i++)r[i-s]=this[i];else r=new Uint16Array(0)}return r}),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(){for(var t=this.length,e=new Uint8Array(this.length),r=0;r<t;r++)e[r]=this[r];return e});const Jl=new F,to=new i;class eo{contains(t,e,r){return!!eo._isHitGraphic(t,e,r,this._hit)&&!eo._isHitGraphic(t,e,r,this._unHit)}static _isHitGraphic(t,e,r,i){if(!i)return!1;let s=i.cmds;if(0==s.length)return!1;let a=s.length;for(let i=0;i<a;i++){let a=s[i];if(a){if("Translate"===a.cmdID)t-=a.tx,e-=a.ty;if(eo._isHitCmd(t,e,r,a))return!0}}return!1}static _isHitCmd(t,e,r,i){if(!i)return!1;var s=!1;switch(i.cmdID){case"DrawRect":i.percent?Jl.setTo(i.x*r.width,i.y*r.height,i.width*r.width,i.height*r.height):Jl.setTo(i.x,i.y,i.width,i.height),s=Jl.contains(t,e);break;case"DrawCircle":let a=i.radius;i.percent?(t-=i.x*r.width,e-=i.y*r.height,a*=r.width):(t-=i.x,e-=i.y),s=t*t+e*e<a*a;break;case"DrawPoly":t-=i.x,e-=i.y,s=eo._ptInPolygon(t,e,i.points)}return s}static _ptInPolygon(t,e,r){var i=to;i.setTo(t,e);var s,a,n,l,o,h=0;o=r.length;for(var u=0;u<o;u+=2){if(s=r[u],a=r[u+1],n=r[(u+2)%o],a!=(l=r[(u+3)%o]))if(!(i.y<Math.min(a,l)))if(!(i.y>=Math.max(a,l)))(i.y-a)*(n-s)/(l-a)+s>i.x&&h++}return h%2==1}get hit(){return this._hit||(this._hit=new fs),this._hit}set hit(t){this._hit=t}get unHit(){return this._unHit||(this._unHit=new fs),this._unHit}set unHit(t){this._unHit=t}onAfterDeserialize(){n.isPlaying&&(this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds))}}Ot.regClass("HitArea",eo);class ro{static enable(){ro._logdiv||(ro._logdiv=A.createElement("div"),ro._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;",A.document.body.appendChild(ro._logdiv),ro._btn=A.createElement("button"),ro._btn.innerText="Hide",ro._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;",ro._btn.onclick=ro.toggle,A.document.body.appendChild(ro._btn))}static toggle(){var t=ro._logdiv.style;""===t.display?(ro._btn.innerText="Show",t.display="none"):(ro._btn.innerText="Hide",t.display="")}static print(t){ro._logdiv&&(ro._count>=ro.maxCount&&ro.clear(),ro._count++,ro._logdiv.innerText+=t+"\n",ro.autoScrollToBottom&&ro._logdiv.scrollHeight-ro._logdiv.scrollTop-ro._logdiv.clientHeight<50&&(ro._logdiv.scrollTop=ro._logdiv.scrollHeight))}static clear(){ro._logdiv.innerText="",ro._count=0}}ro._count=0,ro.maxCount=50,ro.autoScrollToBottom=!0;class io{constructor(t,e,r,i){this.scale=1,this.datas=new Array(300),this.datapos=0,this.id=t,this.color=e,this.name=r,this.scale=i}addData(t){this.datas[this.datapos]=t,this.datapos++,this.datapos%=300}}class so extends Ds{constructor(){super(),this.datas=[],this.xdata=new Array(so.DATANUM),this.ydata=new Array(so.DATANUM),this.hud_width=800,this.hud_height=200,this.gMinV=0,this.gMaxV=100,this.textSpace=40,this.sttm=0,so.inst=this,this._renderType|=ie.CUSTOM,this._setCustomRender(),this.addDataDef(0,16777215,"frame",1),this.addDataDef(1,65280,"update",1),this.addDataDef(2,16711680,"flush",1),so._now=performance?performance.now.bind(performance):Date.now}now(){return so._now()}start(){this.sttm=so._now()}end(t){var e=so._now()-this.sttm;this.updateValue(t,e)}config(t,e){this.hud_width=t,this.hud_height=e}addDataDef(t,e,r,i){this.datas[t]=new io(t,e,r,i)}updateValue(t,e){this.datas[t].addData(e)}v2y(t){return this._y+this.hud_height*(1-(t-this.gMinV)/this.gMaxV)}drawHLine(t,e,r,i){var s=this._x,a=this.v2y(e);t.fillText(i,s,a-6,null,"green",null),s+=this.textSpace,t.fillStyle=r,t.fillRect(s,a,this._x+this.hud_width,1,null)}customRender(t,e,r){var i=performance.now();so._lastTm<=0&&(so._lastTm=i),this.updateValue(0,i-so._lastTm),so._lastTm=i,t.save(),t.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,"#000000cc"),t.globalAlpha=.9,this.drawHLine(t,0,"green","    0"),this.drawHLine(t,10,"green","  10"),this.drawHLine(t,16.667,"red"," "),this.drawHLine(t,20,"green","50|20"),this.drawHLine(t,33.334,"yellow",""),this.drawHLine(t,16.667*3,"yellow",""),this.drawHLine(t,66.668,"yellow",""),this.drawHLine(t,50,"green","20|50"),this.drawHLine(t,100,"green","10|100");for(var s=0,a=this.datas.length;s<a;s++){var n=this.datas[s];if(n){var l=n.datas.length,o=(this.hud_width-this.textSpace)/l,h=n.datapos,u=this._x+this.textSpace;t.fillStyle=n.color;for(var d=l;h<d;h++){var c=this.v2y(n.datas[h]*n.scale);t.fillRect(u,c,o,this.hud_height+this._y-c,null),u+=o}for(h=0;h<n.datapos;h++)c=this.v2y(n.datas[h]*n.scale),t.fillRect(u,c,o,this.hud_height+this._y-c,null),u+=o}}t.restore()}}so._lastTm=0,so._now=null,so.DATANUM=300,so.drawTexTm=0;class ao{constructor(){this.maxCount=1e3}getCacheList(){return r.getPoolBySign(this.sign)}tryDispose(t){var e;(e=r.getPoolBySign(this.sign)).length>this.maxCount&&e.splice(this.maxCount,e.length-this.maxCount)}static addPoolCacheManager(t,e=100){var r;(r=new ao).sign=t,r.maxCount=e,ds.regCacheByFunction(r.tryDispose.bind(r),r.getCacheList.bind(r))}}class no extends v{constructor(){super(...arguments),this._tweenDic={},this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(t,e,r,i=null,s=0){return(new no).to(t,e,r,i,s)}static from(t,e,r,i=null,s=0){return(new no).from(t,e,r,i,s)}to(t,e,r,i=null,s=0){return this._create(t,e,r,i,s,!0)}from(t,e,r,i=null,s=0){return this._create(t,e,r,i,s,!1)}_create(t,e,i,s,a,n){var l=r.getItemByClass("tweenData",lo);return l.isTo=n,l.type=0,l.target=t,l.duration=i,l.data=e,l.startTime=this._startTime+a,l.endTime=l.startTime+l.duration,l.ease=s,this._startTime=Math.max(l.endTime,this._startTime),this._tweenDataList.push(l),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(t,e){var i=r.getItemByClass("tweenData",lo);return i.type=1,i.data=t,i.endTime=i.startTime=this._startTime+e,this._labelDic||(this._labelDic={}),this._labelDic[t]=i,this._tweenDataList.push(i),this}removeLabel(t){if(this._labelDic&&this._labelDic[t]){var e=this._labelDic[t];if(e){var r=this._tweenDataList.indexOf(e);r>-1&&this._tweenDataList.splice(r,1)}delete this._labelDic[t]}}gotoTime(t){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var e,i,s,a;for(var n in this._firstTweenDic)if(i=this._firstTweenDic[n])for(var l in i)l in i.diyTarget&&(i.diyTarget[l]=i[l]);for(n in this._tweenDic)(e=this._tweenDic[n]).clear(),delete this._tweenDic[n];if(this._index=0,this._gidIndex=0,this._currTime=t,this._lastTime=A.now(),null==this._endTweenDataList||this._endTimeSort){function c(t,e){return t.endTime>e.endTime?1:t.endTime<e.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=s=this._tweenDataList.concat(),s.sort(c)}else s=this._endTweenDataList;for(var o=0,h=s.length;o<h;o++)if(0==(a=s[o]).type){if(!(t>=a.endTime))break;this._index=Math.max(this._index,o+1);var u=a.data;if(a.isTo)for(var d in u)a.target[d]=u[d]}for(o=0,h=this._tweenDataList.length;o<h;o++)0==(a=this._tweenDataList[o]).type&&t>=a.startTime&&t<a.endTime&&(this._index=Math.max(this._index,o+1),this._gidIndex++,(e=r.getItemByClass("tween",Ss))._create(a.target,a.data,a.duration,a.ease,St.create(this,this._animComplete,[this._gidIndex]),0,!1,a.isTo,!0,!1),e.setStartTime(this._currTime-(t-a.startTime)),e._updateEase(this._currTime),e.gid=this._gidIndex,this._tweenDic[this._gidIndex]=e)}}gotoLabel(t){if(null!=this._labelDic){var e=this._labelDic[t];e&&this.gotoTime(e.startTime)}}pause(){e.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(t=0,r=!1){if(this._tweenDataList){if(this._startTimeSort){function u(t,e){return t.startTime>e.startTime?1:t.startTime<e.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(u);for(var i=0,s=this._tweenDataList.length;i<s;i++){var a=this._tweenDataList[i];if(null!=a&&0==a.type){var n=a.target,l=n.$_GID||(n.$_GID=P.getGID()),o=null;for(var h in null==this._firstTweenDic[l]?((o={}).diyTarget=n,this._firstTweenDic[l]=o):o=this._firstTweenDic[l],a.data)null==o[h]&&(o[h]=n[h])}}}"string"==typeof t?this.gotoLabel(t):this.gotoTime(t),this._loopKey=r,this._lastTime=A.now(),e.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var t in this._tweenDic)(e=this._tweenDic[t]).complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var e,i=A.now(),a=i-this._lastTime,n=this._currTime+=a*this.scale;for(t in this._lastTime=i,this._tweenDic)(e=this._tweenDic[t])._updateEase(n);if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var l=this._tweenDataList[this._index];n>=l.startTime&&(this._index++,0==l.type?(this._gidIndex++,(e=r.getItemByClass("tween",Ss))._create(l.target,l.data,l.duration,l.ease,St.create(this,this._animComplete,[this._gidIndex]),0,!1,l.isTo,!0,!1),e.setStartTime(n),e.gid=this._gidIndex,this._tweenDic[this._gidIndex]=e,e._updateEase(n)):this.event(s.LABEL,l.data))}}_animComplete(t){this._tweenDic[t]&&delete this._tweenDic[t]}_complete(){this.event(s.COMPLETE)}get index(){return this._frameIndex}set index(t){this._frameIndex=t,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var t,r,i;if(this._labelDic)for(t in this._labelDic)delete this._labelDic[t];for(t in this._tweenDic)this._tweenDic[t].clear(),delete this._tweenDic[t];for(t in this._firstTweenDic)delete this._firstTweenDic[t];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(i=this._tweenDataList.length,r=0;r<i;r++)this._tweenDataList[r]&&this._tweenDataList[r].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,e.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class lo{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,r.recover("tweenData",this)}}class oo{static create(t,e){var r;let i;return"undefined"!=typeof document&&(i=null===(r=document.currentScript)||void 0===r?void 0:r.src,i&&(i=i.substring(0,i.replace(/[?#].*/,"").lastIndexOf("/")+1))),()=>{let r={};return null!=oo.instantiateWasm&&(r.instantiateWasm=function(t,r){return oo.instantiateWasm(e,t).then((t=>(r(t.instance),t)))}),r.locateFile=function(t,r){return e=null!=oo.locateFile?oo.locateFile(t,r,i):r+t},t(r)}}}oo.Memory="undefined"!=typeof WebAssembly?WebAssembly.Memory:null;class ho{constructor(t,e,r,i,s,a){this.destroyed=!1,this.sn=t,this.cluster=e,this.index=r,this.size=i,this.alignedSize=s,this.offset=s*r,this.user=a,this.uploadNum=0,this.moved=!1}needUpload(){this.uploadNum++,this.cluster.needUpload[this.index]=!0}destroy(){return this.destroyed?(console.warn("UniformBufferBlock: object alreay destroyed!"),!1):(this.cluster=null,this.user=null,this.destroyed=!0,!0)}}class uo{constructor(t,e,r){this.sn=0,this.needUpload=[],this.destroyed=!1,this.blocks=[],this.expand=10,this.manager=r,this.blockSize=t,this.blockNum=e,this.totalSize=t*e,this.data=new ArrayBuffer(this.totalSize),this.move=new Uint8Array(this.blockSize),this.buffer=this.manager.createGPUBuffer(this.totalSize),this.needUpload.length=this.blockNum,this.needUpload.fill(!1),this.manager.statisGPUMemory(this.totalSize)}get usedNum(){return this.blocks.length}_expandBuffer(){let t=this.blockNum;this.blockNum+=this.expand,this.blockNum>this.manager.clusterMaxBlock&&(this.blockNum=this.manager.clusterMaxBlock),t=this.blockNum-t,this.totalSize=this.blockSize*this.blockNum;const e=this.blockSize*this.expand;this.needUpload=this.needUpload.concat(new Array(t).fill(!1));const r=new ArrayBuffer(this.totalSize);new Uint8Array(r).set(new Uint8Array(this.data)),this.data=r,this.buffer=this.manager.createGPUBuffer(this.totalSize),this.manager.statisGPUMemory(e),this.blocks.forEach((t=>t&&t.user.notifyGPUBufferChange())),this.manager.renderContext.notifyGPUBufferChange()}_moveBlock(t){const e=this.blocks.length;if(t>=e)return;const r=new Uint8Array(this.data),i=this.blockSize;for(let s=t+1;s<e;s++){const t=s*i,e=t+i,a=t-i;r.copyWithin(a,t,e),this.needUpload[s-1]=this.needUpload[s],this.blocks[s-1]=this.blocks[s],this.blocks[s-1]&&(this.blocks[s-1].index--,this.blocks[s-1].offset-=i,this.blocks[s-1].user.notifyGPUBufferChange())}this.blocks.length--,this.manager.renderContext.notifyGPUBufferChange()}getBlock(t,e){const r=co(t,this.manager.byteAlign);if(r!==this.blockSize)return console.warn("WebGPUBufferCluster: 获取内存块时, 长度错误!"),null;const i=this._getBlockWithExpand(),s=new ho(this.manager.snCounter++,this,i,t,r,e);return this.blocks[i]=s,s}freeBlock(t){const e=this.blocks.indexOf(t);return-1!==e&&(e===this.blocks.length-1?this.blocks.length--:(this.blocks[e]=null,this.needUpload[e]=!1),t.destroy(),!0)}upload(){let t=0,e=0,r=!1,i=-1,s=-1,a=0,n=0;for(let l=0,o=this.blocks.length;l<o;l++)this.needUpload[l]?(-1===i&&(i=l),s=l,r=!0,this.needUpload[l]=!1):r&&(a=i*this.blockSize,n=(s-i+1)*this.blockSize,this.manager.writeBuffer(this.buffer,this.data,a,n),t++,e+=n,i=-1,s=-1,r=!1);r&&(a=i*this.blockSize,n=(s-i+1)*this.blockSize,this.manager.writeBuffer(this.buffer,this.data,a,n),t++,e+=n),this.manager.uploadNum+=t,this.manager.uploadByte+=e,this.manager.statisUpload(t,e)}optimize(){for(let t=this.blocks.length-1;t>-1;t--){const e=this.blocks[t];if(e&&e.uploadNum>this.manager.uploadThreshold&&!e.moved&&t>0){const r=this.needUpload[t],i=this.blockSize,s=new Uint8Array(this.data);this.move.set(new Uint8Array(this.data,i*t,i));for(let e=t-1;e>=0;e--){const t=e*i,r=t+i,a=t+i;s.copyWithin(a,t,r),this.needUpload[e+1]=this.needUpload[e],this.blocks[e+1]=this.blocks[e],this.blocks[e+1]&&(this.blocks[e+1].index++,this.blocks[e+1].offset+=i,this.blocks[e+1].user.notifyGPUBufferChange())}s.set(this.move),this.needUpload[0]=r,e.index=0,e.offset=0,e.moved=!0,this.blocks[0]=e,this.blocks[0].user.notifyGPUBufferChange(),this.manager.renderContext.notifyGPUBufferChange(),this.manager.moveNum++;break}}}removeHole(){for(let t=this.blocks.length-1;t>-1;t--)if(!this.blocks[t]){this._moveBlock(t);break}}clear(t){this.blocks.forEach((t=>t&&t.destroy())),this.blocks.length=0,null!=t&&t>0&&t!==this.blockNum?(this.blockNum=t,this.totalSize=this.blockSize*this.blockNum,this.buffer=this.manager.createGPUBuffer(this.totalSize),this.data=new ArrayBuffer(this.totalSize)):(this.blockNum=0,this.totalSize=0,this.buffer=null,this.data=null),this.needUpload.length=this.blockNum,this.needUpload.fill(!1)}_getBlockWithExpand(){for(let t=this.blocks.length-1;t>-1;t--)if(!this.blocks[t])return t;return this.blocks.length<this.blockNum||this._expandBuffer(),this.blocks.length}destroy(){var t;return this.destroyed?(console.warn("UniformBufferCluster: object alreay destroyed!"),!1):(this.clear(),null!==(t=this.buffer.destroy)&&void 0!==t||this.buffer.destroy(),this.manager.statisGPUMemory(-this.totalSize),this.destroyed=!0,!0)}}function co(t,e){return((t+e-1)/e|0)*e}class _o{constructor(t,e){this.destroyed=!1,this.data=new ArrayBuffer(t),this.buffer=e.getBufferAlone(t),this.manager=e,this.size=t,this.alignedSize=co(t,e.byteAlign)}upload(){const t=performance.now();this.manager.writeBuffer(this.buffer,this.data,0,this.size),this.manager.timeCostSum+=performance.now()-t,this.manager.timeCostCount++,this.manager.timeCostCount>100&&(this.manager.timeCostAvg=this.manager.timeCostSum/this.manager.timeCostCount*1e3|0,this.manager.timeCostSum=0,this.manager.timeCostCount=0),this.manager.uploadNum++,this.manager.uploadByte+=this.size,this.manager.statisUpload(1,this.size)}destroy(){var t;return this.destroyed?(console.warn("UniformBufferAlone: object alreay destroyed!"),!1):(this.data=null,null!==(t=this.buffer.destroy)&&void 0!==t||this.buffer.destroy(),this.manager.statisGPUMemory(-this.size),this.destroyed=!0,!0)}}class po{constructor(t,e,r,i){this.destroyed=!1,this.name=t,this.strId="",this.items=new Map,this.itemNum=0,this.data=i,this.size=e,this.manager=r,this.needUpload=!1,r.useBigBuffer?(this.bufferBlock=r.getBlock(e,this),this.offset=this.bufferBlock.offset):this.bufferAlone=new _o(e,r)}notifyGPUBufferChange(){const t=this.bufferBlock.offset-this.offset;this.offset=this.bufferBlock.offset,this.items.forEach((e=>{const r=po._typeArray(e.type);e.view=new r(this.bufferBlock.cluster.data,e.view.byteOffset+t,e.size/r.BYTES_PER_ELEMENT)})),this.clearGPUBufferBind(),this.needUpload=!0}clearGPUBufferBind(){}addUniform(t,e,r,i,s,a,n,l){this.items.has(t)||(this.items.set(t,this._getUniformItem(e,po._typeArray(r),r,i,s,a,n,l)),this.strId.length>0&&(this.strId+="|"),this.strId+=t,this.itemNum++)}setUniformData(t,e){const r=this.items.get(t);if(r)if(this.needUpload=!0,1==r.count)switch(r.type){case"int":case"float":r.view[0]=e;break;case"vec2":r.view[0]=e.x,r.view[1]=e.y;break;case"vec3":r.view[0]=e.x,r.view[1]=e.y,r.view[2]=e.z;break;case"vec4":r.view[0]=e.x,r.view[1]=e.y,r.view[2]=e.z,r.view[3]=e.w;break;case"mat3":for(let t=0;t<3;t++)r.view[4*t+0]=e.elements[3*t+0],r.view[4*t+1]=e.elements[3*t+1],r.view[4*t+2]=e.elements[3*t+2];break;case"mat4":r.view.set(e.elements)}else{const t=r.count*r.elements,i=r.size/r.count/r.view.BYTES_PER_ELEMENT;for(let s=0,a=0;s<t;s+=r.elements,a+=i)r.view.set(e.subarray(s,s+r.elements),a)}}setBool(t,e){const r=this.items.get(t);r&&(r.view[0]=e?1:0,this.needUpload=!0)}setBoolArray(t,e){const r=this.items.get(t);if(r){for(let t=0,i=Math.min(r.count,e.length);t<i;t++)r.view[t]=e[t]?1:0;this.needUpload=!0}}setInt(t,e){const r=this.items.get(t);r&&(r.view[0]=e,this.needUpload=!0)}setIntArray(t,e){const r=this.items.get(t);if(r){for(let t=0,i=Math.min(r.count,e.length);t<i;t++)r.view[t]=e[t];this.needUpload=!0}}setFloat(t,e){const r=this.items.get(t);r&&(r.view[0]=e,this.needUpload=!0)}setFloatArray(t,e){const r=this.items.get(t);if(r){for(let t=0,i=Math.min(r.count,e.length);t<i;t++)r.view[t]=e[t];this.needUpload=!0}}setVector2(t,e){const r=this.items.get(t);r&&(r.view[0]=e.x,r.view[1]=e.y,this.needUpload=!0)}setVector2Array(t,e){const r=this.items.get(t);if(r){for(let t=0,i=Math.min(r.count,e.length);t<i;t++)r.view[2*t+0]=e[t].x,r.view[2*t+1]=e[t].y;this.needUpload=!0}}setVector3(t,e){const r=this.items.get(t);r&&(r.view[0]=e.x,r.view[1]=e.y,r.view[2]=e.z,this.needUpload=!0)}setVector3Array(t,e){const r=this.items.get(t);if(r){for(let t=0,i=Math.min(r.count,e.length);t<i;t++)r.view[4*t+0]=e[t].x,r.view[4*t+1]=e[t].y,r.view[4*t+2]=e[t].z;this.needUpload=!0}}setVector4(t,e){const r=this.items.get(t);r&&(r.view[0]=e.x,r.view[1]=e.y,r.view[2]=e.z,r.view[3]=e.w,this.needUpload=!0)}setVector4Array(t,e){const r=this.items.get(t);if(r){for(let t=0,i=Math.min(r.count,e.length);t<i;t++)r.view[4*t+0]=e[t].x,r.view[4*t+1]=e[t].y,r.view[4*t+2]=e[t].z,r.view[4*t+3]=e[t].w;this.needUpload=!0}}setMatrix3x3(t,e){const r=this.items.get(t);if(r){for(let t=0;t<3;t++)r.view[4*t+0]=e.elements[3*t+0],r.view[4*t+1]=e.elements[3*t+1],r.view[4*t+2]=e.elements[3*t+2];this.needUpload=!0}}setMatrix3x3Array(t,e){const r=this.items.get(t);if(r){for(let t=0,i=Math.min(r.count,e.length);t<i;t++)for(let i=0;i<3;i++)r.view[16*t+4*i+0]=e[t].elements[3*i+0],r.view[16*t+4*i+1]=e[t].elements[3*i+1],r.view[16*t+4*i+2]=e[t].elements[3*i+2];this.needUpload=!0}}setMatrix4x4(t,e){const r=this.items.get(t);r&&(r.view.set(e.elements),this.needUpload=!0)}setMatrix4x4Array(t,e){const r=this.items.get(t);if(r){for(let t=0,i=Math.min(r.count,e.length);t<i;t++)r.view.set(e[t].elements,16*t);this.needUpload=!0}}setBuffer(t,e){this.setUniformData(t,e)}getUniform(t){return this.items.get(t)}hasUniform(t){return this.items.has(t)}isMe(t){return this.strId===t}upload(){this.needUpload&&(this.manager.useBigBuffer?this.bufferBlock.needUpload():this.bufferAlone.upload(),this.needUpload=!1)}clear(){this.manager.useBigBuffer?new Uint8Array(this.bufferBlock.cluster.data).fill(0,this.bufferBlock.offset,this.bufferBlock.offset+this.bufferBlock.size):new Uint8Array(this.bufferAlone.data).fill(0),this.strId="",this.items.clear(),this.itemNum=0,this.needUpload=!1}destroy(){return this.destroyed?(console.warn("UniformBufferUser: object alreay destroyed!"),!1):(this.manager.useBigBuffer?this.manager.freeBlock(this.bufferBlock):this.bufferAlone.destroy(),this.destroyed=!0,!0)}_getUniformItem(t,e,r,i,s,a,n,l){let o;return o=this.manager.useBigBuffer?new e(this.bufferBlock.cluster.data,this.bufferBlock.offset+i,a/e.BYTES_PER_ELEMENT):new e(this.bufferAlone.data,i,a/e.BYTES_PER_ELEMENT),{name:t,view:o,type:r,align:s,size:a,elements:n,count:l}}static _typeArray(t){return"int"===t?Int32Array:Float32Array}}class fo extends v{get input(){return this._input}get output(){return this._output}get connected(){return this._connected}get endian(){return this._endian}set endian(t){this._endian=t,null!=this._input&&(this._input.endian=t),null!=this._output&&(this._output.endian=t)}constructor(t=null,e=0,r=null,i=null,s=!1){super(),this.disableInput=!1,this.protocols=[],this._byteClass=r||W,this.protocols=i,this.endian=fo.BIG_ENDIAN,t&&e>0&&e<65535&&this.connect(t,e,s)}connect(t,e,r=!1){this.connectByUrl(`${r?"wss":"ws"}://${t}:${e}`)}connectByUrl(t){null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new A.window.WebSocket(t,this.protocols):this._socket=new A.window.WebSocket(t),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=t=>{this._onOpen(t)},this._socket.onmessage=t=>{this._onMessage(t)},this._socket.onclose=t=>{this._onClose(t)},this._socket.onerror=t=>{this._onError(t)}}cleanSocket(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}close(){if(null!=this._socket)try{this._socket.close()}catch(t){}}_onOpen(t){this._connected=!0,this.event(s.OPEN,t)}_onMessage(t){if(t&&t.data){var e=t.data;if(this.disableInput&&e)this.event(s.MESSAGE,e);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var r=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,e&&("string"==typeof e?this._input.writeUTFBytes(e):this._input.writeArrayBuffer(e),this._addInputPosition=this._input.pos,this._input.pos=r),this.event(s.MESSAGE,e)}}}_onClose(t){this._connected=!1,this.event(s.CLOSE,t)}_onError(t){this.event(s.ERROR,t)}send(t){this._socket.send(t)}flush(){if(this._output&&this._output.length>0){var t;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(e){t=e}this._output.endian=this.endian,this._output.clear(),t&&this.event(s.ERROR,t)}}}fo.LITTLE_ENDIAN="littleEndian",fo.BIG_ENDIAN="bigEndian";class go{static getHash(t,e,r,i=9191891){var s,a=0;for(s=0;s<r;s++)a=(2*a+t[e+s])%i;return a}static isSame(t,e,r,i,s,a){if(r!=a)return!1;var n,l;for(l=r,n=0;n<l;n++)if(t[e+n]!=i[s+n])return!1;return!0}}class mo{static get instance(){return mo._instance||(mo._instance=new mo)}static IsJsonbin(t){if(t.byteLength<5)return!1;const e=new Uint32Array(t,0,4)[0];return e==mo.ISJSONBIN||e==mo.ISJSONBIN2||e==mo.ISJSONBIN3}static parse(t){var e=new Int32Array(t,0,4);if(e[0]!==mo.ISJSONBIN&&e[0]!==mo.ISJSONBIN2){var r=new W;r.writeArrayBuffer(t),r.pos=0;var i=r.readUTFBytes();return JSON.parse(i)}return(new mo).read(t)}static parsePack(t){var e=(new mo).read(t);for(var r in e)Bt.cacheRes(r,e[r]);return e}constructor(){}_readArray(t,e,r,i,s){var a,n=[];n.length=r,e>=0&&(a=t.pos,t.pos=e);for(var l=0;l<r;l++)n[l]=this._readOne({},t,null,t.readUint8(),s);return e>=0&&(t.pos=a),n}_getLen(t){let e=t.readUint8();return 128&e?t.readUint8()|(-129&e)<<8:e}static _toLargeNumber(t,e){let r=e.toString(16);if(r.length<7)for(let t=r.length;t<7;t++)r="0"+r;return parseInt(t.toString(16)+""+r,16)}static readInt8Array(t,e,r){var i=e+r;i=i>t._length?t._length:i;var s=new Int8Array(t._d_.buffer.slice(e,i));return t._pos_=i,s}_readOne(t,e,r,i,s){let a,n;switch(i){case mo.NULL:n=null;break;case mo.NUM8:n=e.readByte();break;case mo.NUM16:n=e.readInt16();break;case mo.NUM32:n=e.readInt32();break;case mo.NUM64:n=mo._toLargeNumber(e.readInt32(),e.readInt32());break;case mo.BOOLEAN:n=!!e.readByte();break;case mo.DOUBLE:n=e.readFloat32();break;case mo.NUM16_1000:n=e.readInt16()/1e3;break;case mo.NUM32_1000:n=e.readInt32()/1e3;break;case mo.STRING:n=s.keyArray[e.readUint16()][0];break;case mo.WORDTEXT:a=e.readUint16(),n=s.keyArray[a][3],n||(n=s.keyArray[a][3]=new Qr,n.setText(s.keyArray[a][0]));break;case mo.ARRAYEMPTY:e.readUint8(),n=[];break;case mo.ARRAYNUM8:n=[],n.length=a=e.readUint8();for(let t=0;t<a;t++)n[t]=e.readByte();break;case mo.ARRAYNUM16:n=[],n.length=a=e.readUint8();for(let t=0;t<a;t++)n[t]=e.readInt16();break;case mo.ARRAYNUM32:n=[],n.length=a=e.readUint8();for(let t=0;t<a;t++)n[t]=e.readInt32();break;case mo.ARRAYDOUBLE:n=[],n.length=a=e.readUint8();for(let t=0;t<a;t++)n[t]=e.readFloat32();break;case mo.ARRAYBUFFER:n=e.readArrayBuffer(e.readUint16());break;case mo.ARRAYBUFFER32:n=e.readArrayBuffer(e.readUint32());break;case mo.INT8ARRAY:a=this._getLen(e),n=mo.readInt8Array(e,e.pos,a);break;case mo.UINT8ARRAY:a=this._getLen(e),n=e.readUint8Array(e.pos,a);break;case mo.INT16ARRAY:a=this._getLen(e),n=e.readInt16Array(e.pos,a);break;case mo.FLOAT32ARRAY:a=this._getLen(e),n=e.readFloat32Array(e.pos,a);break;default:return this._readOne_other(t,e,r,i,s)}return t&&r&&(t[r]=n),n}_readOne_other(t,e,r,i,s){let a,n,l,o,h=t;switch(i){case mo.ARRAY8:case mo.ARRAY16:case mo.ARRAY32:switch(i){case mo.ARRAY8:n=e.readUint8();break;case mo.ARRAY16:n=e.readInt16();break;case mo.ARRAY32:n=e.readUint32()}var u=a=[];for(u.length=n,l=0;l<n;l++)i=e.readUint8(),u[l]=this._readOne(null,e,null,i,s);break;case mo.ARRAYREFSOURCE8:case mo.ARRAYREFSOURCE16:n=i===mo.ARRAYREFSOURCE8?e.readUint8():e.readInt16(),o=e.pos-this._dataStartOfs,a=this._readArray(e,-1,n,i,s),this._objectRef[o]={array:a,pos:o};break;case mo.ARRAYREF:case mo.ARRAYREF32:l=e.readByte(),o=i==mo.ARRAYREF?e.readUint16():e.readUint32();let d=this._objectRef[o];if(!d)throw"load ref err";a=l==mo.COMPRESS_NEW?this._readArray(e,o+this._dataStartOfs,d.array.length,i,s):d.array;break;case mo.OBJECT:case mo.OBJECTTHISCLASS:if(null!=r||!t){if(i==mo.OBJECT)h={};else if(n=e.readUint16(),h=this._createObjWithClass(s.keyArray[n][0]),!h)throw"jsonbin read err,no this class:"+s.keyArray[n][0];r&&t&&(t[r]=h)}let c;for(;n=e.readUint16(),n!=mo.OBJECTEND;)c=s.keyArray[n],this._readOne(h,e,c[0],c[1],s);a=h,h=t}return null!=r&&(h[r]=a),a}read(t,e=null){this._createObjWithClass=e;let r,i,s=A.now(),a=new W;switch(a.writeArrayBuffer(t),a.pos=0,this._objectRef={},i=a.readInt32(),i){case mo.ISJSONBIN:r=a.readUTFString();break;case mo.ISJSONBIN2:case mo.ISJSONBIN3:r=a.readUTFString32();break;default:return a.pos=0,null}var n=new yo;n.strs=r.split(mo.SPLITCHAR),n.keyArray.length=n.strs.length/2;for(var l=0,o=n.strs.length;l<o;l+=2)n.keyArray[l/2]=[n.strs[l],parseInt(n.strs[l+1])];let h=A.now();this._dataStartOfs=a.pos;var u={};return this._readOne(u,a,null,mo.OBJECT,n),A.now()-s>10&&console.debug("jsonbinread delay:",A.now()-s+"/"+(h-s),t.byteLength),i==mo.ISJSONBIN3?u.top:u}}mo.ISJSONBIN=16777215,mo.ISJSONBIN2=16777214,mo.ISJSONBIN3=16777213,mo.SPLITCHAR=String.fromCharCode(3),mo.COMPRESS_NEW=1,mo.COMPRESS_REF=2,mo.COMPRESS_REFMODIFY=3,mo.NUM8=0,mo.NUM16=1,mo.NUM32=2,mo.BOOLEAN=3,mo.DOUBLE=4,mo.STRING=5,mo.ARRAY8=6,mo.ARRAY16=7,mo.ARRAYEMPTY=8,mo.ARRAYNUM8=9,mo.ARRAYNUM16=10,mo.ARRAYNUM32=11,mo.ARRAYDOUBLE=12,mo.ARRAYSTRING=13,mo.NULL=14,mo.OBJECT=15,mo.NUM16_1000=16,mo.NUM32_1000=17,mo.WORDTEXT=18,mo.ARRAYBUFFER=19,mo.ARRAYREF=20,mo.ARRAYREFSOURCE8=21,mo.ARRAYREFSOURCE16=22,mo.ARRAYBUFFER32=23,mo.ARRAYREF32=24,mo.ARRAY32=25,mo.OBJECTTHISCLASS=26,mo.NUM64=27,mo.INT8ARRAY=28,mo.UINT8ARRAY=29,mo.INT16ARRAY=30,mo.FLOAT32ARRAY=31,mo.OBJECTEND=32767;class yo{constructor(){this.keys={},this.strs=["BEGIN",0],this.keyArray=[],this.keyIndex=1}}class To{static get instance(){return To._instance||(To._instance=new To)}constructor(){this.objectRef={},this.deep=0}_saveKey(t,e,r,i){this.deep++;var s=t+"/&&__*?/"+e,a=r.keys[s];a||(a=r.keys[s]=r.keyIndex,r.strs.push(t,e),r.keyIndex++),i.writeUint16(a),this.deep--}_getValueArrayType(t){switch(typeof t){case"number":if(Math.floor(t)!==t)return mo.ARRAYDOUBLE;var e=Math.abs(t);return e<128?mo.ARRAYNUM8:e<32767?mo.ARRAYNUM16:mo.ARRAYNUM32;case"string":return mo.OBJECT;case"boolean":return mo.BOOLEAN}return mo.OBJECT}_writeStrOrWordText(t,e,r,i,s){var a=s?mo.WORDTEXT:mo.STRING;null!=e?this._saveKey(e,a,t,i):i.writeUint8(a);var n=t.keys[r];n||(n=t.keys[r]=t.keyIndex,t.strs.push(r,0),t.keyIndex++),i.writeUint16(n)}_writeString(t,e,r){var i=t.keys[e];i||(i=t.keys[e]=t.keyIndex,t.strs.push(e,0),t.keyIndex++),r.writeUint16(i)}_getObjectTypeof(t){return t instanceof ArrayBuffer?"ArrayBuffer":t instanceof Uint8Array?"Uint8Array":t instanceof Int8Array?"Int8Array":t instanceof Int16Array?"Int16Array":t instanceof Float32Array?"Float32Array":t instanceof WordText||To.isWordText(t)?"WordText":"object"}static isWordText(t){return t&&t._text&&(t._$_$ISWORDTYEXT||null!=t.lastGCCnt)}_writeLen(t,e){if(e<128)t.writeUint8(e);else{if(!(e<32768))throw"jsonbin save len must<0x8000 "+e;t.writeUint8(e>>8|128),t.writeUint8(255&e)}}_writeBigNumber(t,e){let r=e.toString(16),i=parseInt(r.substring(0,r.length-7),16),s=parseInt(r.substring(r.length-7),16);if(t.writeInt32(i),t.writeInt32(s),mo._toLargeNumber(i,s)!=e)throw"save big number err:"+e}_writeOne(t,e,r,i,s){if(null==i)return!1;let a=typeof i;if("object"==a&&i){if(i.$__$disbaleJsonBinSv)return i.$__$disbaleJsonBinSv,To.NOSAVETHISOBJ_DELETE,!1;a=this._getObjectTypeof(i)}switch(a){case"number":if(Math.floor(i)!==i){var n=1e3*i;if((0|n)===n){if(Math.abs(i)<32)return null!=r?this._saveKey(r,mo.NUM16_1000,e,t):t.writeUint8(mo.NUM16_1000),t.writeInt16(n),!0;if(Math.abs(i)<2147483)return null!=r?this._saveKey(r,mo.NUM32_1000,e,t):t.writeUint8(mo.NUM32_1000),t.writeInt32(n),!0}return null!=r?this._saveKey(r,mo.DOUBLE,e,t):t.writeUint8(mo.DOUBLE),t.writeFloat32(i),!0}var l=Math.abs(i);return l<128?(null!=r?this._saveKey(r,mo.NUM8,e,t):t.writeUint8(mo.NUM8),t.writeByte(i),!0):l<32767?(null!=r?this._saveKey(r,mo.NUM16,e,t):t.writeUint8(mo.NUM16),t.writeInt16(i),!0):l<2147483647?(null!=r?this._saveKey(r,mo.NUM32,e,t):t.writeUint8(mo.NUM32),t.writeInt32(i),!0):(null!=r?this._saveKey(r,mo.NUM64,e,t):t.writeUint8(mo.NUM64),this._writeBigNumber(t,i),!0);case"string":return this._writeStrOrWordText(e,r,i,t,!1),!0;case"boolean":return null!=r?this._saveKey(r,mo.BOOLEAN,e,t):t.writeUint8(mo.BOOLEAN),t.writeByte(i?1:0),!0;case"ArrayBuffer":return null!=r?this._saveKey(r,mo.ARRAYBUFFER32,e,t):t.writeUint8(mo.ARRAYBUFFER32),t.writeUint32(i.byteLength),t.writeArrayBuffer(i),!0;case"Uint8Array":return null!=r?this._saveKey(r,mo.UINT8ARRAY,e,t):t.writeUint8(mo.UINT8ARRAY),this._writeLen(t,i.byteLength),t.writeArrayBuffer(i.buffer),!0;case"Int8Array":return null!=r?this._saveKey(r,mo.INT8ARRAY,e,t):t.writeUint8(mo.INT8ARRAY),this._writeLen(t,i.byteLength),t.writeArrayBuffer(i.buffer),!0;case"Int16Array":return null!=r?this._saveKey(r,mo.INT16ARRAY,e,t):t.writeUint8(mo.INT16ARRAY),this._writeLen(t,i.byteLength),t.writeArrayBuffer(i.buffer),!0;case"Float32Array":return null!=r?this._saveKey(r,mo.FLOAT32ARRAY,e,t):t.writeUint8(mo.FLOAT32ARRAY),this._writeLen(t,i.byteLength),t.writeArrayBuffer(i.buffer),!0;case"WordText":return this._writeStrOrWordText(e,r,i._text,t,!0),!0;case"object":break;default:throw"jsonbin no this type:"+a}return i?i instanceof Array?this._saveArray(s,t,e,r,i):(this._classEnable_&&i.__CLASS__?null!=r?this._saveKey(r,mo.OBJECTTHISCLASS,e,t):t.writeUint8(mo.OBJECTTHISCLASS):null!=r?this._saveKey(r,mo.OBJECT,e,t):t.writeUint8(mo.OBJECT),this._writeObject(t,e,i),t.writeUint16(mo.OBJECTEND),!0):(null!=r?this._saveKey(r,mo.NULL,e,t):t.writeUint8(mo.NULL),!0)}_saveArray(t,e,r,i,s){var a,n,l,o=s.length;if(0===o)return null!=i?this._saveKey(i,mo.ARRAYEMPTY,r,e):e.writeUint8(mo.ARRAYEMPTY),e.writeByte(0),!0;if(o>1&&o<250&&(n=this._getValueArrayType(s[0]))!=mo.OBJECT){for(a=1;a<o;a++)if(n!==this._getValueArrayType(s[a])){n=mo.OBJECT;break}if(n!=mo.OBJECT&&n!=mo.BOOLEAN){switch(null!=i?this._saveKey(i,n,r,e):e.writeUint8(n),e.writeUint8(s.length),n){case mo.ARRAYNUM8:for(a=0;a<o;a++)e.writeByte(s[a]);break;case mo.ARRAYNUM16:for(a=0;a<o;a++)e.writeInt16(s[a]);break;case mo.ARRAYNUM32:for(a=0;a<o;a++)e.writeInt32(s[a]);break;case mo.ARRAYDOUBLE:for(a=0;a<o;a++)e.writeFloat32(s[a])}return!0}}l=o<250?mo.ARRAY8:o<32700?mo.ARRAY16:mo.ARRAY32;var h=e.pos;null!=i?this._saveKey(i,l,r,e):e.writeUint8(l);var u=e.pos,d=0;switch(l){case mo.ARRAY8:e.writeUint8(o);break;case mo.ARRAY16:e.writeInt16(o);break;case mo.ARRAY32:e.writeUint32(o)}var c,_=e.pos;for(a=0;a<o;a++)this._writeOne(e,r,null,s[a],t)&&d++;if(d!=o){var p=e.pos;e.pos=u,l==mo.ARRAY8?e.writeUint8(d):e.writeInt16(d),e.pos=p}return i&&t&&(c=t[To.COMPRESS+i])&&this._useCompress(e,r,i,s,h,_,c,l),!0}_useCompress(t,e,r,i,s,a,n,l){var o,h,u,d,c=t.pos-a,_=go.getHash(t._u8d_,a,c);if(this.objectRef[_]){var p=this.objectRef[_];for(d=p.length,u=0;u<d;u++)if((h=p[u]).value==i){o=h;break}if(!o)for(u=0;u<d;u++)if(h=p[u],go.isSame(t._u8d_,h.pos,h.len,t._u8d_,a,c)){o=h;break}}else this.objectRef[_]=[];o?(t.pos=s,this._saveKey(r,mo.ARRAYREF32,e,t),t.writeByte(n),t.writeUint32(o.pos)):(this.objectRef[_].push({hashCode:_,pos:a,len:c,value:i}),t.pos=s,this._saveKey(r,l==mo.ARRAY8?mo.ARRAYREFSOURCE8:mo.ARRAYREFSOURCE16,e,t),t.pos=a+c)}_writeObject(t,e,r){for(var i in this._classEnable_&&r.__CLASS__&&this._writeString(e,r.__CLASS__,t),r)i&&i.length>To.NOSAVE_KEY_LEN&&i.substr(0,To.NOSAVE_KEY_LEN)==To.NOSAVEKEY||this._classEnable_&&"__CLASS__"==i||this._writeOne(t,e,i,r[i],r)}write(t,e=!1){this.deep=0,this._classEnable_=e;var r=new xo;this.objectRef={};var i=new W;this._writeObject(i,r,{top:t}),i.writeUint16(mo.OBJECTEND);var s=new W;return s.writeInt32(mo.ISJSONBIN3),s.writeUTFString32(r.strs.join(mo.SPLITCHAR)),s.writeArrayBuffer(i.buffer),s.buffer}}To.COMPRESS="_$TeMpkEy$_CoMpReSs",To.NOSAVEKEY="_$TeMpkEyNoSv$_",To.NOSAVETHISOBJ="$__$disbaleJsonBinSv",To.NOSAVE_KEY_LEN=15,To.NOSAVETHISOBJ_DELETE=2,To.NOSAVETHISOBJ_TRUE=1;class xo{constructor(){this.keys={},this.strs=["BEGIN",0],this.keyArray=[],this.keyIndex=1}}class vo{constructor(t,e){this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new G,this.oldTx=0,this.oldTy=0,this.invMat=new G,this.context=t,this.sprite=e,t._globalClipMatrix.copyTo(this.cachedClipInfo)}startRec(){}endRec(){}isTextNeedRestore(){var t=!1,e=this.touches;if(e)for(var r=0;r<e.length;r++)if(e[r].deleted){t=!0;break}return t}flushsubmit(){Fr.RENDERBASE,this.submits.forEach((t=>{Fr.RENDERBASE}))}releaseMem(){}}vo.matI=new G;class So{constructor(){this._deviceBufferState=l.renderDeviceFactory.createBufferState()}applyState(t,e){this._vertexBuffers=t,this._bindedIndexBuffer=e,this._deviceBufferState&&(1==t.length?(So.vertexBufferArray.length=1,So.vertexBufferArray[0]=t[0]._deviceBuffer):(So.vertexBufferArray.length=0,t.forEach((t=>{So.vertexBufferArray.push(t._deviceBuffer)}))),this._deviceBufferState.applyState(So.vertexBufferArray,e?e._deviceBuffer:null))}destroy(){this._deviceBufferState&&(this._deviceBufferState.destroy(),this._deviceBufferState=null)}}So.vertexBufferArray=[];class Eo{static ArrayMul(t,e,r){if(t)if(e)for(var i,s,a,n,l=0;l<4;l++)i=t[l],s=t[l+4],a=t[l+8],n=t[l+12],r[l]=i*e[0]+s*e[1]+a*e[2]+n*e[3],r[l+4]=i*e[4]+s*e[5]+a*e[6]+n*e[7],r[l+8]=i*e[8]+s*e[9]+a*e[10]+n*e[11],r[l+12]=i*e[12]+s*e[13]+a*e[14]+n*e[15];else Eo.copyArray(t,r);else Eo.copyArray(e,r)}static copyArray(t,e){if(t&&e)for(var r=0;r<t.length;r++)e[r]=t[r]}}const wo=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],Do=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],bo=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];return t.AlphaCmd=Ii,t.Animation=ln,t.Animation2DCondition=Xn,t.Animation2DEvent=Vn,t.Animation2DParm=Yn,t.AnimationBase=en,t.AnimationClip2D=Wn,t.AnimationClip2DParse01=Hn,t.Animator2D=Fn,t.AnimatorController2D=Zn,t.AnimatorControllerLayer2D=Cn,t.AnimatorControllerParse=On,t.AnimatorPlayState2D=Rn,t.AnimatorState2D=Un,t.AnimatorState2DScript=class{setPlayScriptInfo(t,e,r){this.playStateInfo.animator=t,this.playStateInfo.layerindex=e,this.playStateInfo.playState=r}constructor(){this.playStateInfo={animator:null,layerindex:-1,playState:null}}onStateEnter(){}onStateUpdate(t){}onStateExit(){}onStateLoop(){}},t.AnimatorStateBoolCondition=$n,t.AnimatorStateCondition=jn,t.AnimatorStateNumberCondition=qn,t.AnimatorStateTriggerCondition=Kn,t.AnimatorTransition2D=Qn,t.ArabicReshaper=class{characterMapContains(t){for(var e=0;e<wo.length;++e)if(wo[e][0]===t)return!0;return!1}getCharRep(t){for(var e=0;e<wo.length;++e)if(wo[e][0]===t)return wo[e];return!1}getCombCharRep(t,e){for(var r=0;r<Do.length;++r)if(Do[r][0][0]===t&&Do[r][0][1]===e)return Do[r];return!1}isTransparent(t){for(var e=0;e<bo.length;++e)if(bo[e]===t)return!0;return!1}getOriginalCharsFromCode(t){var e;for(e=0;e<wo.length;++e)if(wo[e].indexOf(t)>-1)return String.fromCharCode(wo[e][0]);for(e=0;e<Do.length;++e)if(Do[e].indexOf(t)>-1)return String.fromCharCode(Do[e][0][0])+String.fromCharCode(Do[e][0][1]);return String.fromCharCode(t)}convertArabic(t){for(var e,r,i="",s=0;s<t.length;++s){var a=t.charCodeAt(s);if(this.characterMapContains(a)){for(var n=null,l=null,o=s-1,h=s+1;o>=0&&this.isTransparent(t.charCodeAt(o));--o);for((!(e=!!(n=o>=0?t.charCodeAt(o):null)&&this.getCharRep(n))||null==e[2]&&null==e[3])&&(n=null);h<t.length&&this.isTransparent(t.charCodeAt(h));++h);if((!(e=!!(l=h<t.length?t.charCodeAt(h):null)&&this.getCharRep(l))||null==e[3]&&null==e[4])&&(l=null),1604===a&&null!=l&&(1570===l||1571===l||1573===l||1575===l)){r=this.getCombCharRep(a,l),i+=null!=n?String.fromCharCode(r[4]):String.fromCharCode(r[1]),++s;continue}if(e=this.getCharRep(a),null!=n&&null!=l&&null!=e[3]){i+=String.fromCharCode(e[3]);continue}if(null!=n&&null!=e[4]){i+=String.fromCharCode(e[4]);continue}if(null!=l&&null!=e[2]){i+=String.fromCharCode(e[2]);continue}i+=String.fromCharCode(e[1])}else i+=String.fromCharCode(a)}return i}convertArabicBack(t){var e,r,i="";for(r=0;r<t.length;++r)e=t.charCodeAt(r),i+=this.getOriginalCharsFromCode(e);return i}},t.AssetDb=N,t.AtlasGrid=Wr,t.AtlasInfoManager=yt,t.AtlasResource=xt,t.AudioSound=Pa,t.AudioSoundChannel=La,t.Base64Tool=Zl,t.BasePoly=Lr,t.BaseRenderNode2D=zl,t.BaseTexture=R,t.Batch2DInfo=de,t.BatchProgress=vt,t.Bezier=cr,t.BinHashUtils=go,t.BitmapFont=bs,t.BlendComponent=El,t.BlendMode=pr,t.BlendState=Sl,t.BlurFilter=mn,t.BoundsStyle=Ri,t.Browser=A,t.Buffer=wl,t.BufferState=So,t.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(t){this._tar=t,t.on(s.MOUSE_DOWN,this,this.toChangedState),t.on(s.MOUSE_UP,this,this.toInitState),t.on(s.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&Ss.clear(this._curTween),this._curTween=Ss.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,vs[this.effectEase],St.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&Ss.clear(this._curTween),this._curState=2,this._curTween=Ss.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,vs[this.backEase],St.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},t.Byte=W,t.CacheManger=ds,t.CachePage=mi,t.CacheStyle=Ci,t.Cache_Info=pi,t.CallLater=wa,t.CharRenderInfo=Gr,t.CharRender_Canvas=Jr,t.CharSubmitCache=kr,t.ClassUtils=Ot,t.ClipRectCmd=hs,t.Color=_t,t.ColorFilter=vn,t.ColorUtils=gr,t.CommandEncoder=class{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(t){this._idata.push(t)}},t.CommandUniformMap=class{constructor(t){}addShaderUniform(t,e,r,i=null){throw"need override it"}addShaderUniformArray(t,e,r,i,s=""){throw"need override it"}addShaderBlockUniform(t,e,r){throw"need override it"}},t.Component=tn,t.ComponentDriver=Ca,t.Config=f,t.Config3D=_,t.Const=Ut,t.Context=li,t.DDSTextureInfo=lt,t.DefferTouchResContext=di,t.Delegate=T,t.DepthState=class{},t.Downloader=At,t.Dragging=Es,t.Draw9GridTextureCmd=Qi,t.DrawCircleCmd=Mi,t.DrawCurvesCmd=Bi,t.DrawEllipseCmd=ts,t.DrawGeoCmd=_s,t.DrawGeosCmd=ps,t.DrawImageCmd=Li,t.DrawLineCmd=Pi,t.DrawLinesCmd=Oi,t.DrawPathCmd=Fi,t.DrawPieCmd=ki,t.DrawPolyCmd=Vi,t.DrawRectCmd=Hi,t.DrawRoundRectCmd=es,t.DrawStyle=mr,t.DrawTextureCmd=zi,t.DrawTexturesCmd=us,t.DrawTrianglesCmd=Ki,t.Earcut=Nr,t.EarcutNode=Pr,t.Ease=vs,t.EffectAnimation=on,t.EffectBase=Cl,t.Event=s,t.EventDispatcher=v,t.FadeIn=class extends Cl{_doTween(){return this.target.alpha=0,Ss.to(this.target,{alpha:1},this.duration,vs[this.ease],this._comlete,this.delay)}},t.FadeOut=class extends Cl{_doTween(){return this.target.alpha=1,Ss.to(this.target,{alpha:0},this.duration,vs[this.ease],this._comlete,this.delay)}},t.FastSinglelist=ue,t.FillTextCmd=rs,t.FillTextureCmd=Wi,t.Filter=ee,t.FontInfo=qr,t.FrameAnimation=sn,t.GLSLCodeGenerator=Ol,t.GlowFilter=Sn,t.GrahamScan=re,t.GraphicAnimation=an,t.Graphics=fs,t.GraphicsBounds=ns,t.HDRTextureInfo=el,t.HTMLCanvas=bi,t.HalfFloatUtils=Y,t.Handler=St,t.HideFlags=Gt,t.HierarchyLoader=pn,t.HierarchyParser=_n,t.HierarchyResource=dn,t.HitArea=eo,t.HtmlElement=As,t.HtmlImage=Is,t.HtmlLink=Ms,t.HtmlParseOptions=Bs,t.HtmlParser=Ns,t.HttpRequest=Ct,t.ICharRender=Zr,t.ILaya=e,t.ImgUtils=Et,t.IncludeFile=ve,t.IndexBuffer=class extends wl{constructor(e,r){super(e,r),this._indexType=t.IndexFormat.UInt16}},t.Input=va,t.InputManager=aa,t.JsonBinRead=mo,t.JsonBinWrite=To,t.KTXTextureInfo=dt,t.KeyLocation=Rl,t.Keyboard=bl,t.Keyframe2D=Gn,t.KeyframeNode2D=kn,t.KeyframeNodeList2D=zn,t.Laya=ja,t.LayaEnv=n,t.LayaGL=l,t.LayaGLQuickRunner=hi,t.Loader=Bt,t.LocalStorage=Ua,t.Log=ro,t.Material=Xa,t.MaterialLoader=pl,t.MaterialParser=_l,t.MathUtil=rn,t.MathUtils3D=h,t.MatirxArray=Eo,t.Matrix=G,t.Matrix3x3=Oe,t.Matrix4x4=$e,t.MeasureFont=zr,t.Mesh2D=class extends b{static load(t,r){e.loader.load(t,r,null,Bt.MESH)}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get vertexCount(){return this._vertexCount}get indexCount(){return this._indexBuffer.indexCount}get subMeshCount(){return this._subMeshes.length}get indexFormat(){return this._indexFormat}set indexFormat(t){this._indexFormat=t,this._subMeshes.forEach((e=>{e.indexFormat=t}))}constructor(){super(),this._instanceBufferStateType=0,this._vertexBuffers=null,this._indexBuffer=null,this._vertexCount=0,this._indexFormat=t.IndexFormat.UInt16,this._bufferState=l.renderDeviceFactory.createBufferState(),this._subMeshes=[],this.destroyedImmediately=f.destroyResourceImmediatelyDefault}_disposeResource(){for(let t=0,e=this._subMeshes.length;t<e;t++)this._subMeshes[t].destroy();for(let t=0,e=this._vertexBuffers.length;t<e;t++)this._vertexBuffers[t].destroy();this._indexBuffer&&this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState&&this._instanceBufferState.destroy(),this._instanceWorldVertexBuffer&&this._instanceWorldVertexBuffer.destroy(),this._instanceSimpleAniVertexBuffer&&this._instanceSimpleAniVertexBuffer.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffers=null,this._indexBuffer=null,this._subMeshes=null,this._indexBuffer=null}_setSubMeshes(t){this._subMeshes=t}_setBuffer(t,e){this._bufferState.applyState([t],e)}getSubMesh(t){return this._subMeshes[t]}setVertices(t){for(let e=0,r=t.length;e<r;e++)t[e]&&this._vertexBuffers[e]&&this._vertexBuffers[e].setData(t[e],0,0,t[e].byteLength)}setIndices(e){var r;e instanceof Uint32Array?r=t.IndexFormat.UInt32:e instanceof Uint16Array?r=t.IndexFormat.UInt16:e instanceof Uint8Array&&(r=t.IndexFormat.UInt8);let i=this._indexBuffer;this._indexFormat===r&&i.indexCount===e.length||(i.destroy(),this._indexBuffer=i=l.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Static),i.indexCount=i.indexCount,i.indexType=r),i._setIndexData(e,0),this.indexFormat=r}},t.MeshQuadTexture=te,t.MeshTexture=ri,t.MeshVG=ii,t.Mouse=Ha,t.Node=ms,t.NodeFlags=kt,t.NotImplementedError=V,t.NotReadableError=z,t.NullLoader=dl,t.OutOfRangeError=H,t.PERF_BEGIN=$l,t.PERF_END=Kl,t.PERF_FRAMECLEAR=Ql,t.ParseJSON=fl,t.Path=yr,t.PerfData=io,t.PerfHUD=so,t.PerfTools=jl,t.PerformanceDefine=ql,t.PlayerConfig=g,t.Point=i,t.Pool=r,t.PoolCache=ao,t.Prefab=un,t.PrefabImpl=cn,t.PrimitiveSV=Ga,t.Quaternion=He,t.QuickTestTool=Al,t.Rectangle=F,t.Render=ca,t.Render2D=le,t.Render2DSimple=oe,t.RenderInfo=Ur,t.RenderManager2D=ce,t.RenderObject2D=_i,t.RenderSprite=Di,t.RenderState=xe,t.RenderState2D=ne,t.RenderStateContext=_r,t.RenderTexture=C,t.RenderTexture2D=pt,t.RenderTextureCube=class extends C{constructor(t,e,r,i,s){super(t,t,e,r,i,s),this.faceIndex=0}_createRenderTarget(){this._dimension=t.TextureDimension.Cube,this._renderTarget=l.textureContext.createRenderTargetCubeInternal(this.width,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._texture=this._renderTarget._textures[0]}},t.RenderTextureLoader=sl,t.RenderToCache=ci,t.Resource=b,t.RestoreCmd=Yi,t.RotateCmd=Xi,t.RunDriver=Ra,t.SaveBase=xr,t.SaveClipRect=vr,t.SaveCmd=Ji,t.SaveMark=Sr,t.SaveTransform=Er,t.SaveTranslate=wr,t.ScaleCmd=ji,t.Scene=fn,t.Script=Jn,t.SerializeUtil=ya,t.Shader2D=br,t.Shader3D=dr,t.ShaderCompile=Me,t.ShaderCompileDefineBase=sr,t.ShaderData=class{constructor(t=null){this._ownerResource=t}_addCheckUBO(t,e,r){throw new V}_releaseUBOData(){throw new V}getDefineData(){throw new V}getData(){throw new V}addDefine(t){throw new V}addDefines(t){throw new V}removeDefine(t){throw new V}hasDefine(t){throw new V}clearDefine(){throw new V}getBool(t){throw new V}setBool(t,e){throw new V}getInt(t){throw new V}setInt(t,e){throw new V}getNumber(t){throw new V}setNumber(t,e){throw new V}getVector2(t){throw new V}setVector2(t,e){throw new V}getVector3(t){throw new V}setVector3(t,e){throw new V}getVector(t){throw new V}setVector(t,e){throw new V}getColor(t){throw new V}setColor(t,e){throw new V}getMatrix4x4(t){throw new V}setMatrix4x4(t,e){throw new V}getMatrix3x3(t){throw new V}setMatrix3x3(t,e){throw new V}getBuffer(t){throw new V}setBuffer(t,e){throw new V}setTexture(t,e){throw new V}getTexture(t){throw new V}setUniformBuffer(t,e){throw new V}getUniformBuffer(t){throw new V}setShaderData(e,r,i){switch(r){case t.ShaderDataType.Int:this.setInt(e,i);break;case t.ShaderDataType.Bool:this.setBool(e,i);break;case t.ShaderDataType.Float:this.setNumber(e,i);break;case t.ShaderDataType.Vector2:this.setVector2(e,i);break;case t.ShaderDataType.Vector3:this.setVector3(e,i);break;case t.ShaderDataType.Vector4:this.setVector(e,i);break;case t.ShaderDataType.Color:this.setColor(e,i);break;case t.ShaderDataType.Matrix4x4:this.setMatrix4x4(e,i);break;case t.ShaderDataType.Matrix3x3:this.setMatrix3x3(e,i);break;case t.ShaderDataType.Texture2D:case t.ShaderDataType.TextureCube:this.setTexture(e,i);break;case t.ShaderDataType.Buffer:this.setBuffer(e,i);break;default:throw new Error(`unknown shader data type: ${r}`)}}getShaderData(e,r){switch(r){case t.ShaderDataType.Int:return this.getInt(e);case t.ShaderDataType.Bool:return this.getBool(e);case t.ShaderDataType.Float:return this.getNumber(e);case t.ShaderDataType.Vector2:return this.getVector2(e);case t.ShaderDataType.Vector3:return this.getVector3(e);case t.ShaderDataType.Vector4:return this.getVector(e);case t.ShaderDataType.Color:return this.getColor(e);case t.ShaderDataType.Matrix4x4:return this.getMatrix4x4(e);case t.ShaderDataType.Texture2D:case t.ShaderDataType.TextureCube:return this.getTexture(e);case t.ShaderDataType.Buffer:return this.getBuffer(e);case t.ShaderDataType.Matrix3x3:return this.getMatrix3x3(e);case t.ShaderDataType.Matrix4x4:return this.getMatrix4x4(e);default:throw"unknown shader data type."}}_setInternalTexture(t,e){throw new V}cloneTo(t){throw new V}_cloneUBO(t){throw new V}clone(){throw new V}reset(){throw new V}destroy(){throw new V}},t.ShaderDataDefaultValue=er,t.ShaderDefine=class{constructor(t,e){this._index=t,this._value=e}},t.ShaderDefines2D=Rr,t.ShaderNode=Se,t.ShaderParser=xl,t.ShaderPass=lr,t.ShaderProcessInfo=ir,t.ShaderVariable=Ul,t.ShaderVariant=ar,t.ShaderVariantCollection=nr,t.SingletonList=he,t.Socket=fo,t.Sound=class extends v{load(t){}play(t=0,e=0){return null}get duration(){return 0}dispose(){}},t.SoundChannel=Ba,t.SoundManager=Fa,t.SoundNode=En,t.Sprite=Ds,t.Sprite2DGeometry=Jt,t.SpriteCache=Ti,t.SpriteConst=ie,t.SpriteStyle=Ai,t.SpriteUtils=ws,t.Stage=Aa,t.Stat=se,t.StencilState=class{},t.StringKey=class{constructor(){this._strsToID={},this._idToStrs=[],this._length=0}add(t){var e=this._strsToID[t];return null!=e?e:(this._idToStrs[this._length]=t,this._strsToID[t]=this._length++)}getID(t){var e=this._strsToID[t];return null==e?-1:e}getName(t){var e=this._idToStrs[t];return null==e?void 0:e}},t.SubShader=hr,t.SubUniformBufferData=class extends rr{constructor(t,e){super(t),this._isInPool=!1,this._needUpdate=!1,this._realByte=0,this._offset=e,this._realByte=this._bytelength,this._bytelength=256*Math.ceil(this._bytelength/256)}},t.SubmitBase=Fr,t.SubmitKey=Or,t.System=class{static changeDefinition(t,e){window.Laya[t]=e;var r=t+"=classObj";window.eval(r)}},t.Text=Fs,t.TextAtlas=jr,t.TextRender=ti,t.TextResource=tl,t.TextStyle=Rs,t.TextTexture=Xr,t.Texture=mt,t.Texture2D=ct,t.Texture2DArray=oa,t.Texture2DLoader=il,t.Texture3D=Yl,t.TextureCube=da,t.TextureLoader=ol,t.TextureSV=Va,t.TimeLine=no,t.Timer=Sa,t.TransformCmd=qi,t.TranslateCmd=$i,t.Tween=Ss,t.TypedArrayClasses=_a,t.UBBParser=Os,t.URL=O,t.UniformBufferAlone=_o,t.UniformBufferBase=Wa,t.UniformBufferBlock=ho,t.UniformBufferCluster=uo,t.UniformBufferManager=class{constructor(t){this.useBigBuffer=!0,this.destroyed=!1,this.snCounter=0,this.byteAlign=256,this.clusterMaxBlock=256,this.uploadThreshold=200,this.moveNum=0,this.uploadNum=0,this.uploadByte=0,this.removeHoleTimer=0,this.timeCostAvg=0,this.timeCostSum=0,this.timeCostCount=0,this.clustersAll=new Map,this.clustersCur=new Map,this.useBigBuffer=t}_addCluster(t,e=10){const r=co(t,this.byteAlign),i=new uo(r,e,this),s=this.clustersAll.get(r);return s?(s.push(i),i.sn=s.length-1):this.clustersAll.set(r,[i]),this.clustersCur.set(r,i),i}_removeHole(){this.useBigBuffer&&this.clustersAll.forEach((t=>{for(let e=t.length-1;e>-1;e--)t[e].removeHole()}))}startFrame(){this.uploadNum=0,this.uploadByte=0}setRenderContext(t){this.renderContext=t}getBufferAlone(t,e){const r=co(t,this.byteAlign);return this.statisGPUMemory(r),this.createGPUBuffer(r,e)}removeCluster(t,e){const r=co(t,this.byteAlign);if(-1===e)return this.clustersAll.delete(r),void this.clustersCur.delete(r);const i=this.clustersCur.get(r),s=this.clustersAll.get(r);if(s.length>e){if(s.splice(e,1),0===s.length)return this.clustersAll.delete(r),void this.clustersCur.delete(r);for(let t=e;t<s.length;t++)s[t].sn--;if(i.sn===e)if(1===s.length)this.clustersCur.set(r,s[0]);else{let t=0,e=s[0].usedNum;for(let r=1;r<s.length;r++)s[r].usedNum<e&&(t=r,e=s[r].usedNum);this.clustersCur.set(r,s[t])}}}getBlock(t,e){const r=co(t,this.byteAlign);let i=this.clustersCur.get(r);if(!i)return this._addCluster(r).getBlock(t,e);if(i.usedNum<this.clusterMaxBlock)return i.getBlock(t,e);i=null;const s=this.clustersAll.get(r);for(let t=s.length-1;t>-1;t--)if(s[t].usedNum<this.clusterMaxBlock){i=s[t],this.clustersCur.set(r,i);break}return i?i.getBlock(t,e):this._addCluster(r).getBlock(t,e)}freeBlock(t){const e=t.cluster;return!!e&&(!!e.freeBlock(t)&&(0===e.usedNum&&this.removeCluster(e.blockSize,e.sn),!0))}upload(){if(this.useBigBuffer){const t=performance.now();this.clustersAll.forEach((t=>{for(let e=t.length-1;e>-1;e--)t[e].upload(),t[e].optimize()})),this.timeCostSum+=performance.now()-t,this.timeCostCount++,this.timeCostCount>100&&(this.timeCostAvg=this.timeCostSum/this.timeCostCount*1e3|0,this.timeCostSum=0,this.timeCostCount=0),this.removeHoleTimer++,this.removeHoleTimer>1e3&&(this.removeHoleTimer=0,this._removeHole())}}clear(){this.clustersAll.forEach((t=>{for(let e=t.length-1;e>-1;e--)t[e].clear()}))}destroy(){return this.destroyed?(console.warn("UniformBufferManager: object alreay destroyed!"),!1):(this.clear(),this.clustersAll.clear(),this.clustersCur.clear(),this.destroyed=!0,!0)}createGPUBuffer(t,e){}writeBuffer(t,e,r,i){}statisGPUMemory(t){}statisUpload(t,e){}},t.UniformBufferObject=Ya,t.UniformBufferUser=po,t.UnifromBufferData=rr,t.Utils=P,t.Value2D=Cr,t.Value2DManager=class{},t.Vector2=Qe,t.Vector3=d,t.Vector4=u,t.VectorGraphManager=cs,t.VertexAttributeLayout=Dl,t.VertexBuffer=class extends wl{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(t){this._vertexDeclaration=t}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(t){this._instanceBuffer=t}constructor(t,e){super(t,e),this._instanceBuffer=!1,this._vertexDeclaration=null}},t.VertexDeclaration=Qt,t.VertexElement=Zt,t.VertexElementFormat=$t,t.VertexMesh=or,t.VertexMesh2D=Wl,t.VertexStateContext=Kt,t.VideoNode=bn,t.VideoTexture=wn,t.VideoTextureLoader=al,t.Viewport=kl,t.WasmAdapter=oo,t.WeakObject=za,t.WebAudioSound=Oa,t.WebAudioSoundChannel=Na,t.WebGL=ba,t.WebGLCacheAsNormalCanvas=vo,t.WebGLRTMgr=Xl,t.Widget=hn,t.WordText=Qr,t.WorkerLoader=Tt,t.XML=Rt,t.XMLIterator=bt,t.XMLUtils=wt,t.addAfterInitCallback=Ja,t.addBeforeInitCallback=Za,t.addInitCallback=Qa,t.alertGlobalError=$a,t.allowMultiple=function(t){t.prototype._$singleton=!1},t.classInfo=function(t){return Ft},t.enableDebugPanel=Ka,t.init=qa,t.property=function(t){return Ft},t.regClass=function(t){return function(e){Ot.regClass(t,e)}},t.regLoader=function(t,e,r){return function(i){Bt.registerLoader(t,i,e,r)}},t.roundDown=function(t,e){const r=((t+e-1)/e|0)*e;return r>t?r-e:r},t.roundUp=co,t.runInEditor=function(t){},t}({});
